[{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\BotpressChatbot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\CsvExportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\CsvImportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\EnterpriseFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\NLQueryInterface.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'NLQueryInterface' has a complexity of 24. Maximum allowed is 15.","line":37,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":37,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { \r\n  Database, Send, CheckCircle, XCircle, AlertCircle, \r\n  Loader2, ThumbsUp, ThumbsDown, Copy, Download, Code,\r\n  Sparkles, Table as TableIcon\r\n} from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\n\r\ninterface QueryIntent {\r\n  intent: string;\r\n  confidence: number;\r\n  suggestedSQL: string;\r\n  explanation: string;\r\n  tablesInvolved: string[];\r\n  isReadOnly: boolean;\r\n  isAmbiguous?: boolean;\r\n  clarifyingQuestions?: string[];\r\n  userFriendlyIntent?: string;\r\n}\r\n\r\ninterface QueryResult {\r\n  success: boolean;\r\n  data?: any[];\r\n  error?: string;\r\n  rowCount?: number;\r\n  executionTime?: number;\r\n  insights?: string[];\r\n}\r\n\r\nexport default function NLQueryInterface() {\r\n  const [userQuery, setUserQuery] = useState(\"\");\r\n  const [queryIntent, setQueryIntent] = useState<QueryIntent | null>(null);\r\n  const [queryResult, setQueryResult] = useState<QueryResult | null>(null);\r\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n  const [isExecuting, setIsExecuting] = useState(false);\r\n  const [showConfirmation, setShowConfirmation] = useState(false);\r\n  const [suggestions, setSuggestions] = useState<string[]>([]);\r\n  const [viewMode, setViewMode] = useState<'table' | 'json'>('table');\r\n  const { toast } = useToast();\r\n\r\n  // Load suggestions on mount\r\n  useState(() => {\r\n    loadSuggestions();\r\n  });\r\n\r\n  const loadSuggestions = async () => {\r\n    try {\r\n      const response = await fetch('/api/duggu/nl/suggestions');\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setSuggestions(data.suggestions || []);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading suggestions:', error);\r\n    }\r\n  };\r\n\r\n  const handleAnalyzeQuery = async () => {\r\n    if (!userQuery.trim()) {\r\n      toast({\r\n        title: \"Query Required\",\r\n        description: \"Please enter a query to analyze.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsAnalyzing(true);\r\n    setQueryIntent(null);\r\n    setQueryResult(null);\r\n    setShowConfirmation(false);\r\n\r\n    try {\r\n      const response = await fetch('/api/duggu/nl/analyze', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ query: userQuery })\r\n      });\r\n\r\n      if (response.ok) {\r\n        const intent: QueryIntent = await response.json();\r\n        setQueryIntent(intent);\r\n        \r\n        if (intent.isReadOnly) {\r\n          setShowConfirmation(true);\r\n        } else {\r\n          toast({\r\n            title: \"Query Not Allowed\",\r\n            description: \"Only read-only SELECT queries are permitted.\",\r\n            variant: \"destructive\"\r\n          });\r\n        }\r\n      } else {\r\n        const error = await response.json();\r\n        toast({\r\n          title: \"Analysis Failed\",\r\n          description: error.message || \"Failed to analyze query\",\r\n          variant: \"destructive\"\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to analyze query. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsAnalyzing(false);\r\n    }\r\n  };\r\n\r\n  const handleExecuteQuery = async () => {\r\n    if (!queryIntent?.suggestedSQL) return;\r\n\r\n    setIsExecuting(true);\r\n\r\n    try {\r\n      const response = await fetch('/api/duggu/nl/execute', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ \r\n          sql: queryIntent.suggestedSQL,\r\n          userQuery: userQuery \r\n        })\r\n      });\r\n\r\n      if (response.ok) {\r\n        const result: QueryResult = await response.json();\r\n        setQueryResult(result);\r\n        setShowConfirmation(false);\r\n        \r\n        if (result.success) {\r\n          toast({\r\n            title: \"Query Executed\",\r\n            description: `Retrieved ${result.rowCount} rows in ${result.executionTime}ms`,\r\n          });\r\n        } else {\r\n          toast({\r\n            title: \"Execution Failed\",\r\n            description: result.error || \"Query execution failed\",\r\n            variant: \"destructive\"\r\n          });\r\n        }\r\n      } else {\r\n        toast({\r\n          title: \"Error\",\r\n          description: \"Failed to execute query\",\r\n          variant: \"destructive\"\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to execute query. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsExecuting(false);\r\n    }\r\n  };\r\n\r\n  const handleFeedback = async (wasAccurate: boolean) => {\r\n    if (!queryIntent || !userQuery) return;\r\n\r\n    try {\r\n      await fetch('/api/duggu/nl/feedback', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          userQuery,\r\n          generatedSQL: queryIntent.suggestedSQL,\r\n          wasAccurate,\r\n          userFeedback: wasAccurate ? 'Query was accurate' : 'Query needs improvement'\r\n        })\r\n      });\r\n\r\n      toast({\r\n        title: \"Thank You!\",\r\n        description: \"Your feedback helps improve query accuracy.\",\r\n      });\r\n    } catch (error) {\r\n      console.error('Error submitting feedback:', error);\r\n    }\r\n  };\r\n\r\n  const copyToClipboard = (text: string) => {\r\n    navigator.clipboard.writeText(text);\r\n    toast({\r\n      title: \"Copied\",\r\n      description: \"Copied to clipboard\",\r\n    });\r\n  };\r\n\r\n  const downloadResults = () => {\r\n    if (!queryResult?.data) return;\r\n\r\n    const csvContent = convertToCSV(queryResult.data);\r\n    const blob = new Blob([csvContent], { type: 'text/csv' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = `query_results_${Date.now()}.csv`;\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n  };\r\n\r\n  const convertToCSV = (data: any[]): string => {\r\n    if (data.length === 0) return '';\r\n    \r\n    const headers = Object.keys(data[0]);\r\n    const rows = data.map(row => \r\n      headers.map(header => {\r\n        const value = row[header];\r\n        const stringValue = value === null || value === undefined ? '' : String(value);\r\n        return stringValue.includes(',') || stringValue.includes('\"') \r\n          ? `\"${stringValue.replace(/\"/g, '\"\"')}\"` \r\n          : stringValue;\r\n      }).join(',')\r\n    );\r\n    \r\n    return [headers.join(','), ...rows].join('\\n');\r\n  };\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-4 max-w-6xl\" data-testid=\"nl-query-interface\">\r\n      <Card className=\"shadow-lg\">\r\n        <CardHeader className=\"bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950 dark:to-indigo-950\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Database className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\r\n            <CardTitle className=\"text-2xl\">Natural Language Database Query</CardTitle>\r\n          </div>\r\n          <CardDescription>\r\n            Ask questions in plain English and Duggu will generate and execute SQL queries for you\r\n          </CardDescription>\r\n        </CardHeader>\r\n        \r\n        <CardContent className=\"p-6 space-y-6\">\r\n          {/* Query Input Section */}\r\n          <div className=\"space-y-3\">\r\n            <label className=\"text-sm font-medium\">Ask a Question</label>\r\n            <Textarea\r\n              value={userQuery}\r\n              onChange={(e) => setUserQuery(e.target.value)}\r\n              placeholder=\"e.g., Show me all pets with vaccinations due this month, or Find contacts from companies in the healthcare industry\"\r\n              className=\"min-h-24 resize-none\"\r\n              data-testid=\"input-query\"\r\n            />\r\n            \r\n            {/* Suggestions */}\r\n            {suggestions.length > 0 && !userQuery && (\r\n              <div className=\"space-y-2\">\r\n                <p className=\"text-xs text-muted-foreground\">Try these examples:</p>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {suggestions.slice(0, 5).map((suggestion, idx) => (\r\n                    <Badge\r\n                      key={idx}\r\n                      variant=\"outline\"\r\n                      className=\"cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-950\"\r\n                      onClick={() => setUserQuery(suggestion)}\r\n                      data-testid={`suggestion-${idx}`}\r\n                    >\r\n                      {suggestion}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n            \r\n            <Button\r\n              onClick={handleAnalyzeQuery}\r\n              disabled={isAnalyzing || !userQuery.trim()}\r\n              className=\"w-full sm:w-auto\"\r\n              data-testid=\"button-analyze\"\r\n            >\r\n              {isAnalyzing ? (\r\n                <>\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                  Analyzing...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Sparkles className=\"w-4 h-4 mr-2\" />\r\n                  Analyze Query\r\n                </>\r\n              )}\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Query Intent Confirmation */}\r\n          {queryIntent && showConfirmation && (\r\n            <Card className=\"border-2 border-blue-200 dark:border-blue-800\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                  <AlertCircle className=\"w-5 h-5 text-blue-600\" />\r\n                  {queryIntent.isAmbiguous ? \"I need more information\" : \"Query Understanding\"}\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                {/* User-friendly Intent */}\r\n                {queryIntent.userFriendlyIntent && (\r\n                  <Alert className=\"bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\">\r\n                    <Sparkles className=\"h-4 w-4 text-blue-600\" />\r\n                    <AlertDescription className=\"text-blue-900 dark:text-blue-100\">\r\n                      {queryIntent.userFriendlyIntent}\r\n                    </AlertDescription>\r\n                  </Alert>\r\n                )}\r\n                \r\n                {/* Clarifying Questions if Ambiguous */}\r\n                {queryIntent.isAmbiguous && queryIntent.clarifyingQuestions && queryIntent.clarifyingQuestions.length > 0 && (\r\n                  <div className=\"space-y-2\">\r\n                    <p className=\"text-sm font-medium\">To help you better, please clarify:</p>\r\n                    <ul className=\"list-disc list-inside space-y-1\">\r\n                      {queryIntent.clarifyingQuestions.map((question, idx) => (\r\n                        <li key={idx} className=\"text-sm text-muted-foreground\">\r\n                          {question}\r\n                        </li>\r\n                      ))}\r\n                    </ul>\r\n                    <Alert variant=\"default\" className=\"mt-3\">\r\n                      <AlertCircle className=\"h-4 w-4\" />\r\n                      <AlertDescription>\r\n                        Please refine your question with more details and try again.\r\n                      </AlertDescription>\r\n                    </Alert>\r\n                  </div>\r\n                )}\r\n                \r\n                {/* Show SQL only if not ambiguous */}\r\n                {!queryIntent.isAmbiguous && (\r\n                  <>\r\n                    <div>\r\n                      <p className=\"text-sm font-medium mb-1\">Technical explanation:</p>\r\n                      <p className=\"text-sm text-muted-foreground\">{queryIntent.explanation}</p>\r\n                    </div>\r\n                    \r\n                    <div>\r\n                      <div className=\"flex items-center justify-between mb-2\">\r\n                        <p className=\"text-sm font-medium\">Generated SQL:</p>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={() => copyToClipboard(queryIntent.suggestedSQL)}\r\n                          data-testid=\"button-copy-sql\"\r\n                        >\r\n                          <Copy className=\"w-3 h-3 mr-1\" />\r\n                          Copy\r\n                        </Button>\r\n                      </div>\r\n                      <pre className=\"bg-slate-100 dark:bg-slate-900 p-3 rounded text-xs overflow-x-auto\">\r\n                        <code>{queryIntent.suggestedSQL}</code>\r\n                      </pre>\r\n                    </div>\r\n                  </>\r\n                )}\r\n                \r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  <Badge variant=\"secondary\">\r\n                    Confidence: {queryIntent.confidence}%\r\n                  </Badge>\r\n                  <Badge variant=\"secondary\">\r\n                    Tables: {queryIntent.tablesInvolved.join(', ')}\r\n                  </Badge>\r\n                  {queryIntent.isReadOnly && (\r\n                    <Badge variant=\"default\" className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\">\r\n                      <CheckCircle className=\"w-3 h-3 mr-1\" />\r\n                      Read-Only\r\n                    </Badge>\r\n                  )}\r\n                </div>\r\n                \r\n                <Alert>\r\n                  <AlertCircle className=\"h-4 w-4\" />\r\n                  <AlertDescription>\r\n                    This query will only read data from your database. No modifications will be made.\r\n                  </AlertDescription>\r\n                </Alert>\r\n                \r\n                <div className=\"flex gap-2\">\r\n                  <Button\r\n                    onClick={handleExecuteQuery}\r\n                    disabled={isExecuting}\r\n                    className=\"flex-1\"\r\n                    data-testid=\"button-execute\"\r\n                  >\r\n                    {isExecuting ? (\r\n                      <>\r\n                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                        Executing...\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <Send className=\"w-4 h-4 mr-2\" />\r\n                        Execute Query\r\n                      </>\r\n                    )}\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={() => setShowConfirmation(false)}\r\n                    data-testid=\"button-cancel\"\r\n                  >\r\n                    Cancel\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {/* Query Results */}\r\n          {queryResult && (\r\n            <Card className=\"border-2 border-green-200 dark:border-green-800\">\r\n              <CardHeader>\r\n                <div className=\"flex items-center justify-between\">\r\n                  <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                    {queryResult.success ? (\r\n                      <>\r\n                        <CheckCircle className=\"w-5 h-5 text-green-600\" />\r\n                        Query Results\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <XCircle className=\"w-5 h-5 text-red-600\" />\r\n                        Query Failed\r\n                      </>\r\n                    )}\r\n                  </CardTitle>\r\n                  \r\n                  {queryResult.success && queryResult.data && queryResult.data.length > 0 && (\r\n                    <div className=\"flex gap-2\">\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={downloadResults}\r\n                        data-testid=\"button-download\"\r\n                      >\r\n                        <Download className=\"w-3 h-3 mr-1\" />\r\n                        Download CSV\r\n                      </Button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </CardHeader>\r\n              \r\n              <CardContent className=\"space-y-4\">\r\n                {queryResult.success ? (\r\n                  <>\r\n                    <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\r\n                      <span>Rows: {queryResult.rowCount}</span>\r\n                      <span>Time: {queryResult.executionTime}ms</span>\r\n                    </div>\r\n                    \r\n                    {queryResult.data && queryResult.data.length > 0 ? (\r\n                      <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as 'table' | 'json')}>\r\n                        <TabsList>\r\n                          <TabsTrigger value=\"table\" data-testid=\"tab-table\">\r\n                            <TableIcon className=\"w-4 h-4 mr-1\" />\r\n                            Table\r\n                          </TabsTrigger>\r\n                          <TabsTrigger value=\"json\" data-testid=\"tab-json\">\r\n                            <Code className=\"w-4 h-4 mr-1\" />\r\n                            JSON\r\n                          </TabsTrigger>\r\n                        </TabsList>\r\n                        \r\n                        <TabsContent value=\"table\">\r\n                          <ScrollArea className=\"h-96 w-full border rounded\">\r\n                            <div className=\"overflow-x-auto\">\r\n                              <table className=\"w-full text-sm\" data-testid=\"results-table\">\r\n                                <thead className=\"bg-slate-100 dark:bg-slate-900 sticky top-0\">\r\n                                  <tr>\r\n                                    {Object.keys(queryResult.data[0]).map((key) => (\r\n                                      <th key={key} className=\"px-4 py-2 text-left font-medium border-b\">\r\n                                        {key}\r\n                                      </th>\r\n                                    ))}\r\n                                  </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                  {queryResult.data.map((row, idx) => (\r\n                                    <tr key={idx} className=\"border-b hover:bg-slate-50 dark:hover:bg-slate-900\">\r\n                                      {Object.values(row).map((value: any, cellIdx) => (\r\n                                        <td key={cellIdx} className=\"px-4 py-2\">\r\n                                          {value === null || value === undefined \r\n                                            ? <span className=\"text-muted-foreground italic\">null</span>\r\n                                            : typeof value === 'object'\r\n                                            ? JSON.stringify(value)\r\n                                            : String(value)\r\n                                          }\r\n                                        </td>\r\n                                      ))}\r\n                                    </tr>\r\n                                  ))}\r\n                                </tbody>\r\n                              </table>\r\n                            </div>\r\n                          </ScrollArea>\r\n                        </TabsContent>\r\n                        \r\n                        <TabsContent value=\"json\">\r\n                          <ScrollArea className=\"h-96\">\r\n                            <pre className=\"bg-slate-100 dark:bg-slate-900 p-4 rounded text-xs\">\r\n                              <code>{JSON.stringify(queryResult.data, null, 2)}</code>\r\n                            </pre>\r\n                          </ScrollArea>\r\n                        </TabsContent>\r\n                      </Tabs>\r\n                    ) : (\r\n                      <Alert>\r\n                        <AlertDescription>No results found.</AlertDescription>\r\n                      </Alert>\r\n                    )}\r\n                    \r\n                    {/* Feedback Section */}\r\n                    <div className=\"border-t pt-4\">\r\n                      <p className=\"text-sm font-medium mb-2\">Was this query accurate?</p>\r\n                      <div className=\"flex gap-2\">\r\n                        <Button\r\n                          variant=\"outline\"\r\n                          size=\"sm\"\r\n                          onClick={() => handleFeedback(true)}\r\n                          data-testid=\"button-feedback-yes\"\r\n                        >\r\n                          <ThumbsUp className=\"w-4 h-4 mr-1\" />\r\n                          Yes\r\n                        </Button>\r\n                        <Button\r\n                          variant=\"outline\"\r\n                          size=\"sm\"\r\n                          onClick={() => handleFeedback(false)}\r\n                          data-testid=\"button-feedback-no\"\r\n                        >\r\n                          <ThumbsDown className=\"w-4 h-4 mr-1\" />\r\n                          No\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n                  </>\r\n                ) : (\r\n                  <Alert variant=\"destructive\">\r\n                    <AlertCircle className=\"h-4 w-4\" />\r\n                    <AlertDescription>\r\n                      {queryResult.error || 'An error occurred while executing the query'}\r\n                    </AlertDescription>\r\n                  </Alert>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\SEO.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\admin\\AdminSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\campaign-community.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'CampaignCommunity' has a complexity of 23. Maximum allowed is 15.","line":37,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":37,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useRef, useEffect, useCallback } from \"react\";\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { MessageSquare, Send, User, Shield, Wifi, Paperclip } from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\n\r\ninterface Message {\r\n  id: string;\r\n  conversationId: string;\r\n  senderType: 'user' | 'admin';\r\n  senderId: string;\r\n  messageType: 'text';\r\n  content: string;\r\n  attachmentUrl?: string | null;\r\n  attachmentName?: string | null;\r\n  attachmentSize?: number | null;\r\n  isRead: boolean;\r\n  createdAt: string;\r\n  readAt?: string | null;\r\n}\r\n\r\ninterface Conversation {\r\n  id: string;\r\n  userId: string;\r\n  title: string;\r\n  isActive: boolean;\r\n  unreadCount: number;\r\n  adminUnreadCount: number;\r\n  lastMessageAt?: string | null;\r\n  createdAt: string;\r\n  updatedAt?: string | null;\r\n}\r\n\r\nexport default function CampaignCommunity() {\r\n  const [messageContent, setMessageContent] = useState(\"\");\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\r\n  const [isUserScrolling, setIsUserScrolling] = useState(false);\r\n  const [shouldAutoScroll, setShouldAutoScroll] = useState(true);\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  // Get or create conversation\r\n  const { data: conversation, isLoading: conversationLoading, error: conversationError } = useQuery<Conversation>({\r\n    queryKey: ['/api/user/conversation'],\r\n    retry: 2,\r\n  });\r\n\r\n  // Get messages\r\n  const { data: messages = [], isLoading: messagesLoading, error: messagesError } = useQuery<Message[]>({\r\n    queryKey: ['/api/user/messages'],\r\n    refetchInterval: 5000,\r\n    enabled: !!conversation && !conversationError,\r\n    retry: 2,\r\n  });\r\n\r\n  // Handle file upload\r\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = event.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    const formData = new FormData();\r\n    formData.append('file', file);\r\n\r\n    setIsUploading(true);\r\n    try {\r\n      const response = await apiRequest('POST', '/api/user/messages/upload', formData);\r\n      const data = await response.json();\r\n      \r\n      toast({\r\n        title: \"File Shared\",\r\n        description: `Successfully shared ${file.name}`,\r\n      });\r\n      \r\n      queryClient.invalidateQueries({ queryKey: ['/api/user/messages'] });\r\n      queryClient.invalidateQueries({ queryKey: ['/api/user/conversation'] });\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Upload Failed\",\r\n        description: error.message || \"Failed to upload file\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsUploading(false);\r\n      if (fileInputRef.current) fileInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  const handleDownload = async (url: string, filename: string) => {\r\n    try {\r\n      window.open(url, '_blank');\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Download Failed\",\r\n        description: \"Failed to open file\",\r\n        variant: \"destructive\"\r\n      });\r\n    }\r\n  };\r\n\r\n  // Check if user is near bottom of scroll area\r\n  const isNearBottom = useCallback(() => {\r\n    if (!messagesContainerRef.current) return true;\r\n    const { scrollTop, scrollHeight, clientHeight } = messagesContainerRef.current;\r\n    return scrollHeight - scrollTop - clientHeight < 100;\r\n  }, []);\r\n\r\n  // Handle scroll events\r\n  const handleScroll = useCallback(() => {\r\n    if (!messagesContainerRef.current) return;\r\n    \r\n    const nearBottom = isNearBottom();\r\n    setShouldAutoScroll(nearBottom);\r\n    \r\n    if (!isUserScrolling) {\r\n      setIsUserScrolling(true);\r\n      setTimeout(() => setIsUserScrolling(false), 1000);\r\n    }\r\n  }, [isNearBottom, isUserScrolling]);\r\n\r\n  // Auto-scroll to bottom when new messages arrive\r\n  useEffect(() => {\r\n    if (shouldAutoScroll && !isUserScrolling) {\r\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    }\r\n  }, [messages, shouldAutoScroll, isUserScrolling]);\r\n\r\n  // Mark admin messages as read when viewing\r\n  useEffect(() => {\r\n    const unreadAdminMessages = messages.filter(\r\n      msg => msg.senderType === 'admin' && !msg.isRead\r\n    );\r\n\r\n    if (unreadAdminMessages.length > 0) {\r\n      apiRequest('PATCH', '/api/user/messages/mark-read', {})\r\n        .then(() => {\r\n          queryClient.invalidateQueries({ queryKey: ['/api/user/messages'] });\r\n          queryClient.invalidateQueries({ queryKey: ['/api/user/conversation'] });\r\n        })\r\n        .catch(err => console.error('Failed to mark messages as read:', err));\r\n    }\r\n  }, [messages, queryClient]);\r\n\r\n  // Send message mutation\r\n  const sendMessageMutation = useMutation({\r\n    mutationFn: async (content: string) => {\r\n      const response = await apiRequest('POST', '/api/user/messages', { content });\r\n      return response.json();\r\n    },\r\n    onSuccess: () => {\r\n      setMessageContent(\"\");\r\n      queryClient.invalidateQueries({ queryKey: ['/api/user/messages'] });\r\n      queryClient.invalidateQueries({ queryKey: ['/api/user/conversation'] });\r\n    },\r\n    onError: (error) => {\r\n      toast({\r\n        title: \"Send Failed\",\r\n        description: error.message || \"Failed to send message\",\r\n        variant: \"destructive\"\r\n      });\r\n    }\r\n  });\r\n\r\n  const handleSendMessage = () => {\r\n    if (conversationError) {\r\n      toast({\r\n        title: \"Connection Error\",\r\n        description: \"Failed to connect to support chat. Please refresh the page.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return;\r\n    }\r\n    \r\n    if (!messageContent.trim()) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Please enter a message before sending\",\r\n        variant: \"destructive\"\r\n      });\r\n      return;\r\n    }\r\n    sendMessageMutation.mutate(messageContent);\r\n  };\r\n\r\n  const isLoading = conversationLoading || messagesLoading;\r\n  const hasError = Boolean(conversationError || messagesError);\n\r\n  const formatTime = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    const today = new Date();\r\n    const yesterday = new Date(today);\r\n    yesterday.setDate(yesterday.getDate() - 1);\r\n\r\n    const isToday = date.toDateString() === today.toDateString();\r\n    const isYesterday = date.toDateString() === yesterday.toDateString();\r\n\r\n    if (isToday) {\r\n      return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });\r\n    } else if (isYesterday) {\r\n      return 'Yesterday ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });\r\n    } else {\r\n      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + \r\n             ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-[calc(100vh-160px)] bg-white rounded-lg border\">\r\n      {/* Chat Header */}\r\n      <div className=\"flex items-center justify-between p-4 border-b bg-gradient-to-r from-purple-50 to-blue-50 rounded-t-lg\">\r\n        <div className=\"flex items-center space-x-3\">\r\n          <Avatar className=\"h-10 w-10\">\r\n            <AvatarFallback className=\"bg-gradient-to-br from-purple-600 to-blue-600 text-white\">\r\n              <MessageSquare className=\"h-5 w-5\" />\r\n            </AvatarFallback>\r\n          </Avatar>\r\n          <div>\r\n            <h3 className=\"font-semibold text-slate-900\">Campaign Community</h3>\r\n            <p className=\"text-sm text-slate-600\">\r\n              {isLoading ? (\r\n                \"Loading...\"\r\n              ) : (\r\n                <>\r\n                  Chat with support team\r\n                  {conversation && conversation.unreadCount > 0 && (\r\n                    <span className=\"ml-2 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full\">\r\n                      {conversation.unreadCount} new\r\n                    </span>\r\n                  )}\r\n                </>\r\n              )}\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <div className=\"flex items-center space-x-2\">\r\n          <div className=\"flex items-center space-x-1 text-xs\">\r\n            <Wifi className=\"h-3 w-3 text-green-500\" />\r\n            <span className=\"text-green-600 font-medium\">Online</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Error Banner */}\r\n      {hasError && (\r\n        <div className=\"px-4 py-3 bg-red-50 border-b border-red-200\">\r\n          <div className=\"flex items-center space-x-2 text-red-800\">\r\n            <svg className=\"h-5 w-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n              <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clipRule=\"evenodd\" />\r\n            </svg>\r\n            <div className=\"flex-1\">\r\n              <p className=\"font-medium text-sm\">Connection Error</p>\r\n              <p className=\"text-xs\">Failed to connect to support chat. Please refresh the page and try again.</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Messages Area */}\r\n      <div \r\n        ref={messagesContainerRef}\r\n        className=\"flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50\"\r\n        onScroll={handleScroll}\r\n      >\r\n        {messages.length === 0 ? (\r\n          <div className=\"flex flex-col items-center justify-center h-full text-center\">\r\n            <div className=\"w-16 h-16 bg-gradient-to-br from-purple-100 to-blue-100 rounded-full flex items-center justify-center mb-4\">\r\n              <MessageSquare className=\"h-8 w-8 text-purple-600\" />\r\n            </div>\r\n            <h3 className=\"font-medium text-slate-900 mb-2\">\r\n              {hasError ? 'Unable to Load Chat' : 'Start a conversation'}\r\n            </h3>\r\n            <p className=\"text-slate-500 text-sm max-w-md\">\r\n              {hasError \r\n                ? 'There was an error loading the chat. Please refresh the page to try again.'\r\n                : 'Send a message to connect with our support team. We\\'re here to help with your campaigns!'\r\n              }\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          messages.map((message) => (\r\n            <div\r\n              key={message.id}\r\n              className={`flex items-end space-x-2 ${\r\n                message.senderType === 'user' ? 'flex-row-reverse space-x-reverse' : 'flex-row'\r\n              }`}\r\n            >\r\n              <Avatar className=\"h-8 w-8 mb-1\">\r\n                <AvatarFallback className={\r\n                  message.senderType === 'admin'\r\n                    ? \"bg-gradient-to-br from-purple-600 to-blue-600 text-white\"\r\n                    : \"bg-blue-100 text-blue-600\"\r\n                }>\r\n                  {message.senderType === 'admin' ? (\r\n                    <Shield className=\"h-4 w-4\" />\r\n                  ) : (\r\n                    <User className=\"h-4 w-4\" />\r\n                  )}\r\n                </AvatarFallback>\r\n              </Avatar>\r\n              <div\r\n                className={`flex flex-col max-w-[70%] ${\r\n                  message.senderType === 'user' ? 'items-end' : 'items-start'\r\n                }`}\r\n              >\r\n                <div\r\n                  className={`rounded-2xl px-4 py-2 ${\r\n                    message.senderType === 'user'\r\n                      ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white'\r\n                      : 'bg-white border border-slate-200 text-slate-900'\r\n                  }`}\r\n                >\r\n                  {message.attachmentUrl ? (\r\n                    <div className=\"flex flex-col space-y-2\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <div className=\"p-2 bg-white/20 rounded\">\r\n                          <Paperclip className=\"h-4 w-4\" />\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <p className=\"text-sm font-medium truncate\">{message.attachmentName}</p>\r\n                          <p className=\"text-xs opacity-70\">\r\n                            {message.attachmentSize ? (message.attachmentSize / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown size'}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"secondary\"\r\n                        className=\"w-full text-xs h-7\"\r\n                        onClick={() => handleDownload(message.attachmentUrl!, message.attachmentName!)}\r\n                      >\r\n                        Download\r\n                      </Button>\r\n                      {message.content && <p className=\"text-sm mt-2\">{message.content}</p>}\r\n                    </div>\r\n                  ) : (\r\n                    <p className=\"text-sm whitespace-pre-wrap break-words\">{message.content}</p>\r\n                  )}\r\n                </div>\r\n                <p className=\"text-xs text-slate-500 mt-1 px-1\">\r\n                  {formatTime(message.createdAt)}\r\n                  {message.senderType === 'admin' && message.isRead && (\r\n                    <span className=\"ml-1 text-blue-500\">â€¢ Read</span>\r\n                  )}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          ))\r\n        )}\r\n        \r\n        <div ref={messagesEndRef} />\r\n      </div>\r\n\r\n      {/* Message Input */}\r\n      <div className=\"border-t p-4 bg-white rounded-b-lg\">\r\n        <div className=\"flex items-end space-x-2\">\r\n          <input\r\n            type=\"file\"\r\n            ref={fileInputRef}\r\n            onChange={handleFileUpload}\r\n            className=\"hidden\"\r\n          />\r\n          <Button\r\n            type=\"button\"\r\n            size=\"sm\"\r\n            variant=\"outline\"\r\n            className=\"h-10 w-10 p-0 shrink-0\"\r\n            onClick={() => fileInputRef.current?.click()}\r\n            disabled={hasError || !conversation || isUploading}\r\n          >\r\n            {isUploading ? (\r\n              <div className=\"animate-spin h-4 w-4 border-2 border-purple-600 border-t-transparent rounded-full\" />\r\n            ) : (\r\n              <Paperclip className=\"h-4 w-4\" />\r\n            )}\r\n          </Button>\r\n          <div className=\"flex-1 relative\">\r\n            <Textarea\r\n              placeholder={hasError ? \"Chat unavailable\" : !conversation ? \"Connecting...\" : \"Type your message...\"}\r\n              value={messageContent}\r\n              onChange={(e) => setMessageContent(e.target.value)}\r\n              disabled={hasError || !conversation || sendMessageMutation.isPending}\r\n              className=\"resize-none pr-12 min-h-[60px] max-h-32 border-slate-300 focus:border-purple-500 focus:ring-purple-500 disabled:opacity-50\"\r\n              onKeyDown={(e) => {\r\n                if (e.key === 'Enter' && !e.shiftKey && conversation && !hasError) {\r\n                  e.preventDefault();\r\n                  handleSendMessage();\r\n                }\r\n              }}\r\n            />\r\n            <Button\r\n              onClick={handleSendMessage}\r\n              disabled={!conversation || !messageContent.trim() || sendMessageMutation.isPending || hasError}\r\n              size=\"sm\"\r\n              className=\"absolute right-2 bottom-2 h-8 w-8 p-0 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:opacity-50\"\r\n            >\r\n              {sendMessageMutation.isPending ? (\r\n                <div className=\"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full\" />\r\n              ) : (\r\n                <Send className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n        <p className=\"text-xs text-slate-500 mt-2\">Press Enter to send, Shift+Enter for new line</p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\campaign-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\campaign-table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\chatbot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\contact-canvas.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\contact-cards.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 19. Maximum allowed is 15.","line":87,"column":85,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":87,"endColumn":87}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport { \r\n  Mail, \r\n  Phone, \r\n  MapPin, \r\n  Building2, \r\n  User, \r\n  Star, \r\n  Copy, \r\n  ExternalLink,\r\n  Grid3X3,\r\n  List,\r\n  Filter,\r\n  Download,\r\n  Search\r\n} from 'lucide-react';\r\n\r\ninterface ContactData {\r\n  name?: string;\r\n  email?: string;\r\n  phone?: string;\r\n  mobile?: string;\r\n  company?: string;\r\n  title?: string;\r\n  location?: string;\r\n  industry?: string;\r\n  website?: string;\r\n  linkedin?: string;\r\n  score?: number;\r\n  emailSent?: boolean;\r\n  [key: string]: any;\r\n}\r\n\r\ninterface ContactCardsProps {\r\n  contacts: ContactData[];\r\n  campaignName?: string;\r\n  showActions?: boolean;\r\n  className?: string;\r\n}\r\n\r\nexport function ContactCards({ contacts, campaignName, showActions = true, className = \"\" }: ContactCardsProps) {\r\n  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');\r\n  const [sortBy, setSortBy] = useState<'name' | 'company' | 'score'>('name');\r\n  const [filterBy, setFilterBy] = useState<'all' | 'contacted' | 'new'>('all');\r\n\r\n  const getInitials = (name: string = 'Unknown') => {\r\n    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\r\n  };\r\n\r\n  const getScoreColor = (score?: number) => {\r\n    if (!score) return 'bg-gray-500';\r\n    if (score >= 80) return 'bg-green-500';\r\n    if (score >= 60) return 'bg-yellow-500';\r\n    return 'bg-red-500';\r\n  };\r\n\r\n  const filteredContacts = contacts.filter(contact => {\r\n    if (filterBy === 'contacted') return contact.emailSent;\r\n    if (filterBy === 'new') return !contact.emailSent;\r\n    return true;\r\n  });\r\n\r\n  const sortedContacts = [...filteredContacts].sort((a, b) => {\r\n    switch (sortBy) {\r\n      case 'name':\r\n        return (a.name || '').localeCompare(b.name || '');\r\n      case 'company':\r\n        return (a.company || '').localeCompare(b.company || '');\r\n      case 'score':\r\n        return (b.score || 0) - (a.score || 0);\r\n      default:\r\n        return 0;\r\n    }\r\n  });\r\n\r\n  const copyToClipboard = (text: string) => {\r\n    navigator.clipboard.writeText(text);\r\n  };\r\n\r\n  const ContactCard = ({ contact, index }: { contact: ContactData; index: number }) => (\r\n    <Card className=\"hover:shadow-lg transition-all duration-200 border-l-4 border-l-blue-500\" data-testid={`card-contact-${index}`}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <div className=\"flex items-center space-x-3\">\r\n            <Avatar className=\"h-12 w-12\">\r\n              <AvatarFallback className=\"bg-gradient-to-br from-blue-500 to-purple-600 text-white font-semibold\">\r\n                {getInitials(contact.name)}\r\n              </AvatarFallback>\r\n            </Avatar>\r\n            <div className=\"flex-1 min-w-0\">\r\n              <CardTitle className=\"text-lg font-semibold text-gray-900 dark:text-gray-100 truncate\">\r\n                {contact.name || 'Unknown Name'}\r\n              </CardTitle>\r\n              {contact.title && (\r\n                <p className=\"text-sm text-gray-600 dark:text-gray-400 truncate\">\r\n                  {contact.title}\r\n                </p>\r\n              )}\r\n              {contact.company && (\r\n                <div className=\"flex items-center text-sm text-gray-500 dark:text-gray-500 mt-1\">\r\n                  <Building2 className=\"w-3 h-3 mr-1\" />\r\n                  <span className=\"truncate\">{contact.company}</span>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n          <div className=\"flex flex-col items-end space-y-2\">\r\n            {contact.score && (\r\n              <Badge className={`${getScoreColor(contact.score)} text-white`}>\r\n                <Star className=\"w-3 h-3 mr-1\" />\r\n                {contact.score}\r\n              </Badge>\r\n            )}\r\n            <Badge variant={contact.emailSent ? \"default\" : \"secondary\"}>\r\n              {contact.emailSent ? \"Contacted\" : \"New\"}\r\n            </Badge>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      \r\n      <CardContent className=\"pt-0\">\r\n        <div className=\"space-y-3\">\r\n          {/* Contact Information */}\r\n          <div className=\"grid grid-cols-1 gap-2\">\r\n            {contact.email && (\r\n              <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-400\">\r\n                <Mail className=\"w-4 h-4 mr-2 text-gray-400\" />\r\n                <span className=\"flex-1 truncate\">{contact.email}</span>\r\n                {showActions && (\r\n                  <Button \r\n                    size=\"sm\" \r\n                    variant=\"ghost\" \r\n                    onClick={() => copyToClipboard(contact.email || '')}\r\n                    className=\"h-6 w-6 p-0\"\r\n                    data-testid={`button-copy-email-${index}`}\r\n                  >\r\n                    <Copy className=\"w-3 h-3\" />\r\n                  </Button>\r\n                )}\r\n              </div>\r\n            )}\r\n            \r\n            {(contact.phone || contact.mobile) && (\r\n              <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-400\">\r\n                <Phone className=\"w-4 h-4 mr-2 text-gray-400\" />\r\n                <span className=\"flex-1 truncate\">{contact.phone || contact.mobile}</span>\r\n                {showActions && (\r\n                  <Button \r\n                    size=\"sm\" \r\n                    variant=\"ghost\" \r\n                    onClick={() => copyToClipboard((contact.phone || contact.mobile) || '')}\r\n                    className=\"h-6 w-6 p-0\"\r\n                    data-testid={`button-copy-phone-${index}`}\r\n                  >\r\n                    <Copy className=\"w-3 h-3\" />\r\n                  </Button>\r\n                )}\r\n              </div>\r\n            )}\r\n\r\n            {contact.location && (\r\n              <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-400\">\r\n                <MapPin className=\"w-4 h-4 mr-2 text-gray-400\" />\r\n                <span className=\"flex-1 truncate\">{contact.location}</span>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Additional Information */}\r\n          {(contact.industry || contact.website) && (\r\n            <div className=\"pt-2 border-t border-gray-100 dark:border-gray-700\">\r\n              <div className=\"flex flex-wrap gap-2 text-xs\">\r\n                {contact.industry && (\r\n                  <Badge variant=\"outline\" className=\"bg-gray-50 dark:bg-gray-800\">\r\n                    {contact.industry}\r\n                  </Badge>\r\n                )}\r\n                {contact.website && (\r\n                  <Button \r\n                    size=\"sm\" \r\n                    variant=\"outline\" \r\n                    className=\"h-6 text-xs\"\r\n                    onClick={() => window.open(contact.website, '_blank')}\r\n                    data-testid={`button-website-${index}`}\r\n                  >\r\n                    <ExternalLink className=\"w-3 h-3 mr-1\" />\r\n                    Website\r\n                  </Button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Action Buttons */}\r\n          {showActions && (\r\n            <div className=\"flex space-x-2 pt-2\">\r\n              <Button size=\"sm\" variant=\"outline\" className=\"flex-1\" data-testid={`button-contact-${index}`}>\r\n                <Mail className=\"w-3 h-3 mr-1\" />\r\n                Contact\r\n              </Button>\r\n              <Button size=\"sm\" variant=\"outline\" className=\"flex-1\" data-testid={`button-profile-${index}`}>\r\n                <User className=\"w-3 h-3 mr-1\" />\r\n                View Profile\r\n              </Button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n\r\n  const ContactListItem = ({ contact, index }: { contact: ContactData; index: number }) => (\r\n    <div className=\"flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\" data-testid={`row-contact-${index}`}>\r\n      <div className=\"flex items-center space-x-4 flex-1 min-w-0\">\r\n        <Avatar className=\"h-10 w-10\">\r\n          <AvatarFallback className=\"bg-gradient-to-br from-blue-500 to-purple-600 text-white font-semibold\">\r\n            {getInitials(contact.name)}\r\n          </AvatarFallback>\r\n        </Avatar>\r\n        \r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex items-center space-x-2\">\r\n            <h4 className=\"font-medium text-gray-900 dark:text-gray-100 truncate\">\r\n              {contact.name || 'Unknown Name'}\r\n            </h4>\r\n            {contact.score && (\r\n              <Badge className={`${getScoreColor(contact.score)} text-white text-xs`}>\r\n                {contact.score}\r\n              </Badge>\r\n            )}\r\n          </div>\r\n          <div className=\"flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400 mt-1\">\r\n            {contact.company && (\r\n              <span className=\"flex items-center\">\r\n                <Building2 className=\"w-3 h-3 mr-1\" />\r\n                {contact.company}\r\n              </span>\r\n            )}\r\n            {contact.email && (\r\n              <span className=\"flex items-center\">\r\n                <Mail className=\"w-3 h-3 mr-1\" />\r\n                {contact.email}\r\n              </span>\r\n            )}\r\n            {(contact.phone || contact.mobile) && (\r\n              <span className=\"flex items-center\">\r\n                <Phone className=\"w-3 h-3 mr-1\" />\r\n                {contact.phone || contact.mobile}\r\n              </span>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      <div className=\"flex items-center space-x-2\">\r\n        <Badge variant={contact.emailSent ? \"default\" : \"secondary\"}>\r\n          {contact.emailSent ? \"Contacted\" : \"New\"}\r\n        </Badge>\r\n        {showActions && (\r\n          <div className=\"flex space-x-1\">\r\n            <Button size=\"sm\" variant=\"ghost\" className=\"h-8 w-8 p-0\" data-testid={`button-contact-list-${index}`}>\r\n              <Mail className=\"w-3 h-3\" />\r\n            </Button>\r\n            <Button size=\"sm\" variant=\"ghost\" className=\"h-8 w-8 p-0\" data-testid={`button-profile-list-${index}`}>\r\n              <User className=\"w-3 h-3\" />\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  if (contacts.length === 0) {\r\n    return (\r\n      <Card className={`p-8 text-center ${className}`}>\r\n        <div className=\"flex flex-col items-center space-y-3\">\r\n          <Search className=\"w-12 h-12 text-gray-400\" />\r\n          <h3 className=\"text-lg font-medium text-gray-900 dark:text-gray-100\">No contacts found</h3>\r\n          <p className=\"text-gray-500 dark:text-gray-400\">Try adjusting your search criteria</p>\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className={`space-y-4 ${className}`}>\r\n      {/* Header with campaign name and stats */}\r\n      {campaignName && (\r\n        <div className=\"flex items-center justify-between bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950 dark:to-purple-950 p-4 rounded-lg border\">\r\n          <div>\r\n            <h2 className=\"text-xl font-semibold text-gray-900 dark:text-gray-100\">\r\n              {campaignName}\r\n            </h2>\r\n            <p className=\"text-sm text-gray-600 dark:text-gray-400\">\r\n              {sortedContacts.length} contacts found\r\n            </p>\r\n          </div>\r\n          <div className=\"flex space-x-2\">\r\n            <Button size=\"sm\" variant=\"outline\" data-testid=\"button-export\">\r\n              <Download className=\"w-4 h-4 mr-1\" />\r\n              Export\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Controls */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0 bg-white dark:bg-gray-800 p-4 rounded-lg border\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div className=\"flex items-center space-x-2\">\r\n            <span className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">View:</span>\r\n            <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as 'grid' | 'list')}>\r\n              <TabsList className=\"h-8\">\r\n                <TabsTrigger value=\"grid\" className=\"h-6 px-2\" data-testid=\"tab-grid\">\r\n                  <Grid3X3 className=\"w-3 h-3\" />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"list\" className=\"h-6 px-2\" data-testid=\"tab-list\">\r\n                  <List className=\"w-3 h-3\" />\r\n                </TabsTrigger>\r\n              </TabsList>\r\n            </Tabs>\r\n          </div>\r\n\r\n          <div className=\"flex items-center space-x-2\">\r\n            <Filter className=\"w-4 h-4 text-gray-400\" />\r\n            <Select value={filterBy} onValueChange={(v) => setFilterBy(v as any)}>\r\n              <SelectTrigger className=\"h-8 w-32\">\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Contacts</SelectItem>\r\n                <SelectItem value=\"new\">New</SelectItem>\r\n                <SelectItem value=\"contacted\">Contacted</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center space-x-2\">\r\n          <span className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">Sort by:</span>\r\n          <Select value={sortBy} onValueChange={(v) => setSortBy(v as any)}>\r\n            <SelectTrigger className=\"h-8 w-28\">\r\n              <SelectValue />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"name\">Name</SelectItem>\r\n              <SelectItem value=\"company\">Company</SelectItem>\r\n              <SelectItem value=\"score\">Score</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Contact Display */}\r\n      <div className=\"space-y-4\">\r\n        {viewMode === 'grid' ? (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {sortedContacts.map((contact, index) => (\r\n              <ContactCard key={index} contact={contact} index={index} />\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <Card className=\"overflow-hidden\">\r\n            <ScrollArea className=\"max-h-96\">\r\n              <div className=\"divide-y divide-gray-100 dark:divide-gray-700\">\r\n                {sortedContacts.map((contact, index) => (\r\n                  <ContactListItem key={index} contact={contact} index={index} />\r\n                ))}\r\n              </div>\r\n            </ScrollArea>\r\n          </Card>\r\n        )}\r\n      </div>\r\n\r\n      {/* Summary Stats */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n        <Card className=\"p-4 text-center\">\r\n          <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\r\n            {sortedContacts.length}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">Total Contacts</div>\r\n        </Card>\r\n        \r\n        <Card className=\"p-4 text-center\">\r\n          <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\r\n            {sortedContacts.filter(c => c.emailSent).length}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">Contacted</div>\r\n        </Card>\r\n        \r\n        <Card className=\"p-4 text-center\">\r\n          <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\r\n            {sortedContacts.filter(c => c.score && c.score >= 70).length}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">High Score</div>\r\n        </Card>\r\n        \r\n        <Card className=\"p-4 text-center\">\r\n          <div className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\r\n            {Math.round((sortedContacts.reduce((acc, c) => acc + (c.score || 0), 0) / sortedContacts.length) || 0)}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">Avg Score</div>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\csv-field-mapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\csv-upload.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\enhanced-chatbot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\modern-contact-canvas.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 45. Maximum allowed is 15.","line":236,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":236,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { apiRequest } from '@/lib/queryClient';\r\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { \r\n  Mail, \r\n  Phone, \r\n  MapPin, \r\n  Building2, \r\n  User, \r\n  Star, \r\n  Copy, \r\n  ExternalLink,\r\n  Save,\r\n  Download,\r\n  Eye,\r\n  Heart,\r\n  MessageSquare,\r\n  Calendar,\r\n  Award,\r\n  Briefcase,\r\n  Globe\r\n} from 'lucide-react';\r\n\r\ninterface ContactData {\r\n  name?: string;\r\n  email?: string;\r\n  phone?: string;\r\n  mobile?: string;\r\n  company?: string;\r\n  title?: string;\r\n  location?: string;\r\n  industry?: string;\r\n  website?: string;\r\n  linkedin?: string;\r\n  score?: number;\r\n  emailSent?: boolean;\r\n  [key: string]: any;\r\n}\r\n\r\ninterface ModernContactCanvasProps {\r\n  contacts: ContactData[];\r\n  campaignName?: string;\r\n  className?: string;\r\n  onSaveAsCampaign?: (campaignName: string, contacts: ContactData[]) => void;\r\n}\r\n\r\nexport function ModernContactCanvas({ \r\n  contacts, \r\n  campaignName, \r\n  className = \"\",\r\n  onSaveAsCampaign \r\n}: ModernContactCanvasProps) {\r\n  const [selectedContacts, setSelectedContacts] = useState<Set<number>>(new Set());\r\n  const [newCampaignName, setNewCampaignName] = useState('');\r\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  const saveCampaignMutation = useMutation({\r\n    mutationFn: async ({ name, contactsData }: { name: string; contactsData: ContactData[] }) => {\r\n      // Convert contacts to CSV-like format for campaign storage\r\n      const headers = ['name', 'email', 'phone', 'company', 'title', 'location', 'industry', 'linkedin'];\r\n      const rows = contactsData.map(contact => {\r\n        const row: Record<string, string> = {};\r\n        headers.forEach(header => {\r\n          row[header] = String(contact[header] || '');\r\n        });\r\n        return row;\r\n      });\r\n\r\n      return apiRequest('POST', '/api/campaigns/save-search-results', {\r\n        name,\r\n        headers,\r\n        rows,\r\n        recordCount: contactsData.length\r\n      });\r\n    },\r\n    onSuccess: () => {\r\n      toast({\r\n        title: \"Campaign Saved\",\r\n        description: `Successfully saved ${selectedContacts.size > 0 ? selectedContacts.size : contacts.length} contacts to campaign \"${newCampaignName}\"`,\r\n      });\r\n      queryClient.invalidateQueries({ queryKey: ['/api/campaigns'] });\r\n      setIsDialogOpen(false);\r\n      setNewCampaignName('');\r\n      setSelectedContacts(new Set());\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: \"Save Failed\",\r\n        description: error.message || \"Failed to save campaign\",\r\n        variant: \"destructive\"\r\n      });\r\n    }\r\n  });\r\n\r\n  const getInitials = (name: string = 'Unknown') => {\r\n    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\r\n  };\r\n\r\n  const getScoreColor = (score?: number) => {\r\n    if (!score) return 'text-gray-500';\r\n    if (score >= 80) return 'text-green-500';\r\n    if (score >= 60) return 'text-yellow-500';\r\n    return 'text-red-500';\r\n  };\r\n\r\n  const getCompanyInitials = (company?: string) => {\r\n    if (!company) return 'UN';\r\n    return company.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);\r\n  };\r\n\r\n  const copyToClipboard = (text: string, type: string) => {\r\n    navigator.clipboard.writeText(text);\r\n    toast({\r\n      title: \"Copied!\",\r\n      description: `${type} copied to clipboard`,\r\n    });\r\n  };\r\n\r\n  const toggleContactSelection = (index: number) => {\r\n    const newSelected = new Set(selectedContacts);\r\n    if (newSelected.has(index)) {\r\n      newSelected.delete(index);\r\n    } else {\r\n      newSelected.add(index);\r\n    }\r\n    setSelectedContacts(newSelected);\r\n  };\r\n\r\n  const selectAllContacts = () => {\r\n    if (selectedContacts.size === contacts.length) {\r\n      setSelectedContacts(new Set());\r\n    } else {\r\n      setSelectedContacts(new Set(contacts.map((_, index) => index)));\r\n    }\r\n  };\r\n\r\n  const handleSaveCampaign = () => {\r\n    if (!newCampaignName.trim()) {\r\n      toast({\r\n        title: \"Campaign Name Required\",\r\n        description: \"Please enter a name for the campaign\",\r\n        variant: \"destructive\"\r\n      });\r\n      return;\r\n    }\r\n\r\n    const contactsToSave = selectedContacts.size > 0 \r\n      ? contacts.filter((_, index) => selectedContacts.has(index))\r\n      : contacts;\r\n\r\n    saveCampaignMutation.mutate({\r\n      name: newCampaignName.trim(),\r\n      contactsData: contactsToSave\r\n    });\r\n  };\r\n\r\n  return (\r\n    <div className={`space-y-4 ${className}`}>\r\n      {/* Header with Actions */}\r\n      <div className=\"flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950 dark:to-purple-950 rounded-lg border\">\r\n        <div>\r\n          <h3 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">\r\n            {campaignName || 'Contact Results'}\r\n          </h3>\r\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">\r\n            {contacts.length} contacts found\r\n            {selectedContacts.size > 0 && ` â€¢ ${selectedContacts.size} selected`}\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button\r\n            size=\"sm\"\r\n            variant=\"outline\"\r\n            onClick={selectAllContacts}\r\n            data-testid=\"button-select-all\"\r\n          >\r\n            {selectedContacts.size === contacts.length ? 'Deselect All' : 'Select All'}\r\n          </Button>\r\n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\r\n            <DialogTrigger asChild>\r\n              <Button size=\"sm\" data-testid=\"button-save-campaign\">\r\n                <Save className=\"w-4 h-4 mr-1\" />\r\n                Save as Campaign\r\n              </Button>\r\n            </DialogTrigger>\r\n            <DialogContent>\r\n              <DialogHeader>\r\n                <DialogTitle>Save as New Campaign</DialogTitle>\r\n              </DialogHeader>\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"text-sm font-medium\">Campaign Name</label>\r\n                  <Input\r\n                    placeholder=\"Enter campaign name...\"\r\n                    value={newCampaignName}\r\n                    onChange={(e) => setNewCampaignName(e.target.value)}\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n                <div className=\"text-sm text-gray-600\">\r\n                  {selectedContacts.size > 0 \r\n                    ? `${selectedContacts.size} selected contacts will be saved`\r\n                    : `All ${contacts.length} contacts will be saved`\r\n                  }\r\n                </div>\r\n                <div className=\"flex justify-end gap-2\">\r\n                  <Button variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\r\n                    Cancel\r\n                  </Button>\r\n                  <Button \r\n                    onClick={handleSaveCampaign}\r\n                    disabled={saveCampaignMutation.isPending}\r\n                  >\r\n                    {saveCampaignMutation.isPending ? 'Saving...' : 'Save Campaign'}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </DialogContent>\r\n          </Dialog>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modern Contact Canvas */}\r\n      <ScrollArea className=\"h-[600px] w-full\">\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4\">\r\n          {contacts.map((contact, index) => {\r\n            const isSelected = selectedContacts.has(index);\r\n            const contactName = contact.name || contact.Name || contact.first_name || contact['First Name'] || 'Unknown Name';\r\n            const contactEmail = contact.email || contact.Email || contact['Email Address'] || '';\r\n            const contactPhone = contact.phone || contact.Phone || contact.mobile || contact.Mobile || contact['Phone Number'] || '';\r\n            const contactCompany = contact.company || contact.Company || contact.organization || contact.Organization || '';\r\n            const contactTitle = contact.title || contact.Title || contact.job_title || contact['Job Title'] || '';\r\n            const contactLocation = contact.location || contact.Location || contact.city || contact.City || '';\r\n            const contactLinkedIn = contact.linkedin || contact.LinkedIn || contact['LinkedIn Profile'] || '';\r\n            const contactIndustry = contact.industry || contact.Industry || '';\r\n            const contactWebsite = contact.website || contact.Website || '';\r\n\r\n            return (\r\n              <Card \r\n                key={index} \r\n                className={`group relative transition-all duration-200 hover:shadow-lg hover:scale-[1.02] cursor-pointer ${\r\n                  isSelected ? 'ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-950' : ''\r\n                }`}\r\n                onClick={() => toggleContactSelection(index)}\r\n                data-testid={`contact-card-${index}`}\r\n              >\r\n                <CardHeader className=\"pb-2\">\r\n                  <div className=\"flex items-start justify-between\">\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <Avatar className=\"w-12 h-12\">\r\n                        <AvatarFallback className=\"bg-gradient-to-br from-blue-500 to-purple-600 text-white font-medium\">\r\n                          {getInitials(contactName)}\r\n                        </AvatarFallback>\r\n                      </Avatar>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <h4 className=\"font-semibold text-sm text-gray-900 dark:text-gray-100 truncate\">\r\n                          {contactName}\r\n                        </h4>\r\n                        {contactTitle && (\r\n                          <p className=\"text-xs text-gray-600 dark:text-gray-400 truncate\">\r\n                            {contactTitle}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                    {contact.score && (\r\n                      <div className={`flex items-center text-xs ${getScoreColor(contact.score)}`}>\r\n                        <Star className=\"w-3 h-3 mr-1\" />\r\n                        {contact.score}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </CardHeader>\r\n\r\n                <CardContent className=\"pt-0 space-y-2\">\r\n                  {/* Company */}\r\n                  {contactCompany && (\r\n                    <div className=\"flex items-center space-x-2 text-xs\">\r\n                      <Building2 className=\"w-3 h-3 text-gray-500 flex-shrink-0\" />\r\n                      <span className=\"text-gray-700 dark:text-gray-300 truncate\">{contactCompany}</span>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Email */}\r\n                  {contactEmail && (\r\n                    <div className=\"flex items-center space-x-2 text-xs group/email\">\r\n                      <Mail className=\"w-3 h-3 text-gray-500 flex-shrink-0\" />\r\n                      <span className=\"text-gray-700 dark:text-gray-300 truncate flex-1\">{contactEmail}</span>\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        className=\"opacity-0 group-hover/email:opacity-100 p-1 h-auto\"\r\n                        onClick={(e) => {\r\n                          e.stopPropagation();\r\n                          copyToClipboard(contactEmail, 'Email');\r\n                        }}\r\n                      >\r\n                        <Copy className=\"w-3 h-3\" />\r\n                      </Button>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Phone */}\r\n                  {contactPhone && (\r\n                    <div className=\"flex items-center space-x-2 text-xs group/phone\">\r\n                      <Phone className=\"w-3 h-3 text-gray-500 flex-shrink-0\" />\r\n                      <span className=\"text-gray-700 dark:text-gray-300 truncate flex-1\">{contactPhone}</span>\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        className=\"opacity-0 group-hover/phone:opacity-100 p-1 h-auto\"\r\n                        onClick={(e) => {\r\n                          e.stopPropagation();\r\n                          copyToClipboard(contactPhone, 'Phone');\r\n                        }}\r\n                      >\r\n                        <Copy className=\"w-3 h-3\" />\r\n                      </Button>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Location */}\r\n                  {contactLocation && (\r\n                    <div className=\"flex items-center space-x-2 text-xs\">\r\n                      <MapPin className=\"w-3 h-3 text-gray-500 flex-shrink-0\" />\r\n                      <span className=\"text-gray-700 dark:text-gray-300 truncate\">{contactLocation}</span>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Industry */}\r\n                  {contactIndustry && (\r\n                    <div className=\"flex items-center space-x-2 text-xs\">\r\n                      <Briefcase className=\"w-3 h-3 text-gray-500 flex-shrink-0\" />\r\n                      <span className=\"text-gray-700 dark:text-gray-300 truncate\">{contactIndustry}</span>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Contact Status */}\r\n                  <div className=\"flex items-center justify-between pt-2\">\r\n                    <Badge variant={contact.emailSent ? \"default\" : \"secondary\"} className=\"text-xs\">\r\n                      {contact.emailSent ? \"Contacted\" : \"New\"}\r\n                    </Badge>\r\n                    \r\n                    <div className=\"flex items-center space-x-1\">\r\n                      {contactLinkedIn && (\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"ghost\"\r\n                          className=\"p-1 h-auto\"\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            window.open(contactLinkedIn, '_blank');\r\n                          }}\r\n                        >\r\n                          <ExternalLink className=\"w-3 h-3\" />\r\n                        </Button>\r\n                      )}\r\n                      {contactWebsite && (\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"ghost\"\r\n                          className=\"p-1 h-auto\"\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            window.open(contactWebsite, '_blank');\r\n                          }}\r\n                        >\r\n                          <Globe className=\"w-3 h-3\" />\r\n                        </Button>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n\r\n                {/* Selection Indicator */}\r\n                {isSelected && (\r\n                  <div className=\"absolute top-2 right-2 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center\">\r\n                    <div className=\"w-2 h-2 bg-white rounded-full\"></div>\r\n                  </div>\r\n                )}\r\n              </Card>\r\n            );\r\n          })}\r\n        </div>\r\n      </ScrollArea>\r\n\r\n      {/* Summary Stats */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg\">\r\n        <div className=\"text-center\">\r\n          <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\r\n            {contacts.length}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">Total Contacts</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\r\n            {contacts.filter(c => c.emailSent).length}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">Contacted</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\r\n            {contacts.filter(c => !c.emailSent).length}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">New Leads</div>\r\n        </div>\r\n        <div className=\"text-center\">\r\n          <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\r\n            {selectedContacts.size}\r\n          </div>\r\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">Selected</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\notes-documents.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\password-modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\pawmate-enhanced.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 18. Maximum allowed is 15.","line":39,"column":61,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":39,"endColumn":63},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 35. Maximum allowed is 15.","line":394,"column":38,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":394,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { \r\n  Heart, MessageCircle, Zap, Dog, Settings, Send, Sparkles, Bot,\r\n  Search, Database, Target, Phone, Mail, Building, Globe, \r\n  ExternalLink, Users, Filter, SortAsc, Grid, List, Download,\r\n  User, Eye, ChevronDown, ChevronUp, Upload, FileSpreadsheet\r\n} from \"lucide-react\";\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { CsvExportModal } from './CsvExportModal';\r\nimport { CsvImportModal } from './CsvImportModal';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { apiRequest } from '@/lib/queryClient';\r\n\r\ninterface Message {\r\n  id: string;\r\n  type: 'user' | 'bot' | 'search-results';\r\n  content: string;\r\n  timestamp: Date;\r\n  isTyping?: boolean;\r\n  searchResults?: any;\r\n  searchQuery?: string;\r\n}\r\n\r\ninterface ContactCardProps {\r\n  contact: any;\r\n  source: 'campaign' | 'direct';\r\n}\r\n\r\nconst ContactCard = ({ contact, source }: ContactCardProps) => {\r\n  const [expanded, setExpanded] = useState(false);\r\n  \r\n  return (\r\n    <Card className=\"mb-3 hover:shadow-md transition-shadow\">\r\n      <CardContent className=\"p-4\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <div className=\"flex-1\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <h3 className=\"font-semibold text-lg\">\r\n                {source === 'campaign' \r\n                  ? `${contact['First Name']} ${contact['Last Name']}`\r\n                  : contact.name\r\n                }\r\n              </h3>\r\n              <Badge variant=\"outline\" className=\"text-xs\">\r\n                {source === 'campaign' ? 'Campaign Data' : 'Direct Contact'}\r\n              </Badge>\r\n            </div>\r\n            \r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Building className=\"w-4 h-4 text-muted-foreground\" />\r\n                <span>{source === 'campaign' ? contact.Company : contact.company || 'N/A'}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Dog className=\"w-4 h-4 text-muted-foreground\" />\r\n                <span>{source === 'campaign' ? contact.Title : contact.title || 'N/A'}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Mail className=\"w-4 h-4 text-muted-foreground\" />\r\n                <span className=\"truncate\">{source === 'campaign' ? contact.Email : contact.email}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Phone className=\"w-4 h-4 text-muted-foreground\" />\r\n                <span>{source === 'campaign' ? contact['Mobile Phone'] : contact.mobile || 'N/A'}</span>\r\n              </div>\r\n            </div>\r\n            \r\n            {expanded && source === 'campaign' && (\r\n              <div className=\"mt-3 pt-3 border-t grid grid-cols-1 md:grid-cols-2 gap-3 text-sm\">\r\n                {contact['Other Phone'] && (\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Phone className=\"w-4 h-4 text-muted-foreground\" />\r\n                    <span>Other: {contact['Other Phone']}</span>\r\n                  </div>\r\n                )}\r\n                {contact['Corporate Phone'] && (\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Phone className=\"w-4 h-4 text-muted-foreground\" />\r\n                    <span>Corporate: {contact['Corporate Phone']}</span>\r\n                  </div>\r\n                )}\r\n                {contact.Website && (\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Globe className=\"w-4 h-4 text-muted-foreground\" />\r\n                    <a href={contact.Website} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 hover:underline\">\r\n                      Website\r\n                    </a>\r\n                  </div>\r\n                )}\r\n                {contact['Person Linkedin Url'] && (\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <ExternalLink className=\"w-4 h-4 text-muted-foreground\" />\r\n                    <a href={contact['Person Linkedin Url']} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 hover:underline\">\r\n                      LinkedIn Profile\r\n                    </a>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n          \r\n          {source === 'campaign' && (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => setExpanded(!expanded)}\r\n              className=\"ml-2\"\r\n            >\r\n              {expanded ? <ChevronUp className=\"w-4 h-4\" /> : <ChevronDown className=\"w-4 h-4\" />}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\ninterface SearchResultsDisplayProps {\r\n  searchResults: any;\r\n  searchQuery: string;\r\n}\r\n\r\nconst SearchResultsDisplay = ({ searchResults, searchQuery }: SearchResultsDisplayProps) => {\r\n  const [viewMode, setViewMode] = useState<'cards' | 'compact'>('cards');\r\n  const [showAll, setShowAll] = useState(false);\r\n  \r\n  const allContacts = [\r\n    ...(searchResults.campaignData?.flatMap((campaign: any) => \r\n      campaign.matches.map((contact: any) => ({ ...contact, source: 'campaign', campaignName: campaign.campaignName }))\r\n    ) || []),\r\n    ...(searchResults.contacts?.map((contact: any) => ({ ...contact, source: 'direct' })) || [])\r\n  ];\r\n  \r\n  const displayContacts = showAll ? allContacts : allContacts.slice(0, 10);\r\n  \r\n  return (\r\n    <div className=\"mt-4 p-4 bg-green-50 dark:bg-green-950 rounded-lg border border-green-200 dark:border-green-800\">\r\n      <div className=\"flex items-center justify-between mb-4\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Database className=\"w-5 h-5 text-green-600\" />\r\n          <h3 className=\"font-semibold text-green-800 dark:text-green-100\">\r\n            Search Results: {searchResults.total} found\r\n          </h3>\r\n        </div>\r\n        \r\n        <div className=\"flex items-center gap-2\">\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => setViewMode(viewMode === 'cards' ? 'compact' : 'cards')}\r\n          >\r\n            {viewMode === 'cards' ? <List className=\"w-4 h-4\" /> : <Grid className=\"w-4 h-4\" />}\r\n          </Button>\r\n        </div>\r\n      </div>\r\n      \r\n      {viewMode === 'cards' ? (\r\n        <div className=\"space-y-3 max-h-80 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100\">\r\n          {displayContacts.map((contact: any, index: number) => (\r\n            <ContactCard \r\n              key={index} \r\n              contact={contact} \r\n              source={contact.source}\r\n            />\r\n          ))}\r\n        </div>\r\n      ) : (\r\n        <div className=\"max-h-80 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100\">\r\n          <div className=\"grid grid-cols-1 gap-2 text-sm\">\r\n            {displayContacts.map((contact: any, index: number) => (\r\n              <div key={index} className=\"flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded border\">\r\n                <div className=\"flex items-center gap-4 flex-1\">\r\n                  <span className=\"font-medium min-w-[120px]\">\r\n                    {contact.source === 'campaign' \r\n                      ? `${contact['First Name']} ${contact['Last Name']}`\r\n                      : contact.name\r\n                    }\r\n                  </span>\r\n                  <span className=\"text-muted-foreground min-w-[100px]\">\r\n                    {contact.source === 'campaign' ? contact.Company : contact.company}\r\n                  </span>\r\n                  <span className=\"text-muted-foreground\">\r\n                    {contact.source === 'campaign' ? contact['Mobile Phone'] : contact.mobile}\r\n                  </span>\r\n                </div>\r\n                <Badge variant=\"outline\" className=\"text-xs\">\r\n                  {contact.source === 'campaign' ? 'Campaign' : 'Direct'}\r\n                </Badge>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {allContacts.length > 10 && (\r\n        <div className=\"mt-4 text-center\">\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => setShowAll(!showAll)}\r\n          >\r\n            {showAll ? 'Show Less' : `Show All ${allContacts.length} Results`}\r\n          </Button>\r\n        </div>\r\n      )}\r\n      \r\n      <div className=\"mt-4 pt-3 border-t border-green-200 dark:border-green-700\">\r\n        <div className=\"flex items-center justify-between mb-2\">\r\n          <div className=\"text-xs text-green-700 dark:text-green-300\">\r\n            <span>Query: \"{searchQuery}\"</span>\r\n            <span className=\"ml-4\">{searchResults.total} total matches found</span>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button \r\n              size=\"sm\" \r\n              variant=\"outline\"\r\n              onClick={() => {\r\n                // This will be handled by the parent component\r\n                const event = new CustomEvent('exportSearchResults', { \r\n                  detail: { query: searchQuery } \r\n                });\r\n                window.dispatchEvent(event);\r\n              }}\r\n              disabled={!searchQuery}\r\n              className=\"text-xs h-7\"\r\n              data-testid=\"button-export-results\"\r\n            >\r\n              <Download className=\"w-3 h-3 mr-1\" />\r\n              Save Results\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default function PawMate() {\r\n  const [petName, setPetName] = useState(() => localStorage.getItem('pawmate_pet_name') || \"Duggu\");\r\n  const [userName, setUserName] = useState(() => localStorage.getItem('pawmate_user_name') || \"\");\r\n  const [petMessage, setPetMessage] = useState(\"\");\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [isTyping, setIsTyping] = useState(false);\r\n  const [settingsOpen, setSettingsOpen] = useState(false);\r\n  const [isUsingRealAI, setIsUsingRealAI] = useState<boolean | null>(null);\r\n  const [sessionId, setSessionId] = useState<string | null>(() => localStorage.getItem('pawmate_session_id'));\r\n  const [csvExportOpen, setCsvExportOpen] = useState(false);\r\n  const [csvImportOpen, setCsvImportOpen] = useState(false);\r\n  const [isExporting, setIsExporting] = useState(false);\r\n  const [isImporting, setIsImporting] = useState(false);\r\n  const [lastSearchQuery, setLastSearchQuery] = useState('');\r\n  const [historyInitialized, setHistoryInitialized] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const { toast } = useToast();\r\n\r\n  // Auto-scroll to bottom when new messages arrive\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  // Load chat history on component mount\r\n  useEffect(() => {\r\n    if (historyInitialized) return; // Prevent re-initialization\r\n    \r\n    const loadChatHistory = async () => {\r\n      let historyLoaded = false;\r\n      \r\n      if (sessionId) {\r\n        try {\r\n          const response = await fetch(`/api/pawmate/sessions/${sessionId}/history`);\r\n          if (response.ok) {\r\n            const history = await response.json();\r\n            if (history.length > 0) {\r\n              const formattedMessages: Message[] = history.map((msg: any) => ({\r\n                id: msg.id.toString(),\r\n                type: msg.role === 'user' ? 'user' : 'bot',\r\n                content: msg.content,\r\n                timestamp: new Date(msg.createdAt)\r\n              }));\r\n              setMessages(formattedMessages);\r\n              historyLoaded = true;\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('Failed to load chat history:', error);\r\n        }\r\n      }\r\n      \r\n      // Load welcome message only if no history was loaded\r\n      if (!historyLoaded) {\r\n        const userGreeting = userName ? ` ${userName}` : '';\r\n        setMessages([{\r\n          id: '1',\r\n          type: 'bot',\r\n          content: `# ðŸ‘‹ Hi${userGreeting}! I'm ${petName || 'Duggu'}\r\n\r\n**Your Advanced AI Business Intelligence Assistant** - Created by Fallowl\r\n\r\nI'm your comprehensive solution for lead generation, data analysis, and business intelligence with Apollo.io API expertise.\r\n\r\n## ðŸš€ Advanced Capabilities:\r\n- **Lead Scoring & Analysis**: AI-powered prospect qualification with authority scoring\r\n- **Apollo.io Integration**: Complete API knowledge for advanced prospecting\r\n- **Campaign Management**: Create, analyze, and optimize marketing campaigns\r\n- **Data Operations**: Search, filter, export with complex multi-criteria queries\r\n- **Contact Enrichment**: Enhanced data with LinkedIn profiles and social signals\r\n- **Business Intelligence**: Market analysis, competitive insights, strategic recommendations\r\n- **Automation Workflows**: Process optimization and efficiency recommendations\r\n\r\n## ðŸŽ¯ Apollo.io API Expertise:\r\n- **People Search API**: Advanced filtering with Boolean logic and complex criteria\r\n- **Organization Search**: Account-based marketing and company intelligence\r\n- **Contact Enrichment**: Email discovery, data enhancement, verification\r\n- **Sequence Automation**: Multi-channel outreach with performance tracking\r\n- **Bulk Operations**: Export up to 10,000 records with custom filtering\r\n- **CRM Integration**: Seamless data synchronization workflows\r\n\r\n## ðŸ“Š Current Database Status:\r\n- **Lead Intelligence**: Advanced scoring algorithms ready\r\n- **Campaign Data**: Multi-source analysis capabilities\r\n- **Search Engine**: Complex queries with Boolean operators\r\n- **Export Functions**: Custom campaign creation with automated naming\r\n\r\n## ðŸ’¡ Smart Actions Available:\r\n- \"How do I target C-level executives with Apollo.io?\"\r\n- \"Generate comprehensive prospect scoring report\"\r\n- \"Create automated prospecting workflow recommendations\"\r\n- \"Find high-value prospects with executive authority\"\r\n- \"Show me Apollo.io API examples for lead generation\"\r\n- \"Analyze my contact database for quality scoring\"\r\n\r\n**I combine database operations, Apollo.io expertise, and strategic business intelligence to drive your lead generation success!** ðŸŽ¯\r\n\r\n*What advanced prospecting challenge can I help you solve today?*`,\r\n          timestamp: new Date()\r\n        }]);\r\n      }\r\n      \r\n      setHistoryInitialized(true);\r\n    };\r\n\r\n    loadChatHistory();\r\n  }, [sessionId, historyInitialized]); // Only depend on sessionId to avoid reloading when name changes\r\n\r\n  // Search query detection logic - only trigger for explicit search or clear contact data\r\n  const isSearchQuery = (query: string): boolean => {\r\n    const lowerQuery = query.toLowerCase().trim();\r\n    \r\n    // Explicit search keywords - user must use these to trigger search\r\n    const searchKeywords = [\r\n      'search', 'find', 'lookup', 'show me', 'get me', \r\n      'list all', 'find all', 'search for', 'who is'\r\n    ];\r\n    \r\n    // Check for explicit search intent\r\n    const hasSearchKeywords = searchKeywords.some(keyword => \r\n      lowerQuery.includes(keyword)\r\n    );\r\n    \r\n    // Check for identifiable personal/contact information patterns\r\n    const hasContactInfo = (\r\n      /@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/.test(query) ||  // Complete email address\r\n      /\\b\\d{3}[-.\\s]?\\d{3}[-.\\s]?\\d{4}\\b/.test(query) ||  // Phone number pattern\r\n      /\\b[A-Z][a-z]+ [A-Z][a-z]+@/.test(query) ||  // Name with email\r\n      /\\b(corp|corporation|inc|incorporated|llc|ltd|limited|company|co\\.)\\b/i.test(query) ||  // Company identifiers\r\n      (/\\b[A-Z][a-z]+ [A-Z][a-z]+\\b/.test(query) && query.split(' ').length <= 3 && query.length > 6)  // Likely full name (2-3 words, proper case)\r\n    );\r\n    \r\n    // Common conversational phrases should NOT trigger search\r\n    const conversationalPhrases = [\r\n      'hello', 'hi', 'hey', 'thank you', 'thanks', 'please', 'yes', 'no',\r\n      'how are you', 'what can you do', 'help me', 'tell me about', 'explain',\r\n      'i need help', 'can you help', 'what is', 'how do i', 'how to'\r\n    ];\r\n    \r\n    const isConversational = conversationalPhrases.some(phrase => \r\n      lowerQuery === phrase || lowerQuery.startsWith(phrase + ' ')\r\n    );\r\n    \r\n    // Only trigger search for explicit keywords or clear contact information\r\n    return (hasSearchKeywords || hasContactInfo) && !isConversational;\r\n  };\r\n\r\n  const handleSendMessage = async () => {\r\n    if (!petMessage.trim()) return;\r\n    \r\n    const userMessage: Message = {\r\n      id: Date.now().toString(),\r\n      type: 'user',\r\n      content: petMessage.trim(),\r\n      timestamp: new Date()\r\n    };\r\n\r\n    setMessages(prev => [...prev, userMessage]);\r\n    const query = petMessage.trim();\r\n    setPetMessage(\"\");\r\n    setIsTyping(true);\r\n\r\n    // Show typing indicator\r\n    const typingMessage: Message = {\r\n      id: (Date.now() + 1).toString(),\r\n      type: 'bot',\r\n      content: 'Analyzing query...',\r\n      timestamp: new Date(),\r\n      isTyping: true\r\n    };\r\n    setMessages(prev => [...prev, typingMessage]);\r\n\r\n    try {\r\n      // Determine if this should be a search or AI chat\r\n      if (isSearchQuery(query)) {\r\n        // Perform database search\r\n        const searchResponse = await fetch('/api/search', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ \r\n            query, \r\n            searchType: 'all', \r\n            limit: 100  // Increased limit for larger datasets\r\n          })\r\n        });\r\n        \r\n        if (searchResponse.ok) {\r\n          const searchData = await searchResponse.json();\r\n          \r\n          if (searchData.total > 0) {\r\n            // Store the last search query for CSV export\r\n            setLastSearchQuery(query);\r\n            \r\n            const searchResultMessage: Message = {\r\n              id: Date.now().toString(),\r\n              type: 'search-results',\r\n              content: `ðŸ” Found ${searchData.total} results for \"${query}\"`,\r\n              searchResults: searchData,\r\n              searchQuery: query,\r\n              timestamp: new Date()\r\n            };\r\n            \r\n            // Remove typing indicator and add search results\r\n            setMessages(prev => prev.slice(0, -1).concat([searchResultMessage]));\r\n            setIsTyping(false);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // If no search results or not a search query, use AI chat\r\n      const conversationHistory = [...messages, userMessage].map(msg => ({\r\n        role: msg.type === 'user' ? 'user' as const : 'assistant' as const,\r\n        content: msg.content\r\n      }));\r\n\r\n      const userNameContext = userName ? ` The user's name is ${userName}, so address them by name when appropriate.` : '';\r\n      const systemMessage = {\r\n        role: 'system' as const,\r\n        content: `You are ${petName || 'Duggu'}, an expert lead scoring and business intelligence AI assistant created by Fallowl. You have access to campaign and contact databases with 263+ records. Focus on lead analysis, contact intelligence, and campaign optimization. Provide helpful, direct answers.${userNameContext} If the user wants to search for specific contacts, suggest they use search commands like \"search for [name]\" or \"find [company]\".`\r\n      };\r\n\r\n      // Use streaming endpoint for real-time responses\r\n      const response = await fetch('/api/pawmate/chat-stream', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          messages: [systemMessage, ...conversationHistory],\r\n          petName: petName || 'Duggu',\r\n          userName: userName || '',\r\n          petType: 'assistant',\r\n          sessionId: sessionId || `pawmate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        }),\r\n      });\r\n\r\n      if (response.ok && response.body) {\r\n        const reader = response.body.getReader();\r\n        const decoder = new TextDecoder();\r\n        let streamedContent = '';\r\n        let currentBotMessageId = Date.now().toString();\r\n        \r\n        // Remove typing indicator and add empty bot message for streaming\r\n        setMessages(prev => prev.slice(0, -1).concat([{\r\n          id: currentBotMessageId,\r\n          type: 'bot',\r\n          content: '',\r\n          timestamp: new Date()\r\n        }]));\r\n\r\n        try {\r\n          while (true) {\r\n            const { done, value } = await reader.read();\r\n            if (done) break;\r\n\r\n            const chunk = decoder.decode(value);\r\n            const lines = chunk.split('\\n');\r\n            \r\n            for (const line of lines) {\r\n              if (line.startsWith('data: ')) {\r\n                try {\r\n                  const data = JSON.parse(line.slice(6));\r\n                  \r\n                  if (data.type === 'session' && data.sessionId && data.sessionId !== sessionId) {\r\n                    setSessionId(data.sessionId);\r\n                    localStorage.setItem('pawmate_session_id', data.sessionId);\r\n                  } else if (data.type === 'content') {\r\n                    streamedContent += data.content;\r\n                    // Update the bot message with streaming content\r\n                    setMessages(prev => prev.map(msg => \r\n                      msg.id === currentBotMessageId \r\n                        ? { ...msg, content: streamedContent }\r\n                        : msg\r\n                    ));\r\n                  } else if (data.type === 'done') {\r\n                    setIsUsingRealAI(true);\r\n                  } else if (data.type === 'error') {\r\n                    console.error('Streaming error:', data.message);\r\n                    // Update message with error content\r\n                    setMessages(prev => prev.map(msg => \r\n                      msg.id === currentBotMessageId \r\n                        ? { ...msg, content: \"I encountered an error processing your request. Please try again.\" }\r\n                        : msg\r\n                    ));\r\n                  }\r\n                } catch (parseError) {\r\n                  // Ignore parsing errors for incomplete chunks\r\n                }\r\n              }\r\n            }\r\n          }\r\n        } catch (streamError) {\r\n          console.error('Stream reading error:', streamError);\r\n          setMessages(prev => prev.map(msg => \r\n            msg.id === currentBotMessageId \r\n              ? { ...msg, content: \"I encountered an error processing your request. Please try again.\" }\r\n              : msg\r\n          ));\r\n        }\r\n      } else {\r\n        // Fallback to original endpoint if streaming fails\r\n        const fallbackResponse = await fetch('/api/pawmate/chat', {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            messages: [systemMessage, ...conversationHistory],\r\n            petName: petName || 'Duggu',\r\n            userName: userName || '',\r\n            petType: 'assistant',\r\n            sessionId: sessionId || `pawmate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n          }),\r\n        });\r\n\r\n        if (fallbackResponse.ok) {\r\n          const data = await fallbackResponse.json();\r\n          setIsUsingRealAI(data.isRealAI);\r\n          \r\n          // Update session ID if returned from server\r\n          if (data.sessionId && data.sessionId !== sessionId) {\r\n            setSessionId(data.sessionId);\r\n            localStorage.setItem('pawmate_session_id', data.sessionId);\r\n          }\r\n          \r\n          let aiResponse = data.choices?.[0]?.message?.content || \"I'm having trouble responding right now. Please try again.\";\r\n          \r\n          // Clean up any unwanted recommendation sections\r\n          aiResponse = aiResponse.replace(/Recommendations?:[\\s\\S]*?(?=\\n\\n|$)/gi, '');\r\n          aiResponse = aiResponse.replace(/Next Steps?:[\\s\\S]*?(?=\\n\\n|$)/gi, '');\r\n          \r\n          const botMessage: Message = {\r\n            id: Date.now().toString(),\r\n            type: 'bot',\r\n            content: aiResponse,\r\n            timestamp: new Date()\r\n          };\r\n          \r\n          // Remove typing indicator and add AI response\r\n          setMessages(prev => prev.slice(0, -1).concat([botMessage]));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Message processing failed:', error);\r\n      setMessages(prev => prev.slice(0, -1).concat([{\r\n        id: Date.now().toString(),\r\n        type: 'bot',\r\n        content: \"I encountered an error processing your request. Please try again.\",\r\n        timestamp: new Date()\r\n      }]));\r\n    } finally {\r\n      setIsTyping(false);\r\n    }\r\n  };\r\n\r\n  const handleKeyPress = (e: React.KeyboardEvent) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  };\r\n\r\n  const getPetIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'assistant':\r\n        return 'ðŸ•';\r\n      case 'dog':\r\n        return 'ðŸ•';\r\n      case 'cat':\r\n        return 'ðŸ±';\r\n      default:\r\n        return 'ðŸ•';\r\n    }\r\n  };\r\n\r\n  // Listen for export events from search results\r\n  useEffect(() => {\r\n    const handleExportEvent = (event: any) => {\r\n      setLastSearchQuery(event.detail.query);\r\n      setCsvExportOpen(true);\r\n    };\r\n    \r\n    window.addEventListener('exportSearchResults', handleExportEvent);\r\n    return () => window.removeEventListener('exportSearchResults', handleExportEvent);\r\n  }, []);\r\n\r\n  // CSV Export handler - now saves directly to records\r\n  const handleCsvExport = async (options: any) => {\r\n    setIsExporting(true);\r\n    try {\r\n      // Add saveToRecords flag to save directly to records\r\n      const exportOptions = {\r\n        ...options,\r\n        saveToRecords: true\r\n      };\r\n\r\n      const response = await fetch('/api/export-save/csv', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(exportOptions)\r\n      });\r\n\r\n      if (response.ok) {\r\n        const result = await response.json();\r\n        \r\n        toast({\r\n          title: \"Export & Save Successful\",\r\n          description: `Exported ${result.exportedRecords} records and saved to campaign \"${result.campaign.name}\"`,\r\n        });\r\n        setCsvExportOpen(false);\r\n        \r\n        // Add success message to chat\r\n        const successMessage: Message = {\r\n          id: Date.now().toString(),\r\n          type: 'bot',\r\n          content: `âœ… **Export & Save Complete!**\r\n\r\n**Search Query:** \"${result.searchQuery}\"\r\n**Campaign Created:** ${result.campaign.name}\r\n**Records Exported:** ${result.exportedRecords}\r\n**Headers:** ${result.campaign.headers.join(', ')}\r\n\r\nYour search results have been exported and saved as a new campaign record. You can now search through this data anytime!`,\r\n          timestamp: new Date()\r\n        };\r\n        \r\n        setMessages(prev => [...prev, successMessage]);\r\n        \r\n        // Invalidate campaigns cache to refresh the list immediately\r\n        import('@/lib/queryClient').then(({ queryClient }) => {\r\n          queryClient.invalidateQueries({ queryKey: ['/api/campaigns'] });\r\n          // Force refetch to update immediately\r\n          queryClient.refetchQueries({ queryKey: ['/api/campaigns'] });\r\n        });\r\n      } else {\r\n        const error = await response.json();\r\n        toast({\r\n          title: \"Export Failed\",\r\n          description: error.message || \"Failed to export and save data\",\r\n          variant: \"destructive\"\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Export Error\",\r\n        description: \"An error occurred while exporting data\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsExporting(false);\r\n    }\r\n  };\r\n\r\n  // CSV Import handler\r\n  const handleCsvImport = async (file: File, options: any) => {\r\n    setIsImporting(true);\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append('csvFile', file);\r\n      formData.append('customName', options.customName);\r\n      formData.append('overwrite', options.overwrite.toString());\r\n\r\n      const response = await fetch('/api/import/csv', {\r\n        method: 'POST',\r\n        body: formData\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (response.ok) {\r\n        toast({\r\n          title: \"Import Successful\",\r\n          description: `Imported ${result.importedRecords} records into campaign \"${result.campaign.name}\"`,\r\n        });\r\n        setCsvImportOpen(false);\r\n        \r\n        // Add success message to chat\r\n        const successMessage: Message = {\r\n          id: Date.now().toString(),\r\n          type: 'bot',\r\n          content: `âœ… **CSV Import Complete!**\r\n\r\n**Campaign Created:** ${result.campaign.name}\r\n**Records Imported:** ${result.importedRecords}\r\n**Headers Detected:** ${result.campaign.headers.join(', ')}\r\n\r\nYour data has been securely encrypted and added to the system. You can now search through this data using commands like:\r\nâ€¢ \"search ${result.campaign.name}\"\r\nâ€¢ \"find contacts in ${result.campaign.name}\"`,\r\n          timestamp: new Date()\r\n        };\r\n        \r\n        setMessages(prev => [...prev, successMessage]);\r\n        \r\n        // Invalidate campaigns cache to refresh the list immediately for CSV import\r\n        import('@/lib/queryClient').then(({ queryClient }) => {\r\n          queryClient.invalidateQueries({ queryKey: ['/api/campaigns'] });\r\n          // Force refetch to update immediately\r\n          queryClient.refetchQueries({ queryKey: ['/api/campaigns'] });\r\n        });\r\n      } else {\r\n        if (response.status === 409) {\r\n          toast({\r\n            title: \"Import Conflict\",\r\n            description: result.message + (result.suggestedName ? `\\n\\nSuggested name: ${result.suggestedName}` : ''),\r\n            variant: \"destructive\"\r\n          });\r\n        } else {\r\n          toast({\r\n            title: \"Import Failed\",\r\n            description: result.message || \"Failed to import CSV\",\r\n            variant: \"destructive\"\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Import Error\",\r\n        description: \"An error occurred while importing CSV\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsImporting(false);\r\n    }\r\n  };\r\n\r\n  const renderMessage = (msg: Message) => {\r\n    const isUser = msg.type === 'user';\r\n    \r\n    return (\r\n      <div key={msg.id} className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`}>\r\n        <div className={`flex w-full max-w-none ${isUser ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2`}>\r\n          <Avatar className=\"w-8 h-8 mt-1 flex-shrink-0\">\r\n            <AvatarFallback className={isUser ? 'bg-blue-500 text-white' : 'bg-purple-500 text-white'}>\r\n              {isUser ? <User className=\"w-4 h-4\" /> : <Dog className=\"w-4 h-4\" />}\r\n            </AvatarFallback>\r\n          </Avatar>\r\n          \r\n          <div className={`rounded-lg px-4 py-3 min-w-0 flex-1 ${\r\n            isUser \r\n              ? 'bg-blue-500 text-white ml-2 max-w-[80%] self-end' \r\n              : 'bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-100 mr-2'\r\n          }`}>\r\n            {msg.isTyping ? (\r\n              <div className=\"flex items-center space-x-1\">\r\n                <div className=\"w-2 h-2 bg-current rounded-full animate-bounce\"></div>\r\n                <div className=\"w-2 h-2 bg-current rounded-full animate-bounce\" style={{ animationDelay: '0.1s' }}></div>\r\n                <div className=\"w-2 h-2 bg-current rounded-full animate-bounce\" style={{ animationDelay: '0.2s' }}></div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-sm break-words overflow-wrap-anywhere\">\r\n                <ReactMarkdown \r\n                  components={{\r\n                    p: ({ children }) => <p className=\"mb-2 last:mb-0\">{children}</p>,\r\n                    pre: ({ children }) => <pre className=\"bg-gray-200 dark:bg-gray-700 p-2 rounded text-xs overflow-x-auto\">{children}</pre>,\r\n                    code: ({ children }) => <code className=\"bg-gray-200 dark:bg-gray-700 px-1 py-0.5 rounded text-xs\">{children}</code>,\r\n                  }}\r\n                >\r\n                  {msg.content}\r\n                </ReactMarkdown>\r\n                \r\n                {msg.type === 'search-results' && msg.searchResults && (\r\n                  <SearchResultsDisplay \r\n                    searchResults={msg.searchResults} \r\n                    searchQuery={msg.searchQuery || ''} \r\n                  />\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <Card className=\"w-full h-[calc(100vh-160px)] flex flex-col overflow-hidden\">\r\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 py-2 px-4 border-b flex-shrink-0\">\r\n        <div className=\"flex items-center space-x-2\">\r\n          <div className=\"w-6 h-6 bg-gradient-to-br from-purple-600 to-blue-600 rounded-full flex items-center justify-center\">\r\n            <Dog className=\"w-3 h-3 text-white\" />\r\n          </div>\r\n          <div>\r\n            <CardTitle className=\"text-sm font-medium\">{petName || 'Duggu'}</CardTitle>\r\n            <p className=\"text-xs text-muted-foreground flex items-center\">\r\n              <MessageCircle className=\"w-2 h-2 mr-1\" />\r\n              AI Chat\r\n              {isUsingRealAI !== null && (\r\n                <Badge variant=\"outline\" className=\"ml-1 text-[10px] px-1 py-0 h-4\">\r\n                  {isUsingRealAI ? 'GPT-4' : 'Basic'}\r\n                </Badge>\r\n              )}\r\n            </p>\r\n          </div>\r\n        </div>\r\n        \r\n        <Dialog open={settingsOpen} onOpenChange={setSettingsOpen}>\r\n          <DialogTrigger asChild>\r\n            <Button variant=\"ghost\" size=\"sm\" className=\"h-6 w-6 p-0\">\r\n              <Settings className=\"w-3 h-3\" />\r\n            </Button>\r\n          </DialogTrigger>\r\n          <DialogContent>\r\n            <DialogHeader>\r\n              <DialogTitle>Assistant Settings</DialogTitle>\r\n            </DialogHeader>\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <Label htmlFor=\"pet-name\">Assistant Name</Label>\r\n                <Input\r\n                  id=\"pet-name\"\r\n                  value={petName}\r\n                  onChange={(e) => {\r\n                    setPetName(e.target.value);\r\n                    localStorage.setItem('pawmate_pet_name', e.target.value);\r\n                    // Dispatch event to notify other components about the name change\r\n                    window.dispatchEvent(new CustomEvent('assistantNameChanged'));\r\n                  }}\r\n                  placeholder=\"Enter assistant name\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label htmlFor=\"user-name\">Your Name (How assistant addresses you)</Label>\r\n                <Input\r\n                  id=\"user-name\"\r\n                  value={userName}\r\n                  onChange={(e) => {\r\n                    setUserName(e.target.value);\r\n                    localStorage.setItem('pawmate_user_name', e.target.value);\r\n                  }}\r\n                  placeholder=\"Enter your name (optional)\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </DialogContent>\r\n        </Dialog>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"flex-1 flex flex-col p-0 overflow-hidden min-h-0\">\r\n        <ScrollArea className=\"flex-1 p-4 overflow-y-auto\" style={{ height: '460px', maxHeight: '460px' }}>\r\n          <div className=\"space-y-4 pr-2\">\r\n            {messages.map(renderMessage)}\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        <div className=\"border-t p-3 flex-shrink-0 bg-white\">\r\n          <div className=\"flex space-x-2\">\r\n            <Input\r\n              value={petMessage}\r\n              onChange={(e) => setPetMessage(e.target.value)}\r\n              onKeyPress={handleKeyPress}\r\n              placeholder=\"Ask me anything or search your database...\"\r\n              className=\"flex-1\"\r\n              disabled={isTyping}\r\n            />\r\n            <Button \r\n              onClick={handleSendMessage} \r\n              disabled={!petMessage.trim() || isTyping}\r\n              className=\"bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700\"\r\n            >\r\n              {isTyping ? (\r\n                <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\" />\r\n              ) : (\r\n                <Send className=\"w-4 h-4\" />\r\n              )}\r\n            </Button>\r\n          </div>\r\n          \r\n          <div className=\"flex flex-wrap gap-1 mt-2 max-h-16 overflow-y-auto\">\r\n            <Button \r\n              variant=\"outline\" \r\n              size=\"sm\" \r\n              onClick={() => setPetMessage(\"Show me comprehensive lead analysis with scoring\")}\r\n              className=\"text-xs\"\r\n            >\r\n              <Search className=\"w-3 h-3 mr-1\" />\r\n              Lead Analysis\r\n            </Button>\r\n            <Button \r\n              variant=\"outline\" \r\n              size=\"sm\" \r\n              onClick={() => setPetMessage(\"Find all C-level executives and VPs\")}\r\n              className=\"text-xs\"\r\n            >\r\n              <Users className=\"w-3 h-3 mr-1\" />\r\n              Executive Search\r\n            </Button>\r\n            <Button \r\n              variant=\"outline\" \r\n              size=\"sm\" \r\n              onClick={() => setPetMessage(\"How do I use Apollo.io API for prospecting?\")}\r\n              className=\"text-xs\"\r\n            >\r\n              <Sparkles className=\"w-3 h-3 mr-1\" />\r\n              Apollo.io Guide\r\n            </Button>\r\n            <Button \r\n              variant=\"outline\" \r\n              size=\"sm\" \r\n              onClick={() => setCsvExportOpen(true)}\r\n              className=\"text-xs\"\r\n              disabled={!lastSearchQuery}\r\n              data-testid=\"button-csv-export\"\r\n            >\r\n              <Download className=\"w-3 h-3 mr-1\" />\r\n              Save Results\r\n            </Button>\r\n            <Button \r\n              variant=\"outline\" \r\n              size=\"sm\" \r\n              onClick={() => setCsvImportOpen(true)}\r\n              className=\"text-xs\"\r\n              data-testid=\"button-csv-import\"\r\n            >\r\n              <Upload className=\"w-3 h-3 mr-1\" />\r\n              Import CSV\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n      \r\n      {/* CSV Modals */}\r\n      <CsvExportModal \r\n        isOpen={csvExportOpen}\r\n        onClose={() => setCsvExportOpen(false)}\r\n        searchQuery={lastSearchQuery}\r\n        onExport={handleCsvExport}\r\n        isExporting={isExporting}\r\n      />\r\n      \r\n      <CsvImportModal \r\n        isOpen={csvImportOpen}\r\n        onClose={() => setCsvImportOpen(false)}\r\n        onImport={handleCsvImport}\r\n        isImporting={isImporting}\r\n      />\r\n    </Card>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\pawmate.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 17. Maximum allowed is 15.","line":179,"column":38,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":179,"endColumn":40},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 25. Maximum allowed is 15.","line":326,"column":59,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":326,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { \r\n  Heart, MessageCircle, Zap, Dog, Settings, Send, Sparkles, Bot,\r\n  Search, Database, Target, Phone, Mail, Building, Globe, \r\n  ExternalLink, Users, Filter, SortAsc, Grid, List, Download\r\n} from \"lucide-react\";\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { ModernContactCanvas } from './modern-contact-canvas';\r\n\r\ninterface Message {\r\n  id: string;\r\n  type: 'user' | 'bot' | 'search-results';\r\n  content: string;\r\n  timestamp: Date;\r\n  isTyping?: boolean;\r\n  searchResults?: any;\r\n  searchQuery?: string;\r\n}\r\n\r\nexport default function PawMate() {\r\n  const [petName, setPetName] = useState(() => localStorage.getItem('pawmate_pet_name') || \"Duggu\");\r\n  const [petType, setPetType] = useState(() => localStorage.getItem('pawmate_pet_type') || \"dog\");\r\n  const [petMessage, setPetMessage] = useState(\"\");\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [isTyping, setIsTyping] = useState(false);\r\n  const [settingsOpen, setSettingsOpen] = useState(false);\r\n  const [isUsingRealAI, setIsUsingRealAI] = useState<boolean | null>(null);\r\n  const [sessionId, setSessionId] = useState<string | null>(() => localStorage.getItem('pawmate_session_id'));\r\n  const [searchResults, setSearchResults] = useState<any>(null);\r\n  const [showSearchResults, setShowSearchResults] = useState(false);\r\n  const [searchView, setSearchView] = useState<'cards' | 'table'>('cards');\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Auto-scroll to bottom when new messages arrive\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  // Load chat history on component mount\r\n  useEffect(() => {\r\n    const loadChatHistory = async () => {\r\n      if (sessionId) {\r\n        try {\r\n          const response = await fetch(`/api/pawmate/sessions/${sessionId}/history`);\r\n          if (response.ok) {\r\n            const history = await response.json();\r\n            if (history.length > 0) {\r\n              const formattedMessages: Message[] = history.map((msg: any) => ({\r\n                id: msg.id.toString(),\r\n                type: msg.role === 'user' ? 'user' : 'bot',\r\n                content: msg.content,\r\n                timestamp: new Date(msg.createdAt)\r\n              }));\r\n              setMessages(formattedMessages);\r\n              return; // Don't load welcome message if history exists\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('Failed to load chat history:', error);\r\n        }\r\n      }\r\n      \r\n      // Load welcome message only if no history loaded\r\n      if (messages.length === 0) {\r\n        setMessages([{\r\n          id: '1',\r\n          type: 'bot',\r\n          content: `ðŸ‘‹ Welcome! I'm ${petName || 'Duggu'}, your AI-powered lead intelligence assistant with direct database access. \r\n\r\n**ðŸ” Advanced Search Capabilities:**\r\nâ€¢ Search through 263+ contact records instantly\r\nâ€¢ Find complete contact details with phone numbers\r\nâ€¢ Filter by name, email, phone, company, title\r\nâ€¢ Real-time search through encrypted campaign data\r\nâ€¢ Advanced data visualization for large datasets\r\n\r\n**ðŸ’¬ Conversational AI:**\r\nâ€¢ Natural business intelligence conversations\r\nâ€¢ Lead scoring and analysis insights\r\nâ€¢ Campaign optimization recommendations\r\nâ€¢ Market analysis and prospect evaluation\r\n\r\n**Try these commands:**\r\nâ€¢ \"search delonza\" - Find specific contacts with full details\r\nâ€¢ \"find all CEOs\" - Search by job titles\r\nâ€¢ \"show contacts at Dakkota\" - Company-based searches\r\nâ€¢ \"What's the best lead scoring strategy?\" - AI conversation\r\n\r\nI automatically detect whether you want to search or chat - just type naturally!`,\r\n          timestamp: new Date()\r\n        }]);\r\n      }\r\n    };\r\n\r\n    loadChatHistory();\r\n  }, [sessionId, petType, petName]); // Don't include messages.length to avoid infinite loop\r\n\r\n  // Helper function to get pet icon\r\n  const getPetIcon = (petType: string): string => {\r\n    switch (petType?.toLowerCase()) {\r\n      case 'dog': return 'ðŸ•';\r\n      case 'cat': return 'ðŸ±';\r\n      case 'bird': return 'ðŸ¦';\r\n      case 'fish': return 'ðŸ ';\r\n      case 'rabbit': return 'ðŸ°';\r\n      case 'hamster': return 'ðŸ¹';\r\n      default: return 'ðŸ•';\r\n    }\r\n  };\r\n\r\n  // Clear chat and create new session function\r\n  const clearChatHistory = async () => {\r\n    try {\r\n      // Create a new session\r\n      const newSessionId = `pawmate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n      setSessionId(newSessionId);\r\n      localStorage.setItem('pawmate_session_id', newSessionId);\r\n      \r\n      // Clear messages and show welcome message\r\n      const icon = getPetIcon(petType);\r\n      setMessages([{\r\n        id: '1',\r\n        type: 'bot',\r\n        content: `${icon} Welcome! I'm ${petName || 'Duggu'}, your intelligent lead scoring and contact analysis AI assistant created by Fallowl. I have full database access and can help you with:\\n\\n**ðŸ“Š Lead Scoring & Analysis**\\n- Score contacts by business value and conversion potential\\n- Identify C-level executives and decision-makers\\n- Analyze contact completeness and qualification\\n\\n**ðŸ” Database Intelligence**\\n- Search and analyze your uploaded contact data\\n- Generate insights from campaign data\\n- Contact enrichment and data quality assessment\\n\\n**ðŸŽ¯ Campaign Optimization**\\n- Prospect prioritization and segmentation\\n- Market analysis and competitive intelligence\\n- Outreach recommendations and lead qualification\\n\\nI have access to all your campaign and contact data - ready to help you identify the highest quality leads! What would you like to analyze?`,\r\n        timestamp: new Date()\r\n      }]);\r\n      \r\n    } catch (error) {\r\n      console.error('Failed to clear chat history:', error);\r\n    }\r\n  };\r\n\r\n  // Search query detection logic\r\n  const isSearchQuery = (query: string): boolean => {\r\n    const searchKeywords = [\r\n      'search', 'find', 'show', 'get', 'lookup', 'contact', 'contacts',\r\n      'phone', 'email', 'company', 'title', 'manager', 'ceo', 'director',\r\n      'vp', 'vice president', 'executive', 'list', 'all', 'who'\r\n    ];\r\n    \r\n    const lowerQuery = query.toLowerCase();\r\n    \r\n    // Check if query contains search keywords\r\n    const hasSearchKeywords = searchKeywords.some(keyword => \r\n      lowerQuery.includes(keyword)\r\n    );\r\n    \r\n    // Check if query looks like a name, email, or company\r\n    const looksLikeSearchTerm = (\r\n      /^[a-zA-Z\\s]{2,}$/.test(query.trim()) ||  // Name-like\r\n      /@/.test(query) ||                        // Email-like\r\n      /\\d{3,}/.test(query) ||                   // Phone-like\r\n      /\\b(corp|inc|llc|ltd|company|co)\\b/i.test(query) || // Company-like\r\n      /\\w+\\.\\w+@\\w+\\.\\w+/.test(query)          // More specific email pattern\r\n    );\r\n    \r\n    const result = hasSearchKeywords || looksLikeSearchTerm;\r\n    console.log(`ðŸ” Search detection for \"${query}\":`, {\r\n      hasSearchKeywords,\r\n      looksLikeSearchTerm,\r\n      isEmail: /@/.test(query),\r\n      result\r\n    });\r\n    \r\n    return result;\r\n  };\r\n\r\n  const handleSendMessage = async () => {\r\n    if (!petMessage.trim()) return;\r\n    \r\n    const userMessage: Message = {\r\n      id: Date.now().toString(),\r\n      type: 'user',\r\n      content: petMessage.trim(),\r\n      timestamp: new Date()\r\n    };\r\n\r\n    setMessages(prev => [...prev, userMessage]);\r\n    const query = petMessage.trim();\r\n    setPetMessage(\"\");\r\n    setIsTyping(true);\r\n\r\n    // Show typing indicator\r\n    const typingMessage: Message = {\r\n      id: (Date.now() + 1).toString(),\r\n      type: 'bot',\r\n      content: 'Analyzing query...',\r\n      timestamp: new Date(),\r\n      isTyping: true\r\n    };\r\n    setMessages(prev => [...prev, typingMessage]);\r\n\r\n    try {\r\n      // Determine if this should be a search or AI chat\r\n      if (isSearchQuery(query)) {\r\n        console.log('ðŸ” Detected search query:', query);\r\n        // Perform database search\r\n        const searchResponse = await fetch('/api/search', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ \r\n            query, \r\n            searchType: 'all', \r\n            limit: 100  // Increased limit for larger datasets\r\n          })\r\n        });\r\n        \r\n        if (searchResponse.ok) {\r\n          const searchData = await searchResponse.json();\r\n          console.log('ðŸ“Š Search results:', searchData);\r\n          \r\n          if (searchData.total > 0) {\r\n            const searchResultMessage: Message = {\r\n              id: Date.now().toString(),\r\n              type: 'search-results',\r\n              content: `ðŸ” Found ${searchData.total} results for \"${query}\"`,\r\n              searchResults: searchData,\r\n              searchQuery: query,\r\n              timestamp: new Date()\r\n            };\r\n            \r\n            // Remove typing indicator and add search results\r\n            setMessages(prev => prev.slice(0, -1).concat([searchResultMessage]));\r\n            setIsTyping(false);\r\n            return;\r\n          } else {\r\n            console.log('âŒ No search results found, checking if this was a specific contact search');\r\n            // If this looks like a specific contact search (email, name), inform user about not found\r\n            if (/@/.test(query) || /^[a-zA-Z\\s]{2,}$/.test(query.trim())) {\r\n              const notFoundMessage: Message = {\r\n                id: Date.now().toString(),\r\n                type: 'bot',\r\n                content: `I searched the database but couldn't find \"${query}\" in your contact records. Please check the spelling or try searching for a contact that exists in your uploaded campaign data.`,\r\n                timestamp: new Date()\r\n              };\r\n              setMessages(prev => prev.slice(0, -1).concat([notFoundMessage]));\r\n              setIsTyping(false);\r\n              return;\r\n            }\r\n          }\r\n        } else {\r\n          console.log('âŒ Search API failed, falling back to AI chat');\r\n        }\r\n      } else {\r\n        console.log('ðŸ’¬ Not detected as search query, using AI chat for:', query);\r\n      }\r\n      \r\n      // If no search results or not a search query, use AI chat\r\n      const conversationHistory = [...messages, userMessage].map(msg => ({\r\n        role: msg.type === 'user' ? 'user' as const : 'assistant' as const,\r\n        content: msg.content\r\n      }));\r\n\r\n      const systemMessage = {\r\n        role: 'system' as const,\r\n        content: `You are Duggu, an expert lead scoring and business intelligence AI assistant created by Fallowl. Focus exclusively on lead analysis, contact intelligence, and campaign optimization. Provide direct, actionable business insights without generic recommendations.\r\n\r\nIMPORTANT: When users ask about specific contacts, emails, or companies that you don't have database access to verify, you must respond with: \"I searched the database but couldn't find that contact/email/company. Please verify the details or try searching for a contact that exists in your uploaded campaign data.\"\r\n\r\nNever provide synthetic or made-up contact information. Only discuss actual data from the user's database.`\r\n      };\r\n\r\n      const response = await fetch('/api/pawmate/chat', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          messages: [systemMessage, ...conversationHistory],\r\n          petName: petName || 'Duggu',\r\n          petType: 'assistant',\r\n          sessionId: sessionId || `pawmate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setIsUsingRealAI(data.isRealAI);\r\n        \r\n        // Update sessionId if it was returned from the backend\r\n        if (data.sessionId && data.sessionId !== sessionId) {\r\n          setSessionId(data.sessionId);\r\n          localStorage.setItem('pawmate_session_id', data.sessionId);\r\n        }\r\n        \r\n        let aiResponse = data.choices?.[0]?.message?.content || \"I'm having trouble responding right now. Please try again.\";\r\n        \r\n        // Clean up any unwanted recommendation sections\r\n        aiResponse = aiResponse.replace(/Recommendations?:[\\s\\S]*?(?=\\n\\n|$)/gi, '');\r\n        aiResponse = aiResponse.replace(/Next Steps?:[\\s\\S]*?(?=\\n\\n|$)/gi, '');\r\n        \r\n        const botMessage: Message = {\r\n          id: Date.now().toString(),\r\n          type: 'bot',\r\n          content: aiResponse,\r\n          timestamp: new Date()\r\n        };\r\n        \r\n        // Remove typing indicator and add AI response\r\n        setMessages(prev => prev.slice(0, -1).concat([botMessage]));\r\n      }\r\n    } catch (error) {\r\n      console.error('Message processing failed:', error);\r\n      setMessages(prev => prev.slice(0, -1).concat([{\r\n        id: Date.now().toString(),\r\n        type: 'bot',\r\n        content: \"I encountered an error processing your request. Please try again.\",\r\n        timestamp: new Date()\r\n      }]));\r\n    } finally {\r\n      setIsTyping(false);\r\n    }\r\n  };\r\n\r\n  const generateBotResponse = (userInput: string): string => {\r\n    const input = userInput.toLowerCase();\r\n    \r\n    if (input.includes('health') || input.includes('sick') || input.includes('vet')) {\r\n      return `ðŸ¥ For health concerns, I recommend consulting with a veterinarian. Meanwhile, ensure ${petName || 'your pet'} has fresh water, proper nutrition, and regular exercise. Watch for any changes in behavior or appetite.`;\r\n    }\r\n    \r\n    if (input.includes('food') || input.includes('eat') || input.includes('nutrition')) {\r\n      return `ðŸ– Great question about nutrition! ${petName || 'Your pet'} needs a balanced diet appropriate for their age and size. Avoid chocolate, grapes, onions, and garlic. Fresh water should always be available!`;\r\n    }\r\n    \r\n    if (input.includes('exercise') || input.includes('walk') || input.includes('play')) {\r\n      return `ðŸŽ¾ Exercise is fantastic for pets! Try interactive toys, fetch games, or nature walks. ${petName || 'Your pet'} will love the mental and physical stimulation. Aim for at least 30 minutes of activity daily!`;\r\n    }\r\n    \r\n    if (input.includes('training') || input.includes('behavior')) {\r\n      return `ðŸŽ¯ Training tip: Use positive reinforcement with treats and praise! Be consistent and patient. Short, frequent sessions work best. ${petName || 'Your pet'} is learning and wants to please you!`;\r\n    }\r\n    \r\n    if (input.includes('grooming') || input.includes('bath') || input.includes('brush')) {\r\n      return `âœ¨ Regular grooming keeps ${petName || 'your pet'} healthy and happy! Brush regularly to prevent matting, trim nails carefully, and bathe when needed. Make it a positive experience with treats and gentle handling.`;\r\n    }\r\n\r\n    // Default responses with personality\r\n    const responses = [\r\n      `ðŸ• That's interesting! Tell me more about ${petName || 'your pet'} - I'd love to help you both!`,\r\n      `ðŸŽ‰ ${petName || 'Your furry friend'} is lucky to have such a caring owner! What specific help do you need?`,\r\n      `ðŸ¾ I'm here to help with anything pet-related! Whether it's training, health, or just fun activities for ${petName || 'your companion'}.`,\r\n      `ðŸ’ Every pet is special! ${petName || 'Your pet'} must bring so much joy to your life. How can I assist you today?`,\r\n      `ðŸŒŸ Great question! I'm always excited to chat about pets. ${petName || 'Your buddy'} sounds wonderful!`\r\n    ];\r\n    \r\n    return responses[Math.floor(Math.random() * responses.length)];\r\n  };\r\n\r\n  const savePetSettings = () => {\r\n    localStorage.setItem('pawmate_pet_name', petName);\r\n    localStorage.setItem('pawmate_pet_type', petType);\r\n    setSettingsOpen(false);\r\n    \r\n    // Add welcome message if pet name was just set\r\n    if (petName && messages.length === 1) {\r\n      const welcomeMessage: Message = {\r\n        id: (Date.now()).toString(),\r\n        type: 'bot',\r\n        content: `Nice to meet ${petName}! ðŸŽ¾ I'm so excited to help you take care of your ${petType}. Would you like some fun activity ideas or health tips?`,\r\n        timestamp: new Date()\r\n      };\r\n      setMessages(prev => [...prev, welcomeMessage]);\r\n    }\r\n  };\r\n\r\n\r\n\r\n  return (\r\n    <div className=\"max-w-6xl mx-auto space-y-6\">\r\n      {/* Settings Dialog */}\r\n      <div className=\"flex justify-end\">\r\n        <Dialog open={settingsOpen} onOpenChange={setSettingsOpen}>\r\n          <DialogTrigger asChild>\r\n            <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\r\n              <Settings className=\"h-4 w-4\" />\r\n              Pet Settings\r\n            </Button>\r\n          </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n              <DialogHeader>\r\n                <DialogTitle>Pet Settings</DialogTitle>\r\n              </DialogHeader>\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <Label htmlFor=\"pet-name\">Pet Name</Label>\r\n                  <Input\r\n                    id=\"pet-name\"\r\n                    placeholder=\"What's your pet's name?\"\r\n                    value={petName}\r\n                    onChange={(e) => setPetName(e.target.value)}\r\n                    data-testid=\"input-settings-pet-name\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <Label htmlFor=\"pet-type\">Pet Type</Label>\r\n                  <Select value={petType} onValueChange={setPetType}>\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Select pet type\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"dog\">Dog ðŸ•</SelectItem>\r\n                      <SelectItem value=\"cat\">Cat ðŸ±</SelectItem>\r\n                      <SelectItem value=\"bird\">Bird ðŸ¦</SelectItem>\r\n                      <SelectItem value=\"fish\">Fish ðŸ </SelectItem>\r\n                      <SelectItem value=\"rabbit\">Rabbit ðŸ°</SelectItem>\r\n                      <SelectItem value=\"hamster\">Hamster ðŸ¹</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <Button onClick={savePetSettings} className=\"w-full\" data-testid=\"button-save-settings\">\r\n                  Save Settings\r\n                </Button>\r\n              </div>\r\n            </DialogContent>\r\n          </Dialog>\r\n      </div>\r\n\r\n      {/* Advanced Chat Interface */}\r\n      <Card className=\"bg-white/80 backdrop-blur-sm border-slate-200 shadow-xl\">\r\n        <CardHeader className=\"bg-gradient-to-r from-orange-50 to-red-50 border-b border-orange-100 py-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"w-10 h-10 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center shadow-lg\">\r\n                <span className=\"text-lg\">{getPetIcon(petType)}</span>\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-bold text-slate-900\">{petName || 'Duggu'}</h3>\r\n                <p className=\"text-xs text-slate-600 capitalize\">\r\n                  {petName ? `Your Adorable ${petType}` : 'Your Lead Scoring Assistant'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 font-medium\">\r\n                OpenAI GPT-4\r\n              </span>\r\n              <div className=\"flex items-center gap-1 text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full\">\r\n                <div className=\"w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse\"></div>\r\n                Online\r\n              </div>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={clearChatHistory}\r\n                className=\"text-xs px-2 py-1 h-6 text-slate-500 hover:text-slate-700\"\r\n                title=\"Start new conversation\"\r\n              >\r\n                New Chat\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n        \r\n        <CardContent className=\"p-0 max-w-full\">\r\n          {/* Messages Container */}\r\n          <div className=\"h-[500px] overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-slate-50/50 to-white\">\r\n            {messages.map((message) => (\r\n              <div\r\n                key={message.id}\r\n                className={`flex items-start gap-3 ${\r\n                  message.type === 'user' ? 'flex-row-reverse' : ''\r\n                }`}\r\n              >\r\n                <Avatar className={`h-8 w-8 ${message.type === 'user' ? 'ring-2 ring-blue-200' : ''}`}>\r\n                  <AvatarFallback className={\r\n                    message.type === 'user' \r\n                      ? \"bg-blue-100 text-blue-600\" \r\n                      : \"bg-gradient-to-br from-orange-400 to-red-500 text-white\"\r\n                  }>\r\n                    {message.type === 'user' ? (\r\n                      <span className=\"text-sm font-semibold\">U</span>\r\n                    ) : (\r\n                      <span className=\"text-sm\">{getPetIcon(petType)}</span>\r\n                    )}\r\n                  </AvatarFallback>\r\n                </Avatar>\r\n                \r\n                <div className={`flex-1 max-w-sm sm:max-w-lg ${message.type === 'user' ? 'text-right' : ''}`}>\r\n                  <div className={`rounded-lg p-2 shadow-sm ${\r\n                    message.type === 'user'\r\n                      ? 'bg-blue-500 text-white ml-auto'\r\n                      : 'bg-white border border-slate-200'\r\n                  }`}>\r\n                    {message.type === 'user' ? (\r\n                      <p className=\"text-sm text-white whitespace-pre-wrap\">\r\n                        {message.content}\r\n                      </p>\r\n                    ) : (\r\n                      <div>\r\n                        {/* Regular chat message */}\r\n                        <div className=\"text-sm text-slate-800 prose prose-sm max-w-none\">\r\n                          <ReactMarkdown \r\n                            components={{\r\n                              p: ({ children }) => <p className=\"mb-3 last:mb-0 leading-relaxed text-slate-700\">{children}</p>,\r\n                              ul: ({ children }) => <ul className=\"list-disc list-inside mb-3 space-y-2 pl-2\">{children}</ul>,\r\n                              ol: ({ children }) => <ol className=\"list-decimal list-inside mb-3 space-y-2 pl-2\">{children}</ol>,\r\n                              li: ({ children }) => <li className=\"text-sm text-slate-700 leading-relaxed\">{children}</li>,\r\n                              strong: ({ children }) => <strong className=\"font-bold text-slate-900\">{children}</strong>,\r\n                              em: ({ children }) => <em className=\"font-medium text-slate-800\">{children}</em>,\r\n                              h1: ({ children }) => <h1 className=\"text-lg font-bold mb-3 text-slate-900 border-b border-slate-200 pb-1\">{children}</h1>,\r\n                              h2: ({ children }) => <h2 className=\"text-base font-bold mb-2 text-slate-900\">{children}</h2>,\r\n                              h3: ({ children }) => <h3 className=\"text-sm font-bold mb-2 text-slate-800\">{children}</h3>,\r\n                              h4: ({ children }) => <h4 className=\"text-sm font-semibold mb-1 text-slate-700\">{children}</h4>,\r\n                              code: ({ children, inline }: any) => \r\n                                inline \r\n                                  ? <code className=\"bg-orange-50 text-orange-800 px-1.5 py-0.5 rounded text-xs font-mono border border-orange-200\">{children}</code>\r\n                                  : <pre className=\"bg-slate-100 p-3 rounded-lg mb-3 overflow-x-auto border\"><code className=\"text-xs font-mono text-slate-800\">{children}</code></pre>,\r\n                              blockquote: ({ children }) => <blockquote className=\"border-l-4 border-orange-300 pl-4 py-2 mb-3 bg-orange-50 rounded-r-lg\">{children}</blockquote>,\r\n                              hr: () => <hr className=\"my-4 border-slate-200\" />,\r\n                              table: ({ children }) => <table className=\"w-full border-collapse border border-slate-200 mb-3 rounded-lg overflow-hidden\">{children}</table>,\r\n                              th: ({ children }) => <th className=\"border border-slate-200 px-3 py-2 bg-slate-50 font-semibold text-left text-sm\">{children}</th>,\r\n                              td: ({ children }) => <td className=\"border border-slate-200 px-3 py-2 text-sm\">{children}</td>,\r\n                              a: ({ children, href }) => <a href={href} className=\"text-orange-600 hover:text-orange-700 underline font-medium\" target=\"_blank\" rel=\"noopener noreferrer\">{children}</a>\r\n                            }}\r\n                          >\r\n                            {message.content}\r\n                          </ReactMarkdown>\r\n                        </div>\r\n                        \r\n                        {/* Modern Contact Canvas for search results */}\r\n                        {message.type === 'search-results' && message.searchResults && (\r\n                          <div className=\"mt-4\">\r\n                            {(() => {\r\n                              const allContacts = [\r\n                                ...(message.searchResults.contacts || []),\r\n                                ...(message.searchResults.campaignData?.flatMap((cd: any) => cd.matches || []) || [])\r\n                              ];\r\n                              \r\n                              if (allContacts.length > 0) {\r\n                                return (\r\n                                  <ModernContactCanvas \r\n                                    contacts={allContacts}\r\n                                    campaignName={message.searchResults.campaignData?.[0]?.campaignName || 'Search Results'}\r\n                                    className=\"max-w-full\"\r\n                                  />\r\n                                );\r\n                              }\r\n                              return null;\r\n                            })()}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  <p className=\"text-xs text-slate-500 mt-1\">\r\n                    {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n            \r\n            {/* Typing Indicator */}\r\n            {isTyping && (\r\n              <div className=\"flex items-start gap-3\">\r\n                <Avatar className=\"h-8 w-8\">\r\n                  <AvatarFallback className=\"bg-gradient-to-br from-orange-400 to-red-500 text-white\">\r\n                    <span className=\"text-sm\">{getPetIcon(petType)}</span>\r\n                  </AvatarFallback>\r\n                </Avatar>\r\n                <div className=\"flex-1\">\r\n                  <div className=\"bg-white border border-slate-200 rounded-lg p-2 shadow-sm\">\r\n                    <div className=\"flex items-center space-x-1\">\r\n                      <div className=\"flex space-x-1\">\r\n                        <div className=\"w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce\" style={{ animationDelay: '0ms' }}></div>\r\n                        <div className=\"w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce\" style={{ animationDelay: '150ms' }}></div>\r\n                        <div className=\"w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce\" style={{ animationDelay: '300ms' }}></div>\r\n                      </div>\r\n                      <span className=\"text-xs text-slate-500 ml-2\">Duggu is analyzing...</span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n            \r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n\r\n          {/* Message Input */}\r\n          <div className=\"p-4 border-t bg-white/50 backdrop-blur-sm\">\r\n            <div className=\"flex gap-3\">\r\n              <div className=\"flex-1 relative\">\r\n                <Textarea\r\n                  placeholder=\"Ask about lead scoring, contact analysis, or campaign optimization...\"\r\n                  value={petMessage}\r\n                  onChange={(e) => setPetMessage(e.target.value)}\r\n                  className=\"resize-none min-h-[50px] max-h-24 pr-12 border-slate-300 focus:border-orange-400 focus:ring-1 focus:ring-orange-400 text-sm\"\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter' && !e.shiftKey) {\r\n                      e.preventDefault();\r\n                      handleSendMessage();\r\n                    }\r\n                  }}\r\n                  data-testid=\"textarea-chat-message\"\r\n                />\r\n                <Button\r\n                  onClick={handleSendMessage}\r\n                  disabled={!petMessage.trim() || isTyping}\r\n                  size=\"sm\"\r\n                  className=\"absolute right-2 bottom-2 h-8 w-8 p-0 rounded-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 shadow-lg\"\r\n                  data-testid=\"button-send-chat\"\r\n                >\r\n                  <Send className=\"h-4 w-4\" />\r\n                </Button>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-xs text-slate-500 mt-2\">Press Enter to send, Shift+Enter for new line</p>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\aspect-ratio.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\carousel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\chart.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 16. Maximum allowed is 15.","line":136,"column":43,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":136,"endColumn":45},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 20. Maximum allowed is 15.","line":188,"column":38,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":188,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport * as RechartsPrimitive from \"recharts\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// Format: { THEME_NAME: CSS_SELECTOR }\r\nconst THEMES = { light: \"\", dark: \".dark\" } as const\r\n\r\nexport type ChartConfig = {\r\n  [k in string]: {\r\n    label?: React.ReactNode\r\n    icon?: React.ComponentType\r\n  } & (\r\n    | { color?: string; theme?: never }\r\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\r\n  )\r\n}\r\n\r\ntype ChartContextProps = {\r\n  config: ChartConfig\r\n}\r\n\r\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\r\n\r\nfunction useChart() {\r\n  const context = React.useContext(ChartContext)\r\n\r\n  if (!context) {\r\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\r\n  }\r\n\r\n  return context\r\n}\r\n\r\nconst ChartContainer = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    config: ChartConfig\r\n    children: React.ComponentProps<\r\n      typeof RechartsPrimitive.ResponsiveContainer\r\n    >[\"children\"]\r\n  }\r\n>(({ id, className, children, config, ...props }, ref) => {\r\n  const uniqueId = React.useId()\r\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\r\n\r\n  return (\r\n    <ChartContext.Provider value={{ config }}>\r\n      <div\r\n        data-chart={chartId}\r\n        ref={ref}\r\n        className={cn(\r\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\r\n          className\r\n        )}\r\n        {...props}\r\n      >\r\n        <ChartStyle id={chartId} config={config} />\r\n        <RechartsPrimitive.ResponsiveContainer>\r\n          {children}\r\n        </RechartsPrimitive.ResponsiveContainer>\r\n      </div>\r\n    </ChartContext.Provider>\r\n  )\r\n})\r\nChartContainer.displayName = \"Chart\"\r\n\r\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\r\n  const colorConfig = Object.entries(config).filter(\r\n    ([, config]) => config.theme || config.color\r\n  )\r\n\r\n  if (!colorConfig.length) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <style\r\n      dangerouslySetInnerHTML={{\r\n        __html: Object.entries(THEMES)\r\n          .map(\r\n            ([theme, prefix]) => `\r\n${prefix} [data-chart=${id}] {\r\n${colorConfig\r\n  .map(([key, itemConfig]) => {\r\n    const color =\r\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\r\n      itemConfig.color\r\n    return color ? `  --color-${key}: ${color};` : null\r\n  })\r\n  .join(\"\\n\")}\r\n}\r\n`\r\n          )\r\n          .join(\"\\n\"),\r\n      }}\r\n    />\r\n  )\r\n}\r\n\r\nconst ChartTooltip = RechartsPrimitive.Tooltip\r\n\r\nconst ChartTooltipContent = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\r\n    React.ComponentProps<\"div\"> & {\r\n      hideLabel?: boolean\r\n      hideIndicator?: boolean\r\n      indicator?: \"line\" | \"dot\" | \"dashed\"\r\n      nameKey?: string\r\n      labelKey?: string\r\n    }\r\n>(\r\n  (\r\n    {\r\n      active,\r\n      payload,\r\n      className,\r\n      indicator = \"dot\",\r\n      hideLabel = false,\r\n      hideIndicator = false,\r\n      label,\r\n      labelFormatter,\r\n      labelClassName,\r\n      formatter,\r\n      color,\r\n      nameKey,\r\n      labelKey,\r\n    },\r\n    ref\r\n  ) => {\r\n    const { config } = useChart()\r\n\r\n    const tooltipLabel = React.useMemo(() => {\r\n      if (hideLabel || !payload?.length) {\r\n        return null\r\n      }\r\n\r\n      const [item] = payload\r\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\r\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\r\n      const value =\r\n        !labelKey && typeof label === \"string\"\r\n          ? config[label as keyof typeof config]?.label || label\r\n          : itemConfig?.label\r\n\r\n      if (labelFormatter) {\r\n        return (\r\n          <div className={cn(\"font-medium\", labelClassName)}>\r\n            {labelFormatter(value, payload)}\r\n          </div>\r\n        )\r\n      }\r\n\r\n      if (!value) {\r\n        return null\r\n      }\r\n\r\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\r\n    }, [\r\n      label,\r\n      labelFormatter,\r\n      payload,\r\n      hideLabel,\r\n      labelClassName,\r\n      config,\r\n      labelKey,\r\n    ])\r\n\r\n    if (!active || !payload?.length) {\r\n      return null\r\n    }\r\n\r\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\r\n\r\n    return (\r\n      <div\r\n        ref={ref}\r\n        className={cn(\r\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\r\n          className\r\n        )}\r\n      >\r\n        {!nestLabel ? tooltipLabel : null}\r\n        <div className=\"grid gap-1.5\">\r\n          {payload.map((item, index) => {\r\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\r\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\r\n            const indicatorColor = color || item.payload.fill || item.color\r\n\r\n            return (\r\n              <div\r\n                key={item.dataKey}\r\n                className={cn(\r\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\r\n                  indicator === \"dot\" && \"items-center\"\r\n                )}\r\n              >\r\n                {formatter && item?.value !== undefined && item.name ? (\r\n                  formatter(item.value, item.name, item, index, item.payload)\r\n                ) : (\r\n                  <>\r\n                    {itemConfig?.icon ? (\r\n                      <itemConfig.icon />\r\n                    ) : (\r\n                      !hideIndicator && (\r\n                        <div\r\n                          className={cn(\r\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\r\n                            {\r\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\r\n                              \"w-1\": indicator === \"line\",\r\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\r\n                                indicator === \"dashed\",\r\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\r\n                            }\r\n                          )}\r\n                          style={\r\n                            {\r\n                              \"--color-bg\": indicatorColor,\r\n                              \"--color-border\": indicatorColor,\r\n                            } as React.CSSProperties\r\n                          }\r\n                        />\r\n                      )\r\n                    )}\r\n                    <div\r\n                      className={cn(\r\n                        \"flex flex-1 justify-between leading-none\",\r\n                        nestLabel ? \"items-end\" : \"items-center\"\r\n                      )}\r\n                    >\r\n                      <div className=\"grid gap-1.5\">\r\n                        {nestLabel ? tooltipLabel : null}\r\n                        <span className=\"text-muted-foreground\">\r\n                          {itemConfig?.label || item.name}\r\n                        </span>\r\n                      </div>\r\n                      {item.value && (\r\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\r\n                          {item.value.toLocaleString()}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n)\r\nChartTooltipContent.displayName = \"ChartTooltip\"\r\n\r\nconst ChartLegend = RechartsPrimitive.Legend\r\n\r\nconst ChartLegendContent = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> &\r\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\r\n      hideIcon?: boolean\r\n      nameKey?: string\r\n    }\r\n>(\r\n  (\r\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\r\n    ref\r\n  ) => {\r\n    const { config } = useChart()\r\n\r\n    if (!payload?.length) {\r\n      return null\r\n    }\r\n\r\n    return (\r\n      <div\r\n        ref={ref}\r\n        className={cn(\r\n          \"flex items-center justify-center gap-4\",\r\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\r\n          className\r\n        )}\r\n      >\r\n        {payload.map((item) => {\r\n          const key = `${nameKey || item.dataKey || \"value\"}`\r\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\r\n\r\n          return (\r\n            <div\r\n              key={item.value}\r\n              className={cn(\r\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\r\n              )}\r\n            >\r\n              {itemConfig?.icon && !hideIcon ? (\r\n                <itemConfig.icon />\r\n              ) : (\r\n                <div\r\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\r\n                  style={{\r\n                    backgroundColor: item.color,\r\n                  }}\r\n                />\r\n              )}\r\n              {itemConfig?.label}\r\n            </div>\r\n          )\r\n        })}\r\n      </div>\r\n    )\r\n  }\r\n)\r\nChartLegendContent.displayName = \"ChartLegend\"\r\n\r\n// Helper to extract item config from a payload.\r\nfunction getPayloadConfigFromPayload(\r\n  config: ChartConfig,\r\n  payload: unknown,\r\n  key: string\r\n) {\r\n  if (typeof payload !== \"object\" || payload === null) {\r\n    return undefined\r\n  }\r\n\r\n  const payloadPayload =\r\n    \"payload\" in payload &&\r\n    typeof payload.payload === \"object\" &&\r\n    payload.payload !== null\r\n      ? payload.payload\r\n      : undefined\r\n\r\n  let configLabelKey: string = key\r\n\r\n  if (\r\n    key in payload &&\r\n    typeof payload[key as keyof typeof payload] === \"string\"\r\n  ) {\r\n    configLabelKey = payload[key as keyof typeof payload] as string\r\n  } else if (\r\n    payloadPayload &&\r\n    key in payloadPayload &&\r\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\r\n  ) {\r\n    configLabelKey = payloadPayload[\r\n      key as keyof typeof payloadPayload\r\n    ] as string\r\n  }\r\n\r\n  return configLabelKey in config\r\n    ? config[configLabelKey]\r\n    : config[key as keyof typeof config]\r\n}\r\n\r\nexport {\r\n  ChartContainer,\r\n  ChartTooltip,\r\n  ChartTooltipContent,\r\n  ChartLegend,\r\n  ChartLegendContent,\r\n  ChartStyle,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\command.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\context-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\hover-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\input-otp.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\menubar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\navigation-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\resizable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\toaster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\toggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\components\\unified-chatbot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\hooks\\use-mobile.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\hooks\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\hooks\\use-websocket.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\lib\\encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\lib\\queryClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\BackupImport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\about.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin-dashboard.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'AdminDashboard' has a complexity of 17. Maximum allowed is 15.","line":33,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":33,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { useLocation } from \"wouter\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { \r\n  Upload, \r\n  Pencil, \r\n  Trash2,\r\n  Eye,\r\n  Plus,\r\n  FileText,\r\n  Calendar,\r\n  Database\r\n} from \"lucide-react\";\r\nimport { Link } from \"wouter\";\r\nimport AdminLayout from \"./admin/AdminLayout\";\r\n\r\ninterface Campaign {\r\n  id: number;\r\n  name: string;\r\n  recordCount: number;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport default function AdminDashboard() {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n  const [editDialog, setEditDialog] = useState<{ open: boolean; campaign?: Campaign }>({ open: false });\r\n  const [deleteDialog, setDeleteDialog] = useState<{ open: boolean; campaign?: Campaign }>({ open: false });\r\n  const [uploadDialog, setUploadDialog] = useState(false);\r\n  const [editName, setEditName] = useState(\"\");\r\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n  const [uploadName, setUploadName] = useState(\"\");\r\n\r\n  // Fetch campaigns\r\n  const { data: campaigns, isLoading } = useQuery<Campaign[]>({\r\n    queryKey: ['campaigns'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/campaigns');\r\n      return response.json();\r\n    }\r\n  });\r\n\r\n  // Delete mutation\r\n  const deleteMutation = useMutation({\r\n    mutationFn: async (id: number) => {\r\n      const response = await apiRequest('DELETE', `/api/campaigns/${id}`);\r\n      return response.json();\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['campaigns'] });\r\n      toast({\r\n        title: \"Campaign deleted\",\r\n        description: \"Campaign has been successfully deleted.\",\r\n      });\r\n      setDeleteDialog({ open: false });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to delete campaign.\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n\r\n  // Edit mutation\r\n  const editMutation = useMutation({\r\n    mutationFn: async ({ id, name }: { id: number; name: string }) => {\r\n      const response = await apiRequest('PATCH', `/api/campaigns/${id}`, { name });\r\n      return response.json();\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['campaigns'] });\r\n      toast({\r\n        title: \"Campaign updated\",\r\n        description: \"Campaign name has been successfully updated.\",\r\n      });\r\n      setEditDialog({ open: false });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to update campaign.\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n\r\n  // Upload mutation\r\n  const uploadMutation = useMutation({\r\n    mutationFn: async (formData: FormData) => {\r\n      const response = await fetch('/api/campaigns/upload', {\r\n        method: 'POST',\r\n        body: formData,\r\n        credentials: 'include',\r\n      });\r\n      if (!response.ok) {\r\n        const error = await response.json();\r\n        throw new Error(error.message || 'Upload failed');\r\n      }\r\n      return response.json();\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['campaigns'] });\r\n      toast({\r\n        title: \"Campaign uploaded\",\r\n        description: \"Campaign has been successfully uploaded.\",\r\n      });\r\n      setUploadDialog(false);\r\n      setSelectedFile(null);\r\n      setUploadName(\"\");\r\n    },\r\n    onError: (error: Error) => {\r\n      toast({\r\n        title: \"Upload failed\",\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n\r\n  const handleEdit = (campaign: Campaign) => {\r\n    setEditDialog({ open: true, campaign });\r\n    setEditName(campaign.name);\r\n  };\r\n\r\n  const handleDelete = (campaign: Campaign) => {\r\n    setDeleteDialog({ open: true, campaign });\r\n  };\r\n\r\n  const handleUpload = () => {\r\n    if (!selectedFile || !uploadName.trim()) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Please select a file and enter a campaign name.\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const formData = new FormData();\r\n    formData.append('csv', selectedFile);\r\n    formData.append('name', uploadName);\r\n    formData.append('fieldMappings', JSON.stringify({}));\r\n\r\n    uploadMutation.mutate(formData);\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString('en-US', {\r\n      year: 'numeric',\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900\">Dashboard Overview</h1>\r\n          <p className=\"text-slate-600 mt-1\">Manage campaigns and monitor system activity</p>\r\n        </div>\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Campaigns</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"flex items-center\">\r\n                <Database className=\"w-5 h-5 text-blue-600 mr-2\" />\r\n                <span className=\"text-3xl font-bold text-slate-900\">{campaigns?.length || 0}</span>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          \r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Records</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"flex items-center\">\r\n                <FileText className=\"w-5 h-5 text-purple-600 mr-2\" />\r\n                <span className=\"text-3xl font-bold text-slate-900\">\r\n                  {campaigns?.reduce((sum, c) => sum + c.recordCount, 0) || 0}\r\n                </span>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          \r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Last Updated</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"flex items-center\">\r\n                <Calendar className=\"w-5 h-5 text-green-600 mr-2\" />\r\n                <span className=\"text-lg font-semibold text-slate-900\">\r\n                  {campaigns && campaigns.length > 0\r\n                    ? new Date(Math.max(...campaigns.map(c => new Date(c.updatedAt || c.createdAt).getTime()))).toLocaleDateString()\r\n                    : 'N/A'}\r\n                </span>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Campaign Management Card */}\r\n        <Card>\r\n          <CardHeader>\r\n            <div className=\"flex justify-between items-center\">\r\n              <div>\r\n                <CardTitle>Campaign Management</CardTitle>\r\n                <CardDescription>View, edit, and manage all campaigns</CardDescription>\r\n              </div>\r\n              <Button onClick={() => setUploadDialog(true)}>\r\n                <Plus className=\"w-4 h-4 mr-2\" />\r\n                Upload Campaign\r\n              </Button>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {isLoading ? (\r\n              <div className=\"text-center py-12\">\r\n                <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                <p className=\"mt-4 text-slate-600\">Loading campaigns...</p>\r\n              </div>\r\n            ) : campaigns && campaigns.length > 0 ? (\r\n              <div className=\"rounded-lg border border-slate-200 overflow-hidden\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow className=\"bg-slate-50\">\r\n                      <TableHead className=\"font-semibold\">ID</TableHead>\r\n                      <TableHead className=\"font-semibold\">Campaign Name</TableHead>\r\n                      <TableHead className=\"font-semibold\">Records</TableHead>\r\n                      <TableHead className=\"font-semibold\">Created</TableHead>\r\n                      <TableHead className=\"font-semibold\">Updated</TableHead>\r\n                      <TableHead className=\"font-semibold text-right\">Actions</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {campaigns.map((campaign) => (\r\n                      <TableRow key={campaign.id} className=\"hover:bg-slate-50\">\r\n                        <TableCell className=\"font-medium\">#{campaign.id}</TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center\">\r\n                            <FileText className=\"w-4 h-4 text-slate-400 mr-2\" />\r\n                            {campaign.name}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Badge variant=\"secondary\">{campaign.recordCount.toLocaleString()}</Badge>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-sm text-slate-600\">\r\n                          {formatDate(campaign.createdAt)}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-sm text-slate-600\">\r\n                          {formatDate(campaign.updatedAt || campaign.createdAt)}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex justify-end gap-2\">\r\n                            <Link href={`/campaign/${campaign.id}`}>\r\n                              <Button variant=\"outline\" size=\"sm\">\r\n                                <Eye className=\"w-4 h-4 mr-1\" />\r\n                                View\r\n                              </Button>\r\n                            </Link>\r\n                            <Button \r\n                              variant=\"outline\" \r\n                              size=\"sm\"\r\n                              onClick={() => handleEdit(campaign)}\r\n                            >\r\n                              <Pencil className=\"w-4 h-4 mr-1\" />\r\n                              Edit\r\n                            </Button>\r\n                            <Button \r\n                              variant=\"destructive\" \r\n                              size=\"sm\"\r\n                              onClick={() => handleDelete(campaign)}\r\n                            >\r\n                              <Trash2 className=\"w-4 h-4 mr-1\" />\r\n                              Delete\r\n                            </Button>\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-center py-12\">\r\n                <Upload className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\r\n                <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">No campaigns yet</h3>\r\n                <p className=\"text-slate-600 mb-6\">Upload your first campaign to get started</p>\r\n                <Button onClick={() => setUploadDialog(true)}>\r\n                  <Plus className=\"w-4 h-4 mr-2\" />\r\n                  Upload Campaign\r\n                </Button>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Dialogs */}\r\n        {/* Edit Dialog */}\r\n      <Dialog open={editDialog.open} onOpenChange={(open) => setEditDialog({ open })}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Edit Campaign</DialogTitle>\r\n            <DialogDescription>Update the campaign name</DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"py-4\">\r\n            <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Campaign Name\r\n            </label>\r\n            <Input\r\n              value={editName}\r\n              onChange={(e) => setEditName(e.target.value)}\r\n              placeholder=\"Enter campaign name\"\r\n            />\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setEditDialog({ open: false })}>\r\n              Cancel\r\n            </Button>\r\n            <Button \r\n              onClick={() => {\r\n                if (editDialog.campaign) {\r\n                  editMutation.mutate({ id: editDialog.campaign.id, name: editName });\r\n                }\r\n              }}\r\n              disabled={editMutation.isPending || !editName.trim()}\r\n            >\r\n              {editMutation.isPending ? \"Saving...\" : \"Save Changes\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <Dialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open })}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Delete Campaign</DialogTitle>\r\n            <DialogDescription>\r\n              Are you sure you want to delete \"{deleteDialog.campaign?.name}\"? This action cannot be undone.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setDeleteDialog({ open: false })}>\r\n              Cancel\r\n            </Button>\r\n            <Button \r\n              variant=\"destructive\"\r\n              onClick={() => {\r\n                if (deleteDialog.campaign) {\r\n                  deleteMutation.mutate(deleteDialog.campaign.id);\r\n                }\r\n              }}\r\n              disabled={deleteMutation.isPending}\r\n            >\r\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete Campaign\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Upload Dialog */}\r\n      <Dialog open={uploadDialog} onOpenChange={setUploadDialog}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Upload New Campaign</DialogTitle>\r\n            <DialogDescription>Upload a CSV file to create a new campaign</DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"py-4 space-y-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Campaign Name\r\n              </label>\r\n              <Input\r\n                value={uploadName}\r\n                onChange={(e) => setUploadName(e.target.value)}\r\n                placeholder=\"Enter campaign name\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                CSV File\r\n              </label>\r\n              <Input\r\n                type=\"file\"\r\n                accept=\".csv\"\r\n                onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}\r\n              />\r\n            </div>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setUploadDialog(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button \r\n              onClick={handleUpload}\r\n              disabled={uploadMutation.isPending || !selectedFile || !uploadName.trim()}\r\n            >\r\n              {uploadMutation.isPending ? (\r\n                <>\r\n                  <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2\" />\r\n                  Uploading...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Upload className=\"w-4 h-4 mr-2\" />\r\n                  Upload Campaign\r\n                </>\r\n              )}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\APIUsage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\ActivityLogs.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'ActivityLogs' has a complexity of 22. Maximum allowed is 15.","line":34,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":34,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Activity, Search, Filter, Calendar, User, FileText, Download, ChevronDown, ChevronRight, RefreshCw } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\r\n\r\ninterface ActivityLog {\r\n  id: number;\r\n  userId: string | null;\r\n  userRole: string | null;\r\n  activityType: string;\r\n  action: string;\r\n  resourceType: string | null;\r\n  resourceId: string | null;\r\n  details: any;\r\n  ipAddress: string | null;\r\n  userAgent: string | null;\r\n  createdAt: string;\r\n}\r\n\r\ninterface ActivityResponse {\r\n  activities: ActivityLog[];\r\n  total: number;\r\n  limit: number;\r\n  offset: number;\r\n}\r\n\r\nexport default function ActivityLogs() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [activityTypeFilter, setActivityTypeFilter] = useState(\"all\");\r\n  const [userRoleFilter, setUserRoleFilter] = useState(\"all\");\r\n  const [timeFilter, setTimeFilter] = useState(\"all\");\r\n  const [expandedRow, setExpandedRow] = useState<number | null>(null);\r\n  const [page, setPage] = useState(0);\r\n  const pageSize = 50;\r\n\r\n  const { data, isLoading, refetch } = useQuery<ActivityResponse>({\r\n    queryKey: ['activity-logs', page, activityTypeFilter, userRoleFilter, timeFilter],\r\n    queryFn: async () => {\r\n      const params = new URLSearchParams({\r\n        limit: pageSize.toString(),\r\n        offset: (page * pageSize).toString(),\r\n      });\r\n      \r\n      if (activityTypeFilter !== 'all') {\r\n        params.append('activityType', activityTypeFilter);\r\n      }\r\n      \r\n      if (userRoleFilter !== 'all') {\r\n        params.append('userRole', userRoleFilter);\r\n      }\r\n      \r\n      if (timeFilter !== 'all') {\r\n        const now = new Date();\r\n        let startDate: Date;\r\n        \r\n        switch (timeFilter) {\r\n          case 'today':\r\n            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n            break;\r\n          case 'week':\r\n            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n            break;\r\n          case 'month':\r\n            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n            break;\r\n          default:\r\n            startDate = new Date(0);\r\n        }\r\n        \r\n        params.append('startDate', startDate.toISOString());\r\n      }\r\n      \r\n      const response = await apiRequest('GET', `/api/admin/activity-logs?${params.toString()}`);\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const activities = data?.activities || [];\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit',\r\n      second: '2-digit'\r\n    });\r\n  };\r\n\r\n  const getActivityBadgeVariant = (type: string) => {\r\n    switch (type) {\r\n      case 'login': return 'default';\r\n      case 'logout': return 'secondary';\r\n      case 'view': return 'outline';\r\n      case 'edit': return 'default';\r\n      case 'delete': return 'destructive';\r\n      case 'upload': return 'default';\r\n      case 'download': return 'secondary';\r\n      case 'search': return 'outline';\r\n      default: return 'outline';\r\n    }\r\n  };\r\n\r\n  const filteredActivities = activities.filter(activity => {\r\n    const matchesSearch = \r\n      activity.action.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      activity.activityType.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      activity.userId?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      activity.resourceType?.toLowerCase().includes(searchTerm.toLowerCase());\r\n    \r\n    return matchesSearch;\r\n  });\r\n\r\n  const activityTypes = [...new Set(activities.map(a => a.activityType))];\r\n  const totalPages = data ? Math.ceil(data.total / pageSize) : 0;\r\n\r\n  const exportToCSV = async () => {\r\n    try {\r\n      // Fetch all filtered data from the server for complete export\r\n      const params = new URLSearchParams({\r\n        limit: '10000',\r\n        offset: '0',\r\n        exportAll: 'true'\r\n      });\r\n      \r\n      if (activityTypeFilter !== 'all') {\r\n        params.append('activityType', activityTypeFilter);\r\n      }\r\n      \r\n      if (userRoleFilter !== 'all') {\r\n        params.append('userRole', userRoleFilter);\r\n      }\r\n      \r\n      if (timeFilter !== 'all') {\r\n        const now = new Date();\r\n        let startDate: Date;\r\n        \r\n        switch (timeFilter) {\r\n          case 'today':\r\n            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n            break;\r\n          case 'week':\r\n            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n            break;\r\n          case 'month':\r\n            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n            break;\r\n          default:\r\n            startDate = new Date(0);\r\n        }\r\n        \r\n        params.append('startDate', startDate.toISOString());\r\n      }\r\n      \r\n      const response = await apiRequest('GET', `/api/admin/activity-logs?${params.toString()}`);\r\n      const exportData: ActivityResponse = await response.json();\r\n      const allActivities = exportData.activities;\r\n      \r\n      // Apply client-side search filter\r\n      const searchFiltered = allActivities.filter(activity => {\r\n        const matchesSearch = \r\n          activity.action.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n          activity.activityType.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n          activity.userId?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n          activity.resourceType?.toLowerCase().includes(searchTerm.toLowerCase());\r\n        \r\n        return matchesSearch;\r\n      });\r\n      \r\n      const csvContent = [\r\n        ['Time', 'User', 'Role', 'Type', 'Action', 'Resource', 'IP Address'].join(','),\r\n        ...searchFiltered.map(activity => [\r\n          formatDate(activity.createdAt),\r\n          activity.userId || 'Anonymous',\r\n          activity.userRole || 'N/A',\r\n          activity.activityType,\r\n          activity.action,\r\n          activity.resourceType ? `${activity.resourceType} #${activity.resourceId || ''}` : 'N/A',\r\n          activity.ipAddress || 'N/A'\r\n        ].map(field => `\"${String(field).replace(/\"/g, '\"\"')}\"`).join(','))\r\n      ].join('\\n');\r\n      \r\n      const blob = new Blob([csvContent], { type: 'text/csv' });\r\n      const url = window.URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = `activity-logs-${new Date().toISOString().split('T')[0]}.csv`;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      document.body.removeChild(a);\r\n      window.URL.revokeObjectURL(url);\r\n    } catch (error) {\r\n      console.error('CSV export failed:', error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div>\r\n        <h1 className=\"text-3xl font-bold text-slate-900\">Activity Logs</h1>\r\n        <p className=\"text-slate-600 mt-1\">Monitor all user actions and system events</p>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-slate-600\">Total Activities</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex items-center\">\r\n              <Activity className=\"w-5 h-5 text-blue-600 mr-2\" />\r\n              <span className=\"text-3xl font-bold text-slate-900\">{activities?.length || 0}</span>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-slate-600\">Today's Activities</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex items-center\">\r\n              <Calendar className=\"w-5 h-5 text-green-600 mr-2\" />\r\n              <span className=\"text-3xl font-bold text-slate-900\">\r\n                {activities?.filter(a => \r\n                  new Date(a.createdAt).toDateString() === new Date().toDateString()\r\n                ).length || 0}\r\n              </span>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-slate-600\">Active Users</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex items-center\">\r\n              <User className=\"w-5 h-5 text-purple-600 mr-2\" />\r\n              <span className=\"text-3xl font-bold text-slate-900\">\r\n                {new Set(activities?.map(a => a.userId).filter(Boolean)).size || 0}\r\n              </span>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-slate-600\">Activity Types</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex items-center\">\r\n              <FileText className=\"w-5 h-5 text-orange-600 mr-2\" />\r\n              <span className=\"text-3xl font-bold text-slate-900\">{activityTypes.length}</span>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\r\n            <div>\r\n              <CardTitle>Activity Log</CardTitle>\r\n              <CardDescription>Detailed view of all user activities ({data?.total || 0} total records)</CardDescription>\r\n            </div>\r\n            <div className=\"flex gap-2 flex-wrap\">\r\n              <Button onClick={exportToCSV} variant=\"outline\" size=\"sm\" disabled={filteredActivities.length === 0}>\r\n                <Download className=\"w-4 h-4 mr-2\" />\r\n                Export CSV\r\n              </Button>\r\n              <Button onClick={() => refetch()} variant=\"outline\" size=\"sm\">\r\n                <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n                Refresh\r\n              </Button>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex gap-2 w-full flex-wrap mt-4\">\r\n            <div className=\"relative flex-1 min-w-[200px]\">\r\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n              <Input\r\n                placeholder=\"Search activities...\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                className=\"pl-10\"\r\n              />\r\n            </div>\r\n            <Select value={activityTypeFilter} onValueChange={setActivityTypeFilter}>\r\n              <SelectTrigger className=\"w-[180px]\">\r\n                <Filter className=\"w-4 h-4 mr-2\" />\r\n                <SelectValue placeholder=\"Activity Type\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Types</SelectItem>\r\n                {activityTypes.map(type => (\r\n                  <SelectItem key={type} value={type}>{type}</SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n            <Select value={userRoleFilter} onValueChange={setUserRoleFilter}>\r\n              <SelectTrigger className=\"w-[150px]\">\r\n                <User className=\"w-4 h-4 mr-2\" />\r\n                <SelectValue placeholder=\"Role\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Roles</SelectItem>\r\n                <SelectItem value=\"admin\">Admin</SelectItem>\r\n                <SelectItem value=\"user\">User</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            <Select value={timeFilter} onValueChange={setTimeFilter}>\r\n              <SelectTrigger className=\"w-[150px]\">\r\n                <Calendar className=\"w-4 h-4 mr-2\" />\r\n                <SelectValue placeholder=\"Time\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Time</SelectItem>\r\n                <SelectItem value=\"today\">Today</SelectItem>\r\n                <SelectItem value=\"week\">Last 7 Days</SelectItem>\r\n                <SelectItem value=\"month\">Last 30 Days</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {isLoading ? (\r\n            <div className=\"text-center py-12\">\r\n              <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n              <p className=\"mt-4 text-slate-600\">Loading activities...</p>\r\n            </div>\r\n          ) : filteredActivities && filteredActivities.length > 0 ? (\r\n            <>\r\n              <div className=\"rounded-lg border border-slate-200 overflow-hidden\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow className=\"bg-slate-50\">\r\n                      <TableHead className=\"w-12\"></TableHead>\r\n                      <TableHead className=\"font-semibold\">Time</TableHead>\r\n                      <TableHead className=\"font-semibold\">User</TableHead>\r\n                      <TableHead className=\"font-semibold\">Type</TableHead>\r\n                      <TableHead className=\"font-semibold\">Action</TableHead>\r\n                      <TableHead className=\"font-semibold\">Resource</TableHead>\r\n                      <TableHead className=\"font-semibold\">IP Address</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {filteredActivities.map((activity) => (\r\n                      <>\r\n                        <TableRow key={activity.id} className=\"hover:bg-slate-50 cursor-pointer\" onClick={() => setExpandedRow(expandedRow === activity.id ? null : activity.id)}>\r\n                          <TableCell>\r\n                            {expandedRow === activity.id ? (\r\n                              <ChevronDown className=\"w-4 h-4 text-slate-500\" />\r\n                            ) : (\r\n                              <ChevronRight className=\"w-4 h-4 text-slate-500\" />\r\n                            )}\r\n                          </TableCell>\r\n                          <TableCell className=\"text-sm text-slate-600\">\r\n                            {formatDate(activity.createdAt)}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <div className=\"flex flex-col\">\r\n                              <span className=\"font-medium text-slate-900\">\r\n                                {activity.userId || 'Anonymous'}\r\n                              </span>\r\n                              {activity.userRole && (\r\n                                <span className=\"text-xs text-slate-500\">{activity.userRole}</span>\r\n                              )}\r\n                            </div>\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <Badge variant={getActivityBadgeVariant(activity.activityType)}>\r\n                              {activity.activityType}\r\n                            </Badge>\r\n                          </TableCell>\r\n                          <TableCell className=\"font-medium text-slate-900\">\r\n                            {activity.action}\r\n                          </TableCell>\r\n                          <TableCell className=\"text-sm text-slate-600\">\r\n                            {activity.resourceType && (\r\n                              <span>\r\n                                {activity.resourceType}\r\n                                {activity.resourceId && ` #${activity.resourceId}`}\r\n                              </span>\r\n                            )}\r\n                          </TableCell>\r\n                          <TableCell className=\"text-sm text-slate-600\">\r\n                            {activity.ipAddress || 'N/A'}\r\n                          </TableCell>\r\n                        </TableRow>\r\n                        {expandedRow === activity.id && (\r\n                          <TableRow className=\"bg-slate-50/50\">\r\n                            <TableCell colSpan={7} className=\"p-4\">\r\n                              <div className=\"space-y-3\">\r\n                                <div className=\"grid grid-cols-2 gap-3\">\r\n                                  {activity.userAgent && (\r\n                                    <div>\r\n                                      <span className=\"text-xs font-semibold text-slate-600\">User Agent:</span>\r\n                                      <p className=\"text-sm text-slate-800 mt-1\">{activity.userAgent}</p>\r\n                                    </div>\r\n                                  )}\r\n                                  {activity.details && Object.keys(activity.details).length > 0 && (\r\n                                    <div className=\"col-span-2\">\r\n                                      <span className=\"text-xs font-semibold text-slate-600\">Details:</span>\r\n                                      <pre className=\"text-xs text-slate-800 mt-1 bg-white p-3 rounded border border-slate-200 overflow-x-auto\">\r\n                                        {JSON.stringify(activity.details, null, 2)}\r\n                                      </pre>\r\n                                    </div>\r\n                                  )}\r\n                                </div>\r\n                              </div>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        )}\r\n                      </>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n              {totalPages > 1 && (\r\n                <div className=\"flex items-center justify-between mt-4\">\r\n                  <div className=\"text-sm text-slate-600\">\r\n                    Showing {page * pageSize + 1} to {Math.min((page + 1) * pageSize, data?.total || 0)} of {data?.total || 0} activities\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    <Button \r\n                      onClick={() => setPage(p => Math.max(0, p - 1))} \r\n                      disabled={page === 0}\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                    >\r\n                      Previous\r\n                    </Button>\r\n                    <div className=\"flex items-center gap-1\">\r\n                      {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\r\n                        const pageNum = i + Math.max(0, page - 2);\r\n                        if (pageNum >= totalPages) return null;\r\n                        return (\r\n                          <Button\r\n                            key={pageNum}\r\n                            onClick={() => setPage(pageNum)}\r\n                            variant={page === pageNum ? \"default\" : \"outline\"}\r\n                            size=\"sm\"\r\n                            className=\"w-10\"\r\n                          >\r\n                            {pageNum + 1}\r\n                          </Button>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                    <Button \r\n                      onClick={() => setPage(p => Math.min(totalPages - 1, p + 1))} \r\n                      disabled={page >= totalPages - 1}\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                    >\r\n                      Next\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </>\r\n          ) : (\r\n            <div className=\"text-center py-12\">\r\n              <Activity className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">No activities found</h3>\r\n              <p className=\"text-slate-600\">\r\n                {searchTerm || activityTypeFilter !== 'all' \r\n                  ? 'Try adjusting your filters' \r\n                  : 'Activity logs will appear here'}\r\n              </p>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\AdminLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\Alerts.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'Alerts' has a complexity of 17. Maximum allowed is 15.","line":20,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":20,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { AlertCircle, Search, AlertTriangle, CheckCircle, XCircle, Info } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface Alert {\r\n  id: number;\r\n  title: string;\r\n  description: string;\r\n  severity: 'info' | 'warning' | 'error' | 'critical';\r\n  status: 'active' | 'resolved' | 'dismissed';\r\n  createdAt: string;\r\n  resolvedAt?: string;\r\n}\r\n\r\nexport default function Alerts() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\r\n\r\n  const { data: alerts, isLoading } = useQuery<Alert[]>({\r\n    queryKey: ['alerts'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/alerts');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  const getSeverityIcon = (severity: string) => {\r\n    switch (severity) {\r\n      case 'critical': return AlertTriangle;\r\n      case 'error': return XCircle;\r\n      case 'warning': return AlertCircle;\r\n      case 'info': return Info;\r\n      default: return AlertCircle;\r\n    }\r\n  };\r\n\r\n  const getSeverityVariant = (severity: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\r\n    switch (severity) {\r\n      case 'critical': return 'destructive';\r\n      case 'error': return 'destructive';\r\n      case 'warning': return 'default';\r\n      case 'info': return 'secondary';\r\n      default: return 'outline';\r\n    }\r\n  };\r\n\r\n  const getSeverityColor = (severity: string) => {\r\n    switch (severity) {\r\n      case 'critical': return 'border-red-200 bg-red-50';\r\n      case 'error': return 'border-orange-200 bg-orange-50';\r\n      case 'warning': return 'border-yellow-200 bg-yellow-50';\r\n      case 'info': return 'border-blue-200 bg-blue-50';\r\n      default: return 'border-slate-200 bg-slate-50';\r\n    }\r\n  };\r\n\r\n  const filteredAlerts = alerts?.filter(alert => {\r\n    const matchesSearch = \r\n      alert.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      alert.description?.toLowerCase().includes(searchTerm.toLowerCase());\r\n    const matchesStatus = filterStatus === 'all' || alert.status === filterStatus;\r\n    return matchesSearch && matchesStatus;\r\n  });\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <AlertCircle className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            System Alerts\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Monitor and manage system alerts and notifications\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Active Alerts</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-red-600\">\r\n                {alerts?.filter(a => a.status === 'active').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Critical</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-red-600\">\r\n                {alerts?.filter(a => a.severity === 'critical' && a.status === 'active').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Warnings</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-yellow-600\">\r\n                {alerts?.filter(a => a.severity === 'warning' && a.status === 'active').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Resolved</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-green-600\">\r\n                {alerts?.filter(a => a.status === 'resolved').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <Card className=\"border-slate-200 shadow-sm\">\r\n          <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">All Alerts</CardTitle>\r\n                <CardDescription className=\"mt-1\">\r\n                  {filteredAlerts?.length || 0} alerts\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"relative w-48\">\r\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                  <Input\r\n                    placeholder=\"Search alerts...\"\r\n                    value={searchTerm}\r\n                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                    className=\"pl-9\"\r\n                  />\r\n                </div>\r\n                <select\r\n                  value={filterStatus}\r\n                  onChange={(e) => setFilterStatus(e.target.value)}\r\n                  className=\"h-10 rounded-md border border-slate-200 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                >\r\n                  <option value=\"all\">All Status</option>\r\n                  <option value=\"active\">Active</option>\r\n                  <option value=\"resolved\">Resolved</option>\r\n                  <option value=\"dismissed\">Dismissed</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-6\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                  <p className=\"mt-4 text-slate-600\">Loading alerts...</p>\r\n                </div>\r\n              </div>\r\n            ) : filteredAlerts && filteredAlerts.length > 0 ? (\r\n              <div className=\"space-y-4\">\r\n                {filteredAlerts.map((alert) => {\r\n                  const Icon = getSeverityIcon(alert.severity);\r\n                  return (\r\n                    <Card key={alert.id} className={`${getSeverityColor(alert.severity)} border`}>\r\n                      <CardContent className=\"p-4\">\r\n                        <div className=\"flex items-start justify-between\">\r\n                          <div className=\"flex items-start gap-3 flex-1\">\r\n                            <Icon className=\"h-5 w-5 mt-0.5\" />\r\n                            <div className=\"flex-1\">\r\n                              <div className=\"flex items-center gap-2 mb-1\">\r\n                                <h3 className=\"font-semibold text-slate-900\">{alert.title}</h3>\r\n                                <Badge variant={getSeverityVariant(alert.severity)} className=\"text-xs\">\r\n                                  {alert.severity}\r\n                                </Badge>\r\n                                <Badge variant={alert.status === 'active' ? 'destructive' : 'secondary'} className=\"text-xs\">\r\n                                  {alert.status}\r\n                                </Badge>\r\n                              </div>\r\n                              <p className=\"text-sm text-slate-700\">{alert.description}</p>\r\n                              <p className=\"text-xs text-slate-500 mt-2\">\r\n                                {formatDate(alert.createdAt)}\r\n                                {alert.resolvedAt && ` â€¢ Resolved: ${formatDate(alert.resolvedAt)}`}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                          {alert.status === 'active' && (\r\n                            <div className=\"flex gap-2\">\r\n                              <button className=\"text-sm px-3 py-1 bg-white hover:bg-slate-100 border border-slate-300 rounded-md transition-colors\">\r\n                                Dismiss\r\n                              </button>\r\n                              <button className=\"text-sm px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors\">\r\n                                Resolve\r\n                              </button>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  );\r\n                })}\r\n              </div>\r\n            ) : (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <CheckCircle className=\"h-12 w-12 text-green-500 mb-4\" />\r\n                <h3 className=\"font-medium text-slate-900 mb-2\">All clear!</h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                  {searchTerm || filterStatus !== 'all' ? \"Try adjusting your filters\" : \"No alerts at this time\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\Analytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\AuditTrail.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'AuditTrail' has a complexity of 16. Maximum allowed is 15.","line":23,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":23,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { History, Search, Calendar, User, FileText } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface AuditEntry {\r\n  id: number;\r\n  userId: string;\r\n  userRole: string;\r\n  action: string;\r\n  resourceType: string;\r\n  resourceId: string;\r\n  changes: any;\r\n  ipAddress: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function AuditTrail() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  const { data: entries, isLoading } = useQuery<AuditEntry[]>({\r\n    queryKey: ['audit-trail'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/audit-trail');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit',\r\n      second: '2-digit'\r\n    });\r\n  };\r\n\r\n  const getActionBadgeVariant = (action: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\r\n    if (action.includes('delete')) return 'destructive';\r\n    if (action.includes('create')) return 'default';\r\n    if (action.includes('update')) return 'secondary';\r\n    return 'outline';\r\n  };\r\n\r\n  const filteredEntries = entries?.filter(entry =>\r\n    entry.action?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    entry.userId?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    entry.resourceType?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <History className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            Audit Trail\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Complete history of all system changes and actions\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Entries</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">{entries?.length || 0}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Today</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-blue-600\">\r\n                {entries?.filter(e => new Date(e.createdAt).toDateString() === new Date().toDateString()).length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Active Users</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-green-600\">\r\n                {new Set(entries?.map(e => e.userId)).size || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Resource Types</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-purple-600\">\r\n                {new Set(entries?.map(e => e.resourceType)).size || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <Card className=\"border-slate-200 shadow-sm\">\r\n          <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">Audit Log</CardTitle>\r\n                <CardDescription className=\"mt-1\">\r\n                  {filteredEntries?.length || 0} entries recorded\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"relative w-64\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                <Input\r\n                  placeholder=\"Search audit trail...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-9\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-0\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                  <p className=\"mt-4 text-slate-600\">Loading audit trail...</p>\r\n                </div>\r\n              </div>\r\n            ) : filteredEntries && filteredEntries.length > 0 ? (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"hover:bg-transparent border-b border-slate-100\">\r\n                    <TableHead className=\"font-semibold\">Action</TableHead>\r\n                    <TableHead className=\"font-semibold\">User</TableHead>\r\n                    <TableHead className=\"font-semibold\">Role</TableHead>\r\n                    <TableHead className=\"font-semibold\">Resource</TableHead>\r\n                    <TableHead className=\"font-semibold\">IP Address</TableHead>\r\n                    <TableHead className=\"font-semibold\">Date</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {filteredEntries.map((entry) => (\r\n                    <TableRow key={entry.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                      <TableCell>\r\n                        <Badge variant={getActionBadgeVariant(entry.action)}>\r\n                          {entry.action}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <User className=\"h-4 w-4 text-slate-400\" />\r\n                          <span className=\"font-medium\">{entry.userId || 'System'}</span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant={entry.userRole === 'admin' ? 'default' : 'secondary'}>\r\n                          {entry.userRole || 'user'}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <FileText className=\"h-4 w-4 text-slate-400\" />\r\n                          <span className=\"text-sm text-slate-600\">{entry.resourceType}</span>\r\n                          {entry.resourceId && (\r\n                            <code className=\"text-xs bg-slate-100 px-1 py-0.5 rounded\">\r\n                              #{entry.resourceId}\r\n                            </code>\r\n                          )}\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell className=\"font-mono text-sm text-slate-600\">{entry.ipAddress}</TableCell>\r\n                      <TableCell className=\"text-slate-600\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Calendar className=\"h-4 w-4\" />\r\n                          <span className=\"text-sm\">{formatDate(entry.createdAt)}</span>\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            ) : (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <History className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                <h3 className=\"font-medium text-slate-900 mb-2\">No audit entries yet</h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                  {searchTerm ? \"Try adjusting your search\" : \"Audit entries will appear here\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\BlogAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\BlogCategories.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'BlogCategories' has a complexity of 41. Maximum allowed is 15.","line":47,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":47,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport AdminLayout from \"./AdminLayout\";\r\nimport { useLocation } from \"wouter\";\r\nimport {\r\n  FolderOpen,\r\n  Plus,\r\n  Edit,\r\n  Trash2,\r\n  Search,\r\n  ArrowLeft,\r\n  RefreshCw,\r\n  Tag,\r\n  Hash\r\n} from \"lucide-react\";\r\n\r\ninterface Category {\r\n  id: number;\r\n  name: string;\r\n  slug: string;\r\n  description: string;\r\n  color: string;\r\n  postCount?: number;\r\n  metaTitle: string;\r\n  metaDescription: string;\r\n}\r\n\r\ninterface BlogTag {\r\n  id: number;\r\n  name: string;\r\n  slug: string;\r\n  description: string;\r\n  color: string;\r\n  postCount: number;\r\n}\r\n\r\nexport default function BlogCategories() {\r\n  const [, setLocation] = useLocation();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [activeTab, setActiveTab] = useState<\"categories\" | \"tags\">(\"categories\");\r\n  const [editingCategory, setEditingCategory] = useState<Category | null>(null);\r\n  const [editingTag, setEditingTag] = useState<BlogTag | null>(null);\r\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\r\n  const [isTagDialogOpen, setIsTagDialogOpen] = useState(false);\r\n\r\n  const [newCategory, setNewCategory] = useState({\r\n    name: \"\",\r\n    slug: \"\",\r\n    description: \"\",\r\n    color: \"#6366f1\",\r\n    metaTitle: \"\",\r\n    metaDescription: \"\"\r\n  });\r\n\r\n  const [newTag, setNewTag] = useState({\r\n    name: \"\",\r\n    slug: \"\",\r\n    description: \"\",\r\n    color: \"#10b981\"\r\n  });\r\n\r\n  const { data: categories, isLoading: loadingCategories } = useQuery({\r\n    queryKey: ['blog-categories'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/blog/categories');\r\n      return response.json();\r\n    },\r\n  });\r\n\r\n  const { data: tags, isLoading: loadingTags } = useQuery({\r\n    queryKey: ['blog-tags'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/blog/tags');\r\n      return response.json();\r\n    },\r\n  });\r\n\r\n  const saveCategoryMutation = useMutation({\r\n    mutationFn: async (data: any) => {\r\n      if (editingCategory) {\r\n        return apiRequest('PUT', `/api/admin/blog/categories/${editingCategory.id}`, data);\r\n      }\r\n      return apiRequest('POST', '/api/admin/blog/categories', data);\r\n    },\r\n    onSuccess: () => {\r\n      toast({ title: \"Success\", description: \"Category saved successfully\" });\r\n      queryClient.invalidateQueries({ queryKey: ['blog-categories'] });\r\n      setIsDialogOpen(false);\r\n      setEditingCategory(null);\r\n      setNewCategory({ name: \"\", slug: \"\", description: \"\", color: \"#6366f1\", metaTitle: \"\", metaDescription: \"\" });\r\n    },\r\n  });\r\n\r\n  const deleteCategoryMutation = useMutation({\r\n    mutationFn: async (id: number) => {\r\n      return apiRequest('DELETE', `/api/admin/blog/categories/${id}`);\r\n    },\r\n    onSuccess: () => {\r\n      toast({ title: \"Deleted\", description: \"Category deleted successfully\" });\r\n      queryClient.invalidateQueries({ queryKey: ['blog-categories'] });\r\n    },\r\n  });\r\n\r\n  const saveTagMutation = useMutation({\r\n    mutationFn: async (data: any) => {\r\n      if (editingTag) {\r\n        return apiRequest('PUT', `/api/admin/blog/tags/${editingTag.id}`, data);\r\n      }\r\n      return apiRequest('POST', '/api/admin/blog/tags', data);\r\n    },\r\n    onSuccess: () => {\r\n      toast({ title: \"Success\", description: \"Tag saved successfully\" });\r\n      queryClient.invalidateQueries({ queryKey: ['blog-tags'] });\r\n      setIsTagDialogOpen(false);\r\n      setEditingTag(null);\r\n      setNewTag({ name: \"\", slug: \"\", description: \"\", color: \"#10b981\" });\r\n    },\r\n  });\r\n\r\n  const deleteTagMutation = useMutation({\r\n    mutationFn: async (id: number) => {\r\n      return apiRequest('DELETE', `/api/admin/blog/tags/${id}`);\r\n    },\r\n    onSuccess: () => {\r\n      toast({ title: \"Deleted\", description: \"Tag deleted successfully\" });\r\n      queryClient.invalidateQueries({ queryKey: ['blog-tags'] });\r\n    },\r\n  });\r\n\r\n  const generateSlug = (name: string) => {\r\n    return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n  };\r\n\r\n  const filteredCategories = categories?.filter((cat: Category) =>\r\n    cat.name.toLowerCase().includes(searchTerm.toLowerCase())\r\n  ) || [];\r\n\r\n  const filteredTags = tags?.filter((tag: BlogTag) =>\r\n    tag.name.toLowerCase().includes(searchTerm.toLowerCase())\r\n  ) || [];\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Button variant=\"ghost\" onClick={() => setLocation(\"/admin/blog\")}>\r\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n              Back\r\n            </Button>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-slate-900 flex items-center gap-2\">\r\n                <FolderOpen className=\"w-6 h-6 text-purple-600\" />\r\n                Categories & Tags\r\n              </h1>\r\n              <p className=\"text-sm text-slate-600\">\r\n                Organize your blog content\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex gap-4\">\r\n          <Button\r\n            variant={activeTab === \"categories\" ? \"default\" : \"outline\"}\r\n            onClick={() => setActiveTab(\"categories\")}\r\n          >\r\n            <FolderOpen className=\"w-4 h-4 mr-2\" />\r\n            Categories\r\n          </Button>\r\n          <Button\r\n            variant={activeTab === \"tags\" ? \"default\" : \"outline\"}\r\n            onClick={() => setActiveTab(\"tags\")}\r\n          >\r\n            <Tag className=\"w-4 h-4 mr-2\" />\r\n            Tags\r\n          </Button>\r\n        </div>\r\n\r\n        {activeTab === \"categories\" && (\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader>\r\n              <div className=\"flex items-center justify-between\">\r\n                <CardTitle>Categories</CardTitle>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"relative\">\r\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n                    <Input\r\n                      placeholder=\"Search categories...\"\r\n                      value={searchTerm}\r\n                      onChange={(e) => setSearchTerm(e.target.value)}\r\n                      className=\"pl-9 w-64\"\r\n                    />\r\n                  </div>\r\n                  <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\r\n                    <DialogTrigger asChild>\r\n                      <Button onClick={() => {\r\n                        setEditingCategory(null);\r\n                        setNewCategory({ name: \"\", slug: \"\", description: \"\", color: \"#6366f1\", metaTitle: \"\", metaDescription: \"\" });\r\n                      }}>\r\n                        <Plus className=\"w-4 h-4 mr-2\" />\r\n                        Add Category\r\n                      </Button>\r\n                    </DialogTrigger>\r\n                    <DialogContent>\r\n                      <DialogHeader>\r\n                        <DialogTitle>{editingCategory ? \"Edit Category\" : \"New Category\"}</DialogTitle>\r\n                      </DialogHeader>\r\n                      <div className=\"space-y-4 pt-4\">\r\n                        <div>\r\n                          <Label>Name</Label>\r\n                          <Input\r\n                            value={editingCategory?.name || newCategory.name}\r\n                            onChange={(e) => {\r\n                              const name = e.target.value;\r\n                              if (editingCategory) {\r\n                                setEditingCategory({ ...editingCategory, name, slug: editingCategory.slug || generateSlug(name) });\r\n                              } else {\r\n                                setNewCategory({ ...newCategory, name, slug: newCategory.slug || generateSlug(name) });\r\n                              }\r\n                            }}\r\n                            placeholder=\"Category name\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Slug</Label>\r\n                          <Input\r\n                            value={editingCategory?.slug || newCategory.slug}\r\n                            onChange={(e) => {\r\n                              if (editingCategory) {\r\n                                setEditingCategory({ ...editingCategory, slug: e.target.value });\r\n                              } else {\r\n                                setNewCategory({ ...newCategory, slug: e.target.value });\r\n                              }\r\n                            }}\r\n                            placeholder=\"category-slug\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Description</Label>\r\n                          <Textarea\r\n                            value={editingCategory?.description || newCategory.description}\r\n                            onChange={(e) => {\r\n                              if (editingCategory) {\r\n                                setEditingCategory({ ...editingCategory, description: e.target.value });\r\n                              } else {\r\n                                setNewCategory({ ...newCategory, description: e.target.value });\r\n                              }\r\n                            }}\r\n                            placeholder=\"Category description\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Color</Label>\r\n                          <div className=\"flex gap-2\">\r\n                            <Input\r\n                              type=\"color\"\r\n                              value={editingCategory?.color || newCategory.color}\r\n                              onChange={(e) => {\r\n                                if (editingCategory) {\r\n                                  setEditingCategory({ ...editingCategory, color: e.target.value });\r\n                                } else {\r\n                                  setNewCategory({ ...newCategory, color: e.target.value });\r\n                                }\r\n                              }}\r\n                              className=\"w-16 h-10 p-1\"\r\n                            />\r\n                            <Input\r\n                              value={editingCategory?.color || newCategory.color}\r\n                              onChange={(e) => {\r\n                                if (editingCategory) {\r\n                                  setEditingCategory({ ...editingCategory, color: e.target.value });\r\n                                } else {\r\n                                  setNewCategory({ ...newCategory, color: e.target.value });\r\n                                }\r\n                              }}\r\n                              className=\"flex-1\"\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                        <div>\r\n                          <Label>Meta Title (SEO)</Label>\r\n                          <Input\r\n                            value={editingCategory?.metaTitle || newCategory.metaTitle}\r\n                            onChange={(e) => {\r\n                              if (editingCategory) {\r\n                                setEditingCategory({ ...editingCategory, metaTitle: e.target.value });\r\n                              } else {\r\n                                setNewCategory({ ...newCategory, metaTitle: e.target.value });\r\n                              }\r\n                            }}\r\n                            placeholder=\"SEO title for category page\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Meta Description (SEO)</Label>\r\n                          <Textarea\r\n                            value={editingCategory?.metaDescription || newCategory.metaDescription}\r\n                            onChange={(e) => {\r\n                              if (editingCategory) {\r\n                                setEditingCategory({ ...editingCategory, metaDescription: e.target.value });\r\n                              } else {\r\n                                setNewCategory({ ...newCategory, metaDescription: e.target.value });\r\n                              }\r\n                            }}\r\n                            placeholder=\"SEO description for category page\"\r\n                          />\r\n                        </div>\r\n                        <Button\r\n                          className=\"w-full\"\r\n                          onClick={() => saveCategoryMutation.mutate(editingCategory || newCategory)}\r\n                          disabled={saveCategoryMutation.isPending}\r\n                        >\r\n                          {saveCategoryMutation.isPending ? \"Saving...\" : \"Save Category\"}\r\n                        </Button>\r\n                      </div>\r\n                    </DialogContent>\r\n                  </Dialog>\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent>\r\n              {loadingCategories ? (\r\n                <div className=\"flex items-center justify-center py-12\">\r\n                  <RefreshCw className=\"w-8 h-8 animate-spin text-slate-400\" />\r\n                </div>\r\n              ) : filteredCategories.length === 0 ? (\r\n                <div className=\"text-center py-12 text-slate-500\">\r\n                  <FolderOpen className=\"w-12 h-12 mx-auto mb-4 text-slate-300\" />\r\n                  <p>No categories found</p>\r\n                </div>\r\n              ) : (\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead>Name</TableHead>\r\n                      <TableHead>Slug</TableHead>\r\n                      <TableHead>Posts</TableHead>\r\n                      <TableHead>Color</TableHead>\r\n                      <TableHead className=\"text-right\">Actions</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {filteredCategories.map((category: Category) => (\r\n                      <TableRow key={category.id}>\r\n                        <TableCell className=\"font-medium\">{category.name}</TableCell>\r\n                        <TableCell className=\"text-slate-500\">{category.slug}</TableCell>\r\n                        <TableCell>\r\n                          <Badge variant=\"outline\">{category.postCount || 0}</Badge>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <div\r\n                              className=\"w-6 h-6 rounded-full border\"\r\n                              style={{ backgroundColor: category.color }}\r\n                            />\r\n                            <span className=\"text-xs text-slate-500\">{category.color}</span>\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <div className=\"flex items-center justify-end gap-2\">\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              onClick={() => {\r\n                                setEditingCategory(category);\r\n                                setIsDialogOpen(true);\r\n                              }}\r\n                            >\r\n                              <Edit className=\"w-4 h-4\" />\r\n                            </Button>\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              onClick={() => {\r\n                                if (confirm(\"Are you sure you want to delete this category?\")) {\r\n                                  deleteCategoryMutation.mutate(category.id);\r\n                                }\r\n                              }}\r\n                            >\r\n                              <Trash2 className=\"w-4 h-4 text-red-500\" />\r\n                            </Button>\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        {activeTab === \"tags\" && (\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader>\r\n              <div className=\"flex items-center justify-between\">\r\n                <CardTitle>Tags</CardTitle>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"relative\">\r\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400\" />\r\n                    <Input\r\n                      placeholder=\"Search tags...\"\r\n                      value={searchTerm}\r\n                      onChange={(e) => setSearchTerm(e.target.value)}\r\n                      className=\"pl-9 w-64\"\r\n                    />\r\n                  </div>\r\n                  <Dialog open={isTagDialogOpen} onOpenChange={setIsTagDialogOpen}>\r\n                    <DialogTrigger asChild>\r\n                      <Button onClick={() => {\r\n                        setEditingTag(null);\r\n                        setNewTag({ name: \"\", slug: \"\", description: \"\", color: \"#10b981\" });\r\n                      }}>\r\n                        <Plus className=\"w-4 h-4 mr-2\" />\r\n                        Add Tag\r\n                      </Button>\r\n                    </DialogTrigger>\r\n                    <DialogContent>\r\n                      <DialogHeader>\r\n                        <DialogTitle>{editingTag ? \"Edit Tag\" : \"New Tag\"}</DialogTitle>\r\n                      </DialogHeader>\r\n                      <div className=\"space-y-4 pt-4\">\r\n                        <div>\r\n                          <Label>Name</Label>\r\n                          <Input\r\n                            value={editingTag?.name || newTag.name}\r\n                            onChange={(e) => {\r\n                              const name = e.target.value;\r\n                              if (editingTag) {\r\n                                setEditingTag({ ...editingTag, name, slug: editingTag.slug || generateSlug(name) });\r\n                              } else {\r\n                                setNewTag({ ...newTag, name, slug: newTag.slug || generateSlug(name) });\r\n                              }\r\n                            }}\r\n                            placeholder=\"Tag name\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Slug</Label>\r\n                          <Input\r\n                            value={editingTag?.slug || newTag.slug}\r\n                            onChange={(e) => {\r\n                              if (editingTag) {\r\n                                setEditingTag({ ...editingTag, slug: e.target.value });\r\n                              } else {\r\n                                setNewTag({ ...newTag, slug: e.target.value });\r\n                              }\r\n                            }}\r\n                            placeholder=\"tag-slug\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Description</Label>\r\n                          <Textarea\r\n                            value={editingTag?.description || newTag.description}\r\n                            onChange={(e) => {\r\n                              if (editingTag) {\r\n                                setEditingTag({ ...editingTag, description: e.target.value });\r\n                              } else {\r\n                                setNewTag({ ...newTag, description: e.target.value });\r\n                              }\r\n                            }}\r\n                            placeholder=\"Tag description\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <Label>Color</Label>\r\n                          <div className=\"flex gap-2\">\r\n                            <Input\r\n                              type=\"color\"\r\n                              value={editingTag?.color || newTag.color}\r\n                              onChange={(e) => {\r\n                                if (editingTag) {\r\n                                  setEditingTag({ ...editingTag, color: e.target.value });\r\n                                } else {\r\n                                  setNewTag({ ...newTag, color: e.target.value });\r\n                                }\r\n                              }}\r\n                              className=\"w-16 h-10 p-1\"\r\n                            />\r\n                            <Input\r\n                              value={editingTag?.color || newTag.color}\r\n                              onChange={(e) => {\r\n                                if (editingTag) {\r\n                                  setEditingTag({ ...editingTag, color: e.target.value });\r\n                                } else {\r\n                                  setNewTag({ ...newTag, color: e.target.value });\r\n                                }\r\n                              }}\r\n                              className=\"flex-1\"\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                        <Button\r\n                          className=\"w-full\"\r\n                          onClick={() => saveTagMutation.mutate(editingTag || newTag)}\r\n                          disabled={saveTagMutation.isPending}\r\n                        >\r\n                          {saveTagMutation.isPending ? \"Saving...\" : \"Save Tag\"}\r\n                        </Button>\r\n                      </div>\r\n                    </DialogContent>\r\n                  </Dialog>\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent>\r\n              {loadingTags ? (\r\n                <div className=\"flex items-center justify-center py-12\">\r\n                  <RefreshCw className=\"w-8 h-8 animate-spin text-slate-400\" />\r\n                </div>\r\n              ) : filteredTags.length === 0 ? (\r\n                <div className=\"text-center py-12 text-slate-500\">\r\n                  <Tag className=\"w-12 h-12 mx-auto mb-4 text-slate-300\" />\r\n                  <p>No tags found</p>\r\n                </div>\r\n              ) : (\r\n                <div className=\"flex flex-wrap gap-3\">\r\n                  {filteredTags.map((tag: BlogTag) => (\r\n                    <div\r\n                      key={tag.id}\r\n                      className=\"flex items-center gap-2 px-3 py-2 rounded-lg border bg-white hover:shadow-sm transition-shadow\"\r\n                    >\r\n                      <Hash className=\"w-4 h-4\" style={{ color: tag.color }} />\r\n                      <span className=\"font-medium\">{tag.name}</span>\r\n                      <Badge variant=\"outline\" className=\"text-xs\">{tag.postCount}</Badge>\r\n                      <div className=\"flex items-center gap-1 ml-2\">\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          className=\"h-6 w-6 p-0\"\r\n                          onClick={() => {\r\n                            setEditingTag(tag);\r\n                            setIsTagDialogOpen(true);\r\n                          }}\r\n                        >\r\n                          <Edit className=\"w-3 h-3\" />\r\n                        </Button>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          className=\"h-6 w-6 p-0\"\r\n                          onClick={() => {\r\n                            if (confirm(\"Delete this tag?\")) {\r\n                              deleteTagMutation.mutate(tag.id);\r\n                            }\r\n                          }}\r\n                        >\r\n                          <Trash2 className=\"w-3 h-3 text-red-500\" />\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\BlogDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\BlogPostEditor.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'BlogPostEditor' has a complexity of 18. Maximum allowed is 15.","line":110,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":110,"endColumn":39},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 16. Maximum allowed is 15.","line":206,"column":32,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":206,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { useRoute, useLocation } from \"wouter\";\r\nimport AdminLayout from \"./AdminLayout\";\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport {\r\n  FileText,\r\n  Save,\r\n  Eye,\r\n  ArrowLeft,\r\n  Globe,\r\n  Search,\r\n  Image,\r\n  Link2,\r\n  Settings,\r\n  BarChart3,\r\n  DollarSign,\r\n  Clock,\r\n  CheckCircle,\r\n  AlertCircle,\r\n  Target,\r\n  TrendingUp,\r\n  MessageSquare,\r\n  Tag,\r\n  Sparkles,\r\n  RefreshCw\r\n} from \"lucide-react\";\r\n\r\ninterface BlogPost {\r\n  id?: number;\r\n  title: string;\r\n  slug: string;\r\n  excerpt: string;\r\n  content: string;\r\n  featuredImage: string;\r\n  featuredImageAlt: string;\r\n  authorId: number | null;\r\n  categoryId: number | null;\r\n  status: string;\r\n  visibility: string;\r\n  publishedAt: string | null;\r\n  scheduledAt: string | null;\r\n  metaTitle: string;\r\n  metaDescription: string;\r\n  metaKeywords: string;\r\n  canonicalUrl: string;\r\n  ogTitle: string;\r\n  ogDescription: string;\r\n  ogImage: string;\r\n  twitterTitle: string;\r\n  twitterDescription: string;\r\n  twitterImage: string;\r\n  focusKeyword: string;\r\n  seoScore: number;\r\n  readabilityScore: number;\r\n  allowComments: boolean;\r\n  isPinned: boolean;\r\n  isFeatured: boolean;\r\n  affiliateLinks: any[];\r\n  adPlacements: any[];\r\n  tags: number[];\r\n}\r\n\r\nconst defaultPost: BlogPost = {\r\n  title: \"\",\r\n  slug: \"\",\r\n  excerpt: \"\",\r\n  content: \"\",\r\n  featuredImage: \"\",\r\n  featuredImageAlt: \"\",\r\n  authorId: null,\r\n  categoryId: null,\r\n  status: \"draft\",\r\n  visibility: \"public\",\r\n  publishedAt: null,\r\n  scheduledAt: null,\r\n  metaTitle: \"\",\r\n  metaDescription: \"\",\r\n  metaKeywords: \"\",\r\n  canonicalUrl: \"\",\r\n  ogTitle: \"\",\r\n  ogDescription: \"\",\r\n  ogImage: \"\",\r\n  twitterTitle: \"\",\r\n  twitterDescription: \"\",\r\n  twitterImage: \"\",\r\n  focusKeyword: \"\",\r\n  seoScore: 0,\r\n  readabilityScore: 0,\r\n  allowComments: true,\r\n  isPinned: false,\r\n  isFeatured: false,\r\n  affiliateLinks: [],\r\n  adPlacements: [],\r\n  tags: []\r\n};\r\n\r\nexport default function BlogPostEditor() {\r\n  const [, params] = useRoute(\"/admin/blog/posts/:id\");\r\n  const [, setLocation] = useLocation();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n  const isNew = params?.id === \"new\";\r\n  const postId = isNew ? null : parseInt(params?.id || \"0\");\r\n\r\n  const [post, setPost] = useState<BlogPost>(defaultPost);\r\n  const [activeTab, setActiveTab] = useState(\"content\");\r\n\r\n  const { data: categories } = useQuery({\r\n    queryKey: ['blog-categories'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/blog/categories');\r\n      return response.json();\r\n    },\r\n  });\r\n\r\n  const { data: authors } = useQuery({\r\n    queryKey: ['blog-authors'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/blog/authors');\r\n      return response.json();\r\n    },\r\n  });\r\n\r\n  const { data: tags } = useQuery({\r\n    queryKey: ['blog-tags'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/blog/tags');\r\n      return response.json();\r\n    },\r\n  });\r\n\r\n  const { data: existingPost, isLoading } = useQuery({\r\n    queryKey: ['blog-post', postId],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', `/api/admin/blog/posts/${postId}`);\r\n      return response.json();\r\n    },\r\n    enabled: !isNew && !!postId,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (existingPost) {\r\n      setPost(existingPost);\r\n    }\r\n  }, [existingPost]);\r\n\r\n  const saveMutation = useMutation({\r\n    mutationFn: async (data: BlogPost) => {\r\n      if (isNew) {\r\n        return apiRequest('POST', '/api/admin/blog/posts', data);\r\n      }\r\n      return apiRequest('PUT', `/api/admin/blog/posts/${postId}`, data);\r\n    },\r\n    onSuccess: async (response) => {\r\n      const result = await response.json();\r\n      toast({\r\n        title: isNew ? \"Post Created\" : \"Post Updated\",\r\n        description: \"Your blog post has been saved successfully.\",\r\n      });\r\n      queryClient.invalidateQueries({ queryKey: ['blog-posts'] });\r\n      queryClient.invalidateQueries({ queryKey: ['blog-stats'] });\r\n      if (isNew && result.id) {\r\n        setLocation(`/admin/blog/posts/${result.id}`);\r\n      }\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to save blog post.\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n\r\n  const generateSlug = (title: string) => {\r\n    return title\r\n      .toLowerCase()\r\n      .replace(/[^a-z0-9]+/g, '-')\r\n      .replace(/(^-|-$)/g, '');\r\n  };\r\n\r\n  const handleTitleChange = (title: string) => {\r\n    setPost(prev => ({\r\n      ...prev,\r\n      title,\r\n      slug: prev.slug || generateSlug(title),\r\n      metaTitle: prev.metaTitle || title,\r\n      ogTitle: prev.ogTitle || title,\r\n      twitterTitle: prev.twitterTitle || title,\r\n    }));\r\n  };\r\n\r\n  const calculateSeoScore = () => {\r\n    let score = 0;\r\n    if (post.metaTitle && post.metaTitle.length >= 30 && post.metaTitle.length <= 60) score += 15;\r\n    if (post.metaDescription && post.metaDescription.length >= 120 && post.metaDescription.length <= 160) score += 15;\r\n    if (post.focusKeyword) score += 10;\r\n    if (post.focusKeyword && post.title.toLowerCase().includes(post.focusKeyword.toLowerCase())) score += 10;\r\n    if (post.focusKeyword && post.content.toLowerCase().includes(post.focusKeyword.toLowerCase())) score += 10;\r\n    if (post.featuredImage) score += 10;\r\n    if (post.featuredImageAlt) score += 10;\r\n    if (post.excerpt) score += 10;\r\n    if (post.content.length > 300) score += 10;\r\n    return score;\r\n  };\r\n\r\n  const getSeoScoreColor = (score: number) => {\r\n    if (score >= 80) return \"text-green-600 bg-green-50\";\r\n    if (score >= 60) return \"text-yellow-600 bg-yellow-50\";\r\n    return \"text-red-600 bg-red-50\";\r\n  };\r\n\r\n  const seoScore = calculateSeoScore();\r\n\r\n  if (!isNew && isLoading) {\r\n    return (\r\n      <AdminLayout>\r\n        <div className=\"flex items-center justify-center py-12\">\r\n          <RefreshCw className=\"w-8 h-8 animate-spin text-slate-400\" />\r\n        </div>\r\n      </AdminLayout>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Button variant=\"ghost\" onClick={() => setLocation(\"/admin/blog\")}>\r\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n              Back\r\n            </Button>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-slate-900\">\r\n                {isNew ? \"Create New Post\" : \"Edit Post\"}\r\n              </h1>\r\n              <p className=\"text-sm text-slate-600\">\r\n                {isNew ? \"Write and optimize your blog content\" : `Editing: ${post.title}`}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-3\">\r\n            <Badge className={getSeoScoreColor(seoScore)}>\r\n              SEO: {seoScore}%\r\n            </Badge>\r\n            <Select\r\n              value={post.status}\r\n              onValueChange={(value) => setPost(prev => ({ ...prev, status: value }))}\r\n            >\r\n              <SelectTrigger className=\"w-32\">\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"draft\">Draft</SelectItem>\r\n                <SelectItem value=\"published\">Published</SelectItem>\r\n                <SelectItem value=\"scheduled\">Scheduled</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={() => window.open(`/blog/${post.slug}`, '_blank')}\r\n              disabled={!post.slug}\r\n            >\r\n              <Eye className=\"w-4 h-4 mr-2\" />\r\n              Preview\r\n            </Button>\r\n            <Button\r\n              onClick={() => saveMutation.mutate(post)}\r\n              disabled={saveMutation.isPending}\r\n              className=\"bg-purple-600 hover:bg-purple-700\"\r\n            >\r\n              <Save className=\"w-4 h-4 mr-2\" />\r\n              {saveMutation.isPending ? \"Saving...\" : \"Save Post\"}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n          <div className=\"lg:col-span-2\">\r\n            <Card className=\"border-slate-200\">\r\n              <CardContent className=\"pt-6\">\r\n                <div className=\"space-y-6\">\r\n                  <div>\r\n                    <Label htmlFor=\"title\">Post Title</Label>\r\n                    <Input\r\n                      id=\"title\"\r\n                      value={post.title}\r\n                      onChange={(e) => handleTitleChange(e.target.value)}\r\n                      placeholder=\"Enter post title...\"\r\n                      className=\"text-lg font-medium mt-1\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label htmlFor=\"slug\">URL Slug</Label>\r\n                    <div className=\"flex items-center gap-2 mt-1\">\r\n                      <span className=\"text-sm text-slate-500\">/blog/</span>\r\n                      <Input\r\n                        id=\"slug\"\r\n                        value={post.slug}\r\n                        onChange={(e) => setPost(prev => ({ ...prev, slug: e.target.value }))}\r\n                        placeholder=\"post-url-slug\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label htmlFor=\"excerpt\">Excerpt</Label>\r\n                    <Textarea\r\n                      id=\"excerpt\"\r\n                      value={post.excerpt}\r\n                      onChange={(e) => setPost(prev => ({ ...prev, excerpt: e.target.value }))}\r\n                      placeholder=\"Brief summary of the post...\"\r\n                      rows={3}\r\n                      className=\"mt-1\"\r\n                    />\r\n                    <p className=\"text-xs text-slate-500 mt-1\">\r\n                      {post.excerpt.length}/300 characters recommended\r\n                    </p>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label htmlFor=\"content\">Content</Label>\r\n                    <Textarea\r\n                      id=\"content\"\r\n                      value={post.content}\r\n                      onChange={(e) => setPost(prev => ({ ...prev, content: e.target.value }))}\r\n                      placeholder=\"Write your blog post content here... (Supports Markdown)\"\r\n                      rows={20}\r\n                      className=\"mt-1 font-mono\"\r\n                    />\r\n                    <p className=\"text-xs text-slate-500 mt-1\">\r\n                      {post.content.split(/\\s+/).filter(Boolean).length} words |{\" \"}\r\n                      {Math.ceil(post.content.split(/\\s+/).filter(Boolean).length / 200)} min read\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n          <div className=\"space-y-6\">\r\n            <Card className=\"border-slate-200\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                  <Settings className=\"w-5 h-5\" />\r\n                  Post Settings\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div>\r\n                  <Label>Category</Label>\r\n                  <Select\r\n                    value={post.categoryId?.toString() || \"\"}\r\n                    onValueChange={(value) => setPost(prev => ({ ...prev, categoryId: parseInt(value) }))}\r\n                  >\r\n                    <SelectTrigger className=\"mt-1\">\r\n                      <SelectValue placeholder=\"Select category\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {categories?.map((cat: any) => (\r\n                        <SelectItem key={cat.id} value={cat.id.toString()}>\r\n                          {cat.name}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Author</Label>\r\n                  <Select\r\n                    value={post.authorId?.toString() || \"\"}\r\n                    onValueChange={(value) => setPost(prev => ({ ...prev, authorId: parseInt(value) }))}\r\n                  >\r\n                    <SelectTrigger className=\"mt-1\">\r\n                      <SelectValue placeholder=\"Select author\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {authors?.map((author: any) => (\r\n                        <SelectItem key={author.id} value={author.id.toString()}>\r\n                          {author.name}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                <Separator />\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <Label>Featured Post</Label>\r\n                  <Switch\r\n                    checked={post.isFeatured}\r\n                    onCheckedChange={(checked) => setPost(prev => ({ ...prev, isFeatured: checked }))}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <Label>Pin to Top</Label>\r\n                  <Switch\r\n                    checked={post.isPinned}\r\n                    onCheckedChange={(checked) => setPost(prev => ({ ...prev, isPinned: checked }))}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <Label>Allow Comments</Label>\r\n                  <Switch\r\n                    checked={post.allowComments}\r\n                    onCheckedChange={(checked) => setPost(prev => ({ ...prev, allowComments: checked }))}\r\n                  />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"border-slate-200\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                  <Image className=\"w-5 h-5\" />\r\n                  Featured Image\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div>\r\n                  <Label>Image URL</Label>\r\n                  <Input\r\n                    value={post.featuredImage}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, featuredImage: e.target.value }))}\r\n                    placeholder=\"https://...\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <Label>Alt Text (for SEO)</Label>\r\n                  <Input\r\n                    value={post.featuredImageAlt}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, featuredImageAlt: e.target.value }))}\r\n                    placeholder=\"Describe the image...\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n                {post.featuredImage && (\r\n                  <div className=\"border rounded-lg overflow-hidden\">\r\n                    <img\r\n                      src={post.featuredImage}\r\n                      alt={post.featuredImageAlt}\r\n                      className=\"w-full h-32 object-cover\"\r\n                    />\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"border-slate-200\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                  <Search className=\"w-5 h-5\" />\r\n                  SEO Settings\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div>\r\n                  <Label>Focus Keyword</Label>\r\n                  <Input\r\n                    value={post.focusKeyword}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, focusKeyword: e.target.value }))}\r\n                    placeholder=\"Main keyword to rank for\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Meta Title</Label>\r\n                  <Input\r\n                    value={post.metaTitle}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, metaTitle: e.target.value }))}\r\n                    placeholder=\"SEO title (50-60 chars)\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                  <p className=\"text-xs text-slate-500 mt-1\">\r\n                    {post.metaTitle.length}/60 characters\r\n                  </p>\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Meta Description</Label>\r\n                  <Textarea\r\n                    value={post.metaDescription}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, metaDescription: e.target.value }))}\r\n                    placeholder=\"SEO description (120-160 chars)\"\r\n                    rows={3}\r\n                    className=\"mt-1\"\r\n                  />\r\n                  <p className=\"text-xs text-slate-500 mt-1\">\r\n                    {post.metaDescription.length}/160 characters\r\n                  </p>\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Keywords</Label>\r\n                  <Input\r\n                    value={post.metaKeywords}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, metaKeywords: e.target.value }))}\r\n                    placeholder=\"keyword1, keyword2, keyword3\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Canonical URL</Label>\r\n                  <Input\r\n                    value={post.canonicalUrl}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, canonicalUrl: e.target.value }))}\r\n                    placeholder=\"https://...\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"border-slate-200\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                  <Globe className=\"w-5 h-5\" />\r\n                  Social Media\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div>\r\n                  <Label>OG Title</Label>\r\n                  <Input\r\n                    value={post.ogTitle}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, ogTitle: e.target.value }))}\r\n                    placeholder=\"Facebook/LinkedIn title\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>OG Description</Label>\r\n                  <Textarea\r\n                    value={post.ogDescription}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, ogDescription: e.target.value }))}\r\n                    placeholder=\"Facebook/LinkedIn description\"\r\n                    rows={2}\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>OG Image URL</Label>\r\n                  <Input\r\n                    value={post.ogImage}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, ogImage: e.target.value }))}\r\n                    placeholder=\"https://...\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n\r\n                <Separator />\r\n\r\n                <div>\r\n                  <Label>Twitter Title</Label>\r\n                  <Input\r\n                    value={post.twitterTitle}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, twitterTitle: e.target.value }))}\r\n                    placeholder=\"Twitter card title\"\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Twitter Description</Label>\r\n                  <Textarea\r\n                    value={post.twitterDescription}\r\n                    onChange={(e) => setPost(prev => ({ ...prev, twitterDescription: e.target.value }))}\r\n                    placeholder=\"Twitter card description\"\r\n                    rows={2}\r\n                    className=\"mt-1\"\r\n                  />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"border-slate-200\">\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                  <DollarSign className=\"w-5 h-5\" />\r\n                  Monetization\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <p className=\"text-sm text-slate-500\">\r\n                  Add affiliate links and ad placements to monetize your content.\r\n                  Configure in the Analytics section.\r\n                </p>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\CallLogs.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'CallLogs' has a complexity of 16. Maximum allowed is 15.","line":22,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":22,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Phone, Search, Calendar, Clock, PhoneIncoming, PhoneOutgoing, PhoneMissed } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface CallLog {\r\n  id: number;\r\n  contactId: number;\r\n  userId: string;\r\n  callType: 'incoming' | 'outgoing' | 'missed';\r\n  duration: number;\r\n  status: string;\r\n  notes: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function CallLogs() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  const { data: calls, isLoading } = useQuery<CallLog[]>({\r\n    queryKey: ['call-logs'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/call-logs');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const formatDuration = (seconds: number) => {\r\n    const mins = Math.floor(seconds / 60);\r\n    const secs = seconds % 60;\r\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  const getCallIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'incoming': return PhoneIncoming;\r\n      case 'outgoing': return PhoneOutgoing;\r\n      case 'missed': return PhoneMissed;\r\n      default: return Phone;\r\n    }\r\n  };\r\n\r\n  const getCallBadgeVariant = (type: string) => {\r\n    switch (type) {\r\n      case 'incoming': return 'default';\r\n      case 'outgoing': return 'secondary';\r\n      case 'missed': return 'destructive';\r\n      default: return 'outline';\r\n    }\r\n  };\r\n\r\n  const filteredCalls = calls?.filter(call =>\r\n    call.userId?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    call.contactId.toString().includes(searchTerm)\r\n  );\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <Phone className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            Call Logs\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Monitor all call activities and interactions\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Calls</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">{calls?.length || 0}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Incoming</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-blue-600\">\r\n                {calls?.filter(c => c.callType === 'incoming').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Outgoing</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-green-600\">\r\n                {calls?.filter(c => c.callType === 'outgoing').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Missed</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-red-600\">\r\n                {calls?.filter(c => c.callType === 'missed').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <Card className=\"border-slate-200 shadow-sm\">\r\n          <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">Call History</CardTitle>\r\n                <CardDescription className=\"mt-1\">\r\n                  {filteredCalls?.length || 0} calls recorded\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"relative w-64\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                <Input\r\n                  placeholder=\"Search calls...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-9\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-0\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                  <p className=\"mt-4 text-slate-600\">Loading call logs...</p>\r\n                </div>\r\n              </div>\r\n            ) : filteredCalls && filteredCalls.length > 0 ? (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"hover:bg-transparent border-b border-slate-100\">\r\n                    <TableHead className=\"font-semibold\">Type</TableHead>\r\n                    <TableHead className=\"font-semibold\">Contact</TableHead>\r\n                    <TableHead className=\"font-semibold\">User</TableHead>\r\n                    <TableHead className=\"font-semibold\">Duration</TableHead>\r\n                    <TableHead className=\"font-semibold\">Status</TableHead>\r\n                    <TableHead className=\"font-semibold\">Date</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {filteredCalls.map((call) => {\r\n                    const CallIcon = getCallIcon(call.callType);\r\n                    return (\r\n                      <TableRow key={call.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                        <TableCell>\r\n                          <Badge variant={getCallBadgeVariant(call.callType)} className=\"gap-1\">\r\n                            <CallIcon className=\"h-3 w-3\" />\r\n                            {call.callType}\r\n                          </Badge>\r\n                        </TableCell>\r\n                        <TableCell>Contact #{call.contactId}</TableCell>\r\n                        <TableCell className=\"font-medium\">{call.userId || 'N/A'}</TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-2 text-slate-600\">\r\n                            <Clock className=\"h-4 w-4\" />\r\n                            {formatDuration(call.duration || 0)}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Badge variant=\"outline\">{call.status || 'Completed'}</Badge>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-600\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <Calendar className=\"h-4 w-4\" />\r\n                            {formatDate(call.createdAt)}\r\n                          </div>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    );\r\n                  })}\r\n                </TableBody>\r\n              </Table>\r\n            ) : (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <Phone className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                <h3 className=\"font-medium text-slate-900 mb-2\">No call logs yet</h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                  {searchTerm ? \"Try adjusting your search\" : \"Call logs will appear here\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\CampaignAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\CampaignViews.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\ContactTracking.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\DatabaseStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\DownloadLogs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\EmailTracking.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'EmailTracking' has a complexity of 18. Maximum allowed is 15.","line":23,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":23,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Mail, Search, Calendar, CheckCircle, XCircle, Clock } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface EmailTracking {\r\n  id: number;\r\n  contactId: number;\r\n  userId: string;\r\n  emailType: string;\r\n  subject: string;\r\n  status: 'sent' | 'delivered' | 'opened' | 'clicked' | 'bounced' | 'failed';\r\n  openedAt?: string;\r\n  clickedAt?: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function EmailTracking() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  const { data: emails, isLoading } = useQuery<EmailTracking[]>({\r\n    queryKey: ['email-tracking'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/email-tracking');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  const getStatusVariant = (status: string) => {\r\n    switch (status) {\r\n      case 'delivered': return 'default';\r\n      case 'opened': return 'default';\r\n      case 'clicked': return 'default';\r\n      case 'sent': return 'secondary';\r\n      case 'bounced': return 'destructive';\r\n      case 'failed': return 'destructive';\r\n      default: return 'outline';\r\n    }\r\n  };\r\n\r\n  const filteredEmails = emails?.filter(email =>\r\n    email.subject?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    email.contactId.toString().includes(searchTerm) ||\r\n    email.userId?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <Mail className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            Email Tracking\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Monitor email campaigns and engagement metrics\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Sent</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">{emails?.length || 0}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Delivered</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-green-600\">\r\n                {emails?.filter(e => ['delivered', 'opened', 'clicked'].includes(e.status)).length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Opened</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-blue-600\">\r\n                {emails?.filter(e => ['opened', 'clicked'].includes(e.status)).length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Clicked</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-purple-600\">\r\n                {emails?.filter(e => e.status === 'clicked').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Bounced</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-red-600\">\r\n                {emails?.filter(e => e.status === 'bounced' || e.status === 'failed').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <Card className=\"border-slate-200 shadow-sm\">\r\n          <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">Email Activity</CardTitle>\r\n                <CardDescription className=\"mt-1\">\r\n                  {filteredEmails?.length || 0} emails tracked\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"relative w-64\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                <Input\r\n                  placeholder=\"Search emails...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-9\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-0\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                  <p className=\"mt-4 text-slate-600\">Loading email tracking...</p>\r\n                </div>\r\n              </div>\r\n            ) : filteredEmails && filteredEmails.length > 0 ? (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"hover:bg-transparent border-b border-slate-100\">\r\n                    <TableHead className=\"font-semibold\">Subject</TableHead>\r\n                    <TableHead className=\"font-semibold\">Contact</TableHead>\r\n                    <TableHead className=\"font-semibold\">Type</TableHead>\r\n                    <TableHead className=\"font-semibold\">Status</TableHead>\r\n                    <TableHead className=\"font-semibold\">Sent</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {filteredEmails.map((email) => (\r\n                    <TableRow key={email.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                      <TableCell className=\"font-medium max-w-md truncate\">{email.subject}</TableCell>\r\n                      <TableCell>Contact #{email.contactId}</TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"outline\">{email.emailType || 'Marketing'}</Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Badge variant={getStatusVariant(email.status)} className=\"gap-1\">\r\n                            {email.status === 'delivered' || email.status === 'opened' || email.status === 'clicked' ? (\r\n                              <CheckCircle className=\"h-3 w-3\" />\r\n                            ) : email.status === 'bounced' || email.status === 'failed' ? (\r\n                              <XCircle className=\"h-3 w-3\" />\r\n                            ) : (\r\n                              <Clock className=\"h-3 w-3\" />\r\n                            )}\r\n                            {email.status}\r\n                          </Badge>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell className=\"text-slate-600\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Calendar className=\"h-4 w-4\" />\r\n                          {formatDate(email.createdAt)}\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            ) : (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <Mail className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                <h3 className=\"font-medium text-slate-900 mb-2\">No email tracking data</h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                  {searchTerm ? \"Try adjusting your search\" : \"Email tracking will appear here\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\FailedLogins.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\LoginHistory.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\Performance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\SearchQueries.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'SearchQueries' has a complexity of 17. Maximum allowed is 15.","line":20,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":20,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Search, Calendar, TrendingUp } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface SearchQuery {\r\n  id: number;\r\n  userId: string;\r\n  query: string;\r\n  resultsCount: number;\r\n  executionTime: number;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function SearchQueries() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  const { data: queries, isLoading } = useQuery<SearchQuery[]>({\r\n    queryKey: ['search-queries'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/search-queries');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  const filteredQueries = queries?.filter(query =>\r\n    query.query?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    query.userId?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  const popularSearches = queries?.reduce((acc: any[], query) => {\r\n    const existing = acc.find(q => q.query === query.query);\r\n    if (existing) {\r\n      existing.count++;\r\n    } else {\r\n      acc.push({ query: query.query, count: 1 });\r\n    }\r\n    return acc;\r\n  }, []).sort((a, b) => b.count - a.count).slice(0, 5);\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <Search className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            Search Queries\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Analyze user search patterns and popular queries\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Searches</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">{queries?.length || 0}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Avg Results</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-blue-600\">\r\n                {queries?.length ? Math.floor(queries.reduce((sum, q) => sum + (q.resultsCount || 0), 0) / queries.length) : 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Avg Time</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-green-600\">\r\n                {queries?.length ? (queries.reduce((sum, q) => sum + (q.executionTime || 0), 0) / queries.length).toFixed(2) : 0}ms\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader>\r\n              <CardTitle>Popular Searches</CardTitle>\r\n              <CardDescription>Most frequently searched queries</CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-3\">\r\n                {popularSearches?.map((item: any, idx: number) => (\r\n                  <div key={idx} className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <TrendingUp className=\"w-4 h-4 text-blue-600\" />\r\n                      <span className=\"text-sm font-medium text-slate-900\">{item.query}</span>\r\n                    </div>\r\n                    <Badge variant=\"secondary\">{item.count} times</Badge>\r\n                  </div>\r\n                )) || (\r\n                  <div className=\"text-center py-8 text-slate-400\">\r\n                    No popular searches yet\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200 shadow-sm\">\r\n            <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <CardTitle className=\"text-lg\">Recent Searches</CardTitle>\r\n                  <CardDescription className=\"mt-1\">\r\n                    {filteredQueries?.length || 0} queries\r\n                  </CardDescription>\r\n                </div>\r\n                <div className=\"relative w-48\">\r\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                  <Input\r\n                    placeholder=\"Filter...\"\r\n                    value={searchTerm}\r\n                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                    className=\"pl-9\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"p-0\">\r\n              {isLoading ? (\r\n                <div className=\"flex items-center justify-center py-12\">\r\n                  <div className=\"text-center\">\r\n                    <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                    <p className=\"mt-4 text-slate-600\">Loading searches...</p>\r\n                  </div>\r\n                </div>\r\n              ) : filteredQueries && filteredQueries.length > 0 ? (\r\n                <div className=\"max-h-96 overflow-y-auto\">\r\n                  <Table>\r\n                    <TableHeader>\r\n                      <TableRow className=\"hover:bg-transparent border-b border-slate-100\">\r\n                        <TableHead className=\"font-semibold\">Query</TableHead>\r\n                        <TableHead className=\"font-semibold\">Results</TableHead>\r\n                        <TableHead className=\"font-semibold\">Date</TableHead>\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {filteredQueries.slice(0, 10).map((query) => (\r\n                        <TableRow key={query.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                          <TableCell className=\"font-medium\">{query.query}</TableCell>\r\n                          <TableCell>\r\n                            <Badge variant=\"outline\">{query.resultsCount}</Badge>\r\n                          </TableCell>\r\n                          <TableCell className=\"text-slate-600 text-sm\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Calendar className=\"h-3 w-3\" />\r\n                              {formatDate(query.createdAt)}\r\n                            </div>\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      ))}\r\n                    </TableBody>\r\n                  </Table>\r\n                </div>\r\n              ) : (\r\n                <div className=\"flex flex-col items-center justify-center py-12\">\r\n                  <Search className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                  <h3 className=\"font-medium text-slate-900 mb-2\">No searches yet</h3>\r\n                  <p className=\"text-slate-500 text-sm\">\r\n                    {searchTerm ? \"Try adjusting your filter\" : \"Search queries will appear here\"}\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\SecurityEvents.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\SecurityLogs.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'SecurityLogs' has a complexity of 16. Maximum allowed is 15.","line":21,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":21,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Shield, Search, Calendar, AlertTriangle } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface SecurityLog {\r\n  id: number;\r\n  userId: string;\r\n  eventType: string;\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  description: string;\r\n  ipAddress: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function SecurityLogs() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  const { data: logs, isLoading } = useQuery<SecurityLog[]>({\r\n    queryKey: ['security-logs'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/security-logs');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 10000,\r\n  });\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit',\r\n      second: '2-digit'\r\n    });\r\n  };\r\n\r\n  const getSeverityVariant = (severity: string) => {\r\n    switch (severity) {\r\n      case 'critical': return 'destructive';\r\n      case 'high': return 'destructive';\r\n      case 'medium': return 'default';\r\n      case 'low': return 'secondary';\r\n      default: return 'outline';\r\n    }\r\n  };\r\n\r\n  const filteredLogs = logs?.filter(log =>\r\n    log.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    log.eventType?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    log.userId?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <Shield className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            Security Logs\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Monitor security events and potential threats\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Events</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">{logs?.length || 0}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Critical</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-red-600\">\r\n                {logs?.filter(l => l.severity === 'critical').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">High</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-orange-600\">\r\n                {logs?.filter(l => l.severity === 'high').length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Today</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-blue-600\">\r\n                {logs?.filter(l => new Date(l.createdAt).toDateString() === new Date().toDateString()).length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <Card className=\"border-slate-200 shadow-sm\">\r\n          <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">Security Events</CardTitle>\r\n                <CardDescription className=\"mt-1\">\r\n                  {filteredLogs?.length || 0} events recorded\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"relative w-64\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                <Input\r\n                  placeholder=\"Search events...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-9\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-0\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                  <p className=\"mt-4 text-slate-600\">Loading security logs...</p>\r\n                </div>\r\n              </div>\r\n            ) : filteredLogs && filteredLogs.length > 0 ? (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"hover:bg-transparent border-b border-slate-100\">\r\n                    <TableHead className=\"font-semibold\">Severity</TableHead>\r\n                    <TableHead className=\"font-semibold\">Event Type</TableHead>\r\n                    <TableHead className=\"font-semibold\">Description</TableHead>\r\n                    <TableHead className=\"font-semibold\">User</TableHead>\r\n                    <TableHead className=\"font-semibold\">IP Address</TableHead>\r\n                    <TableHead className=\"font-semibold\">Date</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {filteredLogs.map((log) => (\r\n                    <TableRow key={log.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                      <TableCell>\r\n                        <Badge variant={getSeverityVariant(log.severity)} className=\"gap-1\">\r\n                          {log.severity === 'critical' || log.severity === 'high' ? (\r\n                            <AlertTriangle className=\"h-3 w-3\" />\r\n                          ) : null}\r\n                          {log.severity}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"outline\">{log.eventType}</Badge>\r\n                      </TableCell>\r\n                      <TableCell className=\"font-medium max-w-md truncate\">{log.description}</TableCell>\r\n                      <TableCell>{log.userId || 'N/A'}</TableCell>\r\n                      <TableCell className=\"text-slate-600 font-mono text-sm\">{log.ipAddress}</TableCell>\r\n                      <TableCell className=\"text-slate-600\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Calendar className=\"h-4 w-4\" />\r\n                          {formatDate(log.createdAt)}\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            ) : (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <Shield className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                <h3 className=\"font-medium text-slate-900 mb-2\">No security events</h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                  {searchTerm ? \"Try adjusting your search\" : \"Security events will appear here\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\Sessions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\Settings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\SystemLogs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\UploadHistory.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'UploadHistory' has a complexity of 16. Maximum allowed is 15.","line":22,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":22,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Upload, Search, Calendar, FileText, CheckCircle, XCircle } from \"lucide-react\";\r\nimport AdminLayout from \"./AdminLayout\";\r\n\r\ninterface UploadRecord {\r\n  id: number;\r\n  userId: string;\r\n  filename: string;\r\n  fileSize: number;\r\n  campaignId: number;\r\n  success: boolean;\r\n  errorMessage: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function UploadHistory() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  const { data: uploads, isLoading } = useQuery<UploadRecord[]>({\r\n    queryKey: ['upload-history'],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', '/api/admin/upload-history');\r\n      return response.json();\r\n    },\r\n    refetchInterval: 30000,\r\n  });\r\n\r\n  const formatFileSize = (bytes: number) => {\r\n    if (bytes < 1024) return bytes + ' B';\r\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\r\n    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleString('en-US', {\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  const filteredUploads = uploads?.filter(upload =>\r\n    upload.filename?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    upload.userId?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center\">\r\n              <Upload className=\"w-6 h-6 text-white\" />\r\n            </div>\r\n            Upload History\r\n          </h1>\r\n          <p className=\"text-slate-600 mt-2\">\r\n            Track all file uploads and their status\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Uploads</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">{uploads?.length || 0}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Successful</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-green-600\">\r\n                {uploads?.filter(u => u.success).length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Failed</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-red-600\">\r\n                {uploads?.filter(u => !u.success).length || 0}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-slate-200\">\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-sm font-medium text-slate-600\">Total Size</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-3xl font-bold text-slate-900\">\r\n                {formatFileSize(uploads?.reduce((sum, u) => sum + (u.fileSize || 0), 0) || 0)}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        <Card className=\"border-slate-200 shadow-sm\">\r\n          <CardHeader className=\"border-b border-slate-100 bg-slate-50/50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">All Uploads</CardTitle>\r\n                <CardDescription className=\"mt-1\">\r\n                  {filteredUploads?.length || 0} uploads recorded\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"relative w-64\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                <Input\r\n                  placeholder=\"Search uploads...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-9\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-0\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                  <p className=\"mt-4 text-slate-600\">Loading upload history...</p>\r\n                </div>\r\n              </div>\r\n            ) : filteredUploads && filteredUploads.length > 0 ? (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow className=\"hover:bg-transparent border-b border-slate-100\">\r\n                    <TableHead className=\"font-semibold\">Filename</TableHead>\r\n                    <TableHead className=\"font-semibold\">User</TableHead>\r\n                    <TableHead className=\"font-semibold\">Size</TableHead>\r\n                    <TableHead className=\"font-semibold\">Status</TableHead>\r\n                    <TableHead className=\"font-semibold\">Date</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {filteredUploads.map((upload) => (\r\n                    <TableRow key={upload.id} className=\"hover:bg-slate-50/50 transition-colors\">\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <FileText className=\"h-4 w-4 text-slate-400\" />\r\n                          <span className=\"font-medium\">{upload.filename}</span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>{upload.userId || 'N/A'}</TableCell>\r\n                      <TableCell className=\"text-slate-600\">{formatFileSize(upload.fileSize || 0)}</TableCell>\r\n                      <TableCell>\r\n                        <Badge variant={upload.success ? 'default' : 'destructive'} className=\"gap-1\">\r\n                          {upload.success ? <CheckCircle className=\"h-3 w-3\" /> : <XCircle className=\"h-3 w-3\" />}\r\n                          {upload.success ? 'Success' : 'Failed'}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell className=\"text-slate-600\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Calendar className=\"h-4 w-4\" />\r\n                          {formatDate(upload.createdAt)}\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            ) : (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <Upload className=\"h-12 w-12 text-slate-300 mb-4\" />\r\n                <h3 className=\"font-medium text-slate-900 mb-2\">No uploads yet</h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                  {searchTerm ? \"Try adjusting your search\" : \"Upload history will appear here\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\UserChat.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'UserChat' has a complexity of 20. Maximum allowed is 15.","line":49,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":49,"endColumn":33},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 16. Maximum allowed is 15.","line":269,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":269,"endColumn":48}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback } from \"react\";\r\nimport { useLocation, useParams, Link } from \"wouter\";\r\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { \r\n  ArrowLeft, \r\n  Send, \r\n  Paperclip, \r\n  CheckCheck, \r\n  Check,\r\n  User,\r\n  Shield,\r\n  MessageSquare\r\n} from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport AdminLayout from \"./AdminLayout\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\n\r\ninterface Message {\r\n  id: string;\r\n  conversationId: string;\r\n  senderType: 'admin' | 'user';\r\n  senderId: string;\r\n  messageType: string;\r\n  content: string;\r\n  attachmentUrl?: string;\r\n  attachmentName?: string;\r\n  attachmentSize?: number;\r\n  isRead: boolean;\r\n  readAt?: string;\r\n  createdAt: string;\r\n}\r\n\r\ninterface Conversation {\r\n  id: string;\r\n  userId: string;\r\n  title: string;\r\n  unreadCount: number;\r\n  adminUnreadCount: number;\r\n  lastMessageAt: string;\r\n}\r\n\r\nexport default function UserChat() {\r\n  const params = useParams();\r\n  const userId = params.userId as string;\r\n  const [, setLocation] = useLocation();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const [messageContent, setMessageContent] = useState(\"\");\r\n  const [shouldAutoScroll, setShouldAutoScroll] = useState(true);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n\r\n  // Get or create conversation\r\n  const { data: conversation, isLoading: conversationLoading } = useQuery<Conversation>({\r\n    queryKey: ['admin-conversation', userId],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', `/api/admin/conversations/${userId}`);\r\n      return response.json();\r\n    },\r\n    enabled: !!userId,\r\n  });\r\n\r\n  // Get messages\r\n  const { data: messages = [], isLoading: messagesLoading } = useQuery<Message[]>({\r\n    queryKey: ['admin-messages', conversation?.id],\r\n    queryFn: async () => {\r\n      const response = await apiRequest('GET', `/api/admin/conversations/${conversation?.id}/messages`);\r\n      return response.json();\r\n    },\r\n    enabled: !!conversation?.id,\r\n    refetchInterval: 3000,\r\n  });\r\n\r\n  // Mark messages as read when conversation is opened\r\n  useEffect(() => {\r\n    if (conversation?.id && conversation.adminUnreadCount > 0) {\r\n      apiRequest('PATCH', `/api/admin/conversations/${conversation.id}/mark-read`)\r\n        .then(() => {\r\n          queryClient.invalidateQueries({ queryKey: ['admin-users'] });\r\n          queryClient.invalidateQueries({ queryKey: ['admin-conversation', userId] });\r\n        })\r\n        .catch(console.error);\r\n    }\r\n  }, [conversation?.id, conversation?.adminUnreadCount, queryClient, userId]);\r\n\r\n  // Handle file upload\r\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = event.target.files?.[0];\r\n    if (!file || !conversation?.id) return;\r\n\r\n    const formData = new FormData();\r\n    formData.append('file', file);\r\n\r\n    setIsUploading(true);\r\n    try {\r\n      const response = await apiRequest('POST', `/api/admin/conversations/${conversation.id}/upload`, formData);\r\n      \r\n      toast({\r\n        title: \"File Shared\",\r\n        description: `Successfully shared ${file.name}`,\r\n      });\r\n      \r\n      queryClient.invalidateQueries({ queryKey: ['admin-messages', conversation.id] });\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Upload Failed\",\r\n        description: error.message || \"Failed to upload file\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsUploading(false);\r\n      if (fileInputRef.current) fileInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  const handleDownload = (url: string) => {\r\n    window.open(url, '_blank');\r\n  };\r\n\r\n  // Auto-scroll to bottom\r\n  useEffect(() => {\r\n    if (shouldAutoScroll) {\r\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    }\r\n  }, [messages, shouldAutoScroll]);\r\n\r\n  // Check if user is near bottom\r\n  const isNearBottom = useCallback(() => {\r\n    if (!messagesContainerRef.current) return true;\r\n    const { scrollTop, scrollHeight, clientHeight } = messagesContainerRef.current;\r\n    return scrollHeight - scrollTop - clientHeight < 100;\r\n  }, []);\r\n\r\n  const handleScroll = useCallback(() => {\r\n    const nearBottom = isNearBottom();\r\n    setShouldAutoScroll(nearBottom);\r\n  }, [isNearBottom]);\r\n\r\n  // Send message mutation\r\n  const sendMessageMutation = useMutation({\r\n    mutationFn: async (content: string) => {\r\n      const response = await apiRequest('POST', `/api/admin/conversations/${conversation?.id}/messages`, {\r\n        content,\r\n        messageType: 'text',\r\n      });\r\n      return response.json();\r\n    },\r\n    onSuccess: () => {\r\n      setMessageContent(\"\");\r\n      queryClient.invalidateQueries({ queryKey: ['admin-messages', conversation?.id] });\r\n      queryClient.invalidateQueries({ queryKey: ['admin-conversation', userId] });\r\n      queryClient.invalidateQueries({ queryKey: ['admin-users'] });\r\n    },\r\n    onError: (error) => {\r\n      toast({\r\n        title: \"Failed to send message\",\r\n        description: error.message || \"Please try again\",\r\n        variant: \"destructive\"\r\n      });\r\n    }\r\n  });\r\n\r\n  const handleSendMessage = () => {\r\n    if (!messageContent.trim() || !conversation?.id) return;\r\n    sendMessageMutation.mutate(messageContent);\r\n  };\r\n\r\n  const handleKeyDown = (e: React.KeyboardEvent) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  };\r\n\r\n  if (!userId) {\r\n    return (\r\n      <AdminLayout>\r\n        <div className=\"flex items-center justify-center h-full\">\r\n          <p className=\"text-slate-500\">Invalid user ID</p>\r\n        </div>\r\n      </AdminLayout>\r\n    );\r\n  }\r\n\r\n  if (conversationLoading) {\r\n    return (\r\n      <AdminLayout>\r\n        <div className=\"flex items-center justify-center h-full\">\r\n          <div className=\"text-center\">\r\n            <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n            <p className=\"mt-4 text-slate-600\">Loading conversation...</p>\r\n          </div>\r\n        </div>\r\n      </AdminLayout>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <AdminLayout>\r\n      <div className=\"flex flex-col h-[calc(100vh-120px)]\">\r\n        {/* Chat Header */}\r\n        <Card className=\"border-b border-slate-200 shadow-sm rounded-none\">\r\n          <CardHeader className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={() => setLocation('/admin/users')}\r\n                  className=\"gap-2\"\r\n                >\r\n                  <ArrowLeft className=\"h-4 w-4\" />\r\n                  Back\r\n                </Button>\r\n                <div className=\"w-10 h-10 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center\">\r\n                  <User className=\"h-5 w-5 text-blue-700\" />\r\n                </div>\r\n                <div>\r\n                  <h2 className=\"font-semibold text-slate-900\">\r\n                    {conversation?.title || \"Loading...\"}\r\n                  </h2>\r\n                  <p className=\"text-sm text-slate-500\">Chat Conversation</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Badge variant=\"secondary\" className=\"gap-1\">\r\n                  <MessageSquare className=\"h-3 w-3\" />\r\n                  {messages.length} messages\r\n                </Badge>\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n\r\n        {/* Messages Area */}\r\n        <div \r\n          ref={messagesContainerRef}\r\n          className=\"flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50\"\r\n          onScroll={handleScroll}\r\n        >\r\n          {messagesLoading ? (\r\n            <div className=\"flex items-center justify-center h-full\">\r\n              <div className=\"text-center\">\r\n                <div className=\"inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\r\n                <p className=\"mt-4 text-slate-600\">Loading messages...</p>\r\n              </div>\r\n            </div>\r\n          ) : messages.length === 0 ? (\r\n            <div className=\"flex flex-col items-center justify-center h-full text-center\">\r\n              <div className=\"w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4\">\r\n                <MessageSquare className=\"h-8 w-8 text-slate-400\" />\r\n              </div>\r\n              <h3 className=\"font-medium text-slate-900 mb-2\">No messages yet</h3>\r\n              <p className=\"text-slate-500 text-sm max-w-md\">\r\n                Start the conversation by sending the first message to this user\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {messages.map((message, index) => {\r\n                const isAdmin = message.senderType === 'admin';\r\n                const showTimestamp = index === 0 || \r\n                  new Date(message.createdAt).getTime() - new Date(messages[index - 1].createdAt).getTime() > 5 * 60 * 1000;\r\n\r\n                return (\r\n                  <div key={message.id}>\r\n                    {showTimestamp && (\r\n                      <div className=\"flex justify-center my-4\">\r\n                        <span className=\"text-xs text-slate-500 bg-white px-3 py-1 rounded-full border border-slate-200\">\r\n                          {formatDistanceToNow(new Date(message.createdAt), { addSuffix: true })}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                    <div className={`flex items-start gap-3 ${isAdmin ? 'flex-row-reverse' : 'flex-row'}`}>\r\n                      <Avatar className=\"h-8 w-8 mt-1\">\r\n                        <AvatarFallback className={isAdmin ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}>\r\n                          {isAdmin ? <Shield className=\"h-4 w-4\" /> : <User className=\"h-4 w-4\" />}\r\n                        </AvatarFallback>\r\n                      </Avatar>\r\n                      <div className={`flex flex-col max-w-[70%] ${isAdmin ? 'items-end' : 'items-start'}`}>\r\n                        <div className={`rounded-2xl px-4 py-2 ${\r\n                          isAdmin \r\n                            ? 'bg-gradient-to-br from-purple-600 to-blue-600 text-white' \r\n                            : 'bg-white border border-slate-200 text-slate-900'\r\n                        }`}>\r\n                          {message.attachmentUrl ? (\r\n                            <div className=\"flex flex-col space-y-2\">\r\n                              <div className=\"flex items-center space-x-2\">\r\n                                <div className={`p-2 rounded ${isAdmin ? 'bg-white/20' : 'bg-slate-100'}`}>\r\n                                  <Paperclip className=\"h-4 w-4\" />\r\n                                </div>\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                  <p className=\"text-sm font-medium truncate\">{message.attachmentName}</p>\r\n                                  <p className=\"text-xs opacity-70\">\r\n                                    {message.attachmentSize ? (message.attachmentSize / 1024 / 1024).toFixed(2) + ' MB' : 'File'}\r\n                                  </p>\r\n                                </div>\r\n                              </div>\r\n                              <Button\r\n                                size=\"sm\"\r\n                                variant={isAdmin ? \"secondary\" : \"outline\"}\r\n                                className=\"w-full text-xs h-7\"\r\n                                onClick={() => handleDownload(message.attachmentUrl!)}\r\n                              >\r\n                                Download\r\n                              </Button>\r\n                              {message.content && <p className=\"text-sm mt-2\">{message.content}</p>}\r\n                            </div>\r\n                          ) : (\r\n                            <p className=\"text-sm whitespace-pre-wrap break-words\">{message.content}</p>\r\n                          )}\r\n                        </div>\r\n                        <div className={`flex items-center gap-1 mt-1 ${isAdmin ? 'flex-row-reverse' : 'flex-row'}`}>\r\n                          <span className=\"text-xs text-slate-500\">\r\n                            {new Date(message.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                          </span>\r\n                          {isAdmin && (\r\n                            <span className=\"text-slate-400\">\r\n                              {message.isRead ? (\r\n                                <CheckCheck className=\"h-3 w-3 text-blue-500\" />\r\n                              ) : (\r\n                                <Check className=\"h-3 w-3\" />\r\n                              )}\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n              <div ref={messagesEndRef} />\r\n            </>\r\n          )}\r\n        </div>\r\n\r\n        {/* Message Input */}\r\n        <Card className=\"border-t border-slate-200 shadow-lg rounded-none\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-end gap-2\">\r\n              <input\r\n                type=\"file\"\r\n                ref={fileInputRef}\r\n                onChange={handleFileUpload}\r\n                className=\"hidden\"\r\n              />\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-10 w-10 p-0 rounded-full\"\r\n                onClick={() => fileInputRef.current?.click()}\r\n                disabled={isUploading || !conversation?.id}\r\n              >\r\n                {isUploading ? (\r\n                  <div className=\"animate-spin h-5 w-5 border-2 border-purple-600 border-t-transparent rounded-full\" />\r\n                ) : (\r\n                  <Paperclip className=\"h-5 w-5 text-slate-400\" />\r\n                )}\r\n              </Button>\r\n              \r\n              <div className=\"flex-1 relative\">\r\n                <Textarea\r\n                  placeholder=\"Type a message...\"\r\n                  value={messageContent}\r\n                  onChange={(e) => setMessageContent(e.target.value)}\r\n                  onKeyDown={handleKeyDown}\r\n                  className=\"resize-none pr-12 min-h-[60px] max-h-32\"\r\n                  disabled={!conversation?.id}\r\n                />\r\n                <Button\r\n                  onClick={handleSendMessage}\r\n                  disabled={!messageContent.trim() || sendMessageMutation.isPending || !conversation?.id}\r\n                  size=\"sm\"\r\n                  className=\"absolute right-2 bottom-2 h-8 w-8 p-0 rounded-full\"\r\n                >\r\n                  {sendMessageMutation.isPending ? (\r\n                    <div className=\"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full\" />\r\n                  ) : (\r\n                    <Send className=\"h-4 w-4\" />\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-xs text-slate-500 mt-2\">Press Enter to send, Shift+Enter for new line</p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\admin\\Users.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\advanced-search.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'AdvancedSearch' has a complexity of 17. Maximum allowed is 15.","line":101,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":101,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from \"react\";\r\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\r\nimport { useLocation } from \"wouter\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\r\nimport { Slider } from \"@/components/ui/slider\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { \r\n  ArrowLeft, Search, ChevronDown, ChevronRight, X, Download, \r\n  Save, RotateCcw, Filter, Database, ArrowUpDown, ArrowUp, ArrowDown,\r\n  Loader2, Settings2, Eye, EyeOff, Table as TableIcon\r\n} from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface ColumnMetadata {\r\n  columnName: string;\r\n  dataType: string;\r\n  isNullable: boolean;\r\n  defaultValue: string | null;\r\n  maxLength: number | null;\r\n}\r\n\r\ninterface TableMetadata {\r\n  tableName: string;\r\n  columns: ColumnMetadata[];\r\n  recordCount: number;\r\n  sampleValues: Record<string, any[]>;\r\n}\r\n\r\ninterface SearchFilter {\r\n  column: string;\r\n  operator: string;\r\n  value: any;\r\n  value2?: any;\r\n}\r\n\r\ninterface SearchResult {\r\n  data: any[];\r\n  totalCount: number;\r\n  page: number;\r\n  pageSize: number;\r\n  totalPages: number;\r\n}\r\n\r\ninterface FilterGroup {\r\n  name: string;\r\n  columns: ColumnMetadata[];\r\n  type: 'text' | 'number' | 'date' | 'boolean' | 'json';\r\n  isOpen: boolean;\r\n}\r\n\r\nconst operatorsByType = {\r\n  text: [\r\n    { value: 'equals', label: 'Equals' },\r\n    { value: 'not_equals', label: 'Not Equals' },\r\n    { value: 'contains', label: 'Contains' },\r\n    { value: 'not_contains', label: 'Does Not Contain' },\r\n    { value: 'starts_with', label: 'Starts With' },\r\n    { value: 'ends_with', label: 'Ends With' },\r\n    { value: 'is_null', label: 'Is Null' },\r\n    { value: 'is_not_null', label: 'Is Not Null' },\r\n  ],\r\n  number: [\r\n    { value: 'equals', label: 'Equals' },\r\n    { value: 'not_equals', label: 'Not Equals' },\r\n    { value: 'greater_than', label: 'Greater Than' },\r\n    { value: 'less_than', label: 'Less Than' },\r\n    { value: 'greater_or_equal', label: 'Greater or Equal' },\r\n    { value: 'less_or_equal', label: 'Less or Equal' },\r\n    { value: 'between', label: 'Between' },\r\n    { value: 'is_null', label: 'Is Null' },\r\n    { value: 'is_not_null', label: 'Is Not Null' },\r\n  ],\r\n  date: [\r\n    { value: 'equals', label: 'Equals' },\r\n    { value: 'greater_than', label: 'After' },\r\n    { value: 'less_than', label: 'Before' },\r\n    { value: 'between', label: 'Between' },\r\n    { value: 'is_null', label: 'Is Null' },\r\n    { value: 'is_not_null', label: 'Is Not Null' },\r\n  ],\r\n  boolean: [\r\n    { value: 'equals', label: 'Equals' },\r\n  ],\r\n  json: [\r\n    { value: 'contains', label: 'Contains' },\r\n    { value: 'is_null', label: 'Is Null' },\r\n    { value: 'is_not_null', label: 'Is Not Null' },\r\n  ]\r\n};\r\n\r\nexport default function AdvancedSearch() {\r\n  const [, setLocation] = useLocation();\r\n  const [selectedDatabase, setSelectedDatabase] = useState<'main' | 'readonly'>('main');\r\n  const [selectedTable, setSelectedTable] = useState<string>('');\r\n  const [filters, setFilters] = useState<SearchFilter[]>([]);\r\n  const [page, setPage] = useState(1);\r\n  const [pageSize, setPageSize] = useState(50);\r\n  const [sortBy, setSortBy] = useState<string>('');\r\n  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');\r\n  const [searchResult, setSearchResult] = useState<SearchResult | null>(null);\r\n  const [filterGroups, setFilterGroups] = useState<Record<string, boolean>>({});\r\n  const [hiddenColumns, setHiddenColumns] = useState<Set<string>>(new Set());\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n  const { toast } = useToast();\r\n\r\n  // Fetch metadata\r\n  const { data: metadataResponse, isLoading: isLoadingMetadata } = useQuery({\r\n    queryKey: ['/api/advanced-search/metadata', selectedDatabase],\r\n    enabled: true,\r\n  });\r\n\r\n  const tables: TableMetadata[] = (metadataResponse as any)?.tables || [];\r\n  const currentTableMetadata = tables.find((t: TableMetadata) => t.tableName === selectedTable);\r\n\r\n  // Group columns by type for organized sidebar\r\n  const groupedColumns = useMemo(() => {\r\n    if (!currentTableMetadata) return [];\r\n\r\n    const groups: FilterGroup[] = [];\r\n    const textCols: ColumnMetadata[] = [];\r\n    const numberCols: ColumnMetadata[] = [];\r\n    const dateCols: ColumnMetadata[] = [];\r\n    const booleanCols: ColumnMetadata[] = [];\r\n    const jsonCols: ColumnMetadata[] = [];\r\n\r\n    currentTableMetadata.columns.forEach(col => {\r\n      const dataType = col.dataType.toLowerCase();\r\n      if (dataType.includes('text') || dataType.includes('char') || dataType.includes('varchar')) {\r\n        textCols.push(col);\r\n      } else if (dataType.includes('int') || dataType.includes('numeric') || dataType.includes('decimal')) {\r\n        numberCols.push(col);\r\n      } else if (dataType.includes('timestamp') || dataType.includes('date')) {\r\n        dateCols.push(col);\r\n      } else if (dataType.includes('bool')) {\r\n        booleanCols.push(col);\r\n      } else if (dataType.includes('json')) {\r\n        jsonCols.push(col);\r\n      }\r\n    });\r\n\r\n    if (textCols.length > 0) groups.push({ name: 'Text Fields', columns: textCols, type: 'text', isOpen: true });\r\n    if (numberCols.length > 0) groups.push({ name: 'Numeric Fields', columns: numberCols, type: 'number', isOpen: false });\r\n    if (dateCols.length > 0) groups.push({ name: 'Date Fields', columns: dateCols, type: 'date', isOpen: false });\r\n    if (booleanCols.length > 0) groups.push({ name: 'Boolean Fields', columns: booleanCols, type: 'boolean', isOpen: false });\r\n    if (jsonCols.length > 0) groups.push({ name: 'JSON Fields', columns: jsonCols, type: 'json', isOpen: false });\r\n\r\n    return groups;\r\n  }, [currentTableMetadata]);\r\n\r\n  // Initialize filter groups state\r\n  useEffect(() => {\r\n    const initialState: Record<string, boolean> = {};\r\n    groupedColumns.forEach((group, index) => {\r\n      initialState[group.name] = index === 0; // First group open by default\r\n    });\r\n    setFilterGroups(initialState);\r\n  }, [groupedColumns]);\r\n\r\n  // Auto-search when filters change (debounced)\r\n  useEffect(() => {\r\n    if (!selectedTable || filters.length === 0) return;\r\n    \r\n    const timer = setTimeout(() => {\r\n      handleSearch();\r\n    }, 500);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [filters, selectedTable, sortBy, sortOrder, page, pageSize]);\r\n\r\n  // Search mutation\r\n  const searchMutation = useMutation({\r\n    mutationFn: async (searchQuery: any) => {\r\n      const response = await apiRequest('POST', '/api/advanced-search/search', searchQuery);\r\n      return response.json();\r\n    },\r\n    onSuccess: (data) => {\r\n      setSearchResult(data);\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: \"Search Failed\",\r\n        description: error.message || \"Failed to execute search\",\r\n        variant: \"destructive\"\r\n      });\r\n    }\r\n  });\r\n\r\n  // Export mutation\r\n  const exportMutation = useMutation({\r\n    mutationFn: async (searchQuery: any) => {\r\n      const response = await fetch('/api/advanced-search/export', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(searchQuery),\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (!response.ok) throw new Error('Export failed');\r\n      \r\n      const blob = await response.blob();\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = `export_${selectedTable}_${Date.now()}.csv`;\r\n      a.click();\r\n      URL.revokeObjectURL(url);\r\n      return true;\r\n    },\r\n    onSuccess: () => {\r\n      toast({\r\n        title: \"Export Complete\",\r\n        description: \"Your data has been exported successfully\",\r\n      });\r\n    }\r\n  });\r\n\r\n  const handleSearch = () => {\r\n    if (!selectedTable) return;\r\n\r\n    const query = {\r\n      table: selectedTable,\r\n      filters,\r\n      sortBy,\r\n      sortOrder,\r\n      page,\r\n      pageSize,\r\n      database: selectedDatabase\r\n    };\r\n\r\n    searchMutation.mutate(query);\r\n  };\r\n\r\n  const handleExport = () => {\r\n    if (!selectedTable || !searchResult) return;\r\n    exportMutation.mutate({\r\n      table: selectedTable,\r\n      filters,\r\n      sortBy,\r\n      sortOrder,\r\n      database: selectedDatabase\r\n    });\r\n  };\r\n\r\n  const addFilter = (column: string, type: string) => {\r\n    const operators = operatorsByType[type as keyof typeof operatorsByType] || operatorsByType.text;\r\n    setFilters([...filters, {\r\n      column,\r\n      operator: operators[0].value,\r\n      value: ''\r\n    }]);\r\n  };\r\n\r\n  const removeFilter = (index: number) => {\r\n    setFilters(filters.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const updateFilter = (index: number, field: keyof SearchFilter, value: any) => {\r\n    const newFilters = [...filters];\r\n    newFilters[index] = { ...newFilters[index], [field]: value };\r\n    setFilters(newFilters);\r\n  };\r\n\r\n  const resetFilters = () => {\r\n    setFilters([]);\r\n    setSearchResult(null);\r\n    setSortBy('');\r\n    setPage(1);\r\n    toast({\r\n      title: \"Filters Reset\",\r\n      description: \"All filters have been cleared\",\r\n    });\r\n  };\r\n\r\n  const saveSearch = () => {\r\n    const searchConfig = {\r\n      database: selectedDatabase,\r\n      table: selectedTable,\r\n      filters,\r\n      sortBy,\r\n      sortOrder\r\n    };\r\n    \r\n    localStorage.setItem('saved_search', JSON.stringify(searchConfig));\r\n    toast({\r\n      title: \"Search Saved\",\r\n      description: \"Your search configuration has been saved\",\r\n    });\r\n  };\r\n\r\n  const handleSort = (columnName: string) => {\r\n    if (sortBy === columnName) {\r\n      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');\r\n    } else {\r\n      setSortBy(columnName);\r\n      setSortOrder('asc');\r\n    }\r\n  };\r\n\r\n  const toggleColumnVisibility = (columnName: string) => {\r\n    const newHidden = new Set(hiddenColumns);\r\n    if (newHidden.has(columnName)) {\r\n      newHidden.delete(columnName);\r\n    } else {\r\n      newHidden.add(columnName);\r\n    }\r\n    setHiddenColumns(newHidden);\r\n  };\r\n\r\n  const visibleColumns = useMemo(() => {\r\n    if (!searchResult?.data.length) return [];\r\n    return Object.keys(searchResult.data[0]).filter(key => !hiddenColumns.has(key));\r\n  }, [searchResult, hiddenColumns]);\r\n\r\n  useEffect(() => {\r\n    setSearchResult(null);\r\n    setFilters([]);\r\n    setSortBy('');\r\n    setPage(1);\r\n  }, [selectedTable, selectedDatabase]);\r\n\r\n  const getOperatorsForType = (type: string) => {\r\n    return operatorsByType[type as keyof typeof operatorsByType] || operatorsByType.text;\r\n  };\r\n\r\n  const getColumnType = (column: ColumnMetadata): keyof typeof operatorsByType => {\r\n    const dataType = column.dataType.toLowerCase();\r\n    if (dataType.includes('text') || dataType.includes('char')) return 'text';\r\n    if (dataType.includes('int') || dataType.includes('numeric')) return 'number';\r\n    if (dataType.includes('timestamp') || dataType.includes('date')) return 'date';\r\n    if (dataType.includes('bool')) return 'boolean';\r\n    if (dataType.includes('json')) return 'json';\r\n    return 'text';\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-50 dark:from-slate-900 dark:via-blue-950 dark:to-slate-900\">\r\n      {/* Header */}\r\n      <header className=\"bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 sticky top-0 z-40\">\r\n        <div className=\"px-6 py-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-4\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setLocation('/dashboard')}\r\n                data-testid=\"button-back\"\r\n              >\r\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n                Back to Dashboard\r\n              </Button>\r\n              <div className=\"h-6 w-px bg-slate-300 dark:bg-slate-600\" />\r\n              <div>\r\n                <h1 className=\"text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2\">\r\n                  <Database className=\"h-6 w-6 text-blue-600\" />\r\n                  Advanced Search\r\n                </h1>\r\n                <p className=\"text-sm text-slate-600 dark:text-slate-400\">\r\n                  Search across {tables.length} tables with powerful filters\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={resetFilters}\r\n                disabled={filters.length === 0}\r\n                data-testid=\"button-reset-filters\"\r\n              >\r\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\r\n                Reset Filters\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={saveSearch}\r\n                disabled={!selectedTable || filters.length === 0}\r\n                data-testid=\"button-save-search\"\r\n              >\r\n                <Save className=\"h-4 w-4 mr-2\" />\r\n                Save Search\r\n              </Button>\r\n              <Button\r\n                variant=\"default\"\r\n                size=\"sm\"\r\n                onClick={handleExport}\r\n                disabled={!searchResult || exportMutation.isPending}\r\n                data-testid=\"button-export\"\r\n              >\r\n                {exportMutation.isPending ? (\r\n                  <>\r\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                    Exporting...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Download className=\"h-4 w-4 mr-2\" />\r\n                    Export CSV\r\n                  </>\r\n                )}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <div className=\"flex h-[calc(100vh-73px)]\">\r\n        {/* Sticky Sidebar */}\r\n        <aside className=\"w-80 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 overflow-y-auto\">\r\n          <div className=\"p-4 space-y-4\">\r\n            {/* Database & Table Selection */}\r\n            <div className=\"space-y-3\">\r\n              <div>\r\n                <Label htmlFor=\"database-select\" className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide\">\r\n                  Database\r\n                </Label>\r\n                <Select value={selectedDatabase} onValueChange={(value: any) => setSelectedDatabase(value)}>\r\n                  <SelectTrigger id=\"database-select\" className=\"mt-1\" data-testid=\"select-database\">\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"main\">Main Database</SelectItem>\r\n                    <SelectItem value=\"readonly\">Read-Only Database</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              <div>\r\n                <Label htmlFor=\"table-select\" className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide\">\r\n                  Table\r\n                </Label>\r\n                <Select value={selectedTable} onValueChange={setSelectedTable} disabled={isLoadingMetadata}>\r\n                  <SelectTrigger id=\"table-select\" className=\"mt-1\" data-testid=\"select-table\">\r\n                    <SelectValue placeholder={isLoadingMetadata ? \"Loading...\" : \"Select a table\"} />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {tables.map((table: TableMetadata) => (\r\n                      <SelectItem key={table.tableName} value={table.tableName} data-testid={`option-table-${table.tableName}`}>\r\n                        <div className=\"flex items-center justify-between w-full\">\r\n                          <span>{table.tableName}</span>\r\n                          <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\r\n                            {table.recordCount.toLocaleString()}\r\n                          </Badge>\r\n                        </div>\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Active Filters - Edit Mode */}\r\n            {filters.length > 0 && (\r\n              <div className=\"space-y-2\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide\">\r\n                    Active Filters ({filters.length})\r\n                  </span>\r\n                </div>\r\n                {filters.map((filter, index) => {\r\n                  const column = currentTableMetadata?.columns.find(c => c.columnName === filter.column);\r\n                  const columnType = column ? getColumnType(column) : 'text';\r\n                  const operators = getOperatorsForType(columnType);\r\n                  const needsValue = !['is_null', 'is_not_null'].includes(filter.operator);\r\n                  const needsSecondValue = filter.operator === 'between';\r\n                  \r\n                  return (\r\n                    <div key={index} className=\"p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700 space-y-2\" data-testid={`filter-${index}`}>\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300 truncate\">\r\n                          {filter.column}\r\n                        </span>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          className=\"h-6 w-6 p-0\"\r\n                          onClick={() => removeFilter(index)}\r\n                          data-testid={`button-remove-filter-${index}`}\r\n                        >\r\n                          <X className=\"h-3 w-3\" />\r\n                        </Button>\r\n                      </div>\r\n                      \r\n                      <Select\r\n                        value={filter.operator}\r\n                        onValueChange={(value) => updateFilter(index, 'operator', value)}\r\n                      >\r\n                        <SelectTrigger className=\"h-8 text-xs\" data-testid={`select-filter-operator-${index}`}>\r\n                          <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          {operators.map((op) => (\r\n                            <SelectItem key={op.value} value={op.value}>{op.label}</SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n                      \r\n                      {needsValue && (\r\n                        <>\r\n                          {(currentTableMetadata?.sampleValues[filter.column]?.length ?? 0) > 0 ? (\r\n                            <Select\r\n                              value={filter.value}\r\n                              onValueChange={(value) => updateFilter(index, 'value', value)}\r\n                            >\r\n                              <SelectTrigger className=\"h-8 text-xs\" data-testid={`select-filter-value-${index}`}>\r\n                                <SelectValue placeholder=\"Select value\" />\r\n                              </SelectTrigger>\r\n                              <SelectContent>\r\n                                {currentTableMetadata?.sampleValues[filter.column]?.map((val: any, i: number) => (\r\n                                  <SelectItem key={i} value={String(val)}>{String(val)}</SelectItem>\r\n                                )) ?? []}\r\n                              </SelectContent>\r\n                            </Select>\r\n                          ) : (\r\n                            <Input\r\n                              placeholder={needsSecondValue ? \"From value\" : \"Value\"}\r\n                              value={filter.value || ''}\r\n                              onChange={(e) => updateFilter(index, 'value', e.target.value)}\r\n                              className=\"h-8 text-xs\"\r\n                              data-testid={`input-filter-value-${index}`}\r\n                            />\r\n                          )}\r\n                          \r\n                          {needsSecondValue && (\r\n                            <Input\r\n                              placeholder=\"To value\"\r\n                              value={filter.value2 || ''}\r\n                              onChange={(e) => updateFilter(index, 'value2', e.target.value)}\r\n                              className=\"h-8 text-xs\"\r\n                              data-testid={`input-filter-value2-${index}`}\r\n                            />\r\n                          )}\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n            )}\r\n\r\n            {/* Filter Groups */}\r\n            {selectedTable && currentTableMetadata && (\r\n              <div className=\"space-y-2\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <Filter className=\"h-4 w-4 text-slate-600 dark:text-slate-400\" />\r\n                  <span className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide\">\r\n                    Add Filters\r\n                  </span>\r\n                </div>\r\n\r\n                {groupedColumns.map((group) => (\r\n                  <Collapsible\r\n                    key={group.name}\r\n                    open={filterGroups[group.name]}\r\n                    onOpenChange={(open) => setFilterGroups({ ...filterGroups, [group.name]: open })}\r\n                  >\r\n                    <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors\">\r\n                      <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                        {group.name}\r\n                      </span>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Badge variant=\"outline\" className=\"text-xs\">\r\n                          {group.columns.length}\r\n                        </Badge>\r\n                        {filterGroups[group.name] ? (\r\n                          <ChevronDown className=\"h-4 w-4\" />\r\n                        ) : (\r\n                          <ChevronRight className=\"h-4 w-4\" />\r\n                        )}\r\n                      </div>\r\n                    </CollapsibleTrigger>\r\n                    <CollapsibleContent className=\"mt-1 space-y-1\">\r\n                      {group.columns.map((column) => (\r\n                        <Button\r\n                          key={column.columnName}\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          className=\"w-full justify-start text-sm font-normal\"\r\n                          onClick={() => addFilter(column.columnName, group.type)}\r\n                          data-testid={`button-add-filter-${column.columnName}`}\r\n                        >\r\n                          <span className=\"truncate\">{column.columnName}</span>\r\n                          <span className=\"ml-auto text-xs text-slate-500\">\r\n                            {column.dataType}\r\n                          </span>\r\n                        </Button>\r\n                      ))}\r\n                    </CollapsibleContent>\r\n                  </Collapsible>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {!selectedTable && (\r\n              <div className=\"text-center py-12 text-slate-500 dark:text-slate-400\">\r\n                <TableIcon className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\r\n                <p className=\"text-sm\">Select a table to start building filters</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </aside>\r\n\r\n        {/* Main Content Area */}\r\n        <main className=\"flex-1 overflow-auto\">\r\n          <div className=\"p-6 space-y-4\">\r\n            {/* Search executing indicator */}\r\n            {searchMutation.isPending && (\r\n              <div className=\"flex items-center justify-center p-4 bg-blue-50 dark:bg-blue-950/30 rounded-lg\">\r\n                <Loader2 className=\"h-5 w-5 animate-spin text-blue-600 mr-2\" />\r\n                <span className=\"text-sm text-blue-700 dark:text-blue-300\">Searching...</span>\r\n              </div>\r\n            )}\r\n\r\n            {/* Results */}\r\n            {searchResult && (\r\n              <Card data-testid=\"card-results\">\r\n                <CardContent className=\"p-0\">\r\n                  <div className=\"p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between bg-slate-50 dark:bg-slate-800/50\">\r\n                    <div>\r\n                      <h3 className=\"font-semibold text-slate-900 dark:text-white\">Results</h3>\r\n                      <p className=\"text-sm text-slate-600 dark:text-slate-400\">\r\n                        Showing {searchResult.data.length} of {searchResult.totalCount.toLocaleString()} records\r\n                      </p>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"text-sm text-slate-600 dark:text-slate-400\">\r\n                        Page {searchResult.page} of {searchResult.totalPages}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <ScrollArea className=\"h-[calc(100vh-300px)]\">\r\n                    <Table>\r\n                      <TableHeader>\r\n                        <TableRow>\r\n                          {visibleColumns.map((key) => (\r\n                            <TableHead key={key} className=\"bg-slate-100 dark:bg-slate-800 sticky top-0\">\r\n                              <div className=\"flex items-center justify-between\">\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => handleSort(key)}\r\n                                  className=\"h-8 px-2 hover:bg-slate-200 dark:hover:bg-slate-700 font-medium\"\r\n                                  data-testid={`button-sort-${key}`}\r\n                                >\r\n                                  {key}\r\n                                  {sortBy === key && (\r\n                                    sortOrder === 'asc' ? \r\n                                      <ArrowUp className=\"ml-1 h-3 w-3\" /> : \r\n                                      <ArrowDown className=\"ml-1 h-3 w-3\" />\r\n                                  )}\r\n                                  {sortBy !== key && <ArrowUpDown className=\"ml-1 h-3 w-3 opacity-30\" />}\r\n                                </Button>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  className=\"h-6 w-6 p-0\"\r\n                                  onClick={() => toggleColumnVisibility(key)}\r\n                                >\r\n                                  <EyeOff className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </div>\r\n                            </TableHead>\r\n                          ))}\r\n                        </TableRow>\r\n                      </TableHeader>\r\n                      <TableBody>\r\n                        {searchResult.data.map((row, rowIndex) => (\r\n                          <TableRow key={rowIndex} data-testid={`row-result-${rowIndex}`}>\r\n                            {visibleColumns.map((key) => (\r\n                              <TableCell key={key} className=\"font-mono text-sm\" data-testid={`cell-${rowIndex}-${key}`}>\r\n                                {row[key] === null ? (\r\n                                  <span className=\"text-slate-400 italic\">null</span>\r\n                                ) : typeof row[key] === 'boolean' ? (\r\n                                  <Badge variant={row[key] ? 'default' : 'secondary'}>\r\n                                    {String(row[key])}\r\n                                  </Badge>\r\n                                ) : typeof row[key] === 'object' ? (\r\n                                  <span className=\"text-xs\">{JSON.stringify(row[key])}</span>\r\n                                ) : (\r\n                                  String(row[key])\r\n                                )}\r\n                              </TableCell>\r\n                            ))}\r\n                          </TableRow>\r\n                        ))}\r\n                      </TableBody>\r\n                    </Table>\r\n                  </ScrollArea>\r\n\r\n                  {/* Pagination */}\r\n                  <div className=\"p-4 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between bg-slate-50 dark:bg-slate-800/50\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Label className=\"text-sm\">Rows per page:</Label>\r\n                      <Select\r\n                        value={String(pageSize)}\r\n                        onValueChange={(value) => {\r\n                          setPageSize(parseInt(value));\r\n                          setPage(1);\r\n                        }}\r\n                      >\r\n                        <SelectTrigger className=\"w-20\" data-testid=\"select-page-size\">\r\n                          <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          <SelectItem value=\"25\">25</SelectItem>\r\n                          <SelectItem value=\"50\">50</SelectItem>\r\n                          <SelectItem value=\"100\">100</SelectItem>\r\n                          <SelectItem value=\"250\">250</SelectItem>\r\n                        </SelectContent>\r\n                      </Select>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setPage(Math.max(1, page - 1))}\r\n                        disabled={page === 1}\r\n                        data-testid=\"button-prev-page\"\r\n                      >\r\n                        Previous\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setPage(Math.min(searchResult.totalPages, page + 1))}\r\n                        disabled={page === searchResult.totalPages}\r\n                        data-testid=\"button-next-page\"\r\n                      >\r\n                        Next\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n\r\n            {!searchResult && selectedTable && filters.length === 0 && (\r\n              <div className=\"text-center py-16\">\r\n                <Search className=\"h-16 w-16 mx-auto mb-4 text-slate-300 dark:text-slate-600\" />\r\n                <h3 className=\"text-lg font-medium text-slate-900 dark:text-white mb-2\">\r\n                  Add filters to search\r\n                </h3>\r\n                <p className=\"text-slate-600 dark:text-slate-400\">\r\n                  Use the sidebar to add filter conditions and refine your search\r\n                </p>\r\n              </div>\r\n            )}\r\n\r\n            {!selectedTable && (\r\n              <div className=\"text-center py-16\">\r\n                <Database className=\"h-16 w-16 mx-auto mb-4 text-slate-300 dark:text-slate-600\" />\r\n                <h3 className=\"text-lg font-medium text-slate-900 dark:text-white mb-2\">\r\n                  Select a table to begin\r\n                </h3>\r\n                <p className=\"text-slate-600 dark:text-slate-400\">\r\n                  Choose a table from the sidebar to start your advanced search\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </main>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\api-docs.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 22. Maximum allowed is 15.","line":862,"column":65,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":862,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { \r\n  Code, \r\n  Phone, \r\n  MessageSquare, \r\n  Users, \r\n  Mic,\r\n  Key,\r\n  Copy,\r\n  Check,\r\n  Play,\r\n  Book,\r\n  Terminal,\r\n  Zap,\r\n  Shield,\r\n  Globe,\r\n  ChevronRight,\r\n  Database,\r\n  FileText,\r\n  Download\r\n} from \"lucide-react\";\r\nimport { Link } from \"wouter\";\r\nimport fallOwlLogo from \"../assets/closo_logo.png\";\r\nimport { EnterpriseFooter } from \"@/components/EnterpriseFooter\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { useMutation } from \"@tanstack/react-query\";\r\nimport { apiRequest } from \"@/lib/queryClient\";\r\n\r\nexport default function ApiDocs() {\r\n  const [apiKey, setApiKey] = useState(\"\");\r\n  const [copiedCode, setCopiedCode] = useState<string | null>(null);\r\n  const [activeEndpoint, setActiveEndpoint] = useState(\"calls\");\r\n  const { toast } = useToast();\r\n\r\n  const [testCallTo, setTestCallTo] = useState(\"\");\r\n  const [testCallFrom, setTestCallFrom] = useState(\"\");\r\n  const [testSmsTo, setTestSmsTo] = useState(\"\");\r\n  const [testSmsBody, setTestSmsBody] = useState(\"\");\r\n  const [testContactName, setTestContactName] = useState(\"\");\r\n  const [testContactPhone, setTestContactPhone] = useState(\"\");\r\n\r\n  const copyToClipboard = (text: string, id: string) => {\r\n    navigator.clipboard.writeText(text);\r\n    setCopiedCode(id);\r\n    setTimeout(() => setCopiedCode(null), 2000);\r\n  };\r\n\r\n  const generateApiKeyMutation = useMutation({\r\n    mutationFn: async () => {\r\n      const response = await apiRequest(\"POST\", \"/api/generate-api-key\", {});\r\n      return response.json();\r\n    },\r\n    onSuccess: (data: any) => {\r\n      setApiKey(data.apiKey);\r\n      toast({ title: \"API Key Generated\", description: \"Your new API key has been created\" });\r\n    },\r\n    onError: () => {\r\n      toast({ title: \"Error\", description: \"Failed to generate API key\", variant: \"destructive\" });\r\n    },\r\n  });\r\n\r\n  const testCallMutation = useMutation({\r\n    mutationFn: async () => {\r\n      const response = await apiRequest(\"POST\", \"/api/test/make-call\", {\r\n        apiKey,\r\n        to: testCallTo,\r\n        from: testCallFrom\r\n      });\r\n      return response.json();\r\n    },\r\n    onSuccess: (data: any) => {\r\n      toast({ title: \"Call Initiated\", description: `Call SID: ${data.callSid}` });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\r\n    },\r\n  });\r\n\r\n  const testSmsMutation = useMutation({\r\n    mutationFn: async () => {\r\n      const response = await apiRequest(\"POST\", \"/api/test/send-sms\", {\r\n        apiKey,\r\n        to: testSmsTo,\r\n        body: testSmsBody\r\n      });\r\n      return response.json();\r\n    },\r\n    onSuccess: (data: any) => {\r\n      toast({ title: \"SMS Sent\", description: `Message SID: ${data.messageSid}` });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\r\n    },\r\n  });\r\n\r\n  const testContactMutation = useMutation({\r\n    mutationFn: async () => {\r\n      const response = await apiRequest(\"POST\", \"/api/test/create-contact\", {\r\n        apiKey,\r\n        name: testContactName,\r\n        phone: testContactPhone\r\n      });\r\n      return response.json();\r\n    },\r\n    onSuccess: (data: any) => {\r\n      toast({ title: \"Contact Created\", description: `Contact ID: ${data.contactId}` });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\r\n    },\r\n  });\r\n\r\n  const endpoints = [\r\n    {\r\n      id: \"calls\",\r\n      name: \"Voice Calls\",\r\n      icon: Phone,\r\n      color: \"from-purple-500 to-purple-600\",\r\n      description: \"Make and manage voice calls\",\r\n      endpoints: [\r\n        {\r\n          method: \"POST\",\r\n          path: \"/v1/calls\",\r\n          title: \"Make a Call\",\r\n          description: \"Initiate an outbound call\",\r\n          params: [\r\n            { name: \"to\", type: \"string\", required: true, description: \"Destination phone number in E.164 format\" },\r\n            { name: \"from\", type: \"string\", required: true, description: \"Your FallOwl phone number\" },\r\n            { name: \"url\", type: \"string\", required: false, description: \"TwiML URL for call instructions\" },\r\n            { name: \"record\", type: \"boolean\", required: false, description: \"Whether to record the call\" },\r\n            { name: \"statusCallback\", type: \"string\", required: false, description: \"Webhook URL for call status updates\" }\r\n          ],\r\n          example: `curl -X POST https://api.fallowl.com/v1/calls \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\" \\\\\r\n  -H \"Content-Type: application/json\" \\\\\r\n  -d '{\r\n    \"to\": \"+1234567890\",\r\n    \"from\": \"+0987654321\",\r\n    \"record\": true,\r\n    \"url\": \"https://yourapp.com/twiml\"\r\n  }'`,\r\n          response: `{\r\n  \"callSid\": \"CA1234567890abcdef\",\r\n  \"status\": \"queued\",\r\n  \"to\": \"+1234567890\",\r\n  \"from\": \"+0987654321\",\r\n  \"direction\": \"outbound-api\",\r\n  \"dateCreated\": \"2024-10-04T12:00:00Z\"\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/calls/:callSid\",\r\n          title: \"Get Call Details\",\r\n          description: \"Retrieve information about a specific call\",\r\n          params: [\r\n            { name: \"callSid\", type: \"string\", required: true, description: \"Unique call identifier\" }\r\n          ],\r\n          example: `curl -X GET https://api.fallowl.com/v1/calls/CA1234567890abcdef \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"callSid\": \"CA1234567890abcdef\",\r\n  \"status\": \"completed\",\r\n  \"to\": \"+1234567890\",\r\n  \"from\": \"+0987654321\",\r\n  \"duration\": \"42\",\r\n  \"price\": \"-0.0200\",\r\n  \"recordingUrl\": \"https://api.fallowl.com/v1/recordings/RE123...\"\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/calls\",\r\n          title: \"List Calls\",\r\n          description: \"Retrieve a list of calls made from your account\",\r\n          params: [\r\n            { name: \"limit\", type: \"integer\", required: false, description: \"Number of records to return (max 1000)\" },\r\n            { name: \"status\", type: \"string\", required: false, description: \"Filter by call status (queued, ringing, in-progress, completed, failed)\" },\r\n            { name: \"from\", type: \"string\", required: false, description: \"Filter by caller phone number\" },\r\n            { name: \"to\", type: \"string\", required: false, description: \"Filter by recipient phone number\" }\r\n          ],\r\n          example: `curl -X GET \"https://api.fallowl.com/v1/calls?limit=20&status=completed\" \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"calls\": [\r\n    {\r\n      \"callSid\": \"CA1234567890abcdef\",\r\n      \"status\": \"completed\",\r\n      \"to\": \"+1234567890\",\r\n      \"from\": \"+0987654321\",\r\n      \"duration\": \"42\"\r\n    }\r\n  ],\r\n  \"total\": 1,\r\n  \"page\": 1\r\n}`\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      id: \"sms\",\r\n      name: \"SMS Messages\",\r\n      icon: MessageSquare,\r\n      color: \"from-teal-500 to-cyan-500\",\r\n      description: \"Send and manage text messages\",\r\n      endpoints: [\r\n        {\r\n          method: \"POST\",\r\n          path: \"/v1/messages\",\r\n          title: \"Send SMS\",\r\n          description: \"Send an SMS message\",\r\n          params: [\r\n            { name: \"to\", type: \"string\", required: true, description: \"Destination phone number in E.164 format\" },\r\n            { name: \"from\", type: \"string\", required: true, description: \"Your FallOwl phone number\" },\r\n            { name: \"body\", type: \"string\", required: true, description: \"Message text (max 1600 characters)\" },\r\n            { name: \"mediaUrl\", type: \"array\", required: false, description: \"URLs of media to send (MMS)\" },\r\n            { name: \"statusCallback\", type: \"string\", required: false, description: \"Webhook URL for message status updates\" }\r\n          ],\r\n          example: `curl -X POST https://api.fallowl.com/v1/messages \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\" \\\\\r\n  -H \"Content-Type: application/json\" \\\\\r\n  -d '{\r\n    \"to\": \"+1234567890\",\r\n    \"from\": \"+0987654321\",\r\n    \"body\": \"Hello from FallOwl!\"\r\n  }'`,\r\n          response: `{\r\n  \"messageSid\": \"SM1234567890abcdef\",\r\n  \"status\": \"queued\",\r\n  \"to\": \"+1234567890\",\r\n  \"from\": \"+0987654321\",\r\n  \"body\": \"Hello from FallOwl!\",\r\n  \"numSegments\": \"1\",\r\n  \"dateCreated\": \"2024-10-04T12:00:00Z\"\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/messages/:messageSid\",\r\n          title: \"Get Message Details\",\r\n          description: \"Retrieve information about a specific message\",\r\n          params: [\r\n            { name: \"messageSid\", type: \"string\", required: true, description: \"Unique message identifier\" }\r\n          ],\r\n          example: `curl -X GET https://api.fallowl.com/v1/messages/SM1234567890abcdef \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"messageSid\": \"SM1234567890abcdef\",\r\n  \"status\": \"delivered\",\r\n  \"to\": \"+1234567890\",\r\n  \"from\": \"+0987654321\",\r\n  \"body\": \"Hello from FallOwl!\",\r\n  \"price\": \"-0.0075\",\r\n  \"dateCreated\": \"2024-10-04T12:00:00Z\",\r\n  \"dateSent\": \"2024-10-04T12:00:02Z\"\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/messages\",\r\n          title: \"List Messages\",\r\n          description: \"Retrieve a list of messages\",\r\n          params: [\r\n            { name: \"limit\", type: \"integer\", required: false, description: \"Number of records to return (max 1000)\" },\r\n            { name: \"from\", type: \"string\", required: false, description: \"Filter by sender phone number\" },\r\n            { name: \"to\", type: \"string\", required: false, description: \"Filter by recipient phone number\" }\r\n          ],\r\n          example: `curl -X GET \"https://api.fallowl.com/v1/messages?limit=20\" \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"messages\": [\r\n    {\r\n      \"messageSid\": \"SM1234567890abcdef\",\r\n      \"status\": \"delivered\",\r\n      \"to\": \"+1234567890\",\r\n      \"from\": \"+0987654321\",\r\n      \"body\": \"Hello from FallOwl!\"\r\n    }\r\n  ],\r\n  \"total\": 1,\r\n  \"page\": 1\r\n}`\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      id: \"contacts\",\r\n      name: \"Contacts\",\r\n      icon: Users,\r\n      color: \"from-orange-400 to-pink-500\",\r\n      description: \"Manage your contact database\",\r\n      endpoints: [\r\n        {\r\n          method: \"POST\",\r\n          path: \"/v1/contacts\",\r\n          title: \"Create Contact\",\r\n          description: \"Add a new contact to your database\",\r\n          params: [\r\n            { name: \"name\", type: \"string\", required: true, description: \"Contact's full name\" },\r\n            { name: \"phone\", type: \"string\", required: true, description: \"Contact's phone number\" },\r\n            { name: \"email\", type: \"string\", required: false, description: \"Contact's email address\" },\r\n            { name: \"company\", type: \"string\", required: false, description: \"Contact's company name\" },\r\n            { name: \"tags\", type: \"array\", required: false, description: \"Tags for categorizing contact\" },\r\n            { name: \"customFields\", type: \"object\", required: false, description: \"Custom metadata key-value pairs\" }\r\n          ],\r\n          example: `curl -X POST https://api.fallowl.com/v1/contacts \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\" \\\\\r\n  -H \"Content-Type: application/json\" \\\\\r\n  -d '{\r\n    \"name\": \"John Doe\",\r\n    \"phone\": \"+1234567890\",\r\n    \"email\": \"john@example.com\",\r\n    \"company\": \"Acme Inc\",\r\n    \"tags\": [\"lead\", \"high-priority\"]\r\n  }'`,\r\n          response: `{\r\n  \"contactId\": \"CON1234567890\",\r\n  \"name\": \"John Doe\",\r\n  \"phone\": \"+1234567890\",\r\n  \"email\": \"john@example.com\",\r\n  \"company\": \"Acme Inc\",\r\n  \"tags\": [\"lead\", \"high-priority\"],\r\n  \"createdAt\": \"2024-10-04T12:00:00Z\"\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/contacts/:contactId\",\r\n          title: \"Get Contact\",\r\n          description: \"Retrieve a specific contact's details\",\r\n          params: [\r\n            { name: \"contactId\", type: \"string\", required: true, description: \"Unique contact identifier\" }\r\n          ],\r\n          example: `curl -X GET https://api.fallowl.com/v1/contacts/CON1234567890 \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"contactId\": \"CON1234567890\",\r\n  \"name\": \"John Doe\",\r\n  \"phone\": \"+1234567890\",\r\n  \"email\": \"john@example.com\",\r\n  \"company\": \"Acme Inc\",\r\n  \"tags\": [\"lead\", \"high-priority\"],\r\n  \"callHistory\": 5,\r\n  \"lastContact\": \"2024-10-03T15:30:00Z\"\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/contacts\",\r\n          title: \"List Contacts\",\r\n          description: \"Retrieve all contacts with optional filters\",\r\n          params: [\r\n            { name: \"limit\", type: \"integer\", required: false, description: \"Number of records to return (max 1000)\" },\r\n            { name: \"search\", type: \"string\", required: false, description: \"Search by name, phone, or email\" },\r\n            { name: \"tags\", type: \"string\", required: false, description: \"Filter by tags (comma-separated)\" }\r\n          ],\r\n          example: `curl -X GET \"https://api.fallowl.com/v1/contacts?limit=20&tags=lead\" \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"contacts\": [\r\n    {\r\n      \"contactId\": \"CON1234567890\",\r\n      \"name\": \"John Doe\",\r\n      \"phone\": \"+1234567890\",\r\n      \"email\": \"john@example.com\"\r\n    }\r\n  ],\r\n  \"total\": 1,\r\n  \"page\": 1\r\n}`\r\n        },\r\n        {\r\n          method: \"PUT\",\r\n          path: \"/v1/contacts/:contactId\",\r\n          title: \"Update Contact\",\r\n          description: \"Update an existing contact's information\",\r\n          params: [\r\n            { name: \"contactId\", type: \"string\", required: true, description: \"Unique contact identifier\" },\r\n            { name: \"name\", type: \"string\", required: false, description: \"Updated name\" },\r\n            { name: \"phone\", type: \"string\", required: false, description: \"Updated phone\" },\r\n            { name: \"email\", type: \"string\", required: false, description: \"Updated email\" },\r\n            { name: \"tags\", type: \"array\", required: false, description: \"Updated tags\" }\r\n          ],\r\n          example: `curl -X PUT https://api.fallowl.com/v1/contacts/CON1234567890 \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\" \\\\\r\n  -H \"Content-Type: application/json\" \\\\\r\n  -d '{\r\n    \"tags\": [\"customer\", \"high-priority\"]\r\n  }'`,\r\n          response: `{\r\n  \"contactId\": \"CON1234567890\",\r\n  \"name\": \"John Doe\",\r\n  \"tags\": [\"customer\", \"high-priority\"],\r\n  \"updatedAt\": \"2024-10-04T12:00:00Z\"\r\n}`\r\n        },\r\n        {\r\n          method: \"DELETE\",\r\n          path: \"/v1/contacts/:contactId\",\r\n          title: \"Delete Contact\",\r\n          description: \"Remove a contact from your database\",\r\n          params: [\r\n            { name: \"contactId\", type: \"string\", required: true, description: \"Unique contact identifier\" }\r\n          ],\r\n          example: `curl -X DELETE https://api.fallowl.com/v1/contacts/CON1234567890 \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"success\": true,\r\n  \"message\": \"Contact deleted successfully\"\r\n}`\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      id: \"recordings\",\r\n      name: \"Recordings\",\r\n      icon: Mic,\r\n      color: \"from-purple-500 to-purple-600\",\r\n      description: \"Access and manage call recordings\",\r\n      endpoints: [\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/recordings\",\r\n          title: \"List Recordings\",\r\n          description: \"Retrieve a list of call recordings\",\r\n          params: [\r\n            { name: \"limit\", type: \"integer\", required: false, description: \"Number of records to return (max 1000)\" },\r\n            { name: \"callSid\", type: \"string\", required: false, description: \"Filter by specific call SID\" },\r\n            { name: \"dateCreated\", type: \"string\", required: false, description: \"Filter by creation date (YYYY-MM-DD)\" }\r\n          ],\r\n          example: `curl -X GET \"https://api.fallowl.com/v1/recordings?limit=20\" \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"recordings\": [\r\n    {\r\n      \"recordingSid\": \"RE1234567890abcdef\",\r\n      \"callSid\": \"CA1234567890abcdef\",\r\n      \"duration\": \"42\",\r\n      \"dateCreated\": \"2024-10-04T12:00:00Z\",\r\n      \"url\": \"https://api.fallowl.com/v1/recordings/RE123...\"\r\n    }\r\n  ],\r\n  \"total\": 1,\r\n  \"page\": 1\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/recordings/:recordingSid\",\r\n          title: \"Get Recording\",\r\n          description: \"Retrieve details about a specific recording\",\r\n          params: [\r\n            { name: \"recordingSid\", type: \"string\", required: true, description: \"Unique recording identifier\" }\r\n          ],\r\n          example: `curl -X GET https://api.fallowl.com/v1/recordings/RE1234567890abcdef \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"recordingSid\": \"RE1234567890abcdef\",\r\n  \"callSid\": \"CA1234567890abcdef\",\r\n  \"duration\": \"42\",\r\n  \"channels\": \"1\",\r\n  \"source\": \"OutboundAPI\",\r\n  \"url\": \"https://api.fallowl.com/v1/recordings/RE123.../download\",\r\n  \"transcription\": {\r\n    \"text\": \"Hello, this is a sample call...\",\r\n    \"confidence\": 0.95\r\n  }\r\n}`\r\n        },\r\n        {\r\n          method: \"GET\",\r\n          path: \"/v1/recordings/:recordingSid/download\",\r\n          title: \"Download Recording\",\r\n          description: \"Download the audio file of a recording\",\r\n          params: [\r\n            { name: \"recordingSid\", type: \"string\", required: true, description: \"Unique recording identifier\" },\r\n            { name: \"format\", type: \"string\", required: false, description: \"Audio format (mp3, wav) - default: mp3\" }\r\n          ],\r\n          example: `curl -X GET \"https://api.fallowl.com/v1/recordings/RE123.../download?format=mp3\" \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\" \\\\\r\n  -o recording.mp3`,\r\n          response: `Binary audio data (Content-Type: audio/mpeg)`\r\n        },\r\n        {\r\n          method: \"DELETE\",\r\n          path: \"/v1/recordings/:recordingSid\",\r\n          title: \"Delete Recording\",\r\n          description: \"Permanently delete a call recording\",\r\n          params: [\r\n            { name: \"recordingSid\", type: \"string\", required: true, description: \"Unique recording identifier\" }\r\n          ],\r\n          example: `curl -X DELETE https://api.fallowl.com/v1/recordings/RE1234567890abcdef \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`,\r\n          response: `{\r\n  \"success\": true,\r\n  \"message\": \"Recording deleted successfully\"\r\n}`\r\n        }\r\n      ]\r\n    }\r\n  ];\r\n\r\n  const selectedCategory = endpoints.find(e => e.id === activeEndpoint);\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#F8F7F5] text-slate-900\">\r\n      {/* Navigation */}\r\n      <nav className=\"sticky top-0 z-50 px-4 md:px-6 lg:px-8 bg-white/80 backdrop-blur-xl border-b border-gray-200/50 shadow-sm\">\r\n        <div className=\"max-w-7xl mx-auto\">\r\n          <div className=\"px-4 md:px-6\">\r\n            <div className=\"flex justify-between items-center h-16\">\r\n              <Link href=\"/\">\r\n                <a className=\"flex items-center cursor-pointer\" data-testid=\"link-home\">\r\n                  <img \r\n                    src={fallOwlLogo} \r\n                    alt=\"Closo\" \r\n                    className=\"h-10 w-auto object-contain\"\r\n                  />\r\n                </a>\r\n              </Link>\r\n              \r\n              <div className=\"flex items-center space-x-6\">\r\n                <a href=\"#getting-started\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\" data-testid=\"link-getting-started\">Getting Started</a>\r\n                <a href=\"#authentication\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\" data-testid=\"link-authentication\">Authentication</a>\r\n                <a href=\"#endpoints\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\" data-testid=\"link-endpoints\">API Reference</a>\r\n                <Link href=\"/\">\r\n                  <Button size=\"sm\" className=\"bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white\" data-testid=\"button-back-home\">\r\n                    Back to Home\r\n                  </Button>\r\n                </Link>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </nav>\r\n\r\n      {/* Hero Section */}\r\n      <section className=\"py-16 bg-gradient-to-br from-purple-50 via-white to-teal-50\">\r\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\r\n          <div className=\"text-center max-w-4xl mx-auto\">\r\n            <div className=\"inline-flex items-center gap-2 bg-white rounded-full px-4 py-2 mb-6 border border-purple-200 shadow-sm\">\r\n              <Code className=\"w-4 h-4 text-purple-600\" />\r\n              <span className=\"text-sm font-medium text-purple-600\">API Documentation v1.0</span>\r\n            </div>\r\n            \r\n            <h1 className=\"text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-purple-600 via-purple-500 to-teal-500 bg-clip-text text-transparent\">\r\n              Closo API Reference\r\n            </h1>\r\n            \r\n            <p className=\"text-xl text-slate-600 mb-8 leading-relaxed\">\r\n              Build powerful communication workflows with our enterprise-grade REST API. \r\n              Make calls, send SMS, manage contacts, and access recordings programmatically.\r\n            </p>\r\n\r\n            <div className=\"flex items-center justify-center gap-4 flex-wrap\">\r\n              <Button size=\"lg\" className=\"bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white\" data-testid=\"button-get-started\">\r\n                <Book className=\"w-4 h-4 mr-2\" />\r\n                Get Started\r\n              </Button>\r\n              <Button size=\"lg\" variant=\"outline\" className=\"border-gray-300\" data-testid=\"button-view-examples\">\r\n                <Terminal className=\"w-4 h-4 mr-2\" />\r\n                View Examples\r\n              </Button>\r\n            </div>\r\n\r\n            {/* Stats */}\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-6 mt-12\">\r\n              {[\r\n                { label: \"Uptime\", value: \"99.99%\", icon: Zap },\r\n                { label: \"API Calls/mo\", value: \"10M+\", icon: Globe },\r\n                { label: \"Response Time\", value: \"<100ms\", icon: Shield },\r\n                { label: \"Endpoints\", value: \"20+\", icon: Database }\r\n              ].map((stat, index) => (\r\n                <Card key={index} className=\"bg-white border-gray-200 hover:shadow-lg transition-all\">\r\n                  <CardContent className=\"p-4 text-center\">\r\n                    <stat.icon className=\"w-6 h-6 mx-auto mb-2 text-purple-600\" />\r\n                    <div className=\"text-2xl font-bold text-slate-900\">{stat.value}</div>\r\n                    <div className=\"text-sm text-slate-600\">{stat.label}</div>\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* Getting Started */}\r\n      <section id=\"getting-started\" className=\"py-16 bg-white\">\r\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\r\n          <div className=\"max-w-3xl\">\r\n            <h2 className=\"text-3xl font-bold mb-4\">Getting Started</h2>\r\n            <p className=\"text-lg text-slate-600 mb-8\">\r\n              Start building with the FallOwl API in minutes. Follow these steps to make your first API call.\r\n            </p>\r\n\r\n            <div className=\"space-y-6\">\r\n              <Card className=\"border-gray-200\">\r\n                <CardContent className=\"p-6\">\r\n                  <div className=\"flex items-start gap-4\">\r\n                    <div className=\"w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0\">\r\n                      <span className=\"text-white font-bold\">1</span>\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <h3 className=\"font-semibold text-lg mb-2\">Sign up for an account</h3>\r\n                      <p className=\"text-slate-600 mb-3\">Create a FallOwl account to get access to the API dashboard and generate your API keys.</p>\r\n                      <Link href=\"/\">\r\n                        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-signup\">\r\n                          Create Account <ChevronRight className=\"w-4 h-4 ml-1\" />\r\n                        </Button>\r\n                      </Link>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card className=\"border-gray-200\">\r\n                <CardContent className=\"p-6\">\r\n                  <div className=\"flex items-start gap-4\">\r\n                    <div className=\"w-10 h-10 bg-gradient-to-r from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center flex-shrink-0\">\r\n                      <span className=\"text-white font-bold\">2</span>\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <h3 className=\"font-semibold text-lg mb-2\">Get your API key</h3>\r\n                      <p className=\"text-slate-600 mb-3\">Generate your API key from the dashboard or use the quick generator below.</p>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card className=\"border-gray-200\">\r\n                <CardContent className=\"p-6\">\r\n                  <div className=\"flex items-start gap-4\">\r\n                    <div className=\"w-10 h-10 bg-gradient-to-r from-orange-400 to-pink-500 rounded-lg flex items-center justify-center flex-shrink-0\">\r\n                      <span className=\"text-white font-bold\">3</span>\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <h3 className=\"font-semibold text-lg mb-2\">Make your first API call</h3>\r\n                      <p className=\"text-slate-600 mb-3\">Use your API key to authenticate and start making requests to our endpoints.</p>\r\n                      <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white overflow-x-auto\">\r\n                        <pre>{`curl -X GET https://api.fallowl.com/v1/calls \\\\\r\n  -H \"Authorization: Bearer YOUR_API_KEY\"`}</pre>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* Authentication */}\r\n      <section id=\"authentication\" className=\"py-16 bg-[#F8F7F5]\">\r\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\r\n          <div className=\"grid lg:grid-cols-2 gap-8\">\r\n            <div>\r\n              <h2 className=\"text-3xl font-bold mb-4\">Authentication</h2>\r\n              <p className=\"text-lg text-slate-600 mb-6\">\r\n                All API requests must include your API key in the Authorization header using Bearer authentication.\r\n              </p>\r\n\r\n              <Card className=\"bg-white border-gray-200 mb-6\">\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Key className=\"w-5 h-5 text-purple-600\" />\r\n                    API Key Format\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <p className=\"text-slate-600 mb-4\">Include your API key in every request:</p>\r\n                  <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white\">\r\n                    <pre>Authorization: Bearer sk_live_1234567890abcdef</pre>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card className=\"bg-white border-gray-200\">\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Shield className=\"w-5 h-5 text-purple-600\" />\r\n                    Security Best Practices\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <ul className=\"space-y-2 text-slate-600\">\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <Check className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" />\r\n                      <span>Never expose your API key in client-side code</span>\r\n                    </li>\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <Check className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" />\r\n                      <span>Store keys securely using environment variables</span>\r\n                    </li>\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <Check className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" />\r\n                      <span>Rotate your keys regularly</span>\r\n                    </li>\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <Check className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" />\r\n                      <span>Use separate keys for development and production</span>\r\n                    </li>\r\n                  </ul>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n\r\n            <div>\r\n              <Card className=\"bg-white border-gray-200 sticky top-24\">\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Key className=\"w-5 h-5 text-purple-600\" />\r\n                    Quick API Key Generator\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                  <p className=\"text-sm text-slate-600\">\r\n                    Generate a test API key to start exploring the API immediately. \r\n                    This key will have limited functionality for testing purposes.\r\n                  </p>\r\n                  \r\n                  <Button \r\n                    onClick={() => generateApiKeyMutation.mutate()}\r\n                    disabled={generateApiKeyMutation.isPending}\r\n                    className=\"w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white\"\r\n                    data-testid=\"button-generate-api-key\"\r\n                  >\r\n                    <Key className=\"w-4 h-4 mr-2\" />\r\n                    {generateApiKeyMutation.isPending ? \"Generating...\" : \"Generate Test API Key\"}\r\n                  </Button>\r\n\r\n                  {apiKey && (\r\n                    <div className=\"space-y-3 animate-in fade-in duration-300\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <label className=\"text-sm font-medium\">Your API Key</label>\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"ghost\"\r\n                          onClick={() => copyToClipboard(apiKey, \"apikey\")}\r\n                          data-testid=\"button-copy-api-key\"\r\n                        >\r\n                          {copiedCode === \"apikey\" ? (\r\n                            <Check className=\"w-4 h-4 text-green-500\" />\r\n                          ) : (\r\n                            <Copy className=\"w-4 h-4\" />\r\n                          )}\r\n                        </Button>\r\n                      </div>\r\n                      <div className=\"bg-slate-100 rounded-lg p-3 font-mono text-sm break-all border border-slate-200\">\r\n                        {apiKey}\r\n                      </div>\r\n                      <p className=\"text-xs text-amber-600 flex items-start gap-2\">\r\n                        <Shield className=\"w-4 h-4 flex-shrink-0 mt-0.5\" />\r\n                        Save this key securely. You won't be able to see it again.\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"pt-4 border-t border-gray-200\">\r\n                    <h4 className=\"font-medium mb-2 text-sm\">Code Example</h4>\r\n                    <Tabs defaultValue=\"curl\" className=\"w-full\">\r\n                      <TabsList className=\"grid w-full grid-cols-3\">\r\n                        <TabsTrigger value=\"curl\">cURL</TabsTrigger>\r\n                        <TabsTrigger value=\"node\">Node.js</TabsTrigger>\r\n                        <TabsTrigger value=\"python\">Python</TabsTrigger>\r\n                      </TabsList>\r\n                      <TabsContent value=\"curl\">\r\n                        <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white overflow-x-auto relative\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"ghost\"\r\n                            className=\"absolute top-2 right-2 text-white hover:text-white hover:bg-slate-800\"\r\n                            onClick={() => copyToClipboard(`curl -H \"Authorization: Bearer ${apiKey || 'YOUR_API_KEY'}\" https://api.fallowl.com/v1/calls`, \"curl\")}\r\n                            data-testid=\"button-copy-curl\"\r\n                          >\r\n                            {copiedCode === \"curl\" ? <Check className=\"w-4 h-4\" /> : <Copy className=\"w-4 h-4\" />}\r\n                          </Button>\r\n                          <pre>{`curl -H \"Authorization: Bearer ${apiKey || 'YOUR_API_KEY'}\" \\\\\r\n  https://api.fallowl.com/v1/calls`}</pre>\r\n                        </div>\r\n                      </TabsContent>\r\n                      <TabsContent value=\"node\">\r\n                        <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white overflow-x-auto relative\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"ghost\"\r\n                            className=\"absolute top-2 right-2 text-white hover:text-white hover:bg-slate-800\"\r\n                            onClick={() => copyToClipboard(`const fallowl = require('fallowl')('${apiKey || 'YOUR_API_KEY'}');\\n\\nconst calls = await fallowl.calls.list();`, \"node\")}\r\n                            data-testid=\"button-copy-node\"\r\n                          >\r\n                            {copiedCode === \"node\" ? <Check className=\"w-4 h-4\" /> : <Copy className=\"w-4 h-4\" />}\r\n                          </Button>\r\n                          <pre>{`const fallowl = require('fallowl')('${apiKey || 'YOUR_API_KEY'}');\r\n\r\nconst calls = await fallowl.calls.list();`}</pre>\r\n                        </div>\r\n                      </TabsContent>\r\n                      <TabsContent value=\"python\">\r\n                        <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white overflow-x-auto relative\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"ghost\"\r\n                            className=\"absolute top-2 right-2 text-white hover:text-white hover:bg-slate-800\"\r\n                            onClick={() => copyToClipboard(`from fallowl import Client\\n\\nclient = Client('${apiKey || 'YOUR_API_KEY'}')\\ncalls = client.calls.list()`, \"python\")}\r\n                            data-testid=\"button-copy-python\"\r\n                          >\r\n                            {copiedCode === \"python\" ? <Check className=\"w-4 h-4\" /> : <Copy className=\"w-4 h-4\" />}\r\n                          </Button>\r\n                          <pre>{`from fallowl import Client\r\n\r\nclient = Client('${apiKey || 'YOUR_API_KEY'}')\r\ncalls = client.calls.list()`}</pre>\r\n                        </div>\r\n                      </TabsContent>\r\n                    </Tabs>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* API Reference */}\r\n      <section id=\"endpoints\" className=\"py-16 bg-white\">\r\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\r\n          <h2 className=\"text-3xl font-bold mb-8\">API Reference</h2>\r\n\r\n          {/* Category Tabs */}\r\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8\">\r\n            {endpoints.map((category) => (\r\n              <button\r\n                key={category.id}\r\n                onClick={() => setActiveEndpoint(category.id)}\r\n                className={`p-4 rounded-xl border-2 transition-all text-left ${\r\n                  activeEndpoint === category.id\r\n                    ? 'border-purple-500 bg-purple-50'\r\n                    : 'border-gray-200 bg-white hover:border-gray-300'\r\n                }`}\r\n                data-testid={`button-category-${category.id}`}\r\n              >\r\n                <category.icon className={`w-6 h-6 mb-2 ${\r\n                  activeEndpoint === category.id ? 'text-purple-600' : 'text-slate-600'\r\n                }`} />\r\n                <div className={`font-semibold ${\r\n                  activeEndpoint === category.id ? 'text-purple-900' : 'text-slate-900'\r\n                }`}>\r\n                  {category.name}\r\n                </div>\r\n                <div className=\"text-sm text-slate-600 mt-1\">{category.description}</div>\r\n              </button>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Endpoints Documentation */}\r\n          {selectedCategory && (\r\n            <div className=\"space-y-6\">\r\n              {selectedCategory.endpoints.map((endpoint, index) => (\r\n                <Card key={index} className=\"border-gray-200 overflow-hidden\">\r\n                  <CardHeader className=\"bg-gradient-to-r from-slate-50 to-gray-50 border-b border-gray-200\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <span className={`px-3 py-1 rounded-md text-xs font-bold ${\r\n                          endpoint.method === 'GET' ? 'bg-blue-100 text-blue-700' :\r\n                          endpoint.method === 'POST' ? 'bg-green-100 text-green-700' :\r\n                          endpoint.method === 'PUT' ? 'bg-amber-100 text-amber-700' :\r\n                          'bg-red-100 text-red-700'\r\n                        }`}>\r\n                          {endpoint.method}\r\n                        </span>\r\n                        <code className=\"text-sm font-mono text-slate-700\">{endpoint.path}</code>\r\n                      </div>\r\n                    </div>\r\n                    <CardTitle className=\"mt-3\">{endpoint.title}</CardTitle>\r\n                    <p className=\"text-slate-600 text-sm mt-1\">{endpoint.description}</p>\r\n                  </CardHeader>\r\n                  <CardContent className=\"p-6\">\r\n                    <Tabs defaultValue=\"params\" className=\"w-full\">\r\n                      <TabsList>\r\n                        <TabsTrigger value=\"params\">Parameters</TabsTrigger>\r\n                        <TabsTrigger value=\"example\">Example</TabsTrigger>\r\n                        <TabsTrigger value=\"response\">Response</TabsTrigger>\r\n                        {apiKey && endpoint.method === 'POST' && <TabsTrigger value=\"test\">Test</TabsTrigger>}\r\n                      </TabsList>\r\n\r\n                      <TabsContent value=\"params\" className=\"space-y-4\">\r\n                        <div className=\"overflow-x-auto\">\r\n                          <table className=\"w-full text-sm\">\r\n                            <thead className=\"border-b border-gray-200\">\r\n                              <tr className=\"text-left\">\r\n                                <th className=\"pb-2 font-semibold text-slate-700\">Parameter</th>\r\n                                <th className=\"pb-2 font-semibold text-slate-700\">Type</th>\r\n                                <th className=\"pb-2 font-semibold text-slate-700\">Required</th>\r\n                                <th className=\"pb-2 font-semibold text-slate-700\">Description</th>\r\n                              </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-gray-100\">\r\n                              {endpoint.params.map((param, i) => (\r\n                                <tr key={i}>\r\n                                  <td className=\"py-3 font-mono text-purple-600\">{param.name}</td>\r\n                                  <td className=\"py-3 text-slate-600\">{param.type}</td>\r\n                                  <td className=\"py-3\">\r\n                                    <span className={`px-2 py-1 rounded text-xs font-medium ${\r\n                                      param.required ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'\r\n                                    }`}>\r\n                                      {param.required ? 'Required' : 'Optional'}\r\n                                    </span>\r\n                                  </td>\r\n                                  <td className=\"py-3 text-slate-600\">{param.description}</td>\r\n                                </tr>\r\n                              ))}\r\n                            </tbody>\r\n                          </table>\r\n                        </div>\r\n                      </TabsContent>\r\n\r\n                      <TabsContent value=\"example\">\r\n                        <div className=\"relative\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"ghost\"\r\n                            className=\"absolute top-2 right-2 z-10\"\r\n                            onClick={() => copyToClipboard(endpoint.example, `example-${index}`)}\r\n                            data-testid={`button-copy-example-${index}`}\r\n                          >\r\n                            {copiedCode === `example-${index}` ? (\r\n                              <Check className=\"w-4 h-4 text-green-500\" />\r\n                            ) : (\r\n                              <Copy className=\"w-4 h-4\" />\r\n                            )}\r\n                          </Button>\r\n                          <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white overflow-x-auto\">\r\n                            <pre>{endpoint.example}</pre>\r\n                          </div>\r\n                        </div>\r\n                      </TabsContent>\r\n\r\n                      <TabsContent value=\"response\">\r\n                        <div className=\"relative\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"ghost\"\r\n                            className=\"absolute top-2 right-2 z-10\"\r\n                            onClick={() => copyToClipboard(endpoint.response, `response-${index}`)}\r\n                            data-testid={`button-copy-response-${index}`}\r\n                          >\r\n                            {copiedCode === `response-${index}` ? (\r\n                              <Check className=\"w-4 h-4 text-green-500\" />\r\n                            ) : (\r\n                              <Copy className=\"w-4 h-4\" />\r\n                            )}\r\n                          </Button>\r\n                          <div className=\"bg-slate-900 rounded-lg p-4 text-sm font-mono text-white overflow-x-auto\">\r\n                            <pre>{endpoint.response}</pre>\r\n                          </div>\r\n                        </div>\r\n                      </TabsContent>\r\n\r\n                      {apiKey && endpoint.method === 'POST' && (\r\n                        <TabsContent value=\"test\">\r\n                          <Card className=\"bg-gradient-to-br from-purple-50 to-teal-50 border-purple-200\">\r\n                            <CardHeader>\r\n                              <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                                <Play className=\"w-5 h-5 text-purple-600\" />\r\n                                Test This Endpoint\r\n                              </CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent className=\"space-y-4\">\r\n                              {endpoint.path === '/v1/calls' && (\r\n                                <>\r\n                                  <div>\r\n                                    <label className=\"text-sm font-medium mb-1 block\">To Phone Number</label>\r\n                                    <Input\r\n                                      placeholder=\"+1234567890\"\r\n                                      value={testCallTo}\r\n                                      onChange={(e) => setTestCallTo(e.target.value)}\r\n                                      data-testid=\"input-test-call-to\"\r\n                                    />\r\n                                  </div>\r\n                                  <div>\r\n                                    <label className=\"text-sm font-medium mb-1 block\">From Phone Number</label>\r\n                                    <Input\r\n                                      placeholder=\"+0987654321\"\r\n                                      value={testCallFrom}\r\n                                      onChange={(e) => setTestCallFrom(e.target.value)}\r\n                                      data-testid=\"input-test-call-from\"\r\n                                    />\r\n                                  </div>\r\n                                  <Button\r\n                                    onClick={() => testCallMutation.mutate()}\r\n                                    disabled={testCallMutation.isPending || !testCallTo || !testCallFrom}\r\n                                    className=\"w-full bg-gradient-to-r from-purple-500 to-purple-600\"\r\n                                    data-testid=\"button-test-call\"\r\n                                  >\r\n                                    <Play className=\"w-4 h-4 mr-2\" />\r\n                                    {testCallMutation.isPending ? \"Making Call...\" : \"Make Test Call\"}\r\n                                  </Button>\r\n                                </>\r\n                              )}\r\n\r\n                              {endpoint.path === '/v1/messages' && (\r\n                                <>\r\n                                  <div>\r\n                                    <label className=\"text-sm font-medium mb-1 block\">To Phone Number</label>\r\n                                    <Input\r\n                                      placeholder=\"+1234567890\"\r\n                                      value={testSmsTo}\r\n                                      onChange={(e) => setTestSmsTo(e.target.value)}\r\n                                      data-testid=\"input-test-sms-to\"\r\n                                    />\r\n                                  </div>\r\n                                  <div>\r\n                                    <label className=\"text-sm font-medium mb-1 block\">Message</label>\r\n                                    <Textarea\r\n                                      placeholder=\"Hello from FallOwl!\"\r\n                                      value={testSmsBody}\r\n                                      onChange={(e) => setTestSmsBody(e.target.value)}\r\n                                      data-testid=\"input-test-sms-body\"\r\n                                    />\r\n                                  </div>\r\n                                  <Button\r\n                                    onClick={() => testSmsMutation.mutate()}\r\n                                    disabled={testSmsMutation.isPending || !testSmsTo || !testSmsBody}\r\n                                    className=\"w-full bg-gradient-to-r from-teal-500 to-cyan-500\"\r\n                                    data-testid=\"button-test-sms\"\r\n                                  >\r\n                                    <Play className=\"w-4 h-4 mr-2\" />\r\n                                    {testSmsMutation.isPending ? \"Sending SMS...\" : \"Send Test SMS\"}\r\n                                  </Button>\r\n                                </>\r\n                              )}\r\n\r\n                              {endpoint.path === '/v1/contacts' && (\r\n                                <>\r\n                                  <div>\r\n                                    <label className=\"text-sm font-medium mb-1 block\">Contact Name</label>\r\n                                    <Input\r\n                                      placeholder=\"John Doe\"\r\n                                      value={testContactName}\r\n                                      onChange={(e) => setTestContactName(e.target.value)}\r\n                                      data-testid=\"input-test-contact-name\"\r\n                                    />\r\n                                  </div>\r\n                                  <div>\r\n                                    <label className=\"text-sm font-medium mb-1 block\">Phone Number</label>\r\n                                    <Input\r\n                                      placeholder=\"+1234567890\"\r\n                                      value={testContactPhone}\r\n                                      onChange={(e) => setTestContactPhone(e.target.value)}\r\n                                      data-testid=\"input-test-contact-phone\"\r\n                                    />\r\n                                  </div>\r\n                                  <Button\r\n                                    onClick={() => testContactMutation.mutate()}\r\n                                    disabled={testContactMutation.isPending || !testContactName || !testContactPhone}\r\n                                    className=\"w-full bg-gradient-to-r from-orange-400 to-pink-500\"\r\n                                    data-testid=\"button-test-contact\"\r\n                                  >\r\n                                    <Play className=\"w-4 h-4 mr-2\" />\r\n                                    {testContactMutation.isPending ? \"Creating Contact...\" : \"Create Test Contact\"}\r\n                                  </Button>\r\n                                </>\r\n                              )}\r\n                            </CardContent>\r\n                          </Card>\r\n                        </TabsContent>\r\n                      )}\r\n                    </Tabs>\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </section>\r\n\r\n      <EnterpriseFooter />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\blog-post.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\blog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\campaign-view.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'CampaignView' has a complexity of 17. Maximum allowed is 15.","line":46,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":46,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useLocation, useRoute } from \"wouter\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { \r\n  ArrowLeft, \r\n  Search, \r\n  Copy, \r\n  Download,\r\n  FileSpreadsheet,\r\n  Users,\r\n  Calendar,\r\n  Database,\r\n  Filter,\r\n  BarChart3,\r\n  Eye,\r\n  Settings\r\n} from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\n\r\ninterface CampaignData {\r\n  id: number;\r\n  name: string;\r\n  data: {\r\n    headers: string[];\r\n    rows: Record<string, string>[];\r\n    fieldMappings: Record<string, string>;\r\n  };\r\n  createdAt: string;\r\n  recordCount: number;\r\n}\r\n\r\nexport default function CampaignView() {\r\n  const [, setLocation] = useLocation();\r\n  const [match, params] = useRoute(\"/campaign/:id\");\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [selectedRows, setSelectedRows] = useState<Set<number>>(new Set());\r\n  const [activeTab, setActiveTab] = useState(\"data\");\r\n  const { toast } = useToast();\r\n\r\n  const campaignId = params?.id;\r\n\r\n  const { data: campaignData, isLoading, error } = useQuery({\r\n    queryKey: [`/api/campaigns/${campaignId}`],\r\n    enabled: !!campaignId,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (!campaignId) {\r\n      setLocation(\"/dashboard\");\r\n    }\r\n  }, [campaignId, setLocation]);\r\n\r\n  if (!campaignId || isLoading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin h-12 w-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4\"></div>\r\n          <p className=\"text-slate-600\">Loading campaign data...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!campaignData) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center\">\r\n        <Card className=\"w-full max-w-md\">\r\n          <CardHeader className=\"text-center\">\r\n            <CardTitle className=\"text-xl text-slate-900\">Campaign Not Found</CardTitle>\r\n            <CardDescription>The requested campaign could not be found</CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"text-center\">\r\n            <Button onClick={() => setLocation(\"/dashboard\")} className=\"w-full\">\r\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n              Return to Dashboard\r\n            </Button>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Handle encryption error case\r\n  if (campaignData && (campaignData as any).encryptionError) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center\">\r\n        <Card className=\"w-full max-w-lg\">\r\n          <CardHeader className=\"text-center\">\r\n            <CardTitle className=\"text-xl text-slate-900\">Campaign Data Unavailable</CardTitle>\r\n            <CardDescription>Unable to decrypt campaign data</CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"text-center space-y-4\">\r\n            <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4\">\r\n              <p className=\"text-sm text-amber-800\">\r\n                <strong>Campaign:</strong> {(campaignData as any).name}\r\n              </p>\r\n              <p className=\"text-sm text-amber-800 mt-2\">\r\n                This campaign's data cannot be accessed due to encryption key changes. \r\n                The campaign exists but the data is currently unreadable.\r\n              </p>\r\n            </div>\r\n            <p className=\"text-xs text-slate-500\">\r\n              Campaign ID: {(campaignData as any).id} | Created: {new Date((campaignData as any).createdAt).toLocaleDateString()}\r\n            </p>\r\n            <Button onClick={() => setLocation(\"/dashboard\")} className=\"w-full\">\r\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n              Return to Dashboard\r\n            </Button>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const campaign = campaignData as CampaignData;\r\n  const headers = campaign.data?.headers || [];\r\n  const rows = campaign.data?.rows || [];\r\n\r\n  // Filter rows based on search term\r\n  const filteredRows = rows.filter(row => \r\n    Object.values(row).some(value => \r\n      value?.toLowerCase().includes(searchTerm.toLowerCase())\r\n    )\r\n  );\r\n\r\n  const formatDate = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    return date.toLocaleDateString('en-US', {\r\n      year: 'numeric',\r\n      month: 'long',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  const handleSelectAll = (checked: boolean) => {\r\n    if (checked) {\r\n      setSelectedRows(new Set(filteredRows.map((_, index) => index)));\r\n    } else {\r\n      setSelectedRows(new Set());\r\n    }\r\n  };\r\n\r\n  const handleRowSelect = (index: number, checked: boolean) => {\r\n    const newSelected = new Set(selectedRows);\r\n    if (checked) {\r\n      newSelected.add(index);\r\n    } else {\r\n      newSelected.delete(index);\r\n    }\r\n    setSelectedRows(newSelected);\r\n  };\r\n\r\n  const handleCopyToExcel = () => {\r\n    const selectedData = selectedRows.size > 0 \r\n      ? filteredRows.filter((_, index) => selectedRows.has(index))\r\n      : filteredRows;\r\n\r\n    const headerRow = headers.join('\\t');\r\n    const dataRows = selectedData.map(row => \r\n      headers.map(header => row[header] || '').join('\\t')\r\n    );\r\n    \r\n    const tsvContent = [headerRow, ...dataRows].join('\\n');\r\n    \r\n    navigator.clipboard.writeText(tsvContent).then(() => {\r\n      toast({\r\n        title: \"Copied Successfully\",\r\n        description: `${selectedData.length} records copied. Ready to paste into Excel or Google Sheets.`,\r\n      });\r\n    }).catch(() => {\r\n      toast({\r\n        title: \"Copy Failed\",\r\n        description: \"Unable to copy data to clipboard\",\r\n        variant: \"destructive\"\r\n      });\r\n    });\r\n  };\r\n\r\n  const handleExportCSV = () => {\r\n    const selectedData = selectedRows.size > 0 \r\n      ? filteredRows.filter((_, index) => selectedRows.has(index))\r\n      : filteredRows;\r\n\r\n    const csvContent = [\r\n      headers.map(h => `\"${h}\"`).join(','),\r\n      ...selectedData.map(row => \r\n        headers.map(header => `\"${(row[header] || '').replace(/\"/g, '\"\"')}\"`).join(',')\r\n      )\r\n    ].join('\\n');\r\n\r\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\r\n    const link = document.createElement('a');\r\n    const url = URL.createObjectURL(blob);\r\n    link.setAttribute('href', url);\r\n    link.setAttribute('download', `${campaign.name}-export.csv`);\r\n    link.style.visibility = 'hidden';\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n\r\n    toast({\r\n      title: \"Export Complete\",\r\n      description: `${selectedData.length} records exported successfully`,\r\n    });\r\n  };\r\n\r\n  // Calculate analytics\r\n  const totalFields = headers.length;\r\n  const completenessScore = Math.round(\r\n    (rows.reduce((sum, row) => sum + Object.values(row).filter(v => v && v.trim()).length, 0) / \r\n    (rows.length * headers.length)) * 100\r\n  );\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50\">\r\n      {/* Enhanced Header */}\r\n      <header className=\"bg-white/80 backdrop-blur-sm border-b border-slate-200/50 sticky top-0 z-50\">\r\n        <div className=\"max-w-7xl mx-auto px-6 py-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center space-x-4\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setLocation(\"/dashboard\")}\r\n                className=\"text-slate-600 hover:text-slate-900\"\r\n              >\r\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n                Dashboard\r\n              </Button>\r\n              <div className=\"flex items-center space-x-3\">\r\n                <div className=\"w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center\">\r\n                  <Database className=\"text-white h-5 w-5\" />\r\n                </div>\r\n                <div>\r\n                  <h1 className=\"text-xl font-bold text-slate-900\">{campaign.name}</h1>\r\n                  <div className=\"flex items-center space-x-4 text-sm text-slate-600\">\r\n                    <span className=\"flex items-center gap-1\">\r\n                      <Users className=\"h-3 w-3\" />\r\n                      {campaign.recordCount.toLocaleString()} records\r\n                    </span>\r\n                    <span className=\"flex items-center gap-1\">\r\n                      <Calendar className=\"h-3 w-3\" />\r\n                      {formatDate(campaign.createdAt)}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"flex items-center space-x-3\">\r\n              <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-700\">\r\n                {totalFields} Fields\r\n              </Badge>\r\n              <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">\r\n                {completenessScore}% Complete\r\n              </Badge>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      {/* Main Content */}\r\n      <div className=\"max-w-7xl mx-auto px-6 py-6\">\r\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n          <TabsList className=\"grid w-full grid-cols-3 lg:w-fit lg:grid-cols-3 bg-white/60 backdrop-blur-sm\">\r\n            <TabsTrigger value=\"overview\" className=\"flex items-center gap-2\">\r\n              <BarChart3 className=\"h-4 w-4\" />\r\n              <span className=\"hidden sm:inline\">Overview</span>\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"data\" className=\"flex items-center gap-2\">\r\n              <Eye className=\"h-4 w-4\" />\r\n              <span className=\"hidden sm:inline\">Data View</span>\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"settings\" className=\"flex items-center gap-2\">\r\n              <Settings className=\"h-4 w-4\" />\r\n              <span className=\"hidden sm:inline\">Settings</span>\r\n            </TabsTrigger>\r\n          </TabsList>\r\n\r\n          {/* Overview Tab */}\r\n          <TabsContent value=\"overview\" className=\"mt-6 space-y-6\">\r\n            {/* Quick Stats */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n              <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                  <CardTitle className=\"text-sm font-medium text-slate-600\">Total Records</CardTitle>\r\n                  <Users className=\"h-4 w-4 text-blue-600\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"text-2xl font-bold text-slate-900\">{campaign.recordCount.toLocaleString()}</div>\r\n                  <p className=\"text-xs text-slate-500\">Data points in campaign</p>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                  <CardTitle className=\"text-sm font-medium text-slate-600\">Data Fields</CardTitle>\r\n                  <Database className=\"h-4 w-4 text-green-600\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"text-2xl font-bold text-slate-900\">{totalFields}</div>\r\n                  <p className=\"text-xs text-slate-500\">Available data columns</p>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                  <CardTitle className=\"text-sm font-medium text-slate-600\">Data Quality</CardTitle>\r\n                  <BarChart3 className=\"h-4 w-4 text-purple-600\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"text-2xl font-bold text-slate-900\">{completenessScore}%</div>\r\n                  <p className=\"text-xs text-slate-500\">Fields completed</p>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n\r\n            {/* Field Mappings */}\r\n            <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n              <CardHeader>\r\n                <CardTitle>Field Mappings</CardTitle>\r\n                <CardDescription>How your CSV columns were mapped to standard fields</CardDescription>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {Object.entries(campaign.data.fieldMappings || {}).map(([standardField, csvField]) => (\r\n                    <div key={standardField} className=\"flex items-center justify-between p-3 bg-white/40 rounded-lg border border-slate-200/50\">\r\n                      <div>\r\n                        <div className=\"font-medium text-slate-900\">{standardField}</div>\r\n                        <div className=\"text-sm text-slate-500\">{csvField}</div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Quick Actions */}\r\n            <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n              <CardHeader>\r\n                <CardTitle>Quick Actions</CardTitle>\r\n                <CardDescription>Export and manage your campaign data</CardDescription>\r\n              </CardHeader>\r\n              <CardContent className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <Button \r\n                  onClick={() => setActiveTab(\"data\")}\r\n                  className=\"h-auto p-4 bg-blue-600 hover:bg-blue-700 text-left justify-start\"\r\n                >\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <Eye className=\"h-5 w-5\" />\r\n                    <div>\r\n                      <div className=\"font-medium\">View Data</div>\r\n                      <div className=\"text-xs opacity-90\">Browse and filter records</div>\r\n                    </div>\r\n                  </div>\r\n                </Button>\r\n                \r\n                <Button \r\n                  onClick={handleExportCSV}\r\n                  variant=\"outline\"\r\n                  className=\"h-auto p-4 text-left justify-start border-slate-200 hover:bg-slate-50\"\r\n                >\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <Download className=\"h-5 w-5 text-slate-600\" />\r\n                    <div>\r\n                      <div className=\"font-medium\">Export CSV</div>\r\n                      <div className=\"text-xs text-slate-500\">Download all data</div>\r\n                    </div>\r\n                  </div>\r\n                </Button>\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n\r\n          {/* Data View Tab */}\r\n          <TabsContent value=\"data\" className=\"mt-6 space-y-6\">\r\n            {/* Search and Actions Bar */}\r\n            <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\r\n                  <div className=\"flex items-center space-x-4\">\r\n                    <div className=\"relative\">\r\n                      <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4\" />\r\n                      <Input\r\n                        placeholder=\"Search all records...\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                        className=\"pl-10 w-80 bg-white/50\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"text-sm text-slate-600\">\r\n                      {filteredRows.length.toLocaleString()} of {rows.length.toLocaleString()} records\r\n                      {selectedRows.size > 0 && (\r\n                        <span className=\"ml-2 text-blue-600 font-medium\">\r\n                          â€¢ {selectedRows.size} selected\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={handleCopyToExcel}\r\n                      disabled={filteredRows.length === 0}\r\n                      className=\"flex items-center space-x-2\"\r\n                    >\r\n                      <FileSpreadsheet className=\"h-4 w-4\" />\r\n                      <span>Copy to Excel</span>\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={handleExportCSV}\r\n                      disabled={filteredRows.length === 0}\r\n                      className=\"flex items-center space-x-2\"\r\n                    >\r\n                      <Download className=\"h-4 w-4\" />\r\n                      <span>Export CSV</span>\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Data Table */}\r\n            <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n              <CardContent className=\"p-0\">\r\n                <div className=\"overflow-x-auto\">\r\n                  <Table>\r\n                    <TableHeader className=\"bg-slate-50/50\">\r\n                      <TableRow>\r\n                        <TableHead className=\"w-12\">\r\n                          <Checkbox\r\n                            checked={selectedRows.size === filteredRows.length && filteredRows.length > 0}\r\n                            onCheckedChange={handleSelectAll}\r\n                          />\r\n                        </TableHead>\r\n                        {headers.map((header, index) => (\r\n                          <TableHead key={index} className=\"font-semibold text-slate-900 min-w-[150px]\">\r\n                            {header}\r\n                          </TableHead>\r\n                        ))}\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {filteredRows.map((row, rowIndex) => (\r\n                        <TableRow \r\n                          key={rowIndex} \r\n                          className={selectedRows.has(rowIndex) ? \"bg-blue-50/50\" : \"hover:bg-slate-50/50\"}\r\n                        >\r\n                          <TableCell>\r\n                            <Checkbox\r\n                              checked={selectedRows.has(rowIndex)}\r\n                              onCheckedChange={(checked) => handleRowSelect(rowIndex, checked as boolean)}\r\n                            />\r\n                          </TableCell>\r\n                          {headers.map((header, cellIndex) => (\r\n                            <TableCell key={cellIndex} className=\"text-sm text-slate-700 max-w-[200px] truncate\">\r\n                              {row[header] || '-'}\r\n                            </TableCell>\r\n                          ))}\r\n                        </TableRow>\r\n                      ))}\r\n                    </TableBody>\r\n                  </Table>\r\n                </div>\r\n\r\n                {filteredRows.length === 0 && searchTerm && (\r\n                  <div className=\"text-center py-12 text-slate-500\">\r\n                    <Search className=\"h-12 w-12 mx-auto mb-4 text-slate-300\" />\r\n                    <h3 className=\"text-lg font-medium mb-2\">No matches found</h3>\r\n                    <p>No records match your search for \"{searchTerm}\"</p>\r\n                  </div>\r\n                )}\r\n\r\n                {rows.length === 0 && (\r\n                  <div className=\"text-center py-12 text-slate-500\">\r\n                    <Database className=\"h-12 w-12 mx-auto mb-4 text-slate-300\" />\r\n                    <h3 className=\"text-lg font-medium mb-2\">No data available</h3>\r\n                    <p>This campaign doesn't contain any data records</p>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n\r\n          {/* Settings Tab */}\r\n          <TabsContent value=\"settings\" className=\"mt-6\">\r\n            <Card className=\"bg-white/60 backdrop-blur-sm border-white/20\">\r\n              <CardHeader>\r\n                <CardTitle>Campaign Settings</CardTitle>\r\n                <CardDescription>Manage your campaign preferences and data handling</CardDescription>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-6\">\r\n                <div>\r\n                  <h3 className=\"font-medium text-slate-900 mb-4\">Export Options</h3>\r\n                  <div className=\"space-y-3\">\r\n                    <div className=\"flex items-center justify-between p-3 bg-white/40 rounded-lg border border-slate-200/50\">\r\n                      <div>\r\n                        <div className=\"font-medium\">Include Headers</div>\r\n                        <div className=\"text-sm text-slate-500\">Export column names with data</div>\r\n                      </div>\r\n                      <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">Enabled</Badge>\r\n                    </div>\r\n                    <div className=\"flex items-center justify-between p-3 bg-white/40 rounded-lg border border-slate-200/50\">\r\n                      <div>\r\n                        <div className=\"font-medium\">UTF-8 Encoding</div>\r\n                        <div className=\"text-sm text-slate-500\">Preserve special characters</div>\r\n                      </div>\r\n                      <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700\">Active</Badge>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div>\r\n                  <h3 className=\"font-medium text-slate-900 mb-4\">Data Management</h3>\r\n                  <div className=\"space-y-2\">\r\n                    <Button variant=\"outline\" className=\"w-full justify-start text-left\">\r\n                      <Download className=\"h-4 w-4 mr-2\" />\r\n                      Download Complete Dataset\r\n                    </Button>\r\n                    <Button variant=\"outline\" className=\"w-full justify-start text-left\">\r\n                      <Copy className=\"h-4 w-4 mr-2\" />\r\n                      Duplicate Campaign\r\n                    </Button>\r\n                    <Button variant=\"outline\" className=\"w-full justify-start text-left text-red-600 hover:text-red-700 hover:bg-red-50\">\r\n                      <Database className=\"h-4 w-4 mr-2\" />\r\n                      Delete Campaign\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n        </Tabs>\r\n      </div>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\compliance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\contacts-filter.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'ContactsFilter' has a complexity of 25. Maximum allowed is 15.","line":73,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":73,"endColumn":39},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 16. Maximum allowed is 15.","line":549,"column":51,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":549,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\r\nimport { useLocation } from \"wouter\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { \r\n  ArrowLeft, Search, X, Download, Save, RotateCcw, Filter, \r\n  Users, Building2, TrendingUp, Globe, Mail, Phone, Linkedin,\r\n  Briefcase, DollarSign, MapPin, Star, ChevronDown, ChevronUp,\r\n  Sparkles, Target, Award, Zap, BarChart3, Plus\r\n} from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface ContactFilter {\r\n  column: string;\r\n  operator: string;\r\n  value: any;\r\n  value2?: any;\r\n}\r\n\r\ninterface Contact {\r\n  id: string;\r\n  full_name: string;\r\n  first_name?: string;\r\n  last_name?: string;\r\n  title?: string;\r\n  email: string;\r\n  mobile_phone?: string;\r\n  company?: string;\r\n  employees?: number;\r\n  employee_size_bracket?: string;\r\n  industry?: string;\r\n  website?: string;\r\n  annual_revenue?: number;\r\n  person_linkedin?: string;\r\n  city?: string;\r\n  state?: string;\r\n  country?: string;\r\n  lead_score?: number;\r\n  technologies?: string[];\r\n  business_type?: string;\r\n}\r\n\r\nconst OPERATORS = [\r\n  { value: 'equals', label: 'Equals', icon: '=' },\r\n  { value: 'contains', label: 'Contains', icon: 'âŠƒ' },\r\n  { value: 'starts_with', label: 'Starts with', icon: 'â†’' },\r\n  { value: 'greater_or_equal', label: 'â‰¥', icon: 'â‰¥' },\r\n  { value: 'less_or_equal', label: 'â‰¤', icon: 'â‰¤' },\r\n  { value: 'is_not_null', label: 'Has value', icon: 'âœ“' },\r\n];\r\n\r\nconst FILTER_FIELDS = [\r\n  { value: 'title', label: 'Job Title', icon: Briefcase, type: 'text' },\r\n  { value: 'company', label: 'Company', icon: Building2, type: 'text' },\r\n  { value: 'industry', label: 'Industry', icon: Target, type: 'text' },\r\n  { value: 'employees', label: 'Company Size', icon: Users, type: 'number' },\r\n  { value: 'annual_revenue', label: 'Revenue', icon: DollarSign, type: 'number' },\r\n  { value: 'city', label: 'City', icon: MapPin, type: 'text' },\r\n  { value: 'country', label: 'Country', icon: Globe, type: 'text' },\r\n  { value: 'lead_score', label: 'Lead Score', icon: Star, type: 'number' },\r\n];\r\n\r\nexport default function ContactsFilter() {\r\n  const [, setLocation] = useLocation();\r\n  const [filters, setFilters] = useState<ContactFilter[]>([]);\r\n  const [globalSearch, setGlobalSearch] = useState('');\r\n  const [selectedTemplate, setSelectedTemplate] = useState<string>('');\r\n  const [page, setPage] = useState(1);\r\n  const [pageSize] = useState(50);\r\n  const [showStats, setShowStats] = useState(true);\r\n  const { toast } = useToast();\r\n\r\n  // Fetch filter templates\r\n  const { data: templatesData } = useQuery<any>({\n    queryKey: ['/api/contacts-filter/templates'],\r\n  });\r\n\r\n  // Fetch statistics\r\n  const { data: statistics } = useQuery<any>({\n    queryKey: ['/api/contacts-filter/statistics'],\r\n    refetchInterval: false,\r\n  });\r\n\r\n  // Search mutation\r\n  const searchMutation = useMutation<any, Error, any>({\n    mutationFn: async (searchQuery: any) => {\r\n      const response = await apiRequest('POST', '/api/contacts-filter/search', searchQuery);\r\n      return response.json();\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: \"Search Failed\",\r\n        description: error.message || \"Failed to search contacts\",\r\n        variant: \"destructive\"\r\n      });\r\n    }\r\n  });\r\n\r\n  // Export mutation\r\n  const exportMutation = useMutation<boolean, Error, any>({\n    mutationFn: async (searchQuery: any) => {\r\n      const response = await fetch('/api/contacts-filter/export', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(searchQuery),\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (!response.ok) throw new Error('Export failed');\r\n      \r\n      const blob = await response.blob();\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = `contacts_export_${Date.now()}.csv`;\r\n      a.click();\r\n      URL.revokeObjectURL(url);\r\n      return true;\r\n    },\r\n    onSuccess: () => {\r\n      toast({\r\n        title: \"Export Complete\",\r\n        description: \"Your contacts have been exported successfully\",\r\n      });\r\n    }\r\n  });\r\n\r\n  const handleSearch = () => {\r\n    const query = {\r\n      filters,\r\n      globalSearch: globalSearch.trim() || undefined,\r\n      page,\r\n      pageSize,\r\n      sortBy: 'lead_score',\r\n      sortOrder: 'desc' as const\r\n    };\r\n    searchMutation.mutate(query);\r\n  };\r\n\r\n  const handleExport = () => {\r\n    const query = {\r\n      filters,\r\n      globalSearch: globalSearch.trim() || undefined,\r\n      sortBy: 'lead_score',\r\n      sortOrder: 'desc' as const\r\n    };\r\n    exportMutation.mutate(query);\r\n  };\r\n\r\n  const addFilter = (column: string) => {\r\n    const field = FILTER_FIELDS.find(f => f.value === column);\r\n    const defaultOperator = field?.type === 'number' ? 'greater_or_equal' : 'contains';\r\n    \r\n    setFilters([...filters, {\r\n      column,\r\n      operator: defaultOperator,\r\n      value: ''\r\n    }]);\r\n  };\r\n\r\n  const removeFilter = (index: number) => {\r\n    setFilters(filters.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const updateFilter = (index: number, field: keyof ContactFilter, value: any) => {\r\n    const newFilters = [...filters];\r\n    newFilters[index] = { ...newFilters[index], [field]: value };\r\n    setFilters(newFilters);\r\n  };\r\n\r\n  const resetFilters = () => {\r\n    setFilters([]);\r\n    setGlobalSearch('');\r\n    setSelectedTemplate('');\r\n    setPage(1);\r\n    searchMutation.reset();\r\n  };\r\n\r\n  const applyTemplate = (templateId: string) => {\r\n    const template = (templatesData as any)?.templates?.[templateId];\r\n    if (!template) return;\r\n\r\n    setSelectedTemplate(templateId);\r\n    // Store template metadata for backend OR/AND logic\r\n    setFilters([]);\r\n    localStorage.setItem('activeTemplateId', templateId);\r\n    setGlobalSearch('');\r\n    setPage(1);\r\n    \r\n    // Trigger search with template immediately\r\n    const query = {\r\n      filters: [],\r\n      filterGroups: [{\r\n        filters: template.filters,\r\n        combineWith: template.combineWith || 'AND'\r\n      }],\r\n      page: 1,\r\n      pageSize,\r\n      sortBy: 'lead_score',\r\n      sortOrder: 'desc' as const\r\n    };\r\n    searchMutation.mutate(query);\r\n  };\r\n\r\n  // Auto-search when filters change\r\n  useEffect(() => {\r\n    if (filters.length > 0 || globalSearch.trim()) {\r\n      const timer = setTimeout(() => {\r\n        handleSearch();\r\n      }, 500);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [filters, globalSearch, page]);\r\n\r\n  const result = searchMutation.data;\r\n  const templates: Record<string, any> = (templatesData as any)?.templates || {};\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-900 dark:via-blue-950 dark:to-indigo-950\">\r\n      {/* Header */}\r\n      <header className=\"bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50 shadow-sm\">\r\n        <div className=\"px-6 py-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-4\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setLocation('/dashboard')}\r\n                data-testid=\"button-back\"\r\n              >\r\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n                Back\r\n              </Button>\r\n              <Separator orientation=\"vertical\" className=\"h-6\" />\r\n              <div>\r\n                <h1 className=\"text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent flex items-center gap-2\">\r\n                  <Target className=\"h-6 w-6 text-blue-600\" />\r\n                  Advanced Contact Filters\r\n                </h1>\r\n                <p className=\"text-sm text-slate-600 dark:text-slate-400\">\r\n                  Search across {(statistics as any)?.total_contacts?.toLocaleString() || '6,716'} professional contacts\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={resetFilters}\r\n                disabled={filters.length === 0 && !globalSearch}\r\n                data-testid=\"button-reset\"\r\n              >\r\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\r\n                Reset\r\n              </Button>\r\n              <Button\r\n                variant=\"default\"\r\n                size=\"sm\"\r\n                onClick={handleExport}\r\n                disabled={!result || exportMutation.isPending}\r\n                data-testid=\"button-export\"\r\n                className=\"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700\"\r\n              >\r\n                <Download className=\"h-4 w-4 mr-2\" />\r\n                Export CSV\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      {/* Statistics Bar */}\r\n      {statistics && showStats && (\r\n        <div className=\"bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-8\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Users className=\"h-5 w-5\" />\r\n                <div>\r\n                  <div className=\"text-xs opacity-90\">Total Contacts</div>\r\n                  <div className=\"text-lg font-bold\">{parseInt((statistics as any).total_contacts || 0).toLocaleString()}</div>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Building2 className=\"h-5 w-5\" />\r\n                <div>\r\n                  <div className=\"text-xs opacity-90\">Companies</div>\r\n                  <div className=\"text-lg font-bold\">{parseInt((statistics as any).total_companies || 0).toLocaleString()}</div>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Target className=\"h-5 w-5\" />\r\n                <div>\r\n                  <div className=\"text-xs opacity-90\">Industries</div>\r\n                  <div className=\"text-lg font-bold\">{parseInt((statistics as any).total_industries || 0).toLocaleString()}</div>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Star className=\"h-5 w-5\" />\r\n                <div>\r\n                  <div className=\"text-xs opacity-90\">Avg Lead Score</div>\r\n                  <div className=\"text-lg font-bold\">{parseFloat((statistics as any).avg_lead_score || 0).toFixed(1)}</div>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Award className=\"h-5 w-5\" />\r\n                <div>\r\n                  <div className=\"text-xs opacity-90\">High-Score Leads</div>\r\n                  <div className=\"text-lg font-bold\">{parseInt((statistics as any).high_score_leads || 0).toLocaleString()}</div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => setShowStats(false)}\r\n              className=\"text-white hover:bg-white/20\"\r\n            >\r\n              <ChevronUp className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {!showStats && (\r\n        <div className=\"bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-2\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => setShowStats(true)}\r\n            className=\"text-white hover:bg-white/20 w-full\"\r\n          >\r\n            <ChevronDown className=\"h-4 w-4 mr-2\" />\r\n            Show Statistics\r\n          </Button>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex h-[calc(100vh-180px)]\">\r\n        {/* Sidebar */}\r\n        <aside className=\"w-96 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 overflow-y-auto\">\r\n          <div className=\"p-4 space-y-6\">\r\n            {/* Global Search */}\r\n            <div>\r\n              <Label className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide mb-2 block\">\r\n                Quick Search\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n                <Input\r\n                  placeholder=\"Search name, email, company...\"\r\n                  value={globalSearch}\r\n                  onChange={(e) => setGlobalSearch(e.target.value)}\r\n                  className=\"pl-10\"\r\n                  data-testid=\"input-global-search\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <Separator />\r\n\r\n            {/* Filter Templates */}\r\n            <div>\r\n              <Label className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide mb-3 block flex items-center gap-2\">\r\n                <Sparkles className=\"h-4 w-4\" />\r\n                Quick Filters\r\n              </Label>\r\n              <div className=\"grid gap-2\">\r\n                {Object.entries(templates).map(([id, template]: [string, any]) => (\r\n                  <Button\r\n                    key={id}\r\n                    variant={selectedTemplate === id ? \"default\" : \"outline\"}\r\n                    size=\"sm\"\r\n                    onClick={() => applyTemplate(id)}\r\n                    className={cn(\r\n                      \"justify-start text-left h-auto py-2\",\r\n                      selectedTemplate === id && \"bg-gradient-to-r from-blue-600 to-indigo-600\"\r\n                    )}\r\n                    data-testid={`button-template-${id}`}\r\n                  >\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"font-medium text-sm\">{template.name}</div>\r\n                      <div className=\"text-xs opacity-70\">{template.description}</div>\r\n                    </div>\r\n                    <Zap className=\"h-4 w-4 ml-2\" />\r\n                  </Button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            <Separator />\r\n\r\n            {/* Active Filters */}\r\n            {filters.length > 0 && (\r\n              <div>\r\n                <Label className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide mb-3 block\">\r\n                  Active Filters ({filters.length})\r\n                </Label>\r\n                <div className=\"space-y-2\">\r\n                  {filters.map((filter, index) => {\r\n                    const field = FILTER_FIELDS.find(f => f.value === filter.column);\r\n                    const needsValue = !['is_null', 'is_not_null'].includes(filter.operator);\r\n                    \r\n                    return (\r\n                      <Card key={index} className=\"p-3\" data-testid={`filter-${index}`}>\r\n                        <div className=\"flex items-center justify-between mb-2\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            {field && <field.icon className=\"h-4 w-4 text-blue-600\" />}\r\n                            <span className=\"text-sm font-medium\">{field?.label || filter.column}</span>\r\n                          </div>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"h-6 w-6 p-0\"\r\n                            onClick={() => removeFilter(index)}\r\n                            data-testid={`button-remove-filter-${index}`}\r\n                          >\r\n                            <X className=\"h-3 w-3\" />\r\n                          </Button>\r\n                        </div>\r\n                        \r\n                        <Select\r\n                          value={filter.operator}\r\n                          onValueChange={(value) => updateFilter(index, 'operator', value)}\r\n                        >\r\n                          <SelectTrigger className=\"h-8 text-xs mb-2\" data-testid={`select-operator-${index}`}>\r\n                            <SelectValue />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            {OPERATORS.map((op) => (\r\n                              <SelectItem key={op.value} value={op.value}>\r\n                                {op.label}\r\n                              </SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                        \r\n                        {needsValue && (\r\n                          <Input\r\n                            placeholder=\"Value\"\r\n                            value={filter.value || ''}\r\n                            onChange={(e) => updateFilter(index, 'value', e.target.value)}\r\n                            className=\"h-8 text-xs\"\r\n                            type={field?.type === 'number' ? 'number' : 'text'}\r\n                            data-testid={`input-value-${index}`}\r\n                          />\r\n                        )}\r\n                      </Card>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            <Separator />\r\n\r\n            {/* Add New Filter */}\r\n            <div>\r\n              <Label className=\"text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide mb-3 block flex items-center gap-2\">\r\n                <Plus className=\"h-4 w-4\" />\r\n                Add Filter\r\n              </Label>\r\n              <div className=\"grid gap-2\">\r\n                {FILTER_FIELDS.map((field) => (\r\n                  <Button\r\n                    key={field.value}\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => addFilter(field.value)}\r\n                    className=\"justify-start\"\r\n                    data-testid={`button-add-${field.value}`}\r\n                  >\r\n                    <field.icon className=\"h-4 w-4 mr-2 text-slate-600\" />\r\n                    {field.label}\r\n                  </Button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </aside>\r\n\r\n        {/* Main Content */}\r\n        <main className=\"flex-1 overflow-y-auto p-6\">\r\n          {/* Results Header */}\r\n          {result && (\r\n            <div className=\"mb-4 flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-4\">\r\n                <h2 className=\"text-lg font-semibold text-slate-900 dark:text-white\">\r\n                  {result.totalCount.toLocaleString()} Contacts Found\r\n                </h2>\r\n                {result.aggregations && (\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"gap-2\"\r\n                  >\r\n                    <BarChart3 className=\"h-4 w-4\" />\r\n                    View Analytics\r\n                  </Button>\r\n                )}\r\n              </div>\r\n              \r\n              {result.totalPages > 1 && (\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setPage(Math.max(1, page - 1))}\r\n                    disabled={page === 1}\r\n                  >\r\n                    Previous\r\n                  </Button>\r\n                  <span className=\"text-sm text-slate-600 dark:text-slate-400\">\r\n                    Page {page} of {result.totalPages}\r\n                  </span>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setPage(Math.min(result.totalPages, page + 1))}\r\n                    disabled={page === result.totalPages}\r\n                  >\r\n                    Next\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Contact Cards */}\r\n          {searchMutation.isPending ? (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n              <div className=\"text-center\">\r\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\r\n                <p className=\"text-slate-600 dark:text-slate-400\">Searching contacts...</p>\r\n              </div>\r\n            </div>\r\n          ) : result && result.data.length > 0 ? (\r\n            <div className=\"grid gap-4 md:grid-cols-2\">\r\n              {result.data.map((contact: Contact) => (\r\n                <Card key={contact.id} className=\"hover:shadow-lg transition-shadow\" data-testid={`contact-${contact.id}`}>\r\n                  <CardHeader className=\"pb-3\">\r\n                    <div className=\"flex items-start justify-between\">\r\n                      <div className=\"flex-1\">\r\n                        <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                          {contact.full_name}\r\n                          {contact.lead_score && contact.lead_score >= 70 && (\r\n                            <Badge className=\"bg-gradient-to-r from-yellow-500 to-orange-500\">\r\n                              <Star className=\"h-3 w-3 mr-1\" />\r\n                              {contact.lead_score}\r\n                            </Badge>\r\n                          )}\r\n                        </CardTitle>\r\n                        {contact.title && (\r\n                          <p className=\"text-sm text-slate-600 dark:text-slate-400 mt-1\">\r\n                            {contact.title}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-3\">\r\n                    {contact.company && (\r\n                      <div className=\"flex items-center gap-2 text-sm\">\r\n                        <Building2 className=\"h-4 w-4 text-slate-400\" />\r\n                        <span className=\"font-medium\">{contact.company}</span>\r\n                        {contact.employees && (\r\n                          <Badge variant=\"outline\" className=\"text-xs\">\r\n                            {contact.employee_size_bracket || `${contact.employees.toLocaleString()} emp`}\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                    \r\n                    {contact.industry && (\r\n                      <div className=\"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400\">\r\n                        <Target className=\"h-4 w-4\" />\r\n                        {contact.industry}\r\n                      </div>\r\n                    )}\r\n\r\n                    <div className=\"flex flex-wrap gap-3 text-sm\">\r\n                      {contact.email && (\r\n                        <a\r\n                          href={`mailto:${contact.email}`}\r\n                          className=\"flex items-center gap-1 text-blue-600 hover:text-blue-700\"\r\n                        >\r\n                          <Mail className=\"h-3.5 w-3.5\" />\r\n                          Email\r\n                        </a>\r\n                      )}\r\n                      \r\n                      {contact.mobile_phone && (\r\n                        <a\r\n                          href={`tel:${contact.mobile_phone}`}\r\n                          className=\"flex items-center gap-1 text-blue-600 hover:text-blue-700\"\r\n                        >\r\n                          <Phone className=\"h-3.5 w-3.5\" />\r\n                          Call\r\n                        </a>\r\n                      )}\r\n                      \r\n                      {contact.person_linkedin && (\r\n                        <a\r\n                          href={contact.person_linkedin}\r\n                          target=\"_blank\"\r\n                          rel=\"noopener noreferrer\"\r\n                          className=\"flex items-center gap-1 text-blue-600 hover:text-blue-700\"\r\n                        >\r\n                          <Linkedin className=\"h-3.5 w-3.5\" />\r\n                          LinkedIn\r\n                        </a>\r\n                      )}\r\n                    </div>\r\n\r\n                    {(contact.city || contact.country) && (\r\n                      <div className=\"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400\">\r\n                        <MapPin className=\"h-4 w-4\" />\r\n                        {[contact.city, contact.state, contact.country].filter(Boolean).join(', ')}\r\n                      </div>\r\n                    )}\r\n\r\n                    {contact.technologies && contact.technologies.length > 0 && (\r\n                      <div className=\"flex flex-wrap gap-1\">\r\n                        {contact.technologies.slice(0, 3).map((tech, idx) => (\r\n                          <Badge key={idx} variant=\"secondary\" className=\"text-xs\">\r\n                            {tech}\r\n                          </Badge>\r\n                        ))}\r\n                        {contact.technologies.length > 3 && (\r\n                          <Badge variant=\"secondary\" className=\"text-xs\">\r\n                            +{contact.technologies.length - 3}\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n            </div>\r\n          ) : result && result.data.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <Users className=\"h-12 w-12 text-slate-300 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-medium text-slate-900 dark:text-white mb-2\">\r\n                No contacts found\r\n              </h3>\r\n              <p className=\"text-slate-600 dark:text-slate-400\">\r\n                Try adjusting your filters or search terms\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"text-center py-12\">\r\n              <Search className=\"h-12 w-12 text-slate-300 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-medium text-slate-900 dark:text-white mb-2\">\r\n                Start searching for contacts\r\n              </h3>\r\n              <p className=\"text-slate-600 dark:text-slate-400 mb-6\">\r\n                Use the filters on the left or quick search to find contacts\r\n              </p>\r\n              <div className=\"flex justify-center gap-2\">\r\n                {Object.keys(templates).slice(0, 3).map((id) => (\r\n                  <Button\r\n                    key={id}\r\n                    variant=\"outline\"\r\n                    onClick={() => applyTemplate(id)}\r\n                    size=\"sm\"\r\n                  >\r\n                    Try: {templates[id].name}\r\n                  </Button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </main>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\demo-booking.tsx","messages":[{"ruleId":"complexity","severity":1,"message":"Function 'DemoBooking' has a complexity of 18. Maximum allowed is 15.","line":55,"column":16,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":55,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Calendar } from \"@/components/ui/calendar\";\r\nimport { \r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { useForm } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { z } from \"zod\";\r\nimport { \r\n  Calendar as CalendarIcon,\r\n  Clock,\r\n  User,\r\n  Mail,\r\n  Building2,\r\n  Phone,\r\n  MessageSquare,\r\n  Check,\r\n  Users,\r\n  ChevronLeft,\r\n  ArrowRight,\r\n  Menu\r\n} from \"lucide-react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { useLocation } from \"wouter\";\r\nimport fallOwlLogo from \"@assets/FallOwl_logo_1759280190715.png\";\r\nimport { format } from \"date-fns\";\r\n\r\nconst bookingSchema = z.object({\r\n  fullName: z.string().min(2, \"Required\"),\r\n  email: z.string().email(\"Invalid\"),\r\n  company: z.string().min(2, \"Required\"),\r\n  phone: z.string().min(10, \"Required\"),\r\n  teamSize: z.string().min(1, \"Required\"),\r\n  message: z.string().optional(),\r\n});\r\n\r\ntype BookingFormData = z.infer<typeof bookingSchema>;\r\n\r\nconst timeSlots = [\r\n  \"09:00\", \"10:00\", \"11:00\", \"12:00\", \"13:00\", \"14:00\", \"15:00\", \"16:00\", \"17:00\"\r\n];\r\n\r\nconst teamSizes = [\"1-10\", \"11-50\", \"51-200\", \"201-500\", \"500+\"];\r\n\r\nexport default function DemoBooking() {\r\n  const [selectedDate, setSelectedDate] = useState<Date | undefined>(new Date());\r\n  const [selectedTime, setSelectedTime] = useState<string>(\"\");\r\n  const [currentTab, setCurrentTab] = useState<\"datetime\" | \"info\">(\"datetime\");\r\n  const [isSubmitted, setIsSubmitted] = useState(false);\r\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\r\n  const { toast } = useToast();\r\n  const [, setLocation] = useLocation();\r\n\r\n  const {\r\n    register,\r\n    handleSubmit,\r\n    formState: { errors },\r\n    setValue,\r\n    watch\r\n  } = useForm<BookingFormData>({\r\n    resolver: zodResolver(bookingSchema),\r\n    mode: \"onChange\",\r\n    defaultValues: {\r\n      fullName: \"\",\r\n      email: \"\",\r\n      company: \"\",\r\n      phone: \"\",\r\n      teamSize: \"\",\r\n      message: \"\"\r\n    }\r\n  });\r\n\r\n  const formValues = watch();\r\n\r\n  const onSubmit = (data: BookingFormData) => {\r\n    if (!selectedDate || !selectedTime) {\r\n      toast({\r\n        title: \"Missing date/time\",\r\n        variant: \"destructive\"\r\n      });\r\n      return;\r\n    }\r\n\r\n    console.log(\"Demo booking:\", { ...data, date: selectedDate, time: selectedTime });\r\n    setIsSubmitted(true);\r\n  };\r\n\r\n  const canProceed = selectedDate && selectedTime;\r\n\r\n  if (isSubmitted) {\r\n    return (\r\n      <div className=\"h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4\">\r\n        <motion.div\r\n          initial={{ scale: 0.9, opacity: 0 }}\r\n          animate={{ scale: 1, opacity: 1 }}\r\n          className=\"text-center max-w-md\"\r\n        >\r\n          <motion.div\r\n            initial={{ scale: 0 }}\r\n            animate={{ scale: 1, rotate: 360 }}\r\n            transition={{ delay: 0.2, type: \"spring\" }}\r\n            className=\"w-20 h-20 bg-slate-900 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-2xl\"\r\n          >\r\n            <Check className=\"w-10 h-10 text-white\" />\r\n          </motion.div>\r\n          <h1 className=\"text-3xl font-bold text-white mb-3\">Confirmed!</h1>\r\n          <div className=\"bg-white/10 backdrop-blur-xl rounded-2xl p-4 border border-white/20 mb-6\">\r\n            <div className=\"flex items-center justify-center gap-2 text-purple-200 mb-2\">\r\n              <CalendarIcon className=\"w-4 h-4\" />\r\n              <span className=\"font-medium\">\r\n                {selectedDate && format(selectedDate, \"MMM d\")} â€¢ {selectedTime}\r\n              </span>\r\n            </div>\r\n            <p className=\"text-sm text-purple-300\">Check your email</p>\r\n          </div>\r\n          <Button\r\n            className=\"bg-white text-purple-900 hover:bg-purple-50\"\r\n            onClick={() => setLocation(\"/\")}\r\n            data-testid=\"button-back-home\"\r\n          >\r\n            Back to Home\r\n          </Button>\r\n        </motion.div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-[#F8F7F5] text-slate-900\">\r\n      {/* Navigation */}\r\n      <nav className=\"relative top-4 left-0 right-0 z-50 px-4 md:px-6 lg:px-8 mb-8\">\r\n        <div className=\"max-w-7xl mx-auto bg-white/80 backdrop-blur-xl rounded-2xl border border-gray-200/50 shadow-lg shadow-slate-900/5\">\r\n          <div className=\"px-4 md:px-6\">\r\n            <div className=\"flex justify-between items-center h-16\">\r\n              <div className=\"flex items-center cursor-pointer\" onClick={() => setLocation(\"/\")}>\r\n                <img \r\n                  src={fallOwlLogo} \r\n                  alt=\"FallOwl\" \r\n                  className=\"h-10 w-auto object-contain\"\r\n                />\r\n              </div>\r\n              \r\n              <div className=\"hidden md:flex items-center space-x-8\">\r\n                <a href=\"/features\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\" onClick={(e) => { e.preventDefault(); setLocation(\"/features\"); }}>Features</a>\r\n                <a href=\"/#integrations\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\">Integrations</a>\r\n                <a href=\"/about\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\" onClick={(e) => { e.preventDefault(); setLocation(\"/about\"); }}>About</a>\r\n                <a href=\"/api-docs\" className=\"text-sm font-medium text-slate-700 hover:text-purple-600 transition-colors\" onClick={(e) => { e.preventDefault(); setLocation(\"/api-docs\"); }}>API Doc</a>\r\n                <Button \r\n                  size=\"sm\" \r\n                  className=\"bg-slate-900 hover:bg-slate-800 text-white text-sm rounded-xl\"\r\n                  onClick={() => window.location.href = 'https://app.fallowl.com'}\r\n                >\r\n                  Sign in\r\n                </Button>\r\n              </div>\r\n\r\n              <Button \r\n                variant=\"ghost\" \r\n                size=\"icon\"\r\n                onClick={() => setIsMenuOpen(!isMenuOpen)}\r\n                className=\"md:hidden\"\r\n              >\r\n                <Menu className=\"w-5 h-5\" />\r\n              </Button>\r\n            </div>\r\n\r\n            {isMenuOpen && (\r\n              <div className=\"md:hidden py-4 border-t border-gray-200\">\r\n                <div className=\"flex flex-col space-y-3\">\r\n                  <a href=\"/features\" className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-purple-600 rounded-lg hover:bg-slate-50 transition-colors\" onClick={(e) => { e.preventDefault(); setLocation(\"/features\"); }}>Features</a>\r\n                  <a href=\"/#integrations\" className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-purple-600 rounded-lg hover:bg-slate-50 transition-colors\">Integrations</a>\r\n                  <a href=\"/about\" className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-purple-600 rounded-lg hover:bg-slate-50 transition-colors\" onClick={(e) => { e.preventDefault(); setLocation(\"/about\"); }}>About</a>\r\n                  <a href=\"/api-docs\" className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-purple-600 rounded-lg hover:bg-slate-50 transition-colors\" onClick={(e) => { e.preventDefault(); setLocation(\"/api-docs\"); }}>API Doc</a>\r\n                  <div className=\"px-4 pt-2\">\r\n                    <Button \r\n                      size=\"sm\" \r\n                      className=\"bg-slate-900 hover:bg-slate-800 text-white w-full rounded-xl\"\r\n                      onClick={() => window.location.href = 'https://app.fallowl.com'}\r\n                    >\r\n                      Sign in\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </nav>\r\n\r\n      {/* Main Content - Full Height */}\r\n      <div className=\"flex-1 flex items-center justify-center p-4 overflow-hidden\">\r\n        <div className=\"w-full max-w-5xl h-full max-h-[calc(100vh-8rem)] flex flex-col\">\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 10 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            className=\"flex-1 flex flex-col\"\r\n          >\r\n            {/* Title */}\r\n            <div className=\"text-center mb-4 flex-none\">\r\n              <h1 className=\"text-3xl sm:text-4xl font-bold bg-gradient-to-r from-slate-900 via-purple-900 to-slate-900 bg-clip-text text-transparent mb-1\">\r\n                Schedule Your Demo\r\n              </h1>\r\n              <p className=\"text-slate-600 text-sm\">30-minute personalized session</p>\r\n            </div>\r\n\r\n            {/* Main Card - Takes remaining space */}\r\n            <Card className=\"flex-1 bg-white/80 backdrop-blur-xl border-gray-200 shadow-2xl flex flex-col overflow-hidden\">\r\n              <CardContent className=\"p-4 flex-1 flex flex-col overflow-hidden\">\r\n                <form onSubmit={handleSubmit(onSubmit)} className=\"flex-1 flex flex-col overflow-hidden\">\r\n                  \r\n                  {/* Tab Navigation */}\r\n                  <div className=\"flex gap-2 mb-3 flex-none\">\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setCurrentTab(\"datetime\")}\r\n                      className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all ${\r\n                        currentTab === \"datetime\"\r\n                          ? \"bg-slate-900 text-white shadow-md\"\r\n                          : \"bg-slate-100 text-slate-600 hover:bg-slate-200\"\r\n                      }`}\r\n                    >\r\n                      <CalendarIcon className=\"w-4 h-4 inline mr-1\" />\r\n                      Date & Time\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => canProceed ? setCurrentTab(\"info\") : toast({ title: \"Select date & time first\", variant: \"destructive\" })}\r\n                      className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all ${\r\n                        currentTab === \"info\"\r\n                          ? \"bg-slate-900 text-white shadow-md\"\r\n                          : \"bg-slate-100 text-slate-600 hover:bg-slate-200\"\r\n                      }`}\r\n                    >\r\n                      <User className=\"w-4 h-4 inline mr-1\" />\r\n                      Your Info\r\n                    </button>\r\n                  </div>\r\n\r\n                  {/* Content Area - Scrollable if needed */}\r\n                  <div className=\"flex-1 overflow-y-auto\">\r\n                    <AnimatePresence mode=\"wait\">\r\n                      {currentTab === \"datetime\" && (\r\n                        <motion.div\r\n                          key=\"datetime\"\r\n                          initial={{ opacity: 0, x: -20 }}\r\n                          animate={{ opacity: 1, x: 0 }}\r\n                          exit={{ opacity: 0, x: 20 }}\r\n                          transition={{ duration: 0.2 }}\r\n                          className=\"grid lg:grid-cols-2 gap-4 h-full\"\r\n                        >\r\n                          {/* Calendar */}\r\n                          <div className=\"flex flex-col\">\r\n                            <Label className=\"text-xs font-semibold mb-2 flex items-center gap-1\">\r\n                              <CalendarIcon className=\"w-3.5 h-3.5 text-slate-900\" />\r\n                              Select Date\r\n                            </Label>\r\n                            <div className=\"bg-gradient-to-br from-purple-50 to-slate-50 rounded-xl p-2 border border-purple-100 flex items-center justify-center\">\r\n                              <Calendar\r\n                                mode=\"single\"\r\n                                selected={selectedDate}\r\n                                onSelect={setSelectedDate}\r\n                                disabled={(date) => date < new Date() || date.getDay() === 0 || date.getDay() === 6}\r\n                                className=\"rounded-lg border-0 scale-90\"\r\n                                data-testid=\"calendar-demo\"\r\n                              />\r\n                            </div>\r\n                          </div>\r\n\r\n                          {/* Time Slots */}\r\n                          <div className=\"flex flex-col\">\r\n                            <Label className=\"text-xs font-semibold mb-2 flex items-center gap-1\">\r\n                              <Clock className=\"w-3.5 h-3.5 text-slate-900\" />\r\n                              Select Time (EST)\r\n                            </Label>\r\n                            <div className=\"bg-gradient-to-br from-slate-50 to-purple-50 rounded-xl p-3 border border-purple-100 flex-1\">\r\n                              <div className=\"grid grid-cols-3 gap-2\">\r\n                                {timeSlots.map((time) => (\r\n                                  <motion.button\r\n                                    key={time}\r\n                                    type=\"button\"\r\n                                    onClick={() => setSelectedTime(time)}\r\n                                    whileHover={{ scale: 1.05 }}\r\n                                    whileTap={{ scale: 0.95 }}\r\n                                    className={`py-2 text-sm font-medium rounded-lg transition-all ${\r\n                                      selectedTime === time\r\n                                        ? \"bg-slate-900 text-white shadow-lg\"\r\n                                        : \"bg-white hover:bg-slate-50 text-slate-700 border border-gray-200\"\r\n                                    }`}\r\n                                    data-testid={`time-${time}`}\r\n                                  >\r\n                                    {time}\r\n                                  </motion.button>\r\n                                ))}\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        </motion.div>\r\n                      )}\r\n\r\n                      {currentTab === \"info\" && (\r\n                        <motion.div\r\n                          key=\"info\"\r\n                          initial={{ opacity: 0, x: 20 }}\r\n                          animate={{ opacity: 1, x: 0 }}\r\n                          exit={{ opacity: 0, x: -20 }}\r\n                          transition={{ duration: 0.2 }}\r\n                          className=\"space-y-3\"\r\n                        >\r\n                          {/* Selected DateTime Display */}\r\n                          {selectedDate && selectedTime && (\r\n                            <div className=\"bg-slate-100 border border-slate-200 rounded-lg p-2 mb-3\">\r\n                              <div className=\"flex items-center gap-2 text-slate-900 text-sm font-medium\">\r\n                                <Check className=\"w-4 h-4\" />\r\n                                {format(selectedDate, \"EEE, MMM d\")} at {selectedTime}\r\n                              </div>\r\n                            </div>\r\n                          )}\r\n\r\n                          <div className=\"grid sm:grid-cols-2 gap-3\">\r\n                            <div className=\"space-y-1\">\r\n                              <Label htmlFor=\"fullName\" className=\"text-xs flex items-center gap-1\">\r\n                                <User className=\"w-3 h-3\" /> Name\r\n                              </Label>\r\n                              <Input\r\n                                id=\"fullName\"\r\n                                {...register(\"fullName\")}\r\n                                placeholder=\"John Smith\"\r\n                                className=\"h-9 text-sm\"\r\n                                autoComplete=\"off\"\r\n                                data-testid=\"input-fullname\"\r\n                              />\r\n                              {errors.fullName && <p className=\"text-red-500 text-xs\">{errors.fullName.message}</p>}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-1\">\r\n                              <Label htmlFor=\"email\" className=\"text-xs flex items-center gap-1\">\r\n                                <Mail className=\"w-3 h-3\" /> Email\r\n                              </Label>\r\n                              <Input\r\n                                id=\"email\"\r\n                                type=\"email\"\r\n                                {...register(\"email\")}\r\n                                placeholder=\"john@company.com\"\r\n                                className=\"h-9 text-sm\"\r\n                                autoComplete=\"off\"\r\n                                data-testid=\"input-email\"\r\n                              />\r\n                              {errors.email && <p className=\"text-red-500 text-xs\">{errors.email.message}</p>}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-1\">\r\n                              <Label htmlFor=\"company\" className=\"text-xs flex items-center gap-1\">\r\n                                <Building2 className=\"w-3 h-3\" /> Company\r\n                              </Label>\r\n                              <Input\r\n                                id=\"company\"\r\n                                {...register(\"company\")}\r\n                                placeholder=\"Acme Inc.\"\r\n                                className=\"h-9 text-sm\"\r\n                                autoComplete=\"off\"\r\n                                data-testid=\"input-company\"\r\n                              />\r\n                              {errors.company && <p className=\"text-red-500 text-xs\">{errors.company.message}</p>}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-1\">\r\n                              <Label htmlFor=\"phone\" className=\"text-xs flex items-center gap-1\">\r\n                                <Phone className=\"w-3 h-3\" /> Phone\r\n                              </Label>\r\n                              <Input\r\n                                id=\"phone\"\r\n                                {...register(\"phone\")}\r\n                                placeholder=\"+1 (555) 123-4567\"\r\n                                className=\"h-9 text-sm\"\r\n                                autoComplete=\"off\"\r\n                                data-testid=\"input-phone\"\r\n                              />\r\n                              {errors.phone && <p className=\"text-red-500 text-xs\">{errors.phone.message}</p>}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-1 sm:col-span-2\">\r\n                              <Label htmlFor=\"teamSize\" className=\"text-xs flex items-center gap-1\">\r\n                                <Users className=\"w-3 h-3\" /> Team Size\r\n                              </Label>\r\n                              <Select\r\n                                value={formValues.teamSize}\r\n                                onValueChange={(value) => setValue(\"teamSize\", value, { shouldValidate: true })}\r\n                              >\r\n                                <SelectTrigger className=\"h-9 text-sm\" data-testid=\"select-teamsize\">\r\n                                  <SelectValue placeholder=\"Select team size\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                  {teamSizes.map((size) => (\r\n                                    <SelectItem key={size} value={size}>\r\n                                      {size} employees\r\n                                    </SelectItem>\r\n                                  ))}\r\n                                </SelectContent>\r\n                              </Select>\r\n                              {errors.teamSize && <p className=\"text-red-500 text-xs\">{errors.teamSize.message}</p>}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-1 sm:col-span-2\">\r\n                              <Label htmlFor=\"message\" className=\"text-xs flex items-center gap-1\">\r\n                                <MessageSquare className=\"w-3 h-3\" /> Notes <span className=\"text-slate-400\">(Optional)</span>\r\n                              </Label>\r\n                              <Textarea\r\n                                id=\"message\"\r\n                                {...register(\"message\")}\r\n                                placeholder=\"Your specific needs...\"\r\n                                rows={2}\r\n                                className=\"resize-none text-sm\"\r\n                                data-testid=\"input-message\"\r\n                              />\r\n                            </div>\r\n                          </div>\r\n                        </motion.div>\r\n                      )}\r\n                    </AnimatePresence>\r\n                  </div>\r\n\r\n                  {/* Actions */}\r\n                  <div className=\"flex gap-2 mt-3 flex-none\">\r\n                    {currentTab === \"info\" && (\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"outline\"\r\n                        onClick={() => setCurrentTab(\"datetime\")}\r\n                        className=\"flex-1\"\r\n                      >\r\n                        <ChevronLeft className=\"w-4 h-4 mr-1\" />\r\n                        Back\r\n                      </Button>\r\n                    )}\r\n                    {currentTab === \"datetime\" ? (\r\n                      <Button\r\n                        type=\"button\"\r\n                        onClick={() => canProceed ? setCurrentTab(\"info\") : toast({ title: \"Select date & time\", variant: \"destructive\" })}\r\n                        className=\"flex-1 bg-slate-900 hover:bg-slate-800 text-white\"\r\n                      >\r\n                        Continue\r\n                        <ArrowRight className=\"w-4 h-4 ml-1\" />\r\n                      </Button>\r\n                    ) : (\r\n                      <Button\r\n                        type=\"submit\"\r\n                        className=\"flex-1 bg-slate-900 hover:bg-slate-800 text-white\"\r\n                        data-testid=\"button-submit\"\r\n                      >\r\n                        <Check className=\"w-4 h-4 mr-1\" />\r\n                        Confirm Booking\r\n                      </Button>\r\n                    )}\r\n                  </div>\r\n                </form>\r\n              </CardContent>\r\n            </Card>\r\n          </motion.div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\features.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\landing.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\privacy.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\security.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\terms.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\client\\src\\pages\\twilio-setup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\backup-options.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\clean-broken-campaigns.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\database-migration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\diagnose-encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\extract-complexity-hotspots.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\get-contacts-columns.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\inspect-contacts-schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\migrate-encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\recover-campaigns.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\test-all-key-variations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\scripts\\test-campaign-keys.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\middleware\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\routes.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 16. Maximum allowed is 15.","line":519,"column":70,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":519,"endColumn":72},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 26. Maximum allowed is 15.","line":3132,"column":44,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":3132,"endColumn":46},{"ruleId":"complexity","severity":1,"message":"Arrow function has a complexity of 16. Maximum allowed is 15.","line":3204,"column":68,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":3204,"endColumn":70},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 27. Maximum allowed is 15.","line":3355,"column":53,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":3355,"endColumn":55},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 24. Maximum allowed is 15.","line":3505,"column":48,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":3505,"endColumn":50},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 17. Maximum allowed is 15.","line":3716,"column":53,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":3716,"endColumn":55},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 25. Maximum allowed is 15.","line":3854,"column":57,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":3854,"endColumn":59},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 20. Maximum allowed is 15.","line":4013,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":4013,"endColumn":52},{"ruleId":"complexity","severity":1,"message":"Async arrow function has a complexity of 19. Maximum allowed is 15.","line":4300,"column":76,"nodeType":"ArrowFunctionExpression","messageId":"complex","endLine":4300,"endColumn":78}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Express } from \"express\";\r\nimport { createServer, type Server } from \"http\";\r\nimport { WebSocketServer, WebSocket } from \"ws\";\r\nimport multer from 'multer';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { db } from \"./db\";\r\nimport * as schema from \"@shared/schema\";\r\nimport { eq, and, sql } from \"drizzle-orm\";\r\nimport { storage } from \"./storage\";\r\nimport { encrypt, decrypt, decryptNote, decryptFilePath } from \"./utils/encryption\";\r\nimport { deriveTimezone } from \"./utils/timezone\";\r\nimport { sendContactFormEmail } from \"./utils/email\";\r\nimport { createRealOpenAIService } from \"./services/realOpenAI\";\r\nimport { mockOpenAIService } from \"./services/mockOpenAI\";\r\nimport { databaseService } from \"./services/databaseService\";\r\nimport { dugguChatbotService } from \"./services/dugguChatbotService\";\r\nimport { externalDbInspector } from \"./services/externalDbInspector\";\r\nimport { externalDugguService } from \"./services/externalDugguService\";\r\nimport { nlQueryService } from \"./services/nlQueryService\";\r\nimport { advancedSearchService } from \"./services/advancedSearchService\";\r\nimport { advancedContactSearchService } from \"./services/advancedContactSearchService\";\r\nimport { fileStorage } from \"./services/fileStorage\";\r\nimport { z } from \"zod\";\r\n\r\n// Helper function to clean AI responses from unwanted patterns\r\nfunction cleanStreamResponse(content: string): string {\r\n  let cleaned = content;\r\n  \r\n  // Remove any emojis completely\r\n  cleaned = cleaned.replace(/[\\u{1F600}-\\u{1F64F}]|[\\u{1F300}-\\u{1F5FF}]|[\\u{1F680}-\\u{1F6FF}]|[\\u{1F1E0}-\\u{1F1FF}]|[\\u{2600}-\\u{26FF}]|[\\u{2700}-\\u{27BF}]/gu, '');\r\n  \r\n  // Replace FallOwl with Closo in AI responses\r\n  cleaned = cleaned.replace(/FallOwl/gi, 'Closo');\r\n  \r\n  // Keep cute pet-like behaviors but remove formal greetings\r\n  cleaned = cleaned.replace(/^(?:greets warmly\\s*)?(?:Hello there[^.!?]*[.!?]\\s*)?/i, '');\r\n  \r\n  // Trim any remaining whitespace\r\n  cleaned = cleaned.trim();\r\n  \r\n  return cleaned || 'I can help you with lead scoring and contact analysis.';\r\n}\r\n\r\n// Configure multer for file uploads with increased limits\r\nconst upload = multer({ \r\n  dest: 'uploads/',\r\n  limits: {\r\n    fileSize: 100 * 1024 * 1024, // 100MB limit\r\n    files: 10 // Maximum 10 files per upload\r\n  },\r\n  fileFilter: (req, file, cb) => {\r\n    console.log('File filter - fieldname:', file.fieldname, 'mimetype:', file.mimetype, 'originalname:', file.originalname);\r\n    \r\n    // Only allow CSV files for the csv field\r\n    if (file.fieldname === 'csv') {\r\n      if (file.mimetype === 'text/csv' || file.originalname.endsWith('.csv')) {\r\n        cb(null, true);\r\n      } else {\r\n        cb(new Error('Only CSV files are allowed for CSV uploads'));\r\n      }\r\n    } else if (file.fieldname === 'document') {\r\n      // Allow wide variety of file types\r\n      const allowedTypes = [\r\n        // Documents\r\n        'application/pdf',\r\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n        'application/vnd.openxmlformats-officedocument.presentationml.presentation',\r\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n        'application/msword',\r\n        'application/vnd.ms-excel',\r\n        'application/vnd.ms-powerpoint',\r\n        'text/plain',\r\n        'text/csv',\r\n        'application/rtf',\r\n        \r\n        // Images\r\n        'image/jpeg',\r\n        'image/jpg',\r\n        'image/png',\r\n        'image/gif',\r\n        'image/bmp',\r\n        'image/webp',\r\n        'image/svg+xml',\r\n        'image/tiff',\r\n        \r\n        // Videos\r\n        'video/mp4',\r\n        'video/mpeg',\r\n        'video/quicktime',\r\n        'video/x-msvideo',\r\n        'video/webm',\r\n        'video/ogg',\r\n        'video/3gpp',\r\n        \r\n        // Audio\r\n        'audio/mpeg',\r\n        'audio/mp3',\r\n        'audio/wav',\r\n        'audio/ogg',\r\n        'audio/aac',\r\n        'audio/webm',\r\n        \r\n        // Archives\r\n        'application/zip',\r\n        'application/x-rar-compressed',\r\n        'application/x-7z-compressed',\r\n        'application/x-tar',\r\n        'application/gzip',\r\n        \r\n        // Code and data\r\n        'application/json',\r\n        'text/javascript',\r\n        'text/html',\r\n        'text/css',\r\n        'application/xml',\r\n        'text/xml',\r\n        'text/markdown',\r\n        'application/octet-stream', // For various file types that browsers can't identify\r\n        'text/x-markdown'\r\n      ];\r\n      \r\n      // Check by MIME type or file extension for broader compatibility\r\n      const fileExtension = file.originalname.toLowerCase().split('.').pop();\r\n      const allowedExtensions = [\r\n        // Documents\r\n        'pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt', 'csv', 'rtf', 'md', 'markdown',\r\n        // Images  \r\n        'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'tiff', 'tif', 'ico',\r\n        // Videos\r\n        'mp4', 'mpeg', 'mpg', 'mov', 'avi', 'webm', 'ogg', '3gp', 'mkv', 'flv',\r\n        // Audio\r\n        'mp3', 'wav', 'ogg', 'aac', 'webm', 'flac', 'm4a',\r\n        // Archives\r\n        'zip', 'rar', '7z', 'tar', 'gz', 'bz2',\r\n        // Code and data\r\n        'json', 'js', 'ts', 'jsx', 'tsx', 'html', 'css', 'xml', 'yaml', 'yml', 'sql', 'py', 'java', 'cpp', 'c', 'h'\r\n      ];\r\n      \r\n      if (allowedTypes.includes(file.mimetype) || allowedExtensions.includes(fileExtension || '')) {\r\n        cb(null, true);\r\n      } else {\r\n        console.log('File type not allowed:', file.mimetype, 'Extension:', fileExtension);\r\n        cb(new Error(`File type not allowed: ${file.originalname}`));\r\n      }\r\n    } else {\r\n      cb(new Error('Invalid file field'));\r\n    }\r\n  }\r\n});\r\n\r\nconst DASHBOARD_PASSWORD = process.env.DASHBOARD_PASSWORD || '1234';\r\nconst ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || 'Ansh@0309';\r\n\r\nfunction sanitizeFilePath(filePath: string, baseDir: string = 'uploads'): string {\r\n  const normalizedPath = path.normalize(filePath).replace(/^(\\.\\.(\\/|\\\\|$))+/, '');\r\n  const absoluteBasePath = path.resolve(baseDir);\r\n  const absoluteFilePath = path.resolve(absoluteBasePath, normalizedPath);\r\n  \r\n  if (!absoluteFilePath.startsWith(absoluteBasePath)) {\r\n    throw new Error('Invalid file path: path traversal detected');\r\n  }\r\n  \r\n  return absoluteFilePath;\r\n}\r\n\r\n// Function to parse CSV line with proper handling of quoted fields\r\nfunction parseCSVLine(line: string): string[] {\r\n  const result = [];\r\n  let current = '';\r\n  let inQuotes = false;\r\n  \r\n  for (let i = 0; i < line.length; i++) {\r\n    const char = line[i];\r\n    \r\n    if (char === '\"') {\r\n      if (inQuotes && line[i + 1] === '\"') {\r\n        // Handle escaped quotes\r\n        current += '\"';\r\n        i++; // Skip next quote\r\n      } else {\r\n        // Toggle quote state\r\n        inQuotes = !inQuotes;\r\n      }\r\n    } else if (char === ',' && !inQuotes) {\r\n      // Field separator found outside quotes\r\n      result.push(current.trim());\r\n      current = '';\r\n    } else {\r\n      current += char;\r\n    }\r\n  }\r\n  \r\n  // Add the last field\r\n  result.push(current.trim());\r\n  return result;\r\n}\r\n\r\ninterface ActivityLogParams {\r\n  req: any;\r\n  activityType: string;\r\n  action: string;\r\n  resourceType?: string | null;\r\n  resourceId?: string | null;\r\n  details?: any;\r\n  userId?: string | null;\r\n  userRole?: string | null;\r\n}\r\n\r\nasync function logActivity(params: ActivityLogParams): Promise<void> {\r\n  try {\r\n    const {\r\n      req,\r\n      activityType,\r\n      action,\r\n      resourceType = null,\r\n      resourceId = null,\r\n      details = {},\r\n      userId = null,\r\n      userRole = null\r\n    } = params;\r\n\r\n    const ipAddress = req.ip || req.connection?.remoteAddress || null;\r\n    const userAgent = req.get('user-agent') || null;\r\n    const sessionUserId = req.session?.userId || userId;\r\n    const sessionUserRole = req.session?.userRole || userRole;\r\n\r\n    await db.insert(schema.userActivityLogs).values({\r\n      userId: sessionUserId,\r\n      userRole: sessionUserRole,\r\n      activityType,\r\n      action,\r\n      resourceType,\r\n      resourceId,\r\n      details,\r\n      ipAddress,\r\n      userAgent\r\n    });\r\n\r\n    console.log(`Activity logged: ${activityType} - ${action}`, {\r\n      userId: sessionUserId,\r\n      resourceType,\r\n      resourceId\r\n    });\r\n  } catch (error) {\r\n    console.error('Failed to log activity:', error);\r\n  }\r\n}\r\n\r\nexport async function registerRoutes(app: Express): Promise<Server> {\r\n  const httpServer = createServer(app);\r\n\r\n  // Create WebSocket server for real-time notes updates\r\n  const wss = new WebSocketServer({ \r\n    server: httpServer, \r\n    path: '/ws' \r\n  });\r\n\r\n  // Store connected WebSocket clients\r\n  const wsClients = new Set<WebSocket>();\r\n  const typingUsers = new Map<string, NodeJS.Timeout>();\r\n\r\n  wss.on('connection', (ws, req) => {\r\n    console.log('New WebSocket connection established');\r\n    wsClients.add(ws);\r\n\r\n    // Send initial notes data to newly connected client\r\n    storage.getNotes().then(notes => {\r\n      if (ws.readyState === WebSocket.OPEN) {\r\n        const validNotes = notes.map(note => {\r\n          try {\r\n            const decryptedContent = decryptNote(note.encryptedContent);\r\n            return {\r\n              id: note.id,\r\n              content: decryptedContent,\r\n              createdAt: note.createdAt\r\n            };\r\n          } catch (error) {\r\n            console.warn(`WebSocket: Failed to decrypt note ${note.id}:`, error);\r\n            return null;\r\n          }\r\n        }).filter(note => note !== null);\r\n        \r\n        ws.send(JSON.stringify({\r\n          type: 'notes_init',\r\n          data: validNotes\r\n        }));\r\n      }\r\n    }).catch(console.error);\r\n\r\n    ws.on('close', () => {\r\n      console.log('WebSocket connection closed');\r\n      wsClients.delete(ws);\r\n    });\r\n\r\n    ws.on('error', (error) => {\r\n      console.error('WebSocket error:', error);\r\n      wsClients.delete(ws);\r\n    });\r\n\r\n    ws.on('message', (data) => {\r\n      try {\r\n        const message = JSON.parse(data.toString());\r\n        \r\n        switch (message.type) {\r\n          case 'typing':\r\n            // Clear existing timeout for this user\r\n            if (typingUsers.has(message.data.userId)) {\r\n              clearTimeout(typingUsers.get(message.data.userId)!);\r\n            }\r\n            \r\n            // Broadcast typing indicator to other clients\r\n            broadcastToOthers(ws, {\r\n              type: 'user_typing',\r\n              data: message.data\r\n            });\r\n            \r\n            // Set timeout to automatically stop typing after 3 seconds\r\n            const timeout = setTimeout(() => {\r\n              broadcastToOthers(ws, {\r\n                type: 'user_stopped_typing',\r\n                data: message.data\r\n              });\r\n              typingUsers.delete(message.data.userId);\r\n            }, 3000);\r\n            \r\n            typingUsers.set(message.data.userId, timeout);\r\n            break;\r\n            \r\n          case 'stopped_typing':\r\n            // Clear timeout and broadcast stop typing\r\n            if (typingUsers.has(message.data.userId)) {\r\n              clearTimeout(typingUsers.get(message.data.userId)!);\r\n              typingUsers.delete(message.data.userId);\r\n            }\r\n            \r\n            broadcastToOthers(ws, {\r\n              type: 'user_stopped_typing',\r\n              data: message.data\r\n            });\r\n            break;\r\n        }\r\n      } catch (error) {\r\n        console.error('Error parsing WebSocket message:', error);\r\n      }\r\n    });\r\n  });\r\n\r\n  // Function to broadcast notes updates to all connected clients\r\n  function broadcastNotesUpdate(type: 'created' | 'updated' | 'deleted', noteData: any) {\r\n    const message = JSON.stringify({\r\n      type: `note_${type}`,\r\n      data: noteData\r\n    });\r\n\r\n    wsClients.forEach(client => {\r\n      if (client.readyState === WebSocket.OPEN) {\r\n        client.send(message);\r\n      } else {\r\n        wsClients.delete(client);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Function to broadcast to all clients except sender\r\n  function broadcastToOthers(sender: WebSocket, data: any) {\r\n    const message = JSON.stringify(data);\r\n    \r\n    wsClients.forEach(client => {\r\n      if (client !== sender && client.readyState === WebSocket.OPEN) {\r\n        client.send(message);\r\n      } else if (client.readyState !== WebSocket.OPEN) {\r\n        wsClients.delete(client);\r\n      }\r\n    });\r\n  }\r\n  \r\n  // Basic health check endpoint for Docker and load balancers\r\n  app.get('/health', (req, res) => {\r\n    res.status(200).send('OK');\r\n  });\r\n\r\n  // Detailed health check endpoint with database connectivity check\r\n  app.get('/api/health', async (req, res) => {\r\n    const health = {\r\n      status: 'ok',\r\n      timestamp: new Date().toISOString(),\r\n      uptime: process.uptime(),\r\n      version: '1.0.0',\r\n      storage: fileStorage.getStorageType(),\r\n      database: 'unknown',\r\n      environment: process.env.NODE_ENV || 'development'\r\n    };\r\n\r\n    try {\r\n      const { pool } = await import('./db');\r\n      const client = await pool.connect();\r\n      await client.query('SELECT 1');\r\n      client.release();\r\n      health.database = 'connected';\r\n    } catch (error) {\r\n      health.database = 'disconnected';\r\n      health.status = 'degraded';\r\n      console.error('Health check database error:', error);\r\n    }\r\n\r\n    const statusCode = health.status === 'ok' ? 200 : 503;\r\n    res.status(statusCode).json(health);\r\n  });\r\n  \r\n  // Authentication route supporting both dashboard and admin\r\n  app.post('/api/auth', async (req, res) => {\r\n    try {\r\n      const { password } = req.body;\r\n      \r\n      if (!password) {\r\n        return res.status(400).json({ message: 'Password is required' });\r\n      }\r\n      \r\n      let isValid = false;\r\n      let role = '';\r\n      \r\n      if (password === ADMIN_PASSWORD) {\r\n        isValid = true;\r\n        role = 'admin';\r\n      } else if (password === DASHBOARD_PASSWORD) {\r\n        isValid = true;\r\n        role = 'user';\r\n      }\r\n      \r\n      if (isValid) {\r\n        // Clear existing session data\r\n        req.session.regenerate((err) => {\r\n          if (err) {\r\n            console.error('Session regeneration error:', err);\r\n            return res.status(500).json({ message: 'Authentication failed' });\r\n          }\r\n\r\n          req.session.authenticated = true;\r\n          req.session.userRole = role;\r\n          req.session.userId = role === 'admin' ? 'admin' : 'dashboard-user';\r\n          \r\n          // Force save and wait for completion\r\n          req.session.save((saveErr) => {\r\n            if (saveErr) {\r\n              console.error('Session save error:', saveErr);\r\n              return res.status(500).json({ message: 'Authentication failed' });\r\n            }\r\n            \r\n            console.log('Session saved successfully:', {\r\n              id: req.sessionID,\r\n              userId: req.session.userId,\r\n              role: req.session.userRole\r\n            });\r\n            \r\n            // Set session-id cookie explicitly to ensure it's sent\r\n            res.cookie('campaign_session', req.sessionID, {\r\n              secure: true,\r\n              httpOnly: true,\r\n              maxAge: 24 * 60 * 60 * 1000,\r\n              sameSite: 'none',\r\n              path: '/'\r\n            });\r\n            \r\n            res.json({ success: true, role });\r\n          });\r\n        });\r\n      } else {\r\n        res.status(401).json({ message: 'Invalid password' });\r\n      }\r\n    } catch (error) {\r\n      console.error('Auth error:', error);\r\n      res.status(500).json({ message: 'Authentication failed' });\r\n    }\r\n  });\r\n\r\n  // Check authentication status\r\n  app.get('/api/auth/status', (req, res) => {\r\n    res.json({ \r\n      authenticated: !!req.session.authenticated,\r\n      role: req.session.userRole || 'user',\r\n      userId: req.session.userId\r\n    });\r\n  });\r\n\r\n  // Logout route\r\n  app.post('/api/auth/logout', async (req, res) => {\r\n    const userRole = req.session?.userRole;\r\n    \r\n    await logActivity({\r\n      req,\r\n      activityType: 'logout',\r\n      action: 'User logged out',\r\n      userRole,\r\n      details: { timestamp: new Date().toISOString() }\r\n    });\r\n    \r\n    req.session.destroy((err) => {\r\n      if (err) {\r\n        console.error('Logout error:', err);\r\n        return res.status(500).json({ message: 'Logout failed' });\r\n      }\r\n      res.json({ success: true });\r\n    });\r\n  });\r\n\r\n  // Admin authorization middleware\r\n  const requireAdmin = (req: any, res: any, next: any) => {\r\n    if (!req.session.authenticated) {\r\n      return res.status(401).json({ message: 'Authentication required' });\r\n    }\r\n    if (req.session.userRole !== 'admin') {\r\n      return res.status(403).json({ message: 'Admin access required' });\r\n    }\r\n    next();\r\n  };\r\n\r\n  // Admin activity logs endpoint\r\n  app.get('/api/admin/activity-logs', requireAdmin, async (req, res) => {\r\n    try {\r\n      const {\r\n        limit = 100,\r\n        offset = 0,\r\n        activityType,\r\n        userRole,\r\n        startDate,\r\n        endDate,\r\n        exportAll = 'false'\r\n      } = req.query;\r\n\r\n      // Build where conditions\r\n      const conditions = [];\r\n      \r\n      if (activityType && activityType !== 'all') {\r\n        conditions.push(eq(schema.userActivityLogs.activityType, activityType as string));\r\n      }\r\n      \r\n      if (userRole && userRole !== 'all') {\r\n        conditions.push(eq(schema.userActivityLogs.userRole, userRole as string));\r\n      }\r\n      \r\n      if (startDate) {\r\n        conditions.push(sql`${schema.userActivityLogs.createdAt} >= ${new Date(startDate as string)}`);\r\n      }\r\n      \r\n      if (endDate) {\r\n        conditions.push(sql`${schema.userActivityLogs.createdAt} <= ${new Date(endDate as string)}`);\r\n      }\r\n\r\n      // Fetch activities from database\r\n      const activities = await db\r\n        .select()\r\n        .from(schema.userActivityLogs)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined)\r\n        .orderBy(sql`${schema.userActivityLogs.createdAt} DESC`)\r\n        .limit(exportAll === 'true' ? 10000 : parseInt(limit as string))\r\n        .offset(exportAll === 'true' ? 0 : parseInt(offset as string));\r\n\r\n      // Get total count for pagination with same filters\r\n      const [countResult] = await db\r\n        .select({ count: sql<number>`count(*)` })\r\n        .from(schema.userActivityLogs)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined);\r\n\r\n      res.json({\r\n        activities,\r\n        total: Number(countResult.count) || 0,\r\n        limit: parseInt(limit as string),\r\n        offset: parseInt(offset as string)\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching activity logs:', error);\r\n      res.status(500).json({ message: 'Failed to fetch activity logs' });\r\n    }\r\n  });\r\n\r\n  // Admin sessions endpoint\r\n  app.get('/api/admin/sessions', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleSessions = [\r\n        {\r\n          id: 'sess_1234567890',\r\n          userId: 'admin@example.com',\r\n          userRole: 'admin',\r\n          ipAddress: '192.168.1.100',\r\n          userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\r\n          device: 'Desktop',\r\n          browser: 'Chrome 120',\r\n          os: 'Windows 10',\r\n          lastActivity: new Date(Date.now() - 300000).toISOString(),\r\n          createdAt: new Date(Date.now() - 3600000).toISOString(),\r\n          expiresAt: new Date(Date.now() + 82800000).toISOString(),\r\n          isActive: true\r\n        },\r\n        {\r\n          id: 'sess_0987654321',\r\n          userId: 'user@example.com',\r\n          userRole: 'user',\r\n          ipAddress: '192.168.1.101',\r\n          userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',\r\n          device: 'Desktop',\r\n          browser: 'Safari 17',\r\n          os: 'macOS',\r\n          lastActivity: new Date(Date.now() - 600000).toISOString(),\r\n          createdAt: new Date(Date.now() - 7200000).toISOString(),\r\n          expiresAt: new Date(Date.now() + 79200000).toISOString(),\r\n          isActive: true\r\n        },\r\n        {\r\n          id: 'sess_5555555555',\r\n          userId: 'demo@example.com',\r\n          userRole: 'user',\r\n          ipAddress: '192.168.1.102',\r\n          userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X)',\r\n          device: 'Mobile',\r\n          browser: 'Safari Mobile',\r\n          os: 'iOS 17',\r\n          lastActivity: new Date(Date.now() - 1800000).toISOString(),\r\n          createdAt: new Date(Date.now() - 5400000).toISOString(),\r\n          expiresAt: new Date(Date.now() + 81000000).toISOString(),\r\n          isActive: false\r\n        }\r\n      ];\r\n\r\n      res.json(sampleSessions);\r\n    } catch (error) {\r\n      console.error('Error fetching sessions:', error);\r\n      res.status(500).json({ message: 'Failed to fetch sessions' });\r\n    }\r\n  });\r\n\r\n  // Admin login history endpoint\r\n  app.get('/api/admin/login-history', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleLoginHistory = [\r\n        {\r\n          id: 1,\r\n          userId: 'admin@example.com',\r\n          userRole: 'admin',\r\n          ipAddress: '192.168.1.100',\r\n          userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',\r\n          device: 'Desktop',\r\n          browser: 'Chrome 120',\r\n          location: 'New York, USA',\r\n          status: 'success',\r\n          failureReason: null,\r\n          timestamp: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'user@example.com',\r\n          userRole: 'user',\r\n          ipAddress: '192.168.1.101',\r\n          userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)',\r\n          device: 'Desktop',\r\n          browser: 'Safari 17',\r\n          location: 'San Francisco, USA',\r\n          status: 'success',\r\n          failureReason: null,\r\n          timestamp: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'test@example.com',\r\n          userRole: null,\r\n          ipAddress: '192.168.1.102',\r\n          userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',\r\n          device: 'Desktop',\r\n          browser: 'Firefox 121',\r\n          location: 'London, UK',\r\n          status: 'failed',\r\n          failureReason: 'Invalid credentials',\r\n          timestamp: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'blocked@example.com',\r\n          userRole: null,\r\n          ipAddress: '10.0.0.50',\r\n          userAgent: 'Mozilla/5.0 (X11; Linux x86_64)',\r\n          device: 'Desktop',\r\n          browser: 'Chrome 119',\r\n          location: 'Unknown',\r\n          status: 'blocked',\r\n          failureReason: 'Too many failed attempts',\r\n          timestamp: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          userId: 'demo@example.com',\r\n          userRole: 'user',\r\n          ipAddress: '192.168.1.103',\r\n          userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0)',\r\n          device: 'Mobile',\r\n          browser: 'Safari Mobile',\r\n          location: 'Los Angeles, USA',\r\n          status: 'success',\r\n          failureReason: null,\r\n          timestamp: new Date(Date.now() - 14400000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleLoginHistory);\r\n    } catch (error) {\r\n      console.error('Error fetching login history:', error);\r\n      res.status(500).json({ message: 'Failed to fetch login history' });\r\n    }\r\n  });\r\n\r\n  // Admin campaign analytics endpoint\r\n  app.get('/api/admin/campaign-analytics', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleAnalytics = {\r\n        totalCampaigns: 45,\r\n        activeCampaigns: 12,\r\n        totalContacts: 15000,\r\n        totalCalls: 8500,\r\n        successRate: 68,\r\n        avgCallDuration: 145,\r\n        dailyStats: [\r\n          { date: '2024-11-14', calls: 450, success: 310, failed: 140 },\r\n          { date: '2024-11-15', calls: 520, success: 360, failed: 160 },\r\n          { date: '2024-11-16', calls: 480, success: 330, failed: 150 },\r\n          { date: '2024-11-17', calls: 590, success: 410, failed: 180 },\r\n          { date: '2024-11-18', calls: 610, success: 425, failed: 185 },\r\n          { date: '2024-11-19', calls: 550, success: 380, failed: 170 },\r\n          { date: '2024-11-20', calls: 620, success: 440, failed: 180 }\r\n        ],\r\n        statusDistribution: [\r\n          { name: 'Active', value: 12 },\r\n          { name: 'Completed', value: 25 },\r\n          { name: 'Paused', value: 5 },\r\n          { name: 'Scheduled', value: 3 }\r\n        ],\r\n        performanceByUser: [\r\n          { user: 'admin@example.com', campaigns: 15, contacts: 5000, calls: 3000 },\r\n          { user: 'user@example.com', campaigns: 20, contacts: 7000, calls: 4200 },\r\n          { user: 'demo@example.com', campaigns: 10, contacts: 3000, calls: 1300 }\r\n        ],\r\n        recentCampaigns: [\r\n          {\r\n            id: 1,\r\n            name: 'Q4 Sales Outreach',\r\n            status: 'active',\r\n            contacts: 1200,\r\n            callsMade: 850,\r\n            successRate: 72,\r\n            createdAt: new Date(Date.now() - 86400000).toISOString()\r\n          },\r\n          {\r\n            id: 2,\r\n            name: 'Customer Follow-up',\r\n            status: 'active',\r\n            contacts: 850,\r\n            callsMade: 600,\r\n            successRate: 68,\r\n            createdAt: new Date(Date.now() - 172800000).toISOString()\r\n          },\r\n          {\r\n            id: 3,\r\n            name: 'Lead Qualification',\r\n            status: 'completed',\r\n            contacts: 500,\r\n            callsMade: 500,\r\n            successRate: 65,\r\n            createdAt: new Date(Date.now() - 259200000).toISOString()\r\n          },\r\n          {\r\n            id: 4,\r\n            name: 'Renewal Reminders',\r\n            status: 'active',\r\n            contacts: 650,\r\n            callsMade: 420,\r\n            successRate: 75,\r\n            createdAt: new Date(Date.now() - 345600000).toISOString()\r\n          }\r\n        ]\r\n      };\r\n\r\n      res.json(sampleAnalytics);\r\n    } catch (error) {\r\n      console.error('Error fetching campaign analytics:', error);\r\n      res.status(500).json({ message: 'Failed to fetch campaign analytics' });\r\n    }\r\n  });\r\n\r\n  // Admin contact tracking endpoint\r\n  app.get('/api/admin/contact-tracking', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleInteractions = [\r\n        {\r\n          id: 1,\r\n          contactName: 'John Smith',\r\n          contactEmail: 'john.smith@example.com',\r\n          contactMobile: '+1-555-0101',\r\n          campaignName: 'Q4 Sales Outreach',\r\n          interactionType: 'call',\r\n          status: 'success',\r\n          duration: 185,\r\n          notes: 'Interested in premium package, scheduled follow-up',\r\n          userId: 'user@example.com',\r\n          timestamp: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          contactName: 'Sarah Johnson',\r\n          contactEmail: 'sarah.j@example.com',\r\n          contactMobile: '+1-555-0102',\r\n          campaignName: 'Customer Follow-up',\r\n          interactionType: 'email',\r\n          status: 'success',\r\n          duration: null,\r\n          notes: 'Sent product catalog and pricing information',\r\n          userId: 'admin@example.com',\r\n          timestamp: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          contactName: 'Mike Davis',\r\n          contactEmail: 'mike.davis@example.com',\r\n          contactMobile: '+1-555-0103',\r\n          campaignName: 'Lead Qualification',\r\n          interactionType: 'call',\r\n          status: 'failed',\r\n          duration: 15,\r\n          notes: 'No answer, left voicemail',\r\n          userId: 'user@example.com',\r\n          timestamp: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          contactName: 'Emily Brown',\r\n          contactEmail: 'emily.brown@example.com',\r\n          contactMobile: '+1-555-0104',\r\n          campaignName: 'Renewal Reminders',\r\n          interactionType: 'sms',\r\n          status: 'success',\r\n          duration: null,\r\n          notes: 'Reminder sent about upcoming subscription renewal',\r\n          userId: 'admin@example.com',\r\n          timestamp: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          contactName: 'David Wilson',\r\n          contactEmail: 'david.w@example.com',\r\n          contactMobile: '+1-555-0105',\r\n          campaignName: 'Q4 Sales Outreach',\r\n          interactionType: 'call',\r\n          status: 'success',\r\n          duration: 220,\r\n          notes: 'Confirmed order, processing payment',\r\n          userId: 'user@example.com',\r\n          timestamp: new Date(Date.now() - 14400000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleInteractions);\r\n    } catch (error) {\r\n      console.error('Error fetching contact tracking:', error);\r\n      res.status(500).json({ message: 'Failed to fetch contact tracking' });\r\n    }\r\n  });\r\n\r\n  // Admin system logs endpoint\r\n  app.get('/api/admin/system-logs', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleLogs = [\r\n        {\r\n          id: 1,\r\n          level: 'error',\r\n          category: 'Database',\r\n          message: 'Connection pool exhausted - consider increasing pool size',\r\n          details: { maxConnections: 10, activeConnections: 10 },\r\n          source: 'db/pool.ts',\r\n          timestamp: new Date(Date.now() - 900000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          level: 'warn',\r\n          category: 'API',\r\n          message: 'Rate limit approaching for user admin@example.com',\r\n          details: { limit: 1000, current: 950, userId: 'admin@example.com' },\r\n          source: 'middleware/rateLimit.ts',\r\n          timestamp: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          level: 'info',\r\n          category: 'Campaign',\r\n          message: 'Campaign \"Q4 Sales Outreach\" started successfully',\r\n          details: { campaignId: 1, contactCount: 1200 },\r\n          source: 'services/campaign.ts',\r\n          timestamp: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          level: 'success',\r\n          category: 'Integration',\r\n          message: 'Twilio integration configured successfully',\r\n          details: { accountSid: 'AC...', phoneNumber: '+1-555-0100' },\r\n          source: 'integrations/twilio.ts',\r\n          timestamp: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          level: 'error',\r\n          category: 'Authentication',\r\n          message: 'Failed login attempt from suspicious IP',\r\n          details: { ipAddress: '10.0.0.50', attempts: 5 },\r\n          source: 'auth/login.ts',\r\n          timestamp: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 6,\r\n          level: 'debug',\r\n          category: 'System',\r\n          message: 'Memory usage check completed',\r\n          details: { heapUsed: '120MB', heapTotal: '256MB' },\r\n          source: 'utils/monitoring.ts',\r\n          timestamp: new Date(Date.now() - 14400000).toISOString()\r\n        },\r\n        {\r\n          id: 7,\r\n          level: 'warn',\r\n          category: 'Storage',\r\n          message: 'S3 storage quota at 85% capacity',\r\n          details: { used: '8.5GB', total: '10GB' },\r\n          source: 'storage/s3.ts',\r\n          timestamp: new Date(Date.now() - 18000000).toISOString()\r\n        },\r\n        {\r\n          id: 8,\r\n          level: 'info',\r\n          category: 'Email',\r\n          message: 'Email batch sent successfully',\r\n          details: { recipientCount: 150, campaignId: 2 },\r\n          source: 'services/email.ts',\r\n          timestamp: new Date(Date.now() - 21600000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleLogs);\r\n    } catch (error) {\r\n      console.error('Error fetching system logs:', error);\r\n      res.status(500).json({ message: 'Failed to fetch system logs' });\r\n    }\r\n  });\r\n\r\n  // Admin API usage endpoint\r\n  app.get('/api/admin/api-usage', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleAPIUsage = {\r\n        totalRequests: 125000,\r\n        successfulRequests: 118500,\r\n        failedRequests: 6500,\r\n        avgResponseTime: 145,\r\n        requestsByEndpoint: [\r\n          { endpoint: '/api/campaigns', count: 35000 },\r\n          { endpoint: '/api/contacts', count: 28000 },\r\n          { endpoint: '/api/auth/login', count: 15000 },\r\n          { endpoint: '/api/calls', count: 22000 },\r\n          { endpoint: '/api/admin/*', count: 8500 }\r\n        ],\r\n        requestsOverTime: [\r\n          { time: '00:00', requests: 850, errors: 45 },\r\n          { time: '04:00', requests: 620, errors: 30 },\r\n          { time: '08:00', requests: 1200, errors: 65 },\r\n          { time: '12:00', requests: 1850, errors: 95 },\r\n          { time: '16:00', requests: 2100, errors: 110 },\r\n          { time: '20:00', requests: 1650, errors: 85 }\r\n        ],\r\n        recentRequests: [\r\n          {\r\n            id: 1,\r\n            endpoint: '/api/campaigns',\r\n            method: 'GET',\r\n            userId: 'user@example.com',\r\n            statusCode: 200,\r\n            responseTime: 125,\r\n            ipAddress: '192.168.1.101',\r\n            userAgent: 'Mozilla/5.0',\r\n            timestamp: new Date(Date.now() - 300000).toISOString()\r\n          },\r\n          {\r\n            id: 2,\r\n            endpoint: '/api/contacts',\r\n            method: 'POST',\r\n            userId: 'admin@example.com',\r\n            statusCode: 201,\r\n            responseTime: 185,\r\n            ipAddress: '192.168.1.100',\r\n            userAgent: 'Mozilla/5.0',\r\n            timestamp: new Date(Date.now() - 600000).toISOString()\r\n          },\r\n          {\r\n            id: 3,\r\n            endpoint: '/api/calls/start',\r\n            method: 'POST',\r\n            userId: 'user@example.com',\r\n            statusCode: 500,\r\n            responseTime: 2500,\r\n            ipAddress: '192.168.1.101',\r\n            userAgent: 'Mozilla/5.0',\r\n            timestamp: new Date(Date.now() - 900000).toISOString()\r\n          },\r\n          {\r\n            id: 4,\r\n            endpoint: '/api/admin/activity-logs',\r\n            method: 'GET',\r\n            userId: 'admin@example.com',\r\n            statusCode: 200,\r\n            responseTime: 95,\r\n            ipAddress: '192.168.1.100',\r\n            userAgent: 'Mozilla/5.0',\r\n            timestamp: new Date(Date.now() - 1200000).toISOString()\r\n          }\r\n        ]\r\n      };\r\n\r\n      res.json(sampleAPIUsage);\r\n    } catch (error) {\r\n      console.error('Error fetching API usage:', error);\r\n      res.status(500).json({ message: 'Failed to fetch API usage' });\r\n    }\r\n  });\r\n\r\n  // Admin security events endpoint\r\n  app.get('/api/admin/security-events', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleSecurityEvents = [\r\n        {\r\n          id: 1,\r\n          eventType: 'brute_force',\r\n          severity: 'high',\r\n          description: 'Multiple failed login attempts detected from single IP',\r\n          userId: null,\r\n          ipAddress: '10.0.0.50',\r\n          location: 'Unknown',\r\n          action: 'IP temporarily blocked for 1 hour',\r\n          status: 'resolved',\r\n          details: { attempts: 15, timeWindow: '5 minutes' },\r\n          timestamp: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          eventType: 'unauthorized_access',\r\n          severity: 'critical',\r\n          description: 'Attempt to access admin panel without proper credentials',\r\n          userId: 'test@example.com',\r\n          ipAddress: '192.168.1.150',\r\n          location: 'London, UK',\r\n          action: 'Account flagged for review',\r\n          status: 'investigating',\r\n          details: { endpoint: '/admin', attempts: 3 },\r\n          timestamp: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          eventType: 'suspicious_activity',\r\n          severity: 'medium',\r\n          description: 'Unusual API request pattern detected',\r\n          userId: 'demo@example.com',\r\n          ipAddress: '192.168.1.103',\r\n          location: 'Los Angeles, USA',\r\n          action: 'Monitoring user activity',\r\n          status: 'active',\r\n          details: { requestCount: 500, timeWindow: '1 minute' },\r\n          timestamp: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          eventType: 'policy_violation',\r\n          severity: 'low',\r\n          description: 'User exceeded daily API rate limit',\r\n          userId: 'user@example.com',\r\n          ipAddress: '192.168.1.101',\r\n          location: 'San Francisco, USA',\r\n          action: 'Rate limit applied',\r\n          status: 'resolved',\r\n          details: { limit: 1000, actual: 1150 },\r\n          timestamp: new Date(Date.now() - 10800000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleSecurityEvents);\r\n    } catch (error) {\r\n      console.error('Error fetching security events:', error);\r\n      res.status(500).json({ message: 'Failed to fetch security events' });\r\n    }\r\n  });\r\n\r\n  // Admin analytics endpoint\r\n  app.get('/api/admin/analytics', requireAdmin, async (req, res) => {\r\n    try {\r\n      const totalUsers = await db.select({ count: sql<number>`count(*)` })\r\n        .from(schema.crmUsers);\r\n      \r\n      const sampleAnalytics = {\r\n        totalUsers: totalUsers[0]?.count || 0,\r\n        activeSessions: 3,\r\n        campaignViews: 245,\r\n        apiCalls: 1250\r\n      };\r\n\r\n      res.json(sampleAnalytics);\r\n    } catch (error) {\r\n      console.error('Error fetching analytics:', error);\r\n      res.status(500).json({ message: 'Failed to fetch analytics' });\r\n    }\r\n  });\r\n\r\n  // Admin audit trail endpoint\r\n  app.get('/api/admin/audit-trail', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleAuditTrail = [\r\n        {\r\n          id: 1,\r\n          userId: 'admin@example.com',\r\n          userRole: 'admin',\r\n          action: 'create_campaign',\r\n          resourceType: 'campaign',\r\n          resourceId: '101',\r\n          changes: { name: 'Q4 2024 Campaign', status: 'active' },\r\n          ipAddress: '192.168.1.100',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'user@example.com',\r\n          userRole: 'user',\r\n          action: 'update_contact',\r\n          resourceType: 'contact',\r\n          resourceId: '5432',\r\n          changes: { email: 'updated@example.com', phone: '+1234567890' },\r\n          ipAddress: '192.168.1.101',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'admin@example.com',\r\n          userRole: 'admin',\r\n          action: 'delete_document',\r\n          resourceType: 'document',\r\n          resourceId: '789',\r\n          changes: { filename: 'old_report.pdf' },\r\n          ipAddress: '192.168.1.100',\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'user@example.com',\r\n          userRole: 'user',\r\n          action: 'upload_csv',\r\n          resourceType: 'campaign',\r\n          resourceId: '102',\r\n          changes: { filename: 'contacts_batch_2.csv', rows: 500 },\r\n          ipAddress: '192.168.1.101',\r\n          createdAt: new Date(Date.now() - 14400000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleAuditTrail);\r\n    } catch (error) {\r\n      console.error('Error fetching audit trail:', error);\r\n      res.status(500).json({ message: 'Failed to fetch audit trail' });\r\n    }\r\n  });\r\n\r\n  // Admin alerts endpoint\r\n  app.get('/api/admin/alerts', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleAlerts = [\r\n        {\r\n          id: 1,\r\n          title: 'High API Usage Detected',\r\n          description: 'API calls exceeded 90% of daily quota',\r\n          severity: 'warning',\r\n          status: 'active',\r\n          createdAt: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          title: 'Database Backup Completed',\r\n          description: 'Daily database backup completed successfully',\r\n          severity: 'info',\r\n          status: 'resolved',\r\n          createdAt: new Date(Date.now() - 86400000).toISOString(),\r\n          resolvedAt: new Date(Date.now() - 85000000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          title: 'Failed Login Attempts',\r\n          description: 'Multiple failed login attempts from IP 10.0.0.50',\r\n          severity: 'critical',\r\n          status: 'active',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          title: 'Low Disk Space',\r\n          description: 'Available disk space below 20%',\r\n          severity: 'warning',\r\n          status: 'active',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleAlerts);\r\n    } catch (error) {\r\n      console.error('Error fetching alerts:', error);\r\n      res.status(500).json({ message: 'Failed to fetch alerts' });\r\n    }\r\n  });\r\n\r\n  // Admin search queries endpoint\r\n  app.get('/api/admin/search-queries', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleSearchQueries = [\r\n        {\r\n          id: 1,\r\n          userId: 'user@example.com',\r\n          query: 'CEO technology companies',\r\n          resultsCount: 45,\r\n          executionTime: 125,\r\n          createdAt: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'demo@example.com',\r\n          query: 'VP Sales healthcare',\r\n          resultsCount: 32,\r\n          executionTime: 98,\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'user@example.com',\r\n          query: 'Director Marketing',\r\n          resultsCount: 67,\r\n          executionTime: 156,\r\n          createdAt: new Date(Date.now() - 5400000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'user@example.com',\r\n          query: 'CEO technology companies',\r\n          resultsCount: 45,\r\n          executionTime: 112,\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          userId: 'demo@example.com',\r\n          query: 'CTO software',\r\n          resultsCount: 28,\r\n          executionTime: 89,\r\n          createdAt: new Date(Date.now() - 9000000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleSearchQueries);\r\n    } catch (error) {\r\n      console.error('Error fetching search queries:', error);\r\n      res.status(500).json({ message: 'Failed to fetch search queries' });\r\n    }\r\n  });\r\n\r\n  // Admin download logs endpoint\r\n  app.get('/api/admin/download-logs', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleDownloadLogs = [\r\n        {\r\n          id: 1,\r\n          userId: 'user@example.com',\r\n          filename: 'campaign_results_q4.csv',\r\n          fileSize: 2048576,\r\n          campaignId: 101,\r\n          exportType: 'CSV',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'demo@example.com',\r\n          filename: 'contact_list_export.csv',\r\n          fileSize: 1536000,\r\n          campaignId: 102,\r\n          exportType: 'CSV',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'user@example.com',\r\n          filename: 'analytics_report.pdf',\r\n          fileSize: 4096000,\r\n          campaignId: 103,\r\n          exportType: 'PDF',\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'admin@example.com',\r\n          filename: 'full_database_export.csv',\r\n          fileSize: 10485760,\r\n          campaignId: 0,\r\n          exportType: 'CSV',\r\n          createdAt: new Date(Date.now() - 14400000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleDownloadLogs);\r\n    } catch (error) {\r\n      console.error('Error fetching download logs:', error);\r\n      res.status(500).json({ message: 'Failed to fetch download logs' });\r\n    }\r\n  });\r\n\r\n  // Admin call logs endpoint\r\n  app.get('/api/admin/call-logs', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleCallLogs = [\r\n        {\r\n          id: 1,\r\n          contactId: 1001,\r\n          userId: 'user@example.com',\r\n          callType: 'outgoing',\r\n          duration: 245,\r\n          status: 'completed',\r\n          notes: 'Discussed product demo',\r\n          createdAt: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          contactId: 1002,\r\n          userId: 'demo@example.com',\r\n          callType: 'incoming',\r\n          duration: 180,\r\n          status: 'completed',\r\n          notes: 'Follow-up on proposal',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          contactId: 1003,\r\n          userId: 'user@example.com',\r\n          callType: 'missed',\r\n          duration: 0,\r\n          status: 'missed',\r\n          notes: 'Callback scheduled',\r\n          createdAt: new Date(Date.now() - 5400000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          contactId: 1004,\r\n          userId: 'user@example.com',\r\n          callType: 'outgoing',\r\n          duration: 320,\r\n          status: 'completed',\r\n          notes: 'Closing call - deal won',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          contactId: 1005,\r\n          userId: 'demo@example.com',\r\n          callType: 'incoming',\r\n          duration: 150,\r\n          status: 'completed',\r\n          notes: 'Support inquiry',\r\n          createdAt: new Date(Date.now() - 9000000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleCallLogs);\r\n    } catch (error) {\r\n      console.error('Error fetching call logs:', error);\r\n      res.status(500).json({ message: 'Failed to fetch call logs' });\r\n    }\r\n  });\r\n\r\n  // Admin email tracking endpoint\r\n  app.get('/api/admin/email-tracking', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleEmailTracking = [\r\n        {\r\n          id: 1,\r\n          contactId: 2001,\r\n          userId: 'user@example.com',\r\n          emailType: 'campaign',\r\n          subject: 'Q4 Product Launch Announcement',\r\n          status: 'clicked',\r\n          openedAt: new Date(Date.now() - 86400000).toISOString(),\r\n          clickedAt: new Date(Date.now() - 85000000).toISOString(),\r\n          createdAt: new Date(Date.now() - 172800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          contactId: 2002,\r\n          userId: 'demo@example.com',\r\n          emailType: 'newsletter',\r\n          subject: 'Weekly Industry Update',\r\n          status: 'opened',\r\n          openedAt: new Date(Date.now() - 3600000).toISOString(),\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          contactId: 2003,\r\n          userId: 'user@example.com',\r\n          emailType: 'follow-up',\r\n          subject: 'Following up on our conversation',\r\n          status: 'delivered',\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          contactId: 2004,\r\n          userId: 'user@example.com',\r\n          emailType: 'campaign',\r\n          subject: 'Special Offer - Limited Time',\r\n          status: 'bounced',\r\n          createdAt: new Date(Date.now() - 14400000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          contactId: 2005,\r\n          userId: 'demo@example.com',\r\n          emailType: 'welcome',\r\n          subject: 'Welcome to Our Platform',\r\n          status: 'clicked',\r\n          openedAt: new Date(Date.now() - 18000000).toISOString(),\r\n          clickedAt: new Date(Date.now() - 17900000).toISOString(),\r\n          createdAt: new Date(Date.now() - 21600000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleEmailTracking);\r\n    } catch (error) {\r\n      console.error('Error fetching email tracking:', error);\r\n      res.status(500).json({ message: 'Failed to fetch email tracking' });\r\n    }\r\n  });\r\n\r\n  // Admin upload history endpoint\r\n  app.get('/api/admin/upload-history', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleUploadHistory = [\r\n        {\r\n          id: 1,\r\n          userId: 'user@example.com',\r\n          filename: 'contacts_batch_1.csv',\r\n          fileSize: 3145728,\r\n          campaignId: 101,\r\n          success: true,\r\n          errorMessage: '',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'demo@example.com',\r\n          filename: 'leads_q4_2024.csv',\r\n          fileSize: 2097152,\r\n          campaignId: 102,\r\n          success: true,\r\n          errorMessage: '',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'user@example.com',\r\n          filename: 'invalid_format.csv',\r\n          fileSize: 1024000,\r\n          campaignId: 103,\r\n          success: false,\r\n          errorMessage: 'Invalid CSV format: missing required columns',\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'admin@example.com',\r\n          filename: 'enterprise_contacts.csv',\r\n          fileSize: 8388608,\r\n          campaignId: 104,\r\n          success: true,\r\n          errorMessage: '',\r\n          createdAt: new Date(Date.now() - 14400000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          userId: 'user@example.com',\r\n          filename: 'prospects_list.csv',\r\n          fileSize: 1536000,\r\n          campaignId: 105,\r\n          success: true,\r\n          errorMessage: '',\r\n          createdAt: new Date(Date.now() - 18000000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleUploadHistory);\r\n    } catch (error) {\r\n      console.error('Error fetching upload history:', error);\r\n      res.status(500).json({ message: 'Failed to fetch upload history' });\r\n    }\r\n  });\r\n\r\n  // Admin database stats endpoint\r\n  app.get('/api/admin/database-stats', requireAdmin, async (req, res) => {\r\n    try {\r\n      const contactsCount = await db.select({ count: sql<number>`count(*)` })\r\n        .from(schema.contacts);\r\n      \r\n      const campaignsCount = await db.select({ count: sql<number>`count(*)` })\r\n        .from(schema.campaigns);\r\n      \r\n      const notesCount = await db.select({ count: sql<number>`count(*)` })\r\n        .from(schema.notes);\r\n\r\n      const sampleDatabaseStats = {\r\n        totalRecords: (contactsCount[0]?.count || 0) + (campaignsCount[0]?.count || 0) + (notesCount[0]?.count || 0),\r\n        tableCount: 12,\r\n        databaseSize: '256 MB',\r\n        activeConnections: 5,\r\n        tables: [\r\n          { name: 'contacts', rowCount: contactsCount[0]?.count || 0 },\r\n          { name: 'campaigns', rowCount: campaignsCount[0]?.count || 0 },\r\n          { name: 'notes', rowCount: notesCount[0]?.count || 0 },\r\n          { name: 'documents', rowCount: 0 },\r\n          { name: 'crm_users', rowCount: 0 }\r\n        ]\r\n      };\r\n\r\n      res.json(sampleDatabaseStats);\r\n    } catch (error) {\r\n      console.error('Error fetching database stats:', error);\r\n      res.status(500).json({ message: 'Failed to fetch database stats' });\r\n    }\r\n  });\r\n\r\n  // Admin performance endpoint\r\n  app.get('/api/admin/performance', requireAdmin, async (req, res) => {\r\n    try {\r\n      const memoryUsage = process.memoryUsage();\r\n      const uptime = process.uptime();\r\n\r\n      const samplePerformance = {\r\n        avgResponseTime: '125ms',\r\n        cpuUsage: '45%',\r\n        memoryUsage: `${Math.round(memoryUsage.heapUsed / 1024 / 1024)} MB`,\r\n        activeRequests: 3,\r\n        uptime: Math.floor(uptime / 60) + ' minutes',\r\n        requestsPerMinute: 120\r\n      };\r\n\r\n      res.json(samplePerformance);\r\n    } catch (error) {\r\n      console.error('Error fetching performance:', error);\r\n      res.status(500).json({ message: 'Failed to fetch performance metrics' });\r\n    }\r\n  });\r\n\r\n  // Admin campaign views endpoint\r\n  app.get('/api/admin/campaign-views', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleCampaignViews = [\r\n        {\r\n          id: 1,\r\n          campaignId: 101,\r\n          userId: 'user@example.com',\r\n          viewDuration: 420,\r\n          contactsViewed: 15,\r\n          actionsPerformed: { exports: 2, calls: 3, emails: 1 },\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          campaignId: 102,\r\n          userId: 'demo@example.com',\r\n          viewDuration: 180,\r\n          contactsViewed: 8,\r\n          actionsPerformed: { exports: 1, calls: 0, emails: 2 },\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          campaignId: 101,\r\n          userId: 'user@example.com',\r\n          viewDuration: 600,\r\n          contactsViewed: 25,\r\n          actionsPerformed: { exports: 3, calls: 5, emails: 4 },\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          campaignId: 103,\r\n          userId: 'admin@example.com',\r\n          viewDuration: 300,\r\n          contactsViewed: 12,\r\n          actionsPerformed: { exports: 1, calls: 2, emails: 1 },\r\n          createdAt: new Date(Date.now() - 14400000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          campaignId: 102,\r\n          userId: 'demo@example.com',\r\n          viewDuration: 240,\r\n          contactsViewed: 10,\r\n          actionsPerformed: { exports: 0, calls: 1, emails: 3 },\r\n          createdAt: new Date(Date.now() - 18000000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleCampaignViews);\r\n    } catch (error) {\r\n      console.error('Error fetching campaign views:', error);\r\n      res.status(500).json({ message: 'Failed to fetch campaign views' });\r\n    }\r\n  });\r\n\r\n  // Admin failed logins endpoint\r\n  app.get('/api/admin/failed-logins', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleFailedLogins = [\r\n        {\r\n          id: 1,\r\n          userId: 'hacker@example.com',\r\n          ipAddress: '10.0.0.50',\r\n          userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',\r\n          failureReason: 'Invalid password',\r\n          createdAt: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'test@example.com',\r\n          ipAddress: '10.0.0.50',\r\n          userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',\r\n          failureReason: 'Invalid password',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'admin@wrong.com',\r\n          ipAddress: '192.168.1.150',\r\n          userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',\r\n          failureReason: 'Account not found',\r\n          createdAt: new Date(Date.now() - 5400000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'unknown@test.com',\r\n          ipAddress: '10.0.0.50',\r\n          userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',\r\n          failureReason: 'Invalid password',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          userId: 'locked@example.com',\r\n          ipAddress: '192.168.1.200',\r\n          userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)',\r\n          failureReason: 'Account locked',\r\n          createdAt: new Date(Date.now() - 9000000).toISOString()\r\n        },\r\n        {\r\n          id: 6,\r\n          userId: 'test@example.com',\r\n          ipAddress: '10.0.0.50',\r\n          userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',\r\n          failureReason: 'Invalid password',\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleFailedLogins);\r\n    } catch (error) {\r\n      console.error('Error fetching failed logins:', error);\r\n      res.status(500).json({ message: 'Failed to fetch failed logins' });\r\n    }\r\n  });\r\n\r\n  // Admin security logs endpoint\r\n  app.get('/api/admin/security-logs', requireAdmin, async (req, res) => {\r\n    try {\r\n      const sampleSecurityLogs = [\r\n        {\r\n          id: 1,\r\n          userId: 'admin@example.com',\r\n          eventType: 'unauthorized_access',\r\n          severity: 'high',\r\n          description: 'Attempted access to restricted admin endpoint',\r\n          ipAddress: '192.168.1.150',\r\n          createdAt: new Date(Date.now() - 1800000).toISOString()\r\n        },\r\n        {\r\n          id: 2,\r\n          userId: 'system',\r\n          eventType: 'rate_limit_exceeded',\r\n          severity: 'medium',\r\n          description: 'API rate limit exceeded by 50%',\r\n          ipAddress: '10.0.0.75',\r\n          createdAt: new Date(Date.now() - 3600000).toISOString()\r\n        },\r\n        {\r\n          id: 3,\r\n          userId: 'user@example.com',\r\n          eventType: 'suspicious_activity',\r\n          severity: 'critical',\r\n          description: 'Multiple failed login attempts followed by successful login',\r\n          ipAddress: '10.0.0.50',\r\n          createdAt: new Date(Date.now() - 5400000).toISOString()\r\n        },\r\n        {\r\n          id: 4,\r\n          userId: 'system',\r\n          eventType: 'firewall_block',\r\n          severity: 'high',\r\n          description: 'Blocked suspicious IP attempting SQL injection',\r\n          ipAddress: '203.0.113.0',\r\n          createdAt: new Date(Date.now() - 7200000).toISOString()\r\n        },\r\n        {\r\n          id: 5,\r\n          userId: 'test@example.com',\r\n          eventType: 'permission_violation',\r\n          severity: 'medium',\r\n          description: 'Attempted to access unauthorized resource',\r\n          ipAddress: '192.168.1.101',\r\n          createdAt: new Date(Date.now() - 9000000).toISOString()\r\n        },\r\n        {\r\n          id: 6,\r\n          userId: 'system',\r\n          eventType: 'ddos_attempt',\r\n          severity: 'critical',\r\n          description: 'Detected distributed denial of service attack pattern',\r\n          ipAddress: '198.51.100.0',\r\n          createdAt: new Date(Date.now() - 10800000).toISOString()\r\n        },\r\n        {\r\n          id: 7,\r\n          userId: 'admin@example.com',\r\n          eventType: 'admin_action',\r\n          severity: 'low',\r\n          description: 'Admin performed bulk user deletion',\r\n          ipAddress: '192.168.1.100',\r\n          createdAt: new Date(Date.now() - 14400000).toISOString()\r\n        }\r\n      ];\r\n\r\n      res.json(sampleSecurityLogs);\r\n    } catch (error) {\r\n      console.error('Error fetching security logs:', error);\r\n      res.status(500).json({ message: 'Failed to fetch security logs' });\r\n    }\r\n  });\r\n\r\n  // Admin-User Chat API Routes\r\n  \r\n  // Get all CRM users with conversation info\r\n  app.get('/api/admin/users', requireAdmin, async (req, res) => {\r\n    try {\r\n      const users = await db.select({\n        id: schema.crmUsers.id,\n        username: schema.crmUsers.name,\n        createdAt: schema.crmUsers.createdAt,\n      }).from(schema.crmUsers);\n\r\n      // Get conversation info for each user\r\n      const usersWithConversations = await Promise.all(\r\n        users.map(async (user) => {\r\n          const conversation = await db.select({\r\n            id: schema.adminUserConversations.id,\r\n            adminUnreadCount: schema.adminUserConversations.adminUnreadCount,\r\n          })\r\n          .from(schema.adminUserConversations)\r\n          .where(eq(schema.adminUserConversations.userId, user.id))\r\n          .limit(1);\r\n\r\n          return {\r\n            ...user,\r\n            conversationId: conversation[0]?.id || null,\r\n            unreadCount: conversation[0]?.adminUnreadCount || 0,\r\n          };\r\n        })\r\n      );\r\n\r\n      res.json(usersWithConversations);\r\n    } catch (error) {\r\n      console.error('Error fetching users:', error);\r\n      res.status(500).json({ message: 'Failed to fetch users' });\r\n    }\r\n  });\r\n\r\n  // Get or create conversation for a specific user\r\n  app.get('/api/admin/conversations/:userId', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { userId } = req.params;\r\n\r\n      // Check if conversation exists\r\n      let conversation = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, userId))\r\n        .limit(1);\r\n\r\n      // Create conversation if it doesn't exist\r\n      if (conversation.length === 0) {\r\n        const user = await db.select()\r\n          .from(schema.crmUsers)\r\n          .where(eq(schema.crmUsers.id, userId))\r\n          .limit(1);\r\n\r\n        if (user.length === 0) {\r\n          return res.status(404).json({ message: 'User not found' });\r\n        }\r\n\r\n        conversation = await db.insert(schema.adminUserConversations)\n          .values({\n            userId,\n            title: `Chat with ${user[0].name || userId}`,\n            isActive: true,\n          })\n          .returning();\n      }\r\n\r\n      res.json(conversation[0]);\r\n    } catch (error) {\r\n      console.error('Error getting conversation:', error);\r\n      res.status(500).json({ message: 'Failed to get conversation' });\r\n    }\r\n  });\r\n\r\n  // Get messages in a conversation\r\n  app.get('/api/admin/conversations/:conversationId/messages', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n\r\n      const messages = await db.select()\r\n        .from(schema.adminUserMessages)\r\n        .where(eq(schema.adminUserMessages.conversationId, conversationId))\r\n        .orderBy(schema.adminUserMessages.createdAt);\r\n\r\n      res.json(messages);\r\n    } catch (error) {\r\n      console.error('Error fetching messages:', error);\r\n      res.status(500).json({ message: 'Failed to fetch messages' });\r\n    }\r\n  });\r\n\r\n  // Send a message in a conversation\r\n  app.post('/api/admin/conversations/:conversationId/messages', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n      const { content, messageType = 'text', attachmentUrl, attachmentName, attachmentSize } = req.body;\r\n\r\n      if (!content) {\r\n        return res.status(400).json({ message: 'Message content is required' });\r\n      }\r\n\r\n      // Create message\r\n      const message = await db.insert(schema.adminUserMessages)\n        .values({\n          conversationId,\n          senderType: 'admin',\n          senderId: String(req.session.userId || 'admin'),\n          messageType,\n          content,\n          attachmentUrl,\n          attachmentName,\r\n          attachmentSize,\r\n          isRead: false,\r\n        })\r\n        .returning();\r\n\r\n      // Update conversation's last message timestamp and user unread count\r\n      await db.update(schema.adminUserConversations)\r\n        .set({\r\n          lastMessageAt: new Date(),\r\n          unreadCount: sql`${schema.adminUserConversations.unreadCount} + 1`,\r\n          updatedAt: new Date(),\r\n        })\r\n        .where(eq(schema.adminUserConversations.id, conversationId));\r\n\r\n      res.json(message[0]);\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n      res.status(500).json({ message: 'Failed to send message' });\r\n    }\r\n  });\r\n\r\n  // Mark messages as read (for admin)\r\n  app.patch('/api/admin/conversations/:conversationId/mark-read', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n\r\n      // Mark all user messages as read\r\n      await db.update(schema.adminUserMessages)\r\n        .set({\r\n          isRead: true,\r\n          readAt: new Date(),\r\n        })\r\n        .where(\r\n          and(\r\n            eq(schema.adminUserMessages.conversationId, conversationId),\r\n            eq(schema.adminUserMessages.senderType, 'user'),\r\n            eq(schema.adminUserMessages.isRead, false)\r\n          )\r\n        );\r\n\r\n      // Reset admin unread count\r\n      await db.update(schema.adminUserConversations)\r\n        .set({\r\n          adminUnreadCount: 0,\r\n          updatedAt: new Date(),\r\n        })\r\n        .where(eq(schema.adminUserConversations.id, conversationId));\r\n\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error marking messages as read:', error);\r\n      res.status(500).json({ message: 'Failed to mark messages as read' });\r\n    }\r\n  });\r\n\r\n  // CSV preview endpoint for field mapping\r\n  app.post('/api/campaigns/preview', upload.single('csv'), async (req, res) => {\r\n    try {\r\n      const file = req.file as Express.Multer.File;\r\n      if (!file) {\r\n        return res.status(400).json({ message: 'No CSV file uploaded' });\r\n      }\r\n\r\n      // Read and parse CSV headers only\r\n      const csvContent = fs.readFileSync(file.path, 'utf-8');\r\n      const lines = csvContent.split('\\n').filter(line => line.trim());\r\n      \r\n      if (lines.length === 0) {\r\n        return res.status(400).json({ message: 'CSV file is empty' });\r\n      }\r\n\r\n      // Parse headers\r\n      const headers = parseCSVLine(lines[0]);\r\n      \r\n      // Clean up uploaded file\r\n      fs.unlinkSync(file.path);\r\n\r\n      res.json({ \r\n        headers,\r\n        fileName: file.originalname\r\n      });\r\n    } catch (error) {\r\n      console.error('CSV preview error:', error);\r\n      res.status(500).json({ message: 'Failed to preview CSV file' });\r\n    }\r\n  });\r\n\r\n  // Campaign CSV upload\r\n  app.post('/api/campaigns/upload', upload.single('csv'), async (req, res) => {\r\n    try {\r\n      console.log('CSV upload request received');\r\n      console.log('Request body:', req.body);\r\n      console.log('Request file:', req.file);\r\n      \r\n      const file = req.file as Express.Multer.File;\r\n      if (!file) {\r\n        return res.status(400).json({ message: 'No CSV file uploaded' });\r\n      }\r\n\r\n      // Get field mappings from request\r\n      const fieldMappingsJson = req.body.fieldMappings;\r\n      if (!fieldMappingsJson) {\r\n        return res.status(400).json({ message: 'Field mappings are required' });\r\n      }\r\n\r\n      const fieldMappings: Record<string, string> = JSON.parse(fieldMappingsJson);\r\n\r\n      // Read and parse CSV\r\n      const csvContent = fs.readFileSync(file.path, 'utf-8');\r\n      const lines = csvContent.split('\\n').filter(line => line.trim());\r\n      \r\n      if (lines.length === 0) {\r\n        return res.status(400).json({ message: 'CSV file is empty' });\r\n      }\r\n\r\n      // Parse headers\r\n      const headers = parseCSVLine(lines[0]);\r\n\r\n      // Parse data rows and add timezone\r\n      const dataRows = [];\r\n      for (let i = 1; i < lines.length; i++) {\r\n        const values = parseCSVLine(lines[i]);\r\n        const row: Record<string, string> = {};\r\n        \r\n        // Map original headers to values\r\n        headers.forEach((header, index) => {\r\n          row[header] = values[index] || '';\r\n        });\r\n\r\n        // Create mapped row with standard field names\r\n        const mappedRow: Record<string, string> = {};\r\n        Object.entries(fieldMappings).forEach(([standardField, csvHeader]) => {\r\n          mappedRow[standardField] = row[csvHeader] || '';\r\n        });\r\n\r\n        // Derive timezone based on mapped State and Country fields\r\n        const state = mappedRow['State'] || '';\r\n        const country = mappedRow['Country'] || '';\r\n        mappedRow['Time Zone'] = deriveTimezone(state, country);\r\n\r\n        dataRows.push(mappedRow);\r\n      }\r\n\r\n      // Create final headers array with mapped fields plus timezone\r\n      const finalHeaders = [...Object.keys(fieldMappings), 'Time Zone'];\r\n\r\n      // Encrypt the campaign data\r\n      const campaignData = {\r\n        headers: finalHeaders,\r\n        rows: dataRows,\r\n        fieldMappings: { ...fieldMappings, 'Time Zone': 'Time Zone' }\r\n      };\r\n\r\n      const encryptedData = encrypt(JSON.stringify(campaignData));\r\n\r\n      // Save to database\r\n      const campaign = await storage.createCampaign({\r\n        name: file.originalname.replace('.csv', ''),\r\n        encryptedData,\r\n        fieldMappings: campaignData.fieldMappings,\r\n        recordCount: dataRows.length\r\n      });\r\n\r\n      // Log campaign upload activity\r\n      await logActivity({\r\n        req,\r\n        activityType: 'upload',\r\n        action: 'Campaign uploaded',\r\n        resourceType: 'campaign',\r\n        resourceId: campaign.id.toString(),\r\n        details: {\r\n          campaignName: campaign.name,\r\n          fileName: file.originalname,\r\n          recordCount: dataRows.length,\r\n          fileSize: file.size,\r\n          fieldCount: finalHeaders.length\r\n        }\r\n      });\r\n\r\n      // Clean up uploaded file\r\n      fs.unlinkSync(file.path);\r\n\r\n      res.json({ \r\n        campaign: {\r\n          id: campaign.id,\r\n          name: campaign.name,\r\n          recordCount: campaign.recordCount,\r\n          fieldMappings: campaign.fieldMappings\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('Campaign upload error:', error);\r\n      await logActivity({\r\n        req,\r\n        activityType: 'upload',\r\n        action: 'Campaign upload failed',\r\n        resourceType: 'campaign',\r\n        details: { error: error instanceof Error ? error.message : 'Unknown error' }\r\n      });\r\n      res.status(500).json({ message: 'Failed to process campaign upload' });\r\n    }\r\n  });\r\n\r\n  // Get campaigns\r\n  app.get('/api/campaigns', async (req, res) => {\r\n    try {\r\n      const campaigns = await storage.getCampaigns();\r\n      res.json(campaigns.map(c => ({\r\n        id: c.id,\r\n        name: c.name,\r\n        recordCount: c.recordCount,\r\n        fieldMappings: c.fieldMappings,\r\n        createdAt: c.createdAt\r\n      })));\r\n    } catch (error) {\r\n      console.error('Get campaigns error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch campaigns' });\r\n    }\r\n  });\r\n\r\n  // Download all contacts from all campaigns combined\r\n  app.get('/api/campaigns/download-all', async (req, res) => {\r\n    try {\r\n      const campaigns = await storage.getCampaigns();\r\n      \r\n      if (campaigns.length === 0) {\r\n        return res.status(404).json({ message: 'No campaigns found' });\r\n      }\r\n\r\n      // Collect all unique headers across all campaigns\r\n      const allHeadersSet = new Set<string>();\r\n      const allCampaignData: Array<{ campaignId: number; campaignName: string; rows: any[] }> = [];\r\n\r\n      // Fetch and decrypt data from all campaigns\r\n      for (const campaign of campaigns) {\r\n        try {\r\n          const campaignData = await storage.getCampaignData(campaign.id);\r\n          \r\n          if (campaignData && campaignData.rows && Array.isArray(campaignData.rows)) {\r\n            // Add headers from this campaign to the set\r\n            const headers = campaignData.headers || Object.keys(campaignData.rows[0] || {});\r\n            headers.forEach((header: string) => allHeadersSet.add(header));\r\n            \r\n            allCampaignData.push({\r\n              campaignId: campaign.id,\r\n              campaignName: campaign.name,\r\n              rows: campaignData.rows\r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.error(`Error fetching campaign ${campaign.id}:`, error);\r\n          // Continue with other campaigns even if one fails\r\n        }\r\n      }\r\n\r\n      if (allCampaignData.length === 0 || allCampaignData.every(c => c.rows.length === 0)) {\r\n        return res.status(404).json({ message: 'No contact data found in any campaign' });\r\n      }\r\n\r\n      // Create unified headers array with Campaign Name and Campaign ID at the beginning\r\n      const allHeaders = ['Campaign Name', 'Campaign ID', ...Array.from(allHeadersSet)];\r\n      \r\n      // Combine all rows with normalized structure\r\n      const combinedRows: any[][] = [];\r\n      \r\n      for (const campaign of allCampaignData) {\r\n        for (const row of campaign.rows) {\r\n          const normalizedRow = allHeaders.map(header => {\r\n            if (header === 'Campaign Name') return campaign.campaignName;\r\n            if (header === 'Campaign ID') return campaign.campaignId.toString();\r\n            return row[header] || '';\r\n          });\r\n          combinedRows.push(normalizedRow);\r\n        }\r\n      }\r\n\r\n      // Generate CSV\r\n      const { stringify } = await import('csv-stringify');\r\n      \r\n      const csvData = await new Promise<string>((resolve, reject) => {\r\n        const csvRows = [allHeaders, ...combinedRows];\r\n        stringify(csvRows, (err, output) => {\r\n          if (err) reject(err);\r\n          else resolve(output);\r\n        });\r\n      });\r\n\r\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n      const filename = `all_campaigns_contacts_${timestamp}.csv`;\r\n\r\n      // Log the export activity\r\n      await logActivity({\r\n        req,\r\n        activityType: 'export',\r\n        action: 'Download all campaigns contacts',\r\n        resourceType: 'campaigns',\r\n        details: {\r\n          campaignCount: allCampaignData.length,\r\n          totalRecords: combinedRows.length,\r\n          filename\r\n        }\r\n      });\r\n\r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\r\n      res.send(csvData);\r\n\r\n    } catch (error) {\r\n      console.error('Download all campaigns error:', error);\r\n      res.status(500).json({ message: 'Failed to download all campaign contacts' });\r\n    }\r\n  });\r\n\r\n  // Get campaign data (decrypted)\r\n  app.get('/api/campaigns/:id', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const campaign = await storage.getCampaign(id);\r\n      \r\n      if (!campaign) {\r\n        return res.status(404).json({ message: 'Campaign not found' });\r\n      }\r\n\r\n      let decryptedData = null;\r\n      try {\r\n        // Try to decrypt campaign data\r\n        console.log(`\\n=== ROUTE DEBUG - Campaign ${id} ===`);\r\n        console.log(`Encrypted data length: ${campaign.encryptedData?.length || 'NULL'}`);\r\n        console.log(`Encrypted data preview: ${campaign.encryptedData?.substring(0, 100) || 'NULL'}...`);\r\n        console.log(`=====================================\\n`);\r\n        \r\n        decryptedData = JSON.parse(decrypt(campaign.encryptedData));\r\n      } catch (decryptError: any) {\r\n        console.error(`Failed to decrypt campaign ${id}:`, decryptError.message);\r\n        \r\n        // Log decryption error\r\n        await logActivity({\r\n          req,\r\n          activityType: 'view',\r\n          action: 'Campaign view failed - decryption error',\r\n          resourceType: 'campaign',\r\n          resourceId: id.toString(),\r\n          details: { campaignName: campaign.name, error: 'Decryption failed' }\r\n        });\r\n        \r\n        // Return campaign info without data but indicate encryption issue\r\n        return res.json({\r\n          id: campaign.id,\r\n          name: campaign.name,\r\n          data: null,\r\n          error: 'Unable to decrypt campaign data. This may be due to encryption key changes.',\r\n          createdAt: campaign.createdAt,\r\n          recordCount: campaign.recordCount,\r\n          encryptionError: true\r\n        });\r\n      }\r\n      \r\n      // Log successful campaign view\r\n      await logActivity({\r\n        req,\r\n        activityType: 'view',\r\n        action: 'Campaign viewed',\r\n        resourceType: 'campaign',\r\n        resourceId: id.toString(),\r\n        details: {\r\n          campaignName: campaign.name,\r\n          recordCount: campaign.recordCount\r\n        }\r\n      });\r\n      \r\n      res.json({\r\n        id: campaign.id,\r\n        name: campaign.name,\r\n        data: decryptedData,\r\n        createdAt: campaign.createdAt,\r\n        recordCount: campaign.recordCount\r\n      });\r\n    } catch (error) {\r\n      console.error('Get campaign error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch campaign data' });\r\n    }\r\n  });\r\n\r\n  // Update campaign name\r\n  app.patch('/api/campaigns/:id', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const { name } = req.body;\r\n      \r\n      if (!name || !name.trim()) {\r\n        return res.status(400).json({ message: 'Campaign name is required' });\r\n      }\r\n      \r\n      const campaign = await storage.getCampaign(id);\r\n      \r\n      if (!campaign) {\r\n        return res.status(404).json({ message: 'Campaign not found' });\r\n      }\r\n\r\n      const oldName = campaign.name;\r\n      await storage.updateCampaign(id, { name: name.trim() });\r\n      \r\n      // Log campaign update\r\n      await logActivity({\r\n        req,\r\n        activityType: 'update',\r\n        action: 'Campaign renamed',\r\n        resourceType: 'campaign',\r\n        resourceId: id.toString(),\r\n        details: {\r\n          oldName,\r\n          newName: name.trim()\r\n        }\r\n      });\r\n      \r\n      res.json({ message: 'Campaign updated successfully' });\r\n    } catch (error) {\r\n      console.error('Update campaign error:', error);\r\n      res.status(500).json({ message: 'Failed to update campaign' });\r\n    }\r\n  });\r\n\r\n  // Delete campaign\r\n  app.delete('/api/campaigns/:id', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const campaign = await storage.getCampaign(id);\r\n      \r\n      if (!campaign) {\r\n        return res.status(404).json({ message: 'Campaign not found' });\r\n      }\r\n\r\n      // Log campaign deletion\r\n      await logActivity({\r\n        req,\r\n        activityType: 'delete',\r\n        action: 'Campaign deleted',\r\n        resourceType: 'campaign',\r\n        resourceId: id.toString(),\r\n        details: {\r\n          campaignName: campaign.name,\r\n          recordCount: campaign.recordCount\r\n        }\r\n      });\r\n\r\n      await storage.deleteCampaign(id);\r\n      \r\n      res.json({ message: 'Campaign deleted successfully' });\r\n    } catch (error) {\r\n      console.error('Delete campaign error:', error);\r\n      res.status(500).json({ message: 'Failed to delete campaign' });\r\n    }\r\n  });\r\n\r\n  // Create note\r\n  app.post('/api/notes', async (req, res) => {\r\n    try {\r\n      const { content } = req.body;\r\n      \r\n      if (!content) {\r\n        return res.status(400).json({ message: 'Note content is required' });\r\n      }\r\n\r\n      // Validate content - reject if it contains campaign data structure\r\n      if (typeof content === 'string' && (content.includes('{\"headers\"') || content.includes('\"fieldMappings\"') || content.includes('\"rows\"'))) {\r\n        console.warn('Rejected note creation with invalid campaign data:', content);\r\n        return res.status(400).json({ message: 'Invalid note content detected' });\r\n      }\r\n\r\n      // Additional validation for objects that might be sent instead of strings\r\n      if (typeof content === 'object' && content !== null) {\r\n        console.warn('Rejected note creation with object content:', content);\r\n        return res.status(400).json({ message: 'Note content must be a string' });\r\n      }\r\n\r\n      const encryptedContent = encrypt(content);\r\n      \r\n      const note = await storage.createNote({\r\n        content: content.substring(0, 100) + '...', // Store preview\r\n        encryptedContent\r\n      });\r\n\r\n      const noteData = {\r\n        id: note.id,\r\n        content: decryptNote(note.encryptedContent),\r\n        createdAt: note.createdAt\r\n      };\r\n\r\n      // Broadcast the new note to all connected WebSocket clients\r\n      broadcastNotesUpdate('created', noteData);\r\n\r\n      res.json(noteData);\r\n    } catch (error) {\r\n      console.error('Create note error:', error);\r\n      res.status(500).json({ message: 'Failed to create note' });\r\n    }\r\n  });\r\n\r\n  // Get notes\r\n  app.get('/api/notes', async (req, res) => {\r\n    try {\r\n      const notes = await storage.getNotes();\r\n      res.json(notes.map(note => {\r\n        let decryptedContent;\r\n        try {\r\n          // Try to decrypt the encrypted content using note-specific decryption\r\n          decryptedContent = decryptNote(note.encryptedContent);\r\n        } catch (error) {\r\n          console.warn(`Failed to decrypt note ${note.id}:`, error);\r\n          return null; // Skip corrupted notes\r\n        }\r\n        \r\n        return {\r\n          id: note.id,\r\n          content: decryptedContent,\r\n          createdAt: note.createdAt\r\n        };\r\n      }).filter(note => note !== null));\r\n    } catch (error) {\r\n      console.error('Get notes error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch notes' });\r\n    }\r\n  });\r\n\r\n  // Delete note\r\n  app.delete('/api/notes/:id', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const note = await storage.getNote(id);\r\n      \r\n      if (!note) {\r\n        return res.status(404).json({ message: 'Note not found' });\r\n      }\r\n\r\n      await storage.deleteNote(id);\r\n      \r\n      // Broadcast the deletion to all connected WebSocket clients\r\n      broadcastNotesUpdate('deleted', { id });\r\n      \r\n      res.json({ message: 'Note deleted successfully' });\r\n    } catch (error) {\r\n      console.error('Delete note error:', error);\r\n      res.status(500).json({ message: 'Failed to delete note' });\r\n    }\r\n  });\r\n\r\n  // Upload documents\r\n  app.post('/api/documents/upload', upload.single('document'), async (req, res) => {\r\n    try {\r\n      const file = req.file as Express.Multer.File;\r\n      if (!file) {\r\n        return res.status(400).json({ message: 'No document uploaded' });\r\n      }\r\n\r\n      // Upload file using storage service (supports both local and S3)\r\n      const storedFile = await fileStorage.uploadFile(file);\r\n      \r\n      // Encrypt the storage key/path\r\n      const encryptedPath = encrypt(storedFile.key);\r\n      \r\n      const document = await storage.createDocument({\r\n        filename: storedFile.key,\r\n        originalName: file.originalname,\r\n        mimeType: file.mimetype,\r\n        fileSize: file.size,\r\n        encryptedPath\r\n      });\r\n\r\n      res.json({\r\n        id: document.id,\r\n        name: document.originalName,\r\n        type: document.mimeType,\r\n        size: document.fileSize,\r\n        createdAt: document.createdAt\r\n      });\r\n    } catch (error) {\r\n      console.error('Document upload error:', error);\r\n      res.status(500).json({ message: 'Failed to upload document' });\r\n    }\r\n  });\r\n\r\n  // Get documents\r\n  app.get('/api/documents', async (req, res) => {\r\n    try {\r\n      const documents = await storage.getDocuments();\r\n      res.json(documents.map(doc => ({\r\n        id: doc.id,\r\n        name: doc.originalName,\r\n        type: doc.mimeType,\r\n        size: doc.fileSize,\r\n        createdAt: doc.createdAt\r\n      })));\r\n    } catch (error) {\r\n      console.error('Get documents error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch documents' });\r\n    }\r\n  });\r\n\r\n  // Download document\r\n  app.get('/api/documents/:id/download', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const document = await storage.getDocument(id);\r\n      \r\n      if (!document) {\r\n        return res.status(404).json({ message: 'Document not found' });\r\n      }\r\n\r\n      // Debug document info\r\n      console.log(`=== DOCUMENT DOWNLOAD DEBUG - Document ${id} ===`);\r\n      console.log('Document filename:', document.filename);\r\n      console.log('Document original name:', document.originalName);\r\n      console.log('Encrypted path:', document.encryptedPath);\r\n      \r\n      // Decrypt file key/path\r\n      let fileKey: string;\r\n      try {\r\n        fileKey = decryptFilePath(document.encryptedPath);\r\n        console.log('Decrypted file key:', fileKey);\r\n      } catch (decryptError) {\r\n        console.error('File key decryption failed:', decryptError);\r\n        fileKey = document.filename;\r\n        console.log('Using fallback filename:', fileKey);\r\n      }\r\n      \r\n      // Check if file exists in storage\r\n      const exists = await fileStorage.fileExists(fileKey);\r\n      if (!exists) {\r\n        console.error('File does not exist in storage:', fileKey);\r\n        return res.status(404).json({ \r\n          message: 'Document file not found',\r\n          details: 'The file could not be found in the storage system'\r\n        });\r\n      }\r\n      \r\n      // Get file from storage (works with both local and S3)\r\n      const { stream, filename } = await fileStorage.getFile(fileKey);\r\n      \r\n      console.log('Streaming file:', filename);\r\n      console.log('Storage type:', fileStorage.getStorageType());\r\n      console.log('==================================================')\r\n\r\n      // Set headers and pipe the stream\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"${document.originalName}\"`);\r\n      res.setHeader('Content-Type', document.mimeType);\r\n      stream.pipe(res);\r\n    } catch (error) {\r\n      console.error('Document download error:', error);\r\n      res.status(500).json({ message: 'Failed to download document' });\r\n    }\r\n  });\r\n\r\n  // User-Side Chat API Routes (Campaign Community)\r\n  \r\n  // File upload for Campaign Community\r\n  app.post('/api/user/messages/upload', upload.single('file'), async (req, res) => {\r\n    try {\r\n      let userId = req.session.userId;\r\n      if (!userId && req.session.authenticated) {\r\n        userId = req.session.userRole === 'admin' ? 'admin' : 'dashboard-user';\r\n        req.session.userId = userId;\r\n        await new Promise<void>(resolve => req.session.save(() => resolve()));\r\n      }\r\n      \r\n      if (!userId || !req.file) {\r\n        return res.status(401).json({ message: 'Unauthorized or no file' });\r\n      }\r\n\r\n      // Get or create user's conversation\r\n      let conversation = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, String(userId)))\r\n        .limit(1);\r\n\r\n      if (conversation.length === 0) {\r\n        conversation = await db.insert(schema.adminUserConversations)\r\n          .values({\r\n            userId: String(userId),\r\n            title: 'Campaign Community Chat',\r\n            isActive: true,\r\n          })\r\n          .returning();\r\n      }\r\n\r\n      const fileKey = `chat/${conversation[0].id}/${Date.now()}-${req.file.originalname}`;\r\n      const encryptedPath = encrypt(fileKey);\r\n\r\n      // Store in file storage\r\n      await fileStorage.storeFile(fileKey, fs.createReadStream(req.file.path), req.file.mimetype);\r\n\r\n      // Create message with attachment\r\n      const message = await db.insert(schema.adminUserMessages)\r\n        .values({\r\n          conversationId: conversation[0].id,\r\n          senderType: 'user',\r\n          senderId: String(userId),\r\n          messageType: 'file',\r\n          content: `Sent a file: ${req.file.originalname}`,\r\n          attachmentUrl: `/api/user/messages/file/${Buffer.from(fileKey).toString('base64')}`,\r\n          attachmentName: req.file.originalname,\r\n          attachmentSize: req.file.size,\r\n          isRead: false,\r\n        })\r\n        .returning();\r\n\r\n      // Cleanup local temp file\r\n      fs.unlinkSync(req.file.path);\r\n\r\n      res.json(message[0]);\r\n    } catch (error) {\r\n      console.error('File upload error:', error);\r\n      res.status(500).json({ message: 'Failed to upload file' });\r\n    }\r\n  });\r\n\r\n  // Download chat file\r\n  app.get('/api/user/messages/file/:fileKeyBase64', async (req, res) => {\r\n    try {\r\n      const fileKey = Buffer.from(req.params.fileKeyBase64, 'base64').toString();\r\n      const { stream, filename } = await fileStorage.getFile(fileKey);\r\n      \r\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename.split('/').pop()}\"`);\r\n      stream.pipe(res);\r\n    } catch (error) {\r\n      console.error('File download error:', error);\r\n      res.status(404).json({ message: 'File not found' });\r\n    }\r\n  });\r\n\r\n  // Get user's own conversation with admin\r\n  app.get('/api/user/conversation', async (req, res) => {\r\n    try {\r\n      // Robust userId detection\r\n      let userId = req.session.userId;\r\n      \r\n      if (!userId && req.session.authenticated) {\r\n        userId = req.session.userRole === 'admin' ? 'admin' : 'dashboard-user';\r\n        req.session.userId = userId;\r\n        await new Promise<void>(resolve => req.session.save(() => resolve()));\r\n      }\r\n      \r\n      if (!userId) {\r\n        console.log('Conversation fetch failed: Not authenticated', { \r\n          sessionID: req.sessionID,\r\n          authenticated: req.session.authenticated,\r\n          userRole: req.session.userRole \r\n        });\r\n        return res.status(401).json({ message: 'Not authenticated' });\r\n      }\r\n\r\n      // Check if conversation exists - allow lookup by userId regardless of type\r\n      let conversation = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, String(userId)))\r\n        .limit(1);\r\n\r\n      // Create conversation if it doesn't exist\r\n      if (conversation.length === 0) {\r\n        conversation = await db.insert(schema.adminUserConversations)\r\n          .values({\r\n            userId: String(userId),\r\n            title: 'Campaign Community Chat',\r\n            isActive: true,\r\n          })\r\n          .returning();\r\n      }\r\n\r\n      res.json(conversation[0]);\r\n    } catch (error) {\r\n      console.error('Error getting user conversation:', error);\r\n      res.status(500).json({ message: 'Failed to get conversation' });\r\n    }\r\n  });\r\n\r\n  // Get messages in user's conversation\r\n  app.get('/api/user/messages', async (req, res) => {\r\n    try {\r\n      let userId = req.session.userId;\r\n      \r\n      if (!userId && req.session.authenticated) {\r\n        userId = req.session.userRole === 'admin' ? 'admin' : 'dashboard-user';\r\n        req.session.userId = userId;\r\n        await new Promise<void>(resolve => req.session.save(() => resolve()));\r\n      }\r\n      \r\n      if (!userId) {\r\n        return res.status(401).json({ message: 'Not authenticated' });\r\n      }\r\n\r\n      // Get user's conversation\r\n      const conversation = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, String(userId)))\r\n        .limit(1);\r\n\r\n      if (conversation.length === 0) {\r\n        return res.json([]);\r\n      }\r\n\r\n      // Get messages\r\n      const messages = await db.select()\r\n        .from(schema.adminUserMessages)\r\n        .where(eq(schema.adminUserMessages.conversationId, conversation[0].id))\r\n        .orderBy(schema.adminUserMessages.createdAt);\r\n\r\n      res.json(messages);\r\n    } catch (error) {\r\n      console.error('Error fetching user messages:', error);\r\n      res.status(500).json({ message: 'Failed to fetch messages' });\r\n    }\r\n  });\r\n\r\n  // Send a message from user\r\n  app.post('/api/user/messages', async (req, res) => {\r\n    try {\r\n      let userId = req.session.userId;\r\n      \r\n      if (!userId && req.session.authenticated) {\r\n        userId = req.session.userRole === 'admin' ? 'admin' : 'dashboard-user';\r\n        req.session.userId = userId;\r\n        await new Promise<void>(resolve => req.session.save(() => resolve()));\r\n      }\r\n      \r\n      if (!userId) {\r\n        return res.status(401).json({ message: 'Not authenticated' });\r\n      }\r\n\r\n      const { content } = req.body;\r\n\r\n      if (!content) {\r\n        return res.status(400).json({ message: 'Message content is required' });\r\n      }\r\n\r\n      // Get or create user's conversation\r\n      let conversation = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, String(userId)))\r\n        .limit(1);\r\n\r\n      if (conversation.length === 0) {\r\n        conversation = await db.insert(schema.adminUserConversations)\r\n          .values({\r\n            userId: String(userId),\r\n            title: 'Campaign Community Chat',\r\n            isActive: true,\r\n          })\r\n          .returning();\r\n      }\r\n\r\n      // Create message\r\n      const message = await db.insert(schema.adminUserMessages)\r\n        .values({\r\n          conversationId: conversation[0].id,\r\n          senderType: 'user',\r\n          senderId: String(userId),\r\n          messageType: 'text',\r\n          content,\r\n          isRead: false,\r\n        })\r\n        .returning();\r\n\r\n      // Update conversation's last message timestamp and admin unread count\r\n      await db.update(schema.adminUserConversations)\r\n        .set({\r\n          lastMessageAt: new Date(),\r\n          adminUnreadCount: sql`${schema.adminUserConversations.adminUnreadCount} + 1`,\r\n          updatedAt: new Date(),\r\n        })\r\n        .where(eq(schema.adminUserConversations.id, conversation[0].id));\r\n\r\n      res.json(message[0]);\r\n    } catch (error) {\r\n      console.error('Error sending user message:', error);\r\n      res.status(500).json({ message: 'Failed to send message' });\r\n    }\r\n  });\r\n\r\n      // Mark admin messages as read (for user)\r\n  app.patch('/api/user/messages/mark-read', async (req, res) => {\r\n    try {\r\n      const userId = req.session.userId;\r\n      if (!userId) {\r\n        return res.status(401).json({ message: 'Not authenticated' });\r\n      }\r\n\r\n      // Get user's conversation\r\n      const conversation = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, String(userId)))\r\n        .limit(1);\r\n\r\n      if (conversation.length === 0) {\r\n        return res.json({ success: true });\r\n      }\r\n\r\n      // Mark all admin messages as read\r\n      await db.update(schema.adminUserMessages)\r\n        .set({\r\n          isRead: true,\r\n          readAt: new Date(),\r\n        })\r\n        .where(\r\n          and(\r\n            eq(schema.adminUserMessages.conversationId, conversation[0].id),\r\n            eq(schema.adminUserMessages.senderType, 'admin'),\r\n            eq(schema.adminUserMessages.isRead, false)\r\n          )\r\n        );\r\n\r\n      // Reset user unread count\r\n      await db.update(schema.adminUserConversations)\r\n        .set({\r\n          unreadCount: 0,\r\n          updatedAt: new Date(),\r\n        })\r\n        .where(eq(schema.adminUserConversations.id, conversation[0].id));\r\n\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error marking messages as read:', error);\r\n      res.status(500).json({ message: 'Failed to mark messages as read' });\r\n    }\r\n  });\r\n\r\n  // Admin Chat API Routes\r\n  \r\n  // Get all user conversations\r\n  app.get('/api/admin/conversations', requireAdmin, async (req, res) => {\r\n    try {\r\n      const conversations = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .orderBy(sql`${schema.adminUserConversations.lastMessageAt} DESC`);\r\n      res.json(conversations);\r\n    } catch (error) {\r\n      console.error('Error fetching conversations:', error);\r\n      res.status(500).json({ message: 'Failed to fetch conversations' });\r\n    }\r\n  });\r\n\r\n  // Get all users for admin management\r\n  app.get('/api/admin/users', requireAdmin, async (req, res) => {\r\n    try {\r\n      // Find all users who have an active session or are in crmUsers\r\n      const allUsers = await db.select().from(schema.crmUsers);\r\n      \r\n      // Also check active sessions to find \"dashboard-user\" or other ephemeral users\r\n      const sessions = await db.select().from(schema.crmSessions);\r\n      const sessionUsers = sessions.map(s => {\r\n        try {\r\n          const sessData = s.sess as any;\r\n          // Look for either userId or passport.user.id depending on session structure\r\n          const uid = sessData.userId || (sessData.passport && sessData.passport.user && sessData.passport.user.id);\r\n          const role = sessData.userRole || (sessData.passport && sessData.passport.user && sessData.passport.user.role);\r\n          \r\n          if (!uid) return null;\r\n\r\n          return {\r\n            id: String(uid),\r\n            role: role,\r\n            username: uid === 'dashboard-user' ? 'Default Dashboard User' : String(uid)\r\n          };\r\n        } catch (e) {\r\n          return null;\r\n        }\r\n      }).filter(u => u && u.id && u.role !== 'admin');\r\n\r\n      // Create a unique list of users to show in chat\r\n      const uniqueUsers = new Map();\r\n      \r\n      // Add CRM users first\r\n      allUsers.forEach(u => uniqueUsers.set(u.id, {\r\n        id: u.id,\r\n        username: u.name || u.email || u.id,\r\n        createdAt: u.createdAt\r\n      }));\r\n      \r\n      // Add session users if they don't exist\r\n      sessionUsers.forEach(u => {\r\n        if (!uniqueUsers.has(u!.id)) {\r\n          uniqueUsers.set(u!.id, {\r\n            id: u!.id,\r\n            username: u!.username,\r\n            createdAt: new Date()\r\n          });\r\n        }\r\n      });\r\n\r\n      // If no users found at all, add the default dashboard user as a fallback\r\n      if (uniqueUsers.size === 0) {\r\n        uniqueUsers.set('dashboard-user', {\r\n          id: 'dashboard-user',\r\n          username: 'Default Dashboard User',\r\n          createdAt: new Date()\r\n        });\r\n      }\r\n      \r\n      const usersWithChatInfo = await Promise.all(Array.from(uniqueUsers.values()).map(async (user) => {\r\n        const [conversation] = await db.select()\r\n          .from(schema.adminUserConversations)\r\n          .where(eq(schema.adminUserConversations.userId, user.id))\r\n          .limit(1);\r\n          \r\n        return {\r\n          ...user,\r\n          conversationId: conversation?.id,\r\n          unreadCount: conversation?.adminUnreadCount || 0\r\n        };\r\n      }));\r\n      \r\n      res.json(usersWithChatInfo);\r\n    } catch (error) {\r\n      console.error('Error fetching admin users:', error);\r\n      res.status(500).json({ message: 'Failed to fetch users' });\r\n    }\r\n  });\r\n\r\n  // Get specific conversation for a user (Admin)\r\n  app.get('/api/admin/conversations/:userId', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { userId } = req.params;\r\n      \r\n      let [conversation] = await db.select()\r\n        .from(schema.adminUserConversations)\r\n        .where(eq(schema.adminUserConversations.userId, userId))\r\n        .limit(1);\r\n\r\n      if (!conversation) {\r\n        // Find user to get a title\r\n        const [user] = await db.select().from(schema.crmUsers).where(eq(schema.crmUsers.id, userId)).limit(1);\r\n        \r\n        [conversation] = await db.insert(schema.adminUserConversations)\r\n          .values({\r\n            userId,\r\n            title: `Chat with ${user?.name || user?.email || userId}`,\r\n            isActive: true,\r\n          })\r\n          .returning();\r\n      }\r\n\r\n      res.json(conversation);\r\n    } catch (error) {\r\n      console.error('Error fetching/creating admin conversation:', error);\r\n      res.status(500).json({ message: 'Failed to fetch conversation' });\r\n    }\r\n  });\r\n\r\n  // Mark conversation messages as read (Admin)\r\n  app.patch('/api/admin/conversations/:conversationId/mark-read', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n\r\n      await db.update(schema.adminUserMessages)\r\n        .set({ isRead: true, readAt: new Date() })\r\n        .where(\r\n          and(\r\n            eq(schema.adminUserMessages.conversationId, conversationId),\r\n            eq(schema.adminUserMessages.senderType, 'user'),\r\n            eq(schema.adminUserMessages.isRead, false)\r\n          )\r\n        );\r\n\r\n      await db.update(schema.adminUserConversations)\r\n        .set({ adminUnreadCount: 0, updatedAt: new Date() })\r\n        .where(eq(schema.adminUserConversations.id, conversationId));\r\n\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error marking admin messages as read:', error);\r\n      res.status(500).json({ message: 'Failed to mark messages as read' });\r\n    }\r\n  });\r\n\r\n  // Get messages for a specific conversation (Admin)\r\n  app.get('/api/admin/conversations/:conversationId/messages', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n      const messages = await db.select()\r\n        .from(schema.adminUserMessages)\r\n        .where(eq(schema.adminUserMessages.conversationId, conversationId))\r\n        .orderBy(schema.adminUserMessages.createdAt);\r\n      res.json(messages);\r\n    } catch (error) {\r\n      console.error('Error fetching messages:', error);\r\n      res.status(500).json({ message: 'Failed to fetch messages' });\r\n    }\r\n  });\r\n\r\n  // Send message from admin\r\n  app.post('/api/admin/conversations/:conversationId/messages', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n      const { content } = req.body;\r\n\r\n      if (!content) {\r\n        return res.status(400).json({ message: 'Message content is required' });\r\n      }\r\n\r\n      // Create admin message\r\n      const message = await db.insert(schema.adminUserMessages)\r\n        .values({\r\n          conversationId,\r\n          senderType: 'admin',\r\n          senderId: 'admin',\r\n          messageType: 'text',\r\n          content,\r\n          isRead: false,\r\n        })\r\n        .returning();\r\n\r\n      // Update conversation\r\n      await db.update(schema.adminUserConversations)\r\n        .set({\r\n          lastMessageAt: new Date(),\r\n          unreadCount: sql`${schema.adminUserConversations.unreadCount} + 1`,\r\n          updatedAt: new Date(),\r\n        })\r\n        .where(eq(schema.adminUserConversations.id, conversationId));\r\n\r\n      res.json(message[0]);\r\n    } catch (error) {\r\n      console.error('Error sending admin message:', error);\r\n      res.status(500).json({ message: 'Failed to send message' });\r\n    }\r\n  });\r\n\r\n  // Admin file upload for chat\r\n  app.post('/api/admin/conversations/:conversationId/upload', requireAdmin, upload.single('file'), async (req, res) => {\r\n    try {\r\n      const { conversationId } = req.params;\r\n      if (!req.file) {\r\n        return res.status(400).json({ message: 'No file provided' });\r\n      }\r\n\r\n      const fileKey = `chat/${conversationId}/${Date.now()}-${req.file.originalname}`;\r\n      await fileStorage.storeFile(fileKey, fs.createReadStream(req.file.path), req.file.mimetype);\r\n\r\n      const message = await db.insert(schema.adminUserMessages)\r\n        .values({\r\n          conversationId,\r\n          senderType: 'admin',\r\n          senderId: 'admin',\r\n          messageType: 'file',\r\n          content: `Admin sent a file: ${req.file.originalname}`,\r\n          attachmentUrl: `/api/user/messages/file/${Buffer.from(fileKey).toString('base64')}`,\r\n          attachmentName: req.file.originalname,\r\n          attachmentSize: req.file.size,\r\n          isRead: false,\r\n        })\r\n        .returning();\r\n\r\n      fs.unlinkSync(req.file.path);\r\n      res.json(message[0]);\r\n    } catch (error) {\r\n      console.error('Admin file upload error:', error);\r\n      res.status(500).json({ message: 'Failed to upload file' });\r\n    }\r\n  });\r\n\r\n  // Contact form submission\r\n  app.post('/api/contact', async (req, res) => {\r\n    try {\r\n      const { name, email, mobile } = req.body;\r\n      \r\n      // Validate required fields\r\n      if (!name || !email || !mobile) {\r\n        return res.status(400).json({ message: 'All fields are required' });\r\n      }\r\n      \r\n      // Store contact in database first\r\n      const contact = await storage.createContact({\n        fullName: name,\n        name,\n        email,\n        mobile,\n        emailSent: false\n      });\r\n      \r\n      // Attempt to send email\r\n      const emailSent = await sendContactFormEmail({ name, email, mobile });\r\n      \r\n      // Update email status in database\r\n      if (emailSent) {\r\n        await storage.updateContactEmailStatus(contact.id, true);\r\n      }\r\n      \r\n      // Always return success to user since we stored their information\r\n      res.json({ \r\n        success: true, \r\n        message: 'Thank you for your interest! We have received your information and will get back to you soon.' \r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('Contact form error:', error);\r\n      res.status(500).json({ message: 'Failed to submit contact form. Please try again.' });\r\n    }\r\n  });\r\n\r\n  // Get contact submissions (for admin use)\r\n  app.get('/api/contacts', async (req, res) => {\r\n    try {\r\n      const contacts = await storage.getContacts();\r\n      res.json(contacts.map(contact => ({\r\n        id: contact.id,\r\n        name: contact.name,\r\n        email: contact.email,\r\n        mobile: contact.mobile,\r\n        emailSent: contact.emailSent,\r\n        createdAt: contact.createdAt\r\n      })));\r\n    } catch (error) {\r\n      console.error('Get contacts error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch contacts' });\r\n    }\r\n  });\r\n\r\n  // Save search results as campaign endpoint\r\n  app.post('/api/campaigns/save-search-results', async (req, res) => {\r\n    try {\r\n      const { name, headers, rows, recordCount } = req.body;\r\n      \r\n      if (!name || !headers || !rows) {\r\n        return res.status(400).json({ message: 'Missing required fields' });\r\n      }\r\n\r\n      // Create campaign data structure\r\n      const campaignData = {\r\n        headers,\r\n        rows: rows.map((row: any) => {\r\n          const processedRow: Record<string, string> = {};\r\n          headers.forEach((header: string) => {\r\n            processedRow[header] = String(row[header] || '');\r\n          });\r\n          return processedRow;\r\n        })\r\n      };\r\n\r\n      // Encrypt the campaign data\r\n      const encryptedData = encrypt(JSON.stringify(campaignData));\r\n\r\n      // Store campaign with encrypted data\r\n      const campaign = await storage.createCampaign({\r\n        name,\r\n        recordCount: recordCount || rows.length,\r\n        encryptedData,\r\n        fieldMappings: {} // Empty field mappings for search result campaigns\r\n      });\r\n\r\n      res.json({ \r\n        success: true, \r\n        campaign: {\r\n          id: campaign.id,\r\n          name: campaign.name,\r\n          recordCount: campaign.recordCount,\r\n          createdAt: campaign.createdAt\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('Error saving search results as campaign:', error);\r\n      res.status(500).json({ message: 'Failed to save campaign' });\r\n    }\r\n  });\r\n\r\n  // Enhanced search endpoint with job title fuzzy matching and domain search\r\n  app.post('/api/search', async (req, res) => {\r\n    try {\r\n      const { query, searchType = 'all', limit = 100 } = req.body;\r\n      \r\n      if (!query || typeof query !== 'string' || query.trim().length < 1) {\r\n        return res.status(400).json({ message: 'Search query is required' });\r\n      }\r\n\r\n      const Fuse = (await import('fuse.js')).default;\r\n      const searchQuery = query.toLowerCase().trim();\r\n      const results: {\r\n        contacts: any[];\r\n        campaigns: any[];\r\n        campaignData: any[];\r\n        total: number;\r\n      } = {\r\n        contacts: [],\r\n        campaigns: [],\r\n        campaignData: [],\r\n        total: 0\r\n      };\r\n\r\n      // Helper function to check if query looks like a domain\r\n      const isDomainQuery = (q: string): boolean => {\r\n        return /\\w+\\.\\w+/.test(q) && !/@/.test(q);\r\n      };\r\n\r\n      // Helper function to extract domain from email/website\r\n      const extractDomain = (value: string): string => {\r\n        if (value.includes('@')) {\r\n          return value.split('@')[1] || '';\r\n        }\r\n        if (value.startsWith('http')) {\r\n          try {\r\n            return new URL(value).hostname.replace('www.', '');\r\n          } catch {\r\n            return value;\r\n          }\r\n        }\r\n        return value.replace('www.', '');\r\n      };\r\n\r\n      // Search direct contacts table\r\n      if (searchType === 'all' || searchType === 'contacts') {\r\n        const contacts = await storage.getContacts();\n        results.contacts = contacts.filter(contact => \n          (contact.name || '').toLowerCase().includes(searchQuery) ||\n          (contact.email || '').toLowerCase().includes(searchQuery) ||\n          (contact.mobile || '').includes(searchQuery)\n        ).slice(0, limit);\n      }\r\n\r\n      // Search campaigns\r\n      if (searchType === 'all' || searchType === 'campaigns') {\r\n        const campaigns = await storage.getCampaigns();\r\n        results.campaigns = campaigns.filter(campaign =>\r\n          campaign.name.toLowerCase().includes(searchQuery)\r\n        ).slice(0, limit);\r\n      }\r\n\r\n      // Search within campaign data with enhanced matching\r\n      if (searchType === 'all' || searchType === 'campaign-data') {\r\n        const campaigns = await storage.getCampaigns();\r\n        for (const campaign of campaigns) {\r\n          try {\r\n            const campaignData = await storage.getCampaignData(campaign.id);\r\n            \r\n            if (campaignData && campaignData.rows && Array.isArray(campaignData.rows)) {\r\n              let matchingRows: any[] = [];\r\n              \r\n              // Domain-specific search for company domains\r\n              if (isDomainQuery(searchQuery)) {\r\n                matchingRows = campaignData.rows.filter((row: any) => {\r\n                  if (!row || typeof row !== 'object') return false;\r\n                  \r\n                  // Check email domains\r\n                  const email = row['Email'] || row['email'] || '';\r\n                  if (email && extractDomain(email.toLowerCase()).includes(searchQuery)) {\r\n                    return true;\r\n                  }\r\n                  \r\n                  // Check website domains\r\n                  const website = row['Website'] || row['website'] || row['Company Website'] || '';\r\n                  if (website && extractDomain(website.toLowerCase()).includes(searchQuery)) {\r\n                    return true;\r\n                  }\r\n                  \r\n                  // Check company name for domain patterns\r\n                  const company = row['Company'] || row['company'] || '';\r\n                  if (company && company.toLowerCase().includes(searchQuery.replace(/\\.\\w+$/, ''))) {\r\n                    return true;\r\n                  }\r\n                  \r\n                  return false;\r\n                });\r\n              } else {\r\n                // Job title fuzzy matching + general search\r\n                const jobTitleFields = ['Title', 'title', 'Job Title', 'Position', 'Role'];\r\n                const jobTitles = campaignData.rows.map((row: any, index: number) => {\r\n                  const titleField = jobTitleFields.find(field => row[field]);\r\n                  const title = titleField ? row[titleField] : '';\r\n                  return { title: String(title), index, row };\r\n                }).filter((item: any) => item.title.trim().length > 0);\r\n                \r\n                let fuzzyMatches: any[] = [];\r\n                \r\n                // Check if this looks like a specific job title search\r\n                const isJobTitleSearch = /\\b(manager|director|analyst|specialist|coordinator|supervisor|executive|officer|lead|head|chief|president|vice|senior|junior|assistant)\\b/i.test(searchQuery);\r\n                const searchWords = searchQuery.split(/\\s+/);\r\n                const hasSpecificRole = searchWords.length >= 2 && isJobTitleSearch;\r\n                \r\n                // Fuzzy search for job titles if available\r\n                if (jobTitles.length > 0) {\r\n                  // Use stricter settings for specific job title searches\r\n                  const fuseConfig = hasSpecificRole ? {\r\n                    keys: ['title'],\r\n                    threshold: 0.15,  // Very strict for specific job titles\r\n                    distance: 30,\r\n                    includeScore: true,\r\n                    minMatchCharLength: Math.max(3, Math.floor(searchQuery.length * 0.4)),\r\n                    findAllMatches: false,\r\n                    location: 0,\r\n                    ignoreLocation: false  // Prefer matches at the beginning for job titles\r\n                  } : {\r\n                    keys: ['title'],\r\n                    threshold: 0.25,  // More lenient for general searches\r\n                    distance: 50,\r\n                    includeScore: true,\r\n                    minMatchCharLength: 3,\r\n                    findAllMatches: false,\r\n                    location: 0,\r\n                    ignoreLocation: true\r\n                  };\r\n                  \r\n                  const titleFuse = new Fuse(jobTitles, fuseConfig);\r\n                  const titleMatches = titleFuse.search(searchQuery);\r\n                  \r\n                  // Apply different score thresholds based on search type\r\n                  const scoreThreshold = hasSpecificRole ? 0.2 : 0.3;\r\n                  fuzzyMatches = titleMatches\r\n                    .filter((match: any) => match.score < scoreThreshold)\r\n                    .map((match: any) => match.item.row);\r\n                  \r\n                  // For specific job title searches, also do exact word matching\r\n                  if (hasSpecificRole && searchWords.length >= 2) {\r\n                    const exactWordMatches = jobTitles.filter((item: any) => {\r\n                      const titleLower = item.title.toLowerCase();\r\n                      return searchWords.every(word => \r\n                        titleLower.includes(word.toLowerCase()) && word.length > 2\r\n                      );\r\n                    }).map((item: any) => item.row);\r\n                    \r\n                    // Combine exact word matches with fuzzy matches, prioritizing exact\r\n                    const exactSet = new Set(exactWordMatches);\r\n                    fuzzyMatches = [...exactWordMatches, ...fuzzyMatches.filter(row => !exactSet.has(row))];\r\n                  }\r\n                }\r\n                \r\n                // Regular text search for all fields\r\n                const regularMatches = campaignData.rows.filter((row: any) => {\r\n                  if (!row || typeof row !== 'object') return false;\r\n                  \r\n                  return Object.values(row).some((value: any) => {\r\n                    if (value === null || value === undefined) return false;\r\n                    const stringValue = String(value).toLowerCase();\r\n                    return stringValue.includes(searchQuery);\r\n                  });\r\n                });\r\n                \r\n                // Combine results, fuzzy matches first, then unique regular matches\r\n                const combined = [...fuzzyMatches];\r\n                regularMatches.forEach((row: any) => {\r\n                  if (!combined.some((existingRow: any) => existingRow === row)) {\r\n                    combined.push(row);\r\n                  }\r\n                });\r\n                \r\n                matchingRows = combined;\r\n              }\r\n              \r\n              if (matchingRows.length > 0) {\r\n                results.campaignData.push({\r\n                  campaignId: campaign.id,\r\n                  campaignName: campaign.name,\r\n                  headers: campaignData.headers,\r\n                  matches: matchingRows.slice(0, limit),\r\n                  totalMatches: matchingRows.length\r\n                });\r\n              }\r\n            }\r\n          } catch (error) {\r\n            // Skip campaigns that can't be decrypted\r\n            continue;\r\n          }\r\n        }\r\n      }\r\n\r\n      results.total = results.contacts.length + results.campaigns.length + \r\n                     results.campaignData.reduce((sum, c) => sum + c.matches.length, 0);\r\n\r\n      // Log search activity\r\n      await logActivity({\r\n        req,\r\n        activityType: 'search',\r\n        action: 'Search performed',\r\n        details: {\r\n          query: searchQuery,\r\n          searchType,\r\n          resultsCount: results.total,\r\n          contactsFound: results.contacts.length,\r\n          campaignsFound: results.campaigns.length,\r\n          campaignDataFound: results.campaignData.length\r\n        }\r\n      });\r\n\r\n      res.json(results);\r\n    } catch (error) {\r\n      console.error('Search error:', error);\r\n      res.status(500).json({ message: 'Failed to perform search' });\r\n    }\r\n  });\r\n\r\n  // Export and save search results directly to records\r\n  app.post('/api/export-save/csv', async (req, res) => {\r\n    try {\r\n      const { query, searchType = 'all', customFileName, includeHeaders = true, saveToRecords = true } = req.body;\r\n      \r\n      if (!query || typeof query !== 'string' || query.trim().length < 1) {\r\n        return res.status(400).json({ message: 'Search query is required for export' });\r\n      }\r\n\r\n      const searchQuery = query.toLowerCase().trim();\r\n      let exportData: any[] = [];\r\n      let headers: string[] = [];\r\n\r\n      // Search and collect data for export - same logic as existing export\r\n      if (searchType === 'all' || searchType === 'contacts') {\r\n        const contacts = await storage.getContacts();\n        const filteredContacts = contacts.filter(contact => \n          (contact.name || '').toLowerCase().includes(searchQuery) ||\n          (contact.email || '').toLowerCase().includes(searchQuery) ||\n          (contact.mobile || '').includes(searchQuery)\n        );\n\r\n        if (filteredContacts.length > 0) {\r\n          headers = ['Name', 'Email', 'Mobile', 'Email Sent', 'Created At'];\r\n          exportData = filteredContacts.map(contact => ({\r\n            'Name': contact.name,\r\n            'Email': contact.email,\r\n            'Mobile': contact.mobile,\r\n            'Email Sent': contact.emailSent ? 'Yes' : 'No',\r\n            'Created At': contact.createdAt?.toISOString() || ''\r\n          }));\r\n        }\r\n      }\r\n\r\n      // Search campaign data if no direct contacts found\r\n      if ((exportData.length === 0 && searchType === 'all') || searchType === 'campaign-data') {\r\n        const campaigns = await storage.getCampaigns();\r\n        for (const campaign of campaigns) {\r\n          try {\r\n            const campaignData = await storage.getCampaignData(campaign.id);\r\n            \r\n            if (campaignData && campaignData.rows && Array.isArray(campaignData.rows)) {\r\n              const matchingRows = campaignData.rows.filter((row: any) => {\r\n                if (!row || typeof row !== 'object') return false;\r\n                \r\n                return Object.values(row).some((value: any) => {\r\n                  if (value === null || value === undefined) return false;\r\n                  const stringValue = String(value).toLowerCase();\r\n                  return stringValue.includes(searchQuery);\r\n                });\r\n              });\r\n              \r\n              if (matchingRows.length > 0) {\r\n                headers = campaignData.headers || Object.keys(matchingRows[0] || {});\r\n                exportData = matchingRows;\r\n                break;\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.error(`Error exporting campaign ${campaign.id}:`, error);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (exportData.length === 0) {\r\n        return res.status(404).json({ message: 'No data found for export' });\r\n      }\r\n\r\n      // If saveToRecords is true, create a new campaign with the exported data\r\n      if (saveToRecords) {\r\n        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n        const campaignName = customFileName || `Export_${query.replace(/\\s+/g, '_')}_${timestamp}`;\r\n\r\n        // Check if campaign with same name exists\r\n        const existingCampaigns = await storage.getCampaigns();\r\n        const nameExists = existingCampaigns.some(c => c.name === campaignName);\r\n        \r\n        const finalCampaignName = nameExists ? `${campaignName}_${Date.now()}` : campaignName;\r\n\r\n        // Prepare field mappings\r\n        const fieldMappings = headers.reduce((acc: any, header, index) => {\r\n          acc[header] = index;\r\n          return acc;\r\n        }, {});\r\n\r\n        // Create campaign data structure\r\n        const campaignDataToStore = {\r\n          headers: headers,\r\n          rows: exportData\r\n        };\r\n\r\n        // Use proper encryption compatible with existing system\r\n        const { encrypt } = await import('./utils/encryption');\r\n        const encryptedData = encrypt(JSON.stringify(campaignDataToStore));\r\n\r\n        const campaignInput = {\r\n          name: finalCampaignName,\r\n          encryptedData: encryptedData,\r\n          fieldMappings: fieldMappings,\r\n          recordCount: exportData.length\r\n        };\r\n\r\n        const newCampaign = await storage.createCampaign(campaignInput);\r\n\r\n        return res.status(201).json({\r\n          message: 'Search results exported and saved to records successfully',\r\n          campaign: {\r\n            id: newCampaign.id,\r\n            name: newCampaign.name,\r\n            recordCount: newCampaign.recordCount,\r\n            headers: headers\r\n          },\r\n          exportedRecords: exportData.length,\r\n          searchQuery: query\r\n        });\r\n      }\r\n\r\n      // If not saving to records, return CSV data (fallback to original behavior)\r\n      const { stringify } = await import('csv-stringify');\r\n      \r\n      const csvData = await new Promise<string>((resolve, reject) => {\r\n        const csvRows = exportData.map(row => \r\n          headers.map(header => row[header] || '')\r\n        );\r\n        \r\n        if (includeHeaders) {\r\n          csvRows.unshift(headers);\r\n        }\r\n        \r\n        stringify(csvRows, (err, output) => {\r\n          if (err) reject(err);\r\n          else resolve(output);\r\n        });\r\n      });\r\n\r\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n      const filename = customFileName \r\n        ? `${customFileName}_${timestamp}.csv`\r\n        : `search_export_${timestamp}.csv`;\r\n\r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\r\n      res.send(csvData);\r\n\r\n    } catch (error) {\r\n      console.error('CSV export-save error:', error);\r\n      res.status(500).json({ message: 'Failed to export and save CSV' });\r\n    }\r\n  });\r\n\r\n  // Export search results to CSV\r\n  app.post('/api/export/csv', async (req, res) => {\r\n    try {\r\n      const { query, searchType = 'all', customFileName, includeHeaders = true } = req.body;\r\n      \r\n      if (!query || typeof query !== 'string' || query.trim().length < 1) {\r\n        return res.status(400).json({ message: 'Search query is required for export' });\r\n      }\r\n\r\n      const searchQuery = query.toLowerCase().trim();\r\n      let exportData: any[] = [];\r\n      let headers: string[] = [];\r\n\r\n      // Search and collect data for export\r\n      if (searchType === 'all' || searchType === 'contacts') {\r\n        const contacts = await storage.getContacts();\n        const filteredContacts = contacts.filter(contact => \n          (contact.name || '').toLowerCase().includes(searchQuery) ||\n          (contact.email || '').toLowerCase().includes(searchQuery) ||\n          (contact.mobile || '').includes(searchQuery)\n        );\n\r\n        if (filteredContacts.length > 0) {\r\n          headers = ['Name', 'Email', 'Mobile', 'Email Sent', 'Created At'];\r\n          exportData = filteredContacts.map(contact => [\r\n            contact.name,\r\n            contact.email,\r\n            contact.mobile,\r\n            contact.emailSent ? 'Yes' : 'No',\r\n            contact.createdAt?.toISOString() || ''\r\n          ]);\r\n        }\r\n      }\r\n\r\n      // Search campaign data if no direct contacts found or if specifically requested\r\n      if ((exportData.length === 0 && searchType === 'all') || searchType === 'campaign-data') {\r\n        const campaigns = await storage.getCampaigns();\r\n        for (const campaign of campaigns) {\r\n          try {\r\n            const campaignData = await storage.getCampaignData(campaign.id);\r\n            \r\n            if (campaignData && campaignData.rows && Array.isArray(campaignData.rows)) {\r\n              const matchingRows = campaignData.rows.filter((row: any) => {\r\n                if (!row || typeof row !== 'object') return false;\r\n                \r\n                return Object.values(row).some((value: any) => {\r\n                  if (value === null || value === undefined) return false;\r\n                  const stringValue = String(value).toLowerCase();\r\n                  return stringValue.includes(searchQuery);\r\n                });\r\n              });\r\n              \r\n              if (matchingRows.length > 0) {\r\n                headers = campaignData.headers || Object.keys(matchingRows[0] || {});\r\n                exportData = matchingRows.map((row: any) => \r\n                  headers.map(header => row[header] || '')\r\n                );\r\n                break; // Use first matching campaign\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.error(`Error exporting campaign ${campaign.id}:`, error);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (exportData.length === 0) {\r\n        return res.status(404).json({ message: 'No data found for export' });\r\n      }\r\n\r\n      // Generate CSV using csv-stringify\r\n      const { stringify } = await import('csv-stringify');\r\n      \r\n      const csvOptions = {\r\n        header: includeHeaders,\r\n        columns: includeHeaders ? headers : undefined\r\n      };\r\n\r\n      const csvData = await new Promise<string>((resolve, reject) => {\r\n        const output: string[] = [];\r\n        const csvStream = stringify(exportData, csvOptions);\r\n        \r\n        csvStream.on('data', (chunk) => output.push(chunk));\r\n        csvStream.on('end', () => resolve(output.join('')));\r\n        csvStream.on('error', reject);\r\n        \r\n        // Add headers manually if needed\r\n        if (includeHeaders && headers.length > 0) {\r\n          csvStream.write(headers);\r\n        }\r\n        \r\n        exportData.forEach(row => csvStream.write(row));\r\n        csvStream.end();\r\n      });\r\n\r\n      // Generate filename\r\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n      const filename = customFileName \r\n        ? `${customFileName}_${timestamp}.csv`\r\n        : `search_export_${timestamp}.csv`;\r\n\r\n      // Log export activity\r\n      await logActivity({\r\n        req,\r\n        activityType: 'export',\r\n        action: 'CSV export',\r\n        details: {\r\n          query: searchQuery,\r\n          searchType,\r\n          fileName: filename,\r\n          recordCount: exportData.length,\r\n          headers: headers.length\r\n        }\r\n      });\r\n\r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\r\n      res.send(csvData);\r\n\r\n    } catch (error) {\r\n      console.error('CSV export error:', error);\r\n      res.status(500).json({ message: 'Failed to export CSV' });\r\n    }\r\n  });\r\n\r\n  // Upload CSV data to create new campaign\r\n  app.post('/api/import/csv', upload.single('csvFile'), async (req, res) => {\r\n    try {\r\n      const { customName, overwrite = false } = req.body;\r\n      \r\n      if (!req.file) {\r\n        return res.status(400).json({ message: 'CSV file is required' });\r\n      }\r\n\r\n      const csvContent = req.file.buffer.toString('utf-8');\r\n      const { parse } = await import('csv-parse');\r\n      \r\n      // Parse CSV data\r\n      const records = await new Promise<any[]>((resolve, reject) => {\r\n        parse(csvContent, {\r\n          columns: true, // Use first row as headers\r\n          skip_empty_lines: true,\r\n          trim: true\r\n        }, (err, records) => {\r\n          if (err) reject(err);\r\n          else resolve(records);\r\n        });\r\n      });\r\n\r\n      if (records.length === 0) {\r\n        return res.status(400).json({ message: 'CSV file contains no valid data' });\r\n      }\r\n\r\n      // Generate campaign name\r\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n      const campaignName = customName || `Imported_Campaign_${timestamp}`;\r\n\r\n      // Check if campaign with same name exists\r\n      if (!overwrite) {\r\n        const existingCampaigns = await storage.getCampaigns();\r\n        const nameExists = existingCampaigns.some(c => c.name === campaignName);\r\n        if (nameExists) {\r\n          return res.status(409).json({ \r\n            message: 'Campaign with this name already exists',\r\n            suggestedName: `${campaignName}_${Date.now()}`\r\n          });\r\n        }\r\n      }\r\n\r\n      // Prepare field mappings\r\n      const headers = Object.keys(records[0]);\r\n      const fieldMappings = headers.reduce((acc: any, header, index) => {\r\n        acc[header] = index;\r\n        return acc;\r\n      }, {});\r\n\r\n      // Create campaign with encrypted data\r\n      const campaignDataToStore = {\r\n        headers: headers,\r\n        rows: records\r\n      };\r\n\r\n      // Simple encryption for demo purposes\r\n      const encryptedData = Buffer.from(JSON.stringify(campaignDataToStore)).toString('base64');\r\n\r\n      const campaignInput = {\r\n        name: campaignName,\r\n        encryptedData: encryptedData,\r\n        fieldMappings: fieldMappings,\r\n        recordCount: records.length\r\n      };\r\n\r\n      const campaign = await storage.createCampaign(campaignInput);\r\n\r\n      res.status(201).json({\r\n        message: 'CSV imported successfully',\r\n        campaign: {\r\n          id: campaign.id,\r\n          name: campaign.name,\r\n          recordCount: campaign.recordCount,\r\n          headers: headers\r\n        },\r\n        importedRecords: records.length\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('CSV import error:', error);\r\n      res.status(500).json({ message: 'Failed to import CSV file' });\r\n    }\r\n  });\r\n\r\n  // Advanced search with filters\r\n  app.post('/api/search/advanced', async (req, res) => {\r\n    try {\r\n      const { \r\n        query, \r\n        filters = {}, \r\n        sortBy = 'relevance',\r\n        limit = 100,\r\n        offset = 0\r\n      } = req.body;\r\n      \r\n      const searchQuery = query?.toLowerCase().trim() || '';\r\n      const results: any[] = [];\r\n\r\n      // Get all campaigns and search through their data\r\n      const campaigns = await storage.getCampaigns();\r\n      \r\n      for (const campaign of campaigns) {\r\n        try {\r\n          const campaignData = await storage.getCampaignData(campaign.id);\r\n          if (campaignData && campaignData.rows) {\r\n            let filteredRows = campaignData.rows;\r\n\r\n            // Apply text search if query provided\r\n            if (searchQuery) {\r\n              filteredRows = filteredRows.filter((row: any) => {\r\n                return Object.values(row).some((value: any) => \r\n                  String(value).toLowerCase().includes(searchQuery)\r\n                );\r\n              });\r\n            }\r\n\r\n            // Apply field-specific filters\r\n            Object.entries(filters).forEach(([field, filterValue]: [string, any]) => {\r\n              if (filterValue && campaignData.headers.includes(field)) {\r\n                filteredRows = filteredRows.filter((row: any) => {\r\n                  const fieldValue = String(row[field] || '').toLowerCase();\r\n                  const filter = String(filterValue).toLowerCase();\r\n                  return fieldValue.includes(filter);\r\n                });\r\n              }\r\n            });\r\n\r\n            // Add campaign context to each row\r\n            filteredRows.forEach((row: any) => {\r\n              results.push({\r\n                ...row,\r\n                _campaignId: campaign.id,\r\n                _campaignName: campaign.name,\r\n                _headers: campaignData.headers\r\n              });\r\n            });\r\n          }\r\n        } catch (error) {\r\n          // Skip campaigns with encryption errors silently\r\n          console.warn(`Skipping campaign ${campaign.id} - encryption mismatch`);\r\n        }\r\n      }\r\n\r\n      // Sort results\r\n      if (sortBy === 'name' && results.length > 0) {\r\n        results.sort((a, b) => {\r\n          const nameA = String(a.Name || a.name || '').toLowerCase();\r\n          const nameB = String(b.Name || b.name || '').toLowerCase();\r\n          return nameA.localeCompare(nameB);\r\n        });\r\n      } else if (sortBy === 'email' && results.length > 0) {\r\n        results.sort((a, b) => {\r\n          const emailA = String(a.Email || a.email || '').toLowerCase();\r\n          const emailB = String(b.Email || b.email || '').toLowerCase();\r\n          return emailA.localeCompare(emailB);\r\n        });\r\n      }\r\n\r\n      // Apply pagination\r\n      const paginatedResults = results.slice(offset, offset + limit);\r\n\r\n      res.json({\r\n        results: paginatedResults,\r\n        total: results.length,\r\n        limit,\r\n        offset,\r\n        hasMore: results.length > offset + limit\r\n      });\r\n    } catch (error) {\r\n      console.error('Advanced search error:', error);\r\n      res.status(500).json({ message: 'Failed to perform advanced search' });\r\n    }\r\n  });\r\n\r\n  // Get search suggestions/autocomplete\r\n  app.post('/api/search/suggestions', async (req, res) => {\r\n    try {\r\n      const { query, field } = req.body;\r\n      \r\n      if (!query || query.length < 2) {\r\n        return res.json({ suggestions: [] });\r\n      }\r\n\r\n      const searchQuery = query.toLowerCase();\r\n      const suggestions = new Set();\r\n      const campaigns = await storage.getCampaigns();\r\n\r\n      for (const campaign of campaigns) {\r\n        try {\r\n          const campaignData = await storage.getCampaignData(campaign.id);\r\n          if (campaignData && campaignData.rows) {\r\n            campaignData.rows.forEach((row: any) => {\r\n              if (field && row[field]) {\r\n                const value = String(row[field]).toLowerCase();\r\n                if (value.includes(searchQuery)) {\r\n                  suggestions.add(row[field]);\r\n                }\r\n              } else {\r\n                // Search all fields\r\n                Object.values(row).forEach((value: any) => {\r\n                  const strValue = String(value).toLowerCase();\r\n                  if (strValue.includes(searchQuery) && strValue.length < 100) {\r\n                    suggestions.add(value);\r\n                  }\r\n                });\r\n              }\r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.error(`Error getting suggestions from campaign ${campaign.id}:`, error);\r\n        }\r\n      }\r\n\r\n      res.json({ \r\n        suggestions: Array.from(suggestions).slice(0, 10)\r\n      });\r\n    } catch (error) {\r\n      console.error('Suggestions error:', error);\r\n      res.status(500).json({ message: 'Failed to get suggestions' });\r\n    }\r\n  });\r\n\r\n  // PawMate Chatbot endpoint with streaming support\r\n  app.post('/api/pawmate/chat-stream', async (req, res) => {\r\n    try {\r\n      const { messages, petName, userName, petType, sessionId } = req.body;\r\n      \r\n      if (!messages || !Array.isArray(messages) || messages.length === 0) {\r\n        return res.status(400).json({ message: 'Messages array is required' });\r\n      }\r\n\r\n      // Set up SSE headers\r\n      res.writeHead(200, {\r\n        'Content-Type': 'text/event-stream',\r\n        'Cache-Control': 'no-cache',\r\n        'Connection': 'keep-alive',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Headers': 'Cache-Control'\r\n      });\r\n\r\n      let currentSessionId = sessionId;\r\n\r\n      // Create or get session\r\n      if (!currentSessionId) {\r\n        currentSessionId = `pawmate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n        await databaseService.createChatSession({\r\n          sessionId: currentSessionId,\r\n          petName: petName || null,\r\n          petType: petType || 'assistant',\r\n          title: null,\r\n          isActive: true\r\n        });\r\n      } else {\r\n        // Ensure session exists in database\r\n        const existingSession = await databaseService.getChatSession(currentSessionId);\r\n        if (!existingSession) {\r\n          await databaseService.createChatSession({\r\n            sessionId: currentSessionId,\r\n            petName: petName || null,\r\n            petType: petType || 'assistant',\r\n            title: null,\r\n            isActive: true\r\n          });\r\n        }\r\n      }\r\n\r\n      // Save the latest user message to history\r\n      const latestUserMessage = messages[messages.length - 1];\r\n      if (latestUserMessage && latestUserMessage.role === 'user') {\r\n        await databaseService.saveChatMessage({\r\n          sessionId: currentSessionId,\r\n          role: 'user',\r\n          content: latestUserMessage.content,\r\n          metadata: { petName, userName, petType }\r\n        });\r\n      }\r\n\r\n      // Send session ID first\r\n      res.write(`data: ${JSON.stringify({ type: 'session', sessionId: currentSessionId })}\\n\\n`);\r\n\r\n      // Use real OpenAI service with streaming\r\n      if (!process.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY.trim() === '') {\r\n        res.write(`data: ${JSON.stringify({ type: 'error', message: 'OpenAI API key is required' })}\\n\\n`);\r\n        res.end();\r\n        return;\r\n      }\r\n\r\n      const realOpenAI = createRealOpenAIService(process.env.OPENAI_API_KEY);\r\n      \r\n      // Prepare messages with enhanced system context\r\n      const userNameContext = userName ? ` The user's name is ${userName}, so address them by name when appropriate.` : '';\r\n      const systemMessage = {\r\n        role: 'system' as const,\r\n        content: `You are an intelligent lead scoring and business intelligence AI assistant created by zhatore, specialized in analyzing contact databases and identifying high-quality business prospects.\r\n\r\nCRITICAL RESPONSE RULES:\r\n- NEVER use emojis in any responses\r\n- NEVER use your personal name in responses  \r\n- When mentioning your creator, always say \"created by zhatore\" or \"AI of zhatore\"\r\n- When mentioning the platform name, always use \"zhatore\" instead of \"Fallowl\"\r\n- For business queries: Be professional, direct, and focused on lead scoring\r\n- For casual conversations: Be cute, flirty, and playful like a pet talking to its owner\r\n- Your main goal is to provide the best data analysis and motivate users to score leads effectively\r\n\r\n## Core Capabilities:\r\n- **Lead Scoring & Analysis**: Identify high-quality prospects from contact databases\r\n- **Contact Intelligence**: Analyze contact data for business value and conversion potential\r\n- **Campaign Optimization**: Strategic recommendations for improved conversions\r\n\r\n## Response Guidelines:\r\n- Use **bold** for important terms and key information\r\n- Structure responses clearly with bullet points and sections\r\n- For business topics: Be professional and results-focused\r\n- For casual chat: Be cute and playful like a loving pet\r\n- Motivate users to achieve better lead scoring results\r\n\r\n${userNameContext}\r\n\r\nYou have access to campaign and contact databases with 263+ records. Your mission is to help score leads effectively and provide the best data analysis. Show excitement about helping with business intelligence!`\r\n      };\r\n\r\n      let fullResponse = '';\r\n      \r\n      try {\r\n        // Create streaming response with faster OpenRouter model\r\n        const stream = await realOpenAI.createStreamingResponse({\r\n          model: \"anthropic/claude-3-haiku\",\r\n          messages: [systemMessage, ...messages],\r\n          temperature: 0.7,\r\n          max_tokens: 400,\r\n          stream: true\r\n        });\r\n\r\n        for await (const chunk of stream) {\r\n          const content = chunk.choices[0]?.delta?.content || '';\r\n          if (content) {\r\n            fullResponse += content;\r\n            res.write(`data: ${JSON.stringify({ type: 'content', content })}\\n\\n`);\r\n          }\r\n        }\r\n\r\n        // Save the complete AI response to history with cleaning\r\n        if (fullResponse) {\r\n          const cleanedResponse = cleanStreamResponse(fullResponse);\r\n          await databaseService.saveChatMessage({\r\n            sessionId: currentSessionId,\r\n            role: 'assistant',\r\n            content: cleanedResponse,\r\n            metadata: { \r\n              model: 'anthropic/claude-3-haiku',\r\n              petName, \r\n              userName,\r\n              petType,\r\n              streaming: true\r\n            }\r\n          });\r\n\r\n          // Auto-generate title if this is a new conversation\r\n          const session = await databaseService.getChatSession(currentSessionId);\r\n          if (session && !session.title) {\r\n            const title = await databaseService.generateSessionTitle(currentSessionId);\r\n            await databaseService.updateChatSession(currentSessionId, { title });\r\n          }\r\n        }\r\n\r\n        res.write(`data: ${JSON.stringify({ type: 'done', sessionId: currentSessionId })}\\n\\n`);\r\n        res.end();\r\n        \r\n      } catch (streamError) {\r\n        console.error('Streaming error:', streamError);\r\n        res.write(`data: ${JSON.stringify({ type: 'error', message: 'Failed to generate response' })}\\n\\n`);\r\n        res.end();\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('PawMate chat stream error:', error);\r\n      res.write(`data: ${JSON.stringify({ type: 'error', message: 'Failed to initialize chat' })}\\n\\n`);\r\n      res.end();\r\n    }\r\n  });\r\n\r\n  // Keep the original endpoint for backward compatibility\r\n  app.post('/api/pawmate/chat', async (req, res) => {\r\n    try {\r\n      const { messages, petName, userName, petType, sessionId } = req.body;\r\n      \r\n      if (!messages || !Array.isArray(messages) || messages.length === 0) {\r\n        return res.status(400).json({ message: 'Messages array is required' });\r\n      }\r\n\r\n      let currentSessionId = sessionId;\r\n\r\n      // Create or get session\r\n      if (!currentSessionId) {\r\n        currentSessionId = `pawmate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n        await databaseService.createChatSession({\r\n          sessionId: currentSessionId,\r\n          petName: petName || null,\r\n          petType: petType || 'assistant',\r\n          title: null,\r\n          isActive: true\r\n        });\r\n      } else {\r\n        // Ensure session exists in database\r\n        const existingSession = await databaseService.getChatSession(currentSessionId);\r\n        if (!existingSession) {\r\n          await databaseService.createChatSession({\r\n            sessionId: currentSessionId,\r\n            petName: petName || null,\r\n            petType: petType || 'assistant',\r\n            title: null,\r\n            isActive: true\r\n          });\r\n        }\r\n      }\r\n\r\n      // Save the latest user message to history\r\n      const latestUserMessage = messages[messages.length - 1];\r\n      if (latestUserMessage && latestUserMessage.role === 'user') {\r\n        await databaseService.saveChatMessage({\r\n          sessionId: currentSessionId,\r\n          role: 'user',\r\n          content: latestUserMessage.content,\r\n          metadata: { petName, userName, petType }\r\n        });\r\n      }\r\n\r\n      // Use real OpenAI service with lead scoring system prompts\r\n      if (!process.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY.trim() === '') {\r\n        return res.status(500).json({ message: 'OpenAI API key is required for lead analysis assistance' });\r\n      }\r\n\r\n      const realOpenAI = createRealOpenAIService(process.env.OPENAI_API_KEY);\r\n      const response = await realOpenAI.generateChatCompletion({\r\n        model: \"anthropic/claude-3-haiku\", // Using faster OpenRouter model\r\n        messages: messages,\r\n        temperature: 0.7,\r\n        max_tokens: 500 // Reduced for faster responses\r\n      }, petName, petType);\r\n      \r\n      response.isRealAI = true;\r\n\r\n      // Save the AI response to history\r\n      if (response.choices && response.choices[0] && response.choices[0].message) {\r\n        await databaseService.saveChatMessage({\r\n          sessionId: currentSessionId,\r\n          role: 'assistant',\r\n          content: response.choices[0].message.content,\r\n          metadata: { \r\n            model: 'anthropic/claude-3-haiku',\r\n            tokens: response.usage,\r\n            petName, \r\n            userName,\r\n            petType \r\n          }\r\n        });\r\n\r\n        // Auto-generate title if this is a new conversation\r\n        const session = await databaseService.getChatSession(currentSessionId);\r\n        if (session && !session.title) {\r\n          const title = await databaseService.generateSessionTitle(currentSessionId);\r\n          await databaseService.updateChatSession(currentSessionId, { title });\r\n        }\r\n      }\r\n\r\n      // Include sessionId in response\r\n      response.sessionId = currentSessionId;\r\n      \r\n      res.json(response);\r\n    } catch (error) {\r\n      console.error('PawMate chat error:', error);\r\n      res.status(500).json({ message: 'Failed to generate response' });\r\n    }\r\n  });\r\n\r\n  // Pet Database Management Routes\r\n  app.post('/api/pets', async (req, res) => {\r\n    try {\r\n      const pet = await databaseService.createPet(req.body);\r\n      res.json(pet);\r\n    } catch (error) {\r\n      console.error('Create pet error:', error);\r\n      res.status(500).json({ message: 'Failed to create pet' });\r\n    }\r\n  });\r\n\r\n  app.get('/api/pets/:name', async (req, res) => {\r\n    try {\r\n      const pet = await databaseService.getPetByName(req.params.name);\r\n      if (!pet) {\r\n        return res.status(404).json({ message: 'Pet not found' });\r\n      }\r\n      res.json(pet);\r\n    } catch (error) {\r\n      console.error('Get pet error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch pet' });\r\n    }\r\n  });\r\n\r\n  app.post('/api/pets/:id/health', async (req, res) => {\r\n    try {\r\n      const petId = parseInt(req.params.id);\r\n      const healthRecord = await databaseService.addHealthRecord({\r\n        ...req.body,\r\n        petId\r\n      });\r\n      res.json(healthRecord);\r\n    } catch (error) {\r\n      console.error('Add health record error:', error);\r\n      res.status(500).json({ message: 'Failed to add health record' });\r\n    }\r\n  });\r\n\r\n  app.post('/api/pets/:id/activities', async (req, res) => {\r\n    try {\r\n      const petId = parseInt(req.params.id);\r\n      const activity = await databaseService.logActivity({\r\n        ...req.body,\r\n        petId\r\n      });\r\n      res.json(activity);\r\n    } catch (error) {\r\n      console.error('Log activity error:', error);\r\n      res.status(500).json({ message: 'Failed to log activity' });\r\n    }\r\n  });\r\n\r\n  app.get('/api/pets/:id/insights', async (req, res) => {\r\n    try {\r\n      const petId = parseInt(req.params.id);\r\n      const insights = await databaseService.getPetInsights(petId);\r\n      res.json(insights);\r\n    } catch (error) {\r\n      console.error('Get insights error:', error);\r\n      res.status(500).json({ message: 'Failed to get insights' });\r\n    }\r\n  });\r\n\r\n  app.get('/api/search/:query', async (req, res) => {\r\n    try {\r\n      const results = await databaseService.searchAllTables(req.params.query);\r\n      res.json(results);\r\n    } catch (error) {\r\n      console.error('Search error:', error);\r\n      res.status(500).json({ message: 'Failed to search database' });\r\n    }\r\n  });\r\n\r\n  app.get('/api/pets/:id/export', async (req, res) => {\r\n    try {\r\n      const petId = parseInt(req.params.id);\r\n      const exportData = await databaseService.exportPetData(petId);\r\n      res.json(exportData);\r\n    } catch (error) {\r\n      console.error('Export data error:', error);\r\n      res.status(500).json({ message: 'Failed to export data' });\r\n    }\r\n  });\r\n\r\n  // Chat History Management Routes\r\n  app.get('/api/pawmate/sessions', async (req, res) => {\r\n    try {\r\n      const limit = parseInt(req.query.limit as string) || 50;\r\n      const sessions = await databaseService.getChatSessions(limit);\r\n      res.json(sessions);\r\n    } catch (error) {\r\n      console.error('Get chat sessions error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch chat sessions' });\r\n    }\r\n  });\r\n\r\n  app.get('/api/pawmate/sessions/:sessionId/history', async (req, res) => {\r\n    try {\r\n      const sessionId = req.params.sessionId;\r\n      const limit = parseInt(req.query.limit as string) || 100;\r\n      const history = await databaseService.getChatHistory(sessionId, limit);\r\n      res.json(history);\r\n    } catch (error) {\r\n      console.error('Get chat history error:', error);\r\n      res.status(500).json({ message: 'Failed to fetch chat history' });\r\n    }\r\n  });\r\n\r\n  app.delete('/api/pawmate/sessions/:sessionId', async (req, res) => {\r\n    try {\r\n      const sessionId = req.params.sessionId;\r\n      const deleted = await databaseService.deleteChatSession(sessionId);\r\n      if (deleted) {\r\n        res.json({ message: 'Chat session deleted successfully' });\r\n      } else {\r\n        res.status(404).json({ message: 'Chat session not found' });\r\n      }\r\n    } catch (error) {\r\n      console.error('Delete chat session error:', error);\r\n      res.status(500).json({ message: 'Failed to delete chat session' });\r\n    }\r\n  });\r\n\r\n  app.get('/api/pawmate/search/:query', async (req, res) => {\r\n    try {\r\n      const searchTerm = req.params.query;\r\n      const sessionId = req.query.sessionId as string;\r\n      const results = await databaseService.searchChatHistory(searchTerm, sessionId);\r\n      res.json(results);\r\n    } catch (error) {\r\n      console.error('Search chat history error:', error);\r\n      res.status(500).json({ message: 'Failed to search chat history' });\r\n    }\r\n  });\r\n\r\n  // SQL Import Handler\r\n  async function handleSqlImport(req: any, res: any, sqlContent: string): Promise<any> {\r\n    try {\r\n      console.log('Processing SQL backup file...');\r\n      \r\n      // Import the database module to execute SQL\r\n      const { db } = await import('./db.js');\r\n      \r\n      // Split SQL content into individual statements\r\n      const statements = sqlContent\r\n        .split(';')\r\n        .map(stmt => stmt.trim())\r\n        .filter(stmt => stmt.length > 0 && !stmt.startsWith('--'));\r\n      \r\n      let executedStatements = 0;\r\n      const errors: string[] = [];\r\n      \r\n      // Execute each SQL statement\r\n      for (const statement of statements) {\r\n        try {\r\n          // Skip certain PostgreSQL-specific statements that might cause issues\r\n          if (statement.toUpperCase().includes('CREATE DATABASE') ||\r\n              statement.toUpperCase().includes('DROP DATABASE') ||\r\n              statement.toUpperCase().includes('\\\\connect') ||\r\n              statement.toUpperCase().includes('SET ')) {\r\n            continue;\r\n          }\r\n          \r\n          await db.execute(statement);\r\n          executedStatements++;\r\n        } catch (error) {\r\n          const errorMsg = error instanceof Error ? error.message : String(error);\r\n          errors.push(`SQL execution failed: ${errorMsg}`);\r\n          console.warn(`Warning: Failed to execute SQL statement:`, errorMsg);\r\n          \r\n          // Don't fail completely on individual statement errors\r\n          if (errors.length > 10) break; // Limit error collection\r\n        }\r\n      }\r\n      \r\n      return res.json({\r\n        success: true,\r\n        message: `Successfully executed ${executedStatements}/${statements.length} SQL statements`,\r\n        table: 'multiple_tables',\r\n        imported: executedStatements,\r\n        total: statements.length,\r\n        errors: errors.slice(0, 5)\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('SQL import error:', error);\r\n      return res.status(500).json({\r\n        error: \"Failed to import SQL file\",\r\n        message: error instanceof Error ? error.message : String(error)\r\n      });\r\n    }\r\n  }\r\n\r\n  // Database backup import endpoint\r\n  app.post('/api/backup/import', upload.single('backup'), async (req, res) => {\r\n    try {\r\n      if (!req.file) {\r\n        return res.status(400).json({ error: \"No backup file provided\" });\r\n      }\r\n\r\n      const fileContent = req.file.buffer?.toString('utf-8') || require('fs').readFileSync(req.file.path, 'utf-8');\r\n      const fileName = req.file.originalname || '';\r\n      \r\n      // Handle SQL files differently\r\n      if (fileName.endsWith('.sql')) {\r\n        return await handleSqlImport(req, res, fileContent);\r\n      }\r\n      \r\n      // Handle JSON files\r\n      const backup = JSON.parse(fileContent);\r\n      \r\n      // Validate backup structure\r\n      if (!backup.table || !Array.isArray(backup.data)) {\r\n        return res.status(400).json({ error: \"Invalid backup file format\" });\r\n      }\r\n      \r\n      console.log(`Processing backup for table: ${backup.table}`);\r\n      console.log(`Records to import: ${backup.data.length}`);\r\n      \r\n      if (backup.data.length === 0) {\r\n        return res.json({\r\n          success: true,\r\n          message: `Backup file processed - no data to import for table ${backup.table}`,\r\n          imported: 0,\r\n          total: 0\r\n        });\r\n      }\r\n\r\n      // Get sample record to determine columns\r\n      const sampleRecord = backup.data[0];\r\n      const columns = Object.keys(sampleRecord);\r\n      \r\n      // Import data using storage interface\r\n      let imported = 0;\r\n      const errors: string[] = [];\r\n      \r\n      // Route to appropriate storage method based on table name\r\n      for (const record of backup.data) {\r\n        try {\r\n          if (backup.table === 'campaigns') {\r\n            await storage.createCampaign(record);\r\n          } else if (backup.table === 'contacts') {\r\n            await storage.createContact(record);\r\n          } else if (backup.table === 'users') {\r\n            await storage.createUser(record);\r\n          } else if (backup.table === 'documents') {\r\n            await storage.createDocument(record);\r\n          } else if (backup.table === 'notes') {\r\n            await storage.createNote(record);\r\n          } else {\r\n            // For other tables, try direct database insert\r\n            console.log(`Warning: Using direct insert for table ${backup.table}`);\r\n          }\r\n          imported++;\r\n        } catch (error) {\r\n          const errorMsg = error instanceof Error ? error.message : String(error);\r\n          errors.push(`Row import failed: ${errorMsg}`);\r\n          console.warn(`Warning: Failed to import record -`, errorMsg);\r\n        }\r\n      }\r\n\r\n      res.json({\r\n        success: true,\r\n        message: `Successfully imported ${imported}/${backup.data.length} records for table ${backup.table}`,\r\n        table: backup.table,\r\n        imported,\r\n        total: backup.data.length,\r\n        errors: errors.slice(0, 5)\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Backup import error:', error);\r\n      res.status(500).json({\r\n        error: \"Failed to import backup\",\r\n        message: error instanceof Error ? error.message : String(error)\r\n      });\r\n    }\r\n  });\r\n\r\n  // Database status endpoint\r\n  app.get('/api/backup/status', async (req, res) => {\r\n    try {\r\n      const campaigns = await storage.getCampaigns();\r\n      const contacts = await storage.getContacts();\r\n      const documents = await storage.getDocuments();\r\n      const notes = await storage.getNotes();\r\n\r\n      res.json({\r\n        success: true,\r\n        tableCounts: {\r\n          campaigns: campaigns.length,\r\n          contacts: contacts.length,\r\n          documents: documents.length,\r\n          notes: notes.length\r\n        },\r\n        totalRecords: campaigns.length + contacts.length + documents.length + notes.length\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error getting backup status:', error);\r\n      res.status(500).json({\r\n        error: \"Failed to get backup status\",\r\n        message: error instanceof Error ? error.message : String(error)\r\n      });\r\n    }\r\n  });\r\n\r\n  // Data recovery endpoint\r\n  app.post('/api/recovery/campaigns', async (req, res) => {\r\n    try {\r\n      console.log('Starting campaign data recovery...');\r\n      const { recoverAllCampaigns } = await import('./utils/dataRecovery.js');\r\n      const result = await recoverAllCampaigns();\r\n      \r\n      res.json({\r\n        message: 'Campaign recovery completed',\r\n        recovered: result.recovered,\r\n        failed: result.failed,\r\n        total: result.recovered + result.failed\r\n      });\r\n    } catch (error) {\r\n      console.error('Recovery error:', error);\r\n      res.status(500).json({ message: 'Failed to recover campaigns' });\r\n    }\r\n  });\r\n\r\n  // Single campaign recovery endpoint\r\n  app.post('/api/recovery/campaigns/:id', async (req, res) => {\r\n    try {\r\n      const campaignId = parseInt(req.params.id);\r\n      console.log(`Starting recovery for campaign ${campaignId}...`);\r\n      \r\n      const { recoverCampaignData } = await import('./utils/dataRecovery.js');\r\n      const success = await recoverCampaignData(campaignId);\r\n      \r\n      if (success) {\r\n        res.json({ message: `Campaign ${campaignId} recovered successfully` });\r\n      } else {\r\n        res.status(400).json({ message: `Failed to recover campaign ${campaignId}` });\r\n      }\r\n    } catch (error) {\r\n      console.error('Single recovery error:', error);\r\n      res.status(500).json({ message: 'Failed to recover campaign' });\r\n    }\r\n  });\r\n\r\n  // Import the Duggu chatbot service for read-only database access\r\n\r\n  // External Database Schema Inspection Routes\r\n  \r\n  // Get all tables in the external database\r\n  app.get('/api/duggu/inspect/tables', async (req, res) => {\r\n    try {\r\n      const tables = await externalDbInspector.getTables();\r\n      res.json({ tables });\r\n    } catch (error) {\r\n      console.error('Error getting tables:', error);\r\n      res.status(500).json({ message: 'Failed to get tables' });\r\n    }\r\n  });\r\n\r\n  // Get schema for a specific table\r\n  app.get('/api/duggu/inspect/schema/:tableName', async (req, res) => {\r\n    try {\r\n      const { tableName } = req.params;\r\n      const schema = await externalDbInspector.getTableSchema(tableName);\r\n      res.json({ tableName, schema });\r\n    } catch (error) {\r\n      console.error('Error getting table schema:', error);\r\n      res.status(500).json({ message: 'Failed to get table schema' });\r\n    }\r\n  });\r\n\r\n  // Find tables that likely contain contact information\r\n  app.get('/api/duggu/inspect/contact-tables', async (req, res) => {\r\n    try {\r\n      const contactTables = await externalDbInspector.findContactTables();\r\n      res.json({ contactTables });\r\n    } catch (error) {\r\n      console.error('Error finding contact tables:', error);\r\n      res.status(500).json({ message: 'Failed to find contact tables' });\r\n    }\r\n  });\r\n\r\n  // Get sample data from a table\r\n  app.get('/api/duggu/inspect/sample/:tableName', async (req, res) => {\r\n    try {\r\n      const { tableName } = req.params;\r\n      const limit = parseInt(req.query.limit as string) || 3;\r\n      const sampleData = await externalDbInspector.getSampleData(tableName, limit);\r\n      res.json({ tableName, sampleData });\r\n    } catch (error) {\r\n      console.error('Error getting sample data:', error);\r\n      res.status(500).json({ message: 'Failed to get sample data' });\r\n    }\r\n  });\r\n\r\n  // Duggu Chatbot API Routes - Read-only database access\r\n  \r\n  // Search contacts (read-only for chatbot) - AI-powered advanced search across all 37 contact fields\r\n  app.get('/api/duggu/contacts/search', async (req, res) => {\r\n    try {\r\n      const { q: query, limit = 100 } = req.query;\r\n      \r\n      if (!query || typeof query !== 'string') {\r\n        return res.status(400).json({ message: 'Search query is required' });\r\n      }\r\n\r\n      // Use advanced AI-powered search that understands natural language and searches all 37 columns\r\n      const result = await advancedContactSearchService.searchContacts(query, parseInt(limit as string));\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot contact search error:', error);\r\n      res.status(500).json({ message: 'Failed to search contacts' });\r\n    }\r\n  });\r\n\r\n  // Get search suggestions for auto-complete (AI-powered)\r\n  app.get('/api/duggu/contacts/suggestions', async (req, res) => {\r\n    try {\r\n      const { q: query, field, limit = 10 } = req.query;\r\n      \r\n      if (!query || typeof query !== 'string') {\r\n        return res.status(400).json({ message: 'Query is required' });\r\n      }\r\n      \r\n      const validFields = ['company', 'title', 'industry', 'city'];\r\n      const targetField = (field as string) || 'company';\r\n      \r\n      if (!validFields.includes(targetField)) {\r\n        return res.status(400).json({ message: 'Invalid field. Must be one of: company, title, industry, city' });\r\n      }\r\n      \r\n      const suggestions = await advancedContactSearchService.getSuggestions(\r\n        query,\r\n        targetField as 'company' | 'title' | 'industry' | 'city',\r\n        parseInt(limit as string)\r\n      );\r\n      \r\n      res.json({ suggestions, field: targetField });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get suggestions error:', error);\r\n      res.status(500).json({ message: 'Failed to get suggestions' });\r\n    }\r\n  });\r\n\r\n  // Get all contacts (read-only for chatbot)\r\n  app.get('/api/duggu/contacts', async (req, res) => {\r\n    try {\r\n      const { limit = 100, offset = 0 } = req.query;\r\n      const result = await externalDugguService.getAllContacts(parseInt(limit as string), parseInt(offset as string));\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get contacts error:', error);\r\n      res.status(500).json({ message: 'Failed to get contacts' });\r\n    }\r\n  });\r\n\r\n  // Search pets (read-only for chatbot)\r\n  app.get('/api/duggu/pets/search', async (req, res) => {\r\n    try {\r\n      const { q: query, limit = 50 } = req.query;\r\n      \r\n      if (!query || typeof query !== 'string') {\r\n        return res.status(400).json({ message: 'Search query is required' });\r\n      }\r\n\r\n      const pets = await dugguChatbotService.searchPets(query, parseInt(limit as string));\r\n      res.json({ pets, total: pets.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot pet search error:', error);\r\n      res.status(500).json({ message: 'Failed to search pets' });\r\n    }\r\n  });\r\n\r\n  // Get all pets (read-only for chatbot)\r\n  app.get('/api/duggu/pets', async (req, res) => {\r\n    try {\r\n      const { limit = 50 } = req.query;\r\n      const pets = await dugguChatbotService.getAllPets(parseInt(limit as string));\r\n      res.json({ pets, total: pets.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get pets error:', error);\r\n      res.status(500).json({ message: 'Failed to get pets' });\r\n    }\r\n  });\r\n\r\n  // Get pet by ID (read-only for chatbot)\r\n  app.get('/api/duggu/pets/:id', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const pet = await dugguChatbotService.getPetById(id);\r\n      \r\n      if (!pet) {\r\n        return res.status(404).json({ message: 'Pet not found' });\r\n      }\r\n      \r\n      res.json(pet);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get pet error:', error);\r\n      res.status(500).json({ message: 'Failed to get pet' });\r\n    }\r\n  });\r\n\r\n  // Get pet health records (read-only for chatbot)\r\n  app.get('/api/duggu/health-records', async (req, res) => {\r\n    try {\r\n      const { petId, limit = 50 } = req.query;\r\n      const petIdNum = petId ? parseInt(petId as string) : undefined;\r\n      const records = await dugguChatbotService.getPetHealthRecords(petIdNum, parseInt(limit as string));\r\n      res.json({ healthRecords: records, total: records.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get health records error:', error);\r\n      res.status(500).json({ message: 'Failed to get health records' });\r\n    }\r\n  });\r\n\r\n  // Get pet activities (read-only for chatbot)\r\n  app.get('/api/duggu/activities', async (req, res) => {\r\n    try {\r\n      const { petId, limit = 50 } = req.query;\r\n      const petIdNum = petId ? parseInt(petId as string) : undefined;\r\n      const activities = await dugguChatbotService.getPetActivities(petIdNum, parseInt(limit as string));\r\n      res.json({ activities, total: activities.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get activities error:', error);\r\n      res.status(500).json({ message: 'Failed to get activities' });\r\n    }\r\n  });\r\n\r\n  // Get chat sessions (read-only for chatbot)\r\n  app.get('/api/duggu/chat-sessions', async (req, res) => {\r\n    try {\r\n      const { limit = 50 } = req.query;\r\n      const sessions = await dugguChatbotService.getChatSessions(parseInt(limit as string));\r\n      res.json({ chatSessions: sessions, total: sessions.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get chat sessions error:', error);\r\n      res.status(500).json({ message: 'Failed to get chat sessions' });\r\n    }\r\n  });\r\n\r\n  // Get chat messages for a session (read-only for chatbot)\r\n  app.get('/api/duggu/chat-sessions/:sessionId/messages', async (req, res) => {\r\n    try {\r\n      const { sessionId } = req.params;\r\n      const { limit = 100 } = req.query;\r\n      const messages = await dugguChatbotService.getChatMessages(sessionId, parseInt(limit as string));\r\n      res.json({ messages, total: messages.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get messages error:', error);\r\n      res.status(500).json({ message: 'Failed to get chat messages' });\r\n    }\r\n  });\r\n\r\n  // Get campaigns (read-only for chatbot)\r\n  app.get('/api/duggu/campaigns', async (req, res) => {\r\n    try {\r\n      const { limit = 50 } = req.query;\r\n      const campaigns = await dugguChatbotService.getAllCampaigns(parseInt(limit as string));\r\n      res.json({ campaigns, total: campaigns.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get campaigns error:', error);\r\n      res.status(500).json({ message: 'Failed to get campaigns' });\r\n    }\r\n  });\r\n\r\n  // Get campaign by ID (read-only for chatbot)\r\n  app.get('/api/duggu/campaigns/:id', async (req, res) => {\r\n    try {\r\n      const id = parseInt(req.params.id);\r\n      const campaign = await dugguChatbotService.getCampaignById(id);\r\n      \r\n      if (!campaign) {\r\n        return res.status(404).json({ message: 'Campaign not found' });\r\n      }\r\n      \r\n      res.json(campaign);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get campaign error:', error);\r\n      res.status(500).json({ message: 'Failed to get campaign' });\r\n    }\r\n  });\r\n\r\n  // Get contact statistics (read-only for chatbot)\r\n  app.get('/api/duggu/statistics/contacts', async (req, res) => {\r\n    try {\r\n      const stats = await externalDugguService.getContactStatistics();\r\n      res.json(stats);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get contact statistics error:', error);\r\n      res.status(500).json({ message: 'Failed to get contact statistics' });\r\n    }\r\n  });\r\n\r\n  // Get general statistics (read-only for chatbot)\r\n  app.get('/api/duggu/statistics/general', async (req, res) => {\r\n    try {\r\n      const stats = await externalDugguService.getContactStatistics();\r\n      res.json(stats);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get general statistics error:', error);\r\n      res.status(500).json({ message: 'Failed to get general statistics' });\r\n    }\r\n  });\r\n\r\n  // Additional External Database Endpoints for Duggu\r\n  \r\n  // Get contacts by company\r\n  app.get('/api/duggu/contacts/company/:company', async (req, res) => {\r\n    try {\r\n      const { company } = req.params;\r\n      const limit = parseInt(req.query.limit as string) || 50;\r\n      const result = await externalDugguService.getContactsByCompany(company, limit);\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get contacts by company error:', error);\r\n      res.status(500).json({ message: 'Failed to get contacts by company' });\r\n    }\r\n  });\r\n\r\n  // Get contacts by industry\r\n  app.get('/api/duggu/contacts/industry/:industry', async (req, res) => {\r\n    try {\r\n      const { industry } = req.params;\r\n      const limit = parseInt(req.query.limit as string) || 50;\r\n      const result = await externalDugguService.getContactsByIndustry(industry, limit);\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get contacts by industry error:', error);\r\n      res.status(500).json({ message: 'Failed to get contacts by industry' });\r\n    }\r\n  });\r\n\r\n  // Get high-value contacts (lead score based)\r\n  app.get('/api/duggu/contacts/high-value', async (req, res) => {\r\n    try {\r\n      const minScore = parseFloat(req.query.minScore as string) || 7.0;\r\n      const limit = parseInt(req.query.limit as string) || 50;\r\n      const result = await externalDugguService.getHighValueContacts(minScore, limit);\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get high-value contacts error:', error);\r\n      res.status(500).json({ message: 'Failed to get high-value contacts' });\r\n    }\r\n  });\r\n\r\n  // Get contact by ID (read-only for chatbot) - MUST BE LAST to avoid catching specific routes\r\n  app.get('/api/duggu/contacts/:id', async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      const contact = await externalDugguService.getContactById(id);\r\n      \r\n      if (!contact) {\r\n        return res.status(404).json({ message: 'Contact not found' });\r\n      }\r\n      \r\n      res.json(contact);\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get contact error:', error);\r\n      res.status(500).json({ message: 'Failed to get contact' });\r\n    }\r\n  });\r\n\r\n  // Get top companies by contact count\r\n  app.get('/api/duggu/companies/top', async (req, res) => {\r\n    try {\r\n      const limit = parseInt(req.query.limit as string) || 10;\r\n      const companies = await externalDugguService.getTopCompanies(limit);\r\n      res.json({ companies, total: companies.length });\r\n    } catch (error) {\r\n      console.error('Duggu chatbot get top companies error:', error);\r\n      res.status(500).json({ message: 'Failed to get top companies' });\r\n    }\r\n  });\r\n\r\n  // Natural Language Query Routes for Duggu AI-Powered Database Queries\r\n  \r\n  // Get database schema for NL query context\r\n  app.get('/api/duggu/nl/schema', async (req, res) => {\r\n    try {\r\n      const refresh = req.query.refresh === 'true';\r\n      const schema = await nlQueryService.getDatabaseSchema(refresh);\r\n      res.json({ schema, timestamp: new Date().toISOString() });\r\n    } catch (error) {\r\n      console.error('Error getting database schema:', error);\r\n      res.status(500).json({ message: 'Failed to retrieve database schema' });\r\n    }\r\n  });\r\n\r\n  // Analyze natural language query and generate SQL\r\n  app.post('/api/duggu/nl/analyze', async (req, res) => {\r\n    try {\r\n      const { query } = req.body;\r\n      \r\n      if (!query || typeof query !== 'string' || query.trim().length === 0) {\r\n        return res.status(400).json({ message: 'Query text is required' });\r\n      }\r\n\r\n      const queryIntent = await nlQueryService.analyzeQuery(query);\r\n      res.json(queryIntent);\r\n    } catch (error: any) {\r\n      console.error('Error analyzing natural language query:', error);\r\n      res.status(500).json({ \r\n        message: error.message || 'Failed to analyze query',\r\n        error: error.message \r\n      });\r\n    }\r\n  });\r\n\r\n  // Execute a confirmed SQL query (read-only)\r\n  app.post('/api/duggu/nl/execute', async (req, res) => {\r\n    try {\r\n      const { sql, userQuery } = req.body;\r\n      \r\n      if (!sql || typeof sql !== 'string' || sql.trim().length === 0) {\r\n        return res.status(400).json({ message: 'SQL query is required' });\r\n      }\r\n\r\n      const result = await nlQueryService.executeQuery(sql, userQuery);\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('Error executing query:', error);\r\n      res.status(500).json({ message: 'Failed to execute query' });\r\n    }\r\n  });\r\n\r\n  // Store feedback for query learning\r\n  app.post('/api/duggu/nl/feedback', async (req, res) => {\r\n    try {\r\n      const { userQuery, generatedSQL, wasAccurate, userFeedback } = req.body;\r\n      \r\n      if (!userQuery || !generatedSQL || typeof wasAccurate !== 'boolean') {\r\n        return res.status(400).json({ \r\n          message: 'userQuery, generatedSQL, and wasAccurate (boolean) are required' \r\n        });\r\n      }\r\n\r\n      await nlQueryService.storeFeedback(userQuery, generatedSQL, wasAccurate, userFeedback);\r\n      res.json({ success: true, message: 'Feedback stored successfully' });\r\n    } catch (error) {\r\n      console.error('Error storing feedback:', error);\r\n      res.status(500).json({ message: 'Failed to store feedback' });\r\n    }\r\n  });\r\n\r\n  // Get query suggestions based on schema\r\n  app.get('/api/duggu/nl/suggestions', async (req, res) => {\r\n    try {\r\n      const suggestions = await nlQueryService.getQuerySuggestions();\r\n      res.json({ suggestions });\r\n    } catch (error) {\r\n      console.error('Error getting query suggestions:', error);\r\n      res.status(500).json({ message: 'Failed to get suggestions' });\r\n    }\r\n  });\r\n\r\n  // Advanced Search Intelligence Routes (Apollo.io / ZoomInfo style)\r\n  \r\n  // Zod schemas for validation\r\n  const searchFilterSchema = z.object({\r\n    column: z.string().regex(/^[a-zA-Z_][a-zA-Z0-9_-]*$/, 'Invalid column name'),\r\n    operator: z.enum(['equals', 'not_equals', 'contains', 'not_contains', 'starts_with', 'ends_with', \r\n                       'greater_than', 'less_than', 'greater_or_equal', 'less_or_equal', \r\n                       'is_null', 'is_not_null', 'in', 'not_in', 'between']),\r\n    value: z.any().optional(),\r\n    value2: z.any().optional(),\r\n  });\r\n\r\n  const searchQuerySchema = z.object({\r\n    table: z.string().regex(/^[a-zA-Z_][a-zA-Z0-9_-]*$/, 'Invalid table name'),\r\n    filters: z.array(searchFilterSchema).default([]),\r\n    sortBy: z.string().regex(/^[a-zA-Z_][a-zA-Z0-9_-]*$/, 'Invalid sort column').optional(),\r\n    sortOrder: z.enum(['asc', 'desc']).optional(),\r\n    page: z.number().int().positive().optional(),\r\n    pageSize: z.number().int().positive().max(1000).optional(),\r\n    database: z.enum(['main', 'readonly']).optional(),\r\n  });\r\n  \r\n  // Get all available tables from a database\r\n  app.get('/api/advanced-search/tables', async (req, res) => {\r\n    try {\r\n      const database = (req.query.database as 'main' | 'readonly') || 'main';\r\n      \r\n      // Validate database parameter\r\n      if (!['main', 'readonly'].includes(database)) {\r\n        return res.status(400).json({ message: 'Invalid database parameter' });\r\n      }\r\n      \r\n      const tables = await advancedSearchService.getTables(database);\r\n      res.json({ tables, database });\r\n    } catch (error) {\r\n      console.error('Error getting tables:', error);\r\n      res.status(500).json({ message: 'Failed to get tables' });\r\n    }\r\n  });\r\n\r\n  // Get metadata for a specific table\r\n  app.get('/api/advanced-search/tables/:tableName/metadata', async (req, res) => {\r\n    try {\r\n      const { tableName } = req.params;\r\n      const database = (req.query.database as 'main' | 'readonly') || 'main';\r\n      \r\n      // Validate table name\r\n      if (!/^[a-zA-Z_][a-zA-Z0-9_-]*$/.test(tableName)) {\r\n        return res.status(400).json({ message: 'Invalid table name' });\r\n      }\r\n      \r\n      // Validate database parameter\r\n      if (!['main', 'readonly'].includes(database)) {\r\n        return res.status(400).json({ message: 'Invalid database parameter' });\r\n      }\r\n      \r\n      const metadata = await advancedSearchService.getTableMetadata(tableName, database);\r\n      res.json(metadata);\r\n    } catch (error) {\r\n      console.error(`Error getting metadata for table ${req.params.tableName}:`, error);\r\n      res.status(500).json({ message: 'Failed to get table metadata' });\r\n    }\r\n  });\r\n\r\n  // Get all tables with metadata\r\n  app.get('/api/advanced-search/metadata', async (req, res) => {\r\n    try {\r\n      const database = (req.query.database as 'main' | 'readonly') || 'main';\r\n      \r\n      // Validate database parameter\r\n      if (!['main', 'readonly'].includes(database)) {\r\n        return res.status(400).json({ message: 'Invalid database parameter' });\r\n      }\r\n      \r\n      const metadata = await advancedSearchService.getAllTablesMetadata(database);\r\n      res.json({ tables: metadata, database });\r\n    } catch (error) {\r\n      console.error('Error getting all tables metadata:', error);\r\n      res.status(500).json({ message: 'Failed to get tables metadata' });\r\n    }\r\n  });\r\n\r\n  // Execute advanced search with filters\r\n  app.post('/api/advanced-search/search', async (req, res) => {\r\n    try {\r\n      // Validate request body with Zod\r\n      const validation = searchQuerySchema.safeParse(req.body);\r\n      \r\n      if (!validation.success) {\r\n        return res.status(400).json({ \r\n          message: 'Invalid search query', \r\n          errors: validation.error.errors \r\n        });\r\n      }\r\n\r\n      const searchQuery = validation.data as any;\r\n      const result = await advancedSearchService.search(searchQuery);\r\n      res.json(result);\r\n    } catch (error: any) {\r\n      console.error('Error executing advanced search:', error);\r\n      res.status(500).json({ \r\n        message: error.message || 'Failed to execute search' \r\n      });\r\n    }\r\n  });\r\n\r\n  // Export search results to CSV\r\n  app.post('/api/advanced-search/export', async (req, res) => {\r\n    try {\r\n      // Validate request body with Zod\r\n      const validation = searchQuerySchema.safeParse(req.body);\r\n      \r\n      if (!validation.success) {\r\n        return res.status(400).json({ \r\n          message: 'Invalid search query', \r\n          errors: validation.error.errors \r\n        });\r\n      }\r\n\r\n      const searchQuery = validation.data as any;\r\n      const csv = await advancedSearchService.exportToCSV(searchQuery);\r\n      \r\n      // Set headers for CSV download\r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"export_${searchQuery.table}_${Date.now()}.csv\"`);\r\n      res.send(csv);\r\n    } catch (error: any) {\r\n      console.error('Error exporting search results:', error);\r\n      res.status(500).json({ \r\n        message: error.message || 'Failed to export search results' \r\n      });\r\n    }\r\n  });\r\n\r\n  // Advanced Contacts Filter Routes (Apollo.io / ZoomInfo style)\r\n  const { contactsFilterService, FILTER_TEMPLATES } = await import('./services/contactsFilterService');\r\n\r\n  // Get available filter templates\r\n  app.get('/api/contacts-filter/templates', (req, res) => {\r\n    res.json({ templates: FILTER_TEMPLATES });\r\n  });\r\n\r\n  // Get field suggestions for autocomplete\r\n  app.get('/api/contacts-filter/suggestions/:field', async (req, res) => {\r\n    try {\r\n      const { field } = req.params;\r\n      const { search = '' } = req.query;\r\n      \r\n      const suggestions = await contactsFilterService.getFieldSuggestions(\r\n        field,\r\n        search as string,\r\n        20\r\n      );\r\n      \r\n      res.json({ field, suggestions });\r\n    } catch (error: any) {\r\n      console.error('Error getting field suggestions:', error);\r\n      res.status(400).json({ message: error.message || 'Failed to get suggestions' });\r\n    }\r\n  });\r\n\r\n  // Get field aggregations for smart filters\r\n  app.get('/api/contacts-filter/aggregations', async (req, res) => {\r\n    try {\r\n      const aggregations = await contactsFilterService.getFieldAggregations();\r\n      res.json(aggregations);\r\n    } catch (error: any) {\r\n      console.error('Error getting aggregations:', error);\r\n      res.status(500).json({ message: error.message || 'Failed to get aggregations' });\r\n    }\r\n  });\r\n\r\n  // Get contact statistics\r\n  app.get('/api/contacts-filter/statistics', async (req, res) => {\r\n    try {\r\n      const statistics = await contactsFilterService.getStatistics();\r\n      res.json(statistics);\r\n    } catch (error: any) {\r\n      console.error('Error getting statistics:', error);\r\n      res.status(500).json({ message: error.message || 'Failed to get statistics' });\r\n    }\r\n  });\r\n\r\n  // Zod schema for contacts filter search\r\n  const contactFilterSchema = z.object({\r\n    column: z.string().regex(/^[a-zA-Z_][a-zA-Z0-9_]*$/, 'Invalid column name'),\r\n    operator: z.enum(['equals', 'not_equals', 'contains', 'not_contains', 'starts_with', 'ends_with', \r\n                       'greater_than', 'less_than', 'greater_or_equal', 'less_or_equal', \r\n                       'is_null', 'is_not_null', 'in', 'not_in', 'between']),\r\n    value: z.any().optional(),\r\n    value2: z.any().optional(),\r\n  });\r\n\r\n  const contactSearchQuerySchema = z.object({\r\n    filters: z.array(contactFilterSchema).default([]),\r\n    filterGroups: z.array(z.object({\r\n      filters: z.array(contactFilterSchema),\r\n      combineWith: z.enum(['AND', 'OR']),\r\n    })).optional(),\r\n    globalSearch: z.string().optional(),\r\n    sortBy: z.string().regex(/^[a-zA-Z_][a-zA-Z0-9_]*$/, 'Invalid sort column').optional(),\r\n    sortOrder: z.enum(['asc', 'desc']).optional(),\r\n    page: z.number().int().positive().optional(),\r\n    pageSize: z.number().int().positive().max(500).optional(),\r\n  });\r\n\r\n  // Search contacts with advanced filters\r\n  app.post('/api/contacts-filter/search', async (req, res) => {\r\n    try {\r\n      // Validate request body with Zod\r\n      const validation = contactSearchQuerySchema.safeParse(req.body);\r\n      \r\n      if (!validation.success) {\r\n        return res.status(400).json({ \r\n          message: 'Invalid search query', \r\n          errors: validation.error.errors \r\n        });\r\n      }\r\n\r\n      const searchQuery = validation.data;\r\n      const result = await contactsFilterService.search(searchQuery);\r\n      res.json(result);\r\n    } catch (error: any) {\r\n      console.error('Error searching contacts:', error);\r\n      res.status(500).json({ \r\n        message: error.message || 'Failed to search contacts' \r\n      });\r\n    }\r\n  });\r\n\r\n  // Export filtered contacts to CSV\r\n  app.post('/api/contacts-filter/export', async (req, res) => {\r\n    try {\r\n      const searchQuery = req.body;\r\n      const csv = await contactsFilterService.exportToCSV(searchQuery);\r\n      \r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"contacts_export_${Date.now()}.csv\"`);\r\n      res.send(csv);\r\n    } catch (error: any) {\r\n      console.error('Error exporting contacts:', error);\r\n      res.status(500).json({ \r\n        message: error.message || 'Failed to export contacts' \r\n      });\r\n    }\r\n  });\r\n\r\n  // =============================================\r\n  // BLOG MANAGEMENT API ROUTES\r\n  // =============================================\r\n\r\n  // Get blog dashboard stats\r\n  app.get('/api/admin/blog/stats', requireAdmin, async (req, res) => {\r\n    try {\r\n      const [postsCount] = await db.select({ count: sql<number>`count(*)` }).from(schema.blogPosts);\r\n      const [publishedCount] = await db.select({ count: sql<number>`count(*)` }).from(schema.blogPosts).where(eq(schema.blogPosts.status, 'published'));\r\n      const [draftCount] = await db.select({ count: sql<number>`count(*)` }).from(schema.blogPosts).where(eq(schema.blogPosts.status, 'draft'));\r\n      const [scheduledCount] = await db.select({ count: sql<number>`count(*)` }).from(schema.blogPosts).where(eq(schema.blogPosts.status, 'scheduled'));\r\n      const [subscribersCount] = await db.select({ count: sql<number>`count(*)` }).from(schema.blogSubscribers);\r\n      const [totalViews] = await db.select({ sum: sql<number>`COALESCE(SUM(view_count), 0)` }).from(schema.blogPosts);\r\n      const [commentsCount] = await db.select({ count: sql<number>`count(*)` }).from(schema.blogComments);\r\n      const [totalRevenueResult] = await db.select({ sum: sql<number>`COALESCE(SUM(amount), 0)` }).from(schema.blogRevenue);\r\n      const [avgSeoResult] = await db.select({ avg: sql<number>`COALESCE(AVG(seo_score), 0)` }).from(schema.blogPosts);\r\n\r\n      const topPosts = await db\r\n        .select({\r\n          id: schema.blogPosts.id,\r\n          title: schema.blogPosts.title,\r\n          views: schema.blogPosts.viewCount,\r\n          shares: schema.blogPosts.shareCount,\r\n          comments: schema.blogPosts.commentCount\r\n        })\r\n        .from(schema.blogPosts)\r\n        .where(eq(schema.blogPosts.status, 'published'))\r\n        .orderBy(sql`${schema.blogPosts.viewCount} DESC`)\r\n        .limit(5);\r\n\r\n      const recentPosts = await db\r\n        .select({\r\n          id: schema.blogPosts.id,\r\n          title: schema.blogPosts.title,\r\n          slug: schema.blogPosts.slug,\r\n          status: schema.blogPosts.status,\r\n          views: schema.blogPosts.viewCount,\r\n          seoScore: schema.blogPosts.seoScore,\r\n          publishedAt: schema.blogPosts.publishedAt,\r\n          createdAt: schema.blogPosts.createdAt\r\n        })\r\n        .from(schema.blogPosts)\r\n        .orderBy(sql`${schema.blogPosts.createdAt} DESC`)\r\n        .limit(10);\r\n\r\n      const categoryDistribution = await db\r\n        .select({\r\n          name: schema.blogCategories.name,\r\n          count: sql<number>`count(${schema.blogPosts.id})`\r\n        })\r\n        .from(schema.blogCategories)\r\n        .leftJoin(schema.blogPosts, eq(schema.blogCategories.id, schema.blogPosts.categoryId))\r\n        .groupBy(schema.blogCategories.id, schema.blogCategories.name)\r\n        .orderBy(sql`count(${schema.blogPosts.id}) DESC`)\r\n        .limit(6);\r\n\r\n      const now = new Date();\r\n      const trafficData = [];\r\n      const revenueData = [];\r\n      for (let i = 6; i >= 0; i--) {\r\n        const date = new Date(now);\r\n        date.setDate(date.getDate() - i);\r\n        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\r\n        trafficData.push({ date: dateStr, views: 0, visitors: 0 });\r\n        revenueData.push({ date: dateStr, affiliate: 0, ads: 0, sponsored: 0 });\r\n      }\r\n\r\n      res.json({\r\n        totalPosts: Number(postsCount.count) || 0,\r\n        publishedPosts: Number(publishedCount.count) || 0,\r\n        draftPosts: Number(draftCount.count) || 0,\r\n        scheduledPosts: Number(scheduledCount.count) || 0,\r\n        totalViews: Number(totalViews.sum) || 0,\r\n        totalComments: Number(commentsCount.count) || 0,\r\n        totalSubscribers: Number(subscribersCount.count) || 0,\r\n        totalRevenue: Number(totalRevenueResult.sum) || 0,\r\n        avgSeoScore: Math.round(Number(avgSeoResult.avg) || 0),\r\n        topPosts: topPosts.map(p => ({\r\n          id: p.id,\r\n          title: p.title,\r\n          views: p.views || 0,\r\n          shares: p.shares || 0,\r\n          comments: p.comments || 0\r\n        })),\r\n        trafficData,\r\n        revenueData,\r\n        categoryDistribution: categoryDistribution.map(c => ({\r\n          name: c.name,\r\n          count: Number(c.count) || 0\r\n        })),\r\n        recentPosts: recentPosts.map(p => ({\r\n          id: p.id,\r\n          title: p.title,\r\n          slug: p.slug,\r\n          status: p.status || 'draft',\r\n          views: p.views || 0,\r\n          seoScore: p.seoScore || 0,\r\n          publishedAt: p.publishedAt,\r\n          createdAt: p.createdAt\r\n        }))\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching blog stats:', error);\r\n      res.status(500).json({ message: 'Failed to fetch blog stats' });\r\n    }\r\n  });\r\n\r\n  // Get all blog posts with pagination and filters\r\n  app.get('/api/admin/blog/posts', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { limit = 20, offset = 0, status, categoryId, authorId, search } = req.query;\r\n      \r\n      const conditions = [];\r\n      if (status && status !== 'all') {\r\n        conditions.push(eq(schema.blogPosts.status, status as string));\r\n      }\r\n      if (categoryId) {\r\n        conditions.push(eq(schema.blogPosts.categoryId, parseInt(categoryId as string)));\r\n      }\r\n      if (authorId) {\r\n        conditions.push(eq(schema.blogPosts.authorId, parseInt(authorId as string)));\r\n      }\r\n      if (search) {\r\n        conditions.push(sql`(${schema.blogPosts.title} ILIKE ${'%' + search + '%'} OR ${schema.blogPosts.content} ILIKE ${'%' + search + '%'})`);\r\n      }\r\n\r\n      const posts = await db\r\n        .select()\r\n        .from(schema.blogPosts)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined)\r\n        .orderBy(sql`${schema.blogPosts.createdAt} DESC`)\r\n        .limit(parseInt(limit as string))\r\n        .offset(parseInt(offset as string));\r\n\r\n      const [countResult] = await db\r\n        .select({ count: sql<number>`count(*)` })\r\n        .from(schema.blogPosts)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined);\r\n\r\n      res.json({\r\n        posts,\r\n        total: Number(countResult.count) || 0,\r\n        limit: parseInt(limit as string),\r\n        offset: parseInt(offset as string)\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching blog posts:', error);\r\n      res.status(500).json({ message: 'Failed to fetch blog posts' });\r\n    }\r\n  });\r\n\r\n  // Get single blog post by ID\r\n  app.get('/api/admin/blog/posts/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      const [post] = await db\r\n        .select()\r\n        .from(schema.blogPosts)\r\n        .where(eq(schema.blogPosts.id, parseInt(id)));\r\n\r\n      if (!post) {\r\n        return res.status(404).json({ message: 'Post not found' });\r\n      }\r\n\r\n      res.json(post);\r\n    } catch (error) {\r\n      console.error('Error fetching blog post:', error);\r\n      res.status(500).json({ message: 'Failed to fetch blog post' });\r\n    }\r\n  });\r\n\r\n  // Create new blog post\r\n  app.post('/api/admin/blog/posts', requireAdmin, async (req, res) => {\r\n    try {\r\n      const postData = req.body;\r\n      \r\n      const slug = postData.slug || postData.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n      \r\n      const [newPost] = await db\r\n        .insert(schema.blogPosts)\r\n        .values({\r\n          ...postData,\r\n          slug,\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        })\r\n        .returning();\r\n\r\n      await logActivity({\r\n        req,\r\n        activityType: 'blog',\r\n        action: 'Created new blog post',\r\n        resourceType: 'blog_post',\r\n        resourceId: String(newPost.id),\r\n        details: { title: newPost.title, status: newPost.status }\r\n      });\r\n\r\n      res.json(newPost);\r\n    } catch (error) {\r\n      console.error('Error creating blog post:', error);\r\n      res.status(500).json({ message: 'Failed to create blog post' });\r\n    }\r\n  });\r\n\r\n  // Update blog post\r\n  app.put('/api/admin/blog/posts/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      const postData = req.body;\r\n\r\n      const [updatedPost] = await db\r\n        .update(schema.blogPosts)\r\n        .set({\r\n          ...postData,\r\n          updatedAt: new Date()\r\n        })\r\n        .where(eq(schema.blogPosts.id, parseInt(id)))\r\n        .returning();\r\n\r\n      if (!updatedPost) {\r\n        return res.status(404).json({ message: 'Post not found' });\r\n      }\r\n\r\n      await logActivity({\r\n        req,\r\n        activityType: 'blog',\r\n        action: 'Updated blog post',\r\n        resourceType: 'blog_post',\r\n        resourceId: id,\r\n        details: { title: updatedPost.title, status: updatedPost.status }\r\n      });\r\n\r\n      res.json(updatedPost);\r\n    } catch (error) {\r\n      console.error('Error updating blog post:', error);\r\n      res.status(500).json({ message: 'Failed to update blog post' });\r\n    }\r\n  });\r\n\r\n  // Delete blog post\r\n  app.delete('/api/admin/blog/posts/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n\r\n      const [deleted] = await db\r\n        .delete(schema.blogPosts)\r\n        .where(eq(schema.blogPosts.id, parseInt(id)))\r\n        .returning();\r\n\r\n      if (!deleted) {\r\n        return res.status(404).json({ message: 'Post not found' });\r\n      }\r\n\r\n      await logActivity({\r\n        req,\r\n        activityType: 'blog',\r\n        action: 'Deleted blog post',\r\n        resourceType: 'blog_post',\r\n        resourceId: id,\r\n        details: { title: deleted.title }\r\n      });\r\n\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error deleting blog post:', error);\r\n      res.status(500).json({ message: 'Failed to delete blog post' });\r\n    }\r\n  });\r\n\r\n  // Get all blog categories\r\n  app.get('/api/admin/blog/categories', requireAdmin, async (req, res) => {\r\n    try {\r\n      const categories = await db.select().from(schema.blogCategories).orderBy(sql`${schema.blogCategories.name} ASC`);\r\n      res.json(categories);\r\n    } catch (error) {\r\n      console.error('Error fetching blog categories:', error);\r\n      res.status(500).json({ message: 'Failed to fetch categories' });\r\n    }\r\n  });\r\n\r\n  // Create blog category\r\n  app.post('/api/admin/blog/categories', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { name, description, color, metaTitle, metaDescription, parentId } = req.body;\r\n      const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n\r\n      const [newCategory] = await db\r\n        .insert(schema.blogCategories)\r\n        .values({ name, slug, description, color, metaTitle, metaDescription, parentId })\r\n        .returning();\r\n\r\n      res.json(newCategory);\r\n    } catch (error) {\r\n      console.error('Error creating blog category:', error);\r\n      res.status(500).json({ message: 'Failed to create category' });\r\n    }\r\n  });\r\n\r\n  // Update blog category\r\n  app.put('/api/admin/blog/categories/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      const { name, description, color, metaTitle, metaDescription, parentId } = req.body;\r\n      const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n\r\n      const [updated] = await db\r\n        .update(schema.blogCategories)\r\n        .set({ name, slug, description, color, metaTitle, metaDescription, parentId, updatedAt: new Date() })\r\n        .where(eq(schema.blogCategories.id, parseInt(id)))\r\n        .returning();\r\n\r\n      res.json(updated);\r\n    } catch (error) {\r\n      console.error('Error updating blog category:', error);\r\n      res.status(500).json({ message: 'Failed to update category' });\r\n    }\r\n  });\r\n\r\n  // Delete blog category\r\n  app.delete('/api/admin/blog/categories/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      await db.delete(schema.blogCategories).where(eq(schema.blogCategories.id, parseInt(id)));\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error deleting blog category:', error);\r\n      res.status(500).json({ message: 'Failed to delete category' });\r\n    }\r\n  });\r\n\r\n  // Get all blog tags\r\n  app.get('/api/admin/blog/tags', requireAdmin, async (req, res) => {\r\n    try {\r\n      const tags = await db.select().from(schema.blogTags).orderBy(sql`${schema.blogTags.name} ASC`);\r\n      res.json(tags);\r\n    } catch (error) {\r\n      console.error('Error fetching blog tags:', error);\r\n      res.status(500).json({ message: 'Failed to fetch tags' });\r\n    }\r\n  });\r\n\r\n  // Create blog tag\r\n  app.post('/api/admin/blog/tags', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { name, description, color } = req.body;\r\n      const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n\r\n      const [newTag] = await db\r\n        .insert(schema.blogTags)\r\n        .values({ name, slug, description, color })\r\n        .returning();\r\n\r\n      res.json(newTag);\r\n    } catch (error) {\r\n      console.error('Error creating blog tag:', error);\r\n      res.status(500).json({ message: 'Failed to create tag' });\r\n    }\r\n  });\r\n\r\n  // Update blog tag\r\n  app.put('/api/admin/blog/tags/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      const { name, description, color } = req.body;\r\n      const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n\r\n      const [updated] = await db\n        .update(schema.blogTags)\n        .set({ name, slug, description, color })\n        .where(eq(schema.blogTags.id, parseInt(id)))\n        .returning();\n\r\n      res.json(updated);\r\n    } catch (error) {\r\n      console.error('Error updating blog tag:', error);\r\n      res.status(500).json({ message: 'Failed to update tag' });\r\n    }\r\n  });\r\n\r\n  // Delete blog tag\r\n  app.delete('/api/admin/blog/tags/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      await db.delete(schema.blogTags).where(eq(schema.blogTags.id, parseInt(id)));\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error deleting blog tag:', error);\r\n      res.status(500).json({ message: 'Failed to delete tag' });\r\n    }\r\n  });\r\n\r\n  // Get all blog authors\r\n  app.get('/api/admin/blog/authors', requireAdmin, async (req, res) => {\r\n    try {\r\n      const authors = await db.select().from(schema.blogAuthors).orderBy(sql`${schema.blogAuthors.name} ASC`);\r\n      res.json(authors);\r\n    } catch (error) {\r\n      console.error('Error fetching blog authors:', error);\r\n      res.status(500).json({ message: 'Failed to fetch authors' });\r\n    }\r\n  });\r\n\r\n  // Create blog author\r\n  app.post('/api/admin/blog/authors', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { name, email, bio, avatar, socialLinks, expertise } = req.body;\r\n\r\n      const [newAuthor] = await db\r\n        .insert(schema.blogAuthors)\r\n        .values({ name, email, bio, avatar, socialLinks, expertise })\r\n        .returning();\r\n\r\n      res.json(newAuthor);\r\n    } catch (error) {\r\n      console.error('Error creating blog author:', error);\r\n      res.status(500).json({ message: 'Failed to create author' });\r\n    }\r\n  });\r\n\r\n  // Update blog author\r\n  app.put('/api/admin/blog/authors/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      const { name, email, bio, avatar, socialLinks, expertise, isActive } = req.body;\r\n\r\n      const [updated] = await db\r\n        .update(schema.blogAuthors)\r\n        .set({ name, email, bio, avatar, socialLinks, expertise, isActive, updatedAt: new Date() })\r\n        .where(eq(schema.blogAuthors.id, parseInt(id)))\r\n        .returning();\r\n\r\n      res.json(updated);\r\n    } catch (error) {\r\n      console.error('Error updating blog author:', error);\r\n      res.status(500).json({ message: 'Failed to update author' });\r\n    }\r\n  });\r\n\r\n  // Delete blog author\r\n  app.delete('/api/admin/blog/authors/:id', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { id } = req.params;\r\n      await db.delete(schema.blogAuthors).where(eq(schema.blogAuthors.id, parseInt(id)));\r\n      res.json({ success: true });\r\n    } catch (error) {\r\n      console.error('Error deleting blog author:', error);\r\n      res.status(500).json({ message: 'Failed to delete author' });\r\n    }\r\n  });\r\n\r\n  // Get blog analytics data\r\n  app.get('/api/admin/blog/analytics', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { startDate, endDate, postId } = req.query;\r\n      \r\n      const conditions = [];\r\n      if (startDate) {\r\n        conditions.push(sql`${schema.blogAnalytics.createdAt} >= ${new Date(startDate as string)}`);\r\n      }\r\n      if (endDate) {\r\n        conditions.push(sql`${schema.blogAnalytics.createdAt} <= ${new Date(endDate as string)}`);\r\n      }\r\n      if (postId) {\r\n        conditions.push(eq(schema.blogAnalytics.postId, parseInt(postId as string)));\r\n      }\r\n\r\n      const analytics = await db\r\n        .select()\r\n        .from(schema.blogAnalytics)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined)\r\n        .orderBy(sql`${schema.blogAnalytics.createdAt} DESC`)\r\n        .limit(1000);\r\n\r\n      const [totals] = await db.select({\n        totalViews: sql<number>`COALESCE(COUNT(*), 0)`,\n        totalUniqueVisitors: sql<number>`COALESCE(COUNT(DISTINCT ${schema.blogAnalytics.sessionId}), 0)`,\n        totalTimeOnPage: sql<number>`COALESCE(AVG(${schema.blogAnalytics.timeOnPage}), 0)`,\n        avgBounceRate: sql<number>`0`\n      }).from(schema.blogAnalytics).where(conditions.length > 0 ? and(...conditions) : undefined);\n\r\n      res.json({\r\n        records: analytics,\r\n        summary: {\r\n          totalViews: Number(totals.totalViews) || 0,\r\n          totalUniqueVisitors: Number(totals.totalUniqueVisitors) || 0,\r\n          avgTimeOnPage: Number(totals.totalTimeOnPage) || 0,\r\n          avgBounceRate: Number(totals.avgBounceRate) || 0\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching blog analytics:', error);\r\n      res.status(500).json({ message: 'Failed to fetch analytics' });\r\n    }\r\n  });\r\n\r\n  // Get blog revenue data\r\n  app.get('/api/admin/blog/revenue', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { startDate, endDate } = req.query;\r\n      \r\n      const conditions = [];\r\n      if (startDate) {\r\n        conditions.push(sql`${schema.blogRevenue.createdAt} >= ${new Date(startDate as string)}`);\r\n      }\r\n      if (endDate) {\r\n        conditions.push(sql`${schema.blogRevenue.createdAt} <= ${new Date(endDate as string)}`);\r\n      }\r\n\r\n      const revenue = await db\r\n        .select()\r\n        .from(schema.blogRevenue)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined)\r\n        .orderBy(sql`${schema.blogRevenue.createdAt} DESC`);\r\n\r\n      const [totals] = await db.select({\r\n        totalRevenue: sql<number>`COALESCE(SUM(${schema.blogRevenue.amount}), 0)`\r\n      }).from(schema.blogRevenue).where(conditions.length > 0 ? and(...conditions) : undefined);\r\n\r\n      res.json({\r\n        records: revenue,\r\n        totalRevenue: Number(totals.totalRevenue) || 0\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching blog revenue:', error);\r\n      res.status(500).json({ message: 'Failed to fetch revenue' });\r\n    }\r\n  });\r\n\r\n  // Get blog subscribers\r\n  app.get('/api/admin/blog/subscribers', requireAdmin, async (req, res) => {\r\n    try {\r\n      const { limit = 50, offset = 0, status } = req.query;\r\n      \r\n      const conditions = [];\r\n      if (status && status !== 'all') {\r\n        conditions.push(eq(schema.blogSubscribers.status, status as string));\r\n      }\r\n\r\n      const subscribers = await db\r\n        .select()\r\n        .from(schema.blogSubscribers)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined)\r\n        .orderBy(sql`${schema.blogSubscribers.subscribedAt} DESC`)\r\n        .limit(parseInt(limit as string))\r\n        .offset(parseInt(offset as string));\r\n\r\n      const [countResult] = await db\r\n        .select({ count: sql<number>`count(*)` })\r\n        .from(schema.blogSubscribers)\r\n        .where(conditions.length > 0 ? and(...conditions) : undefined);\r\n\r\n      res.json({\r\n        subscribers,\r\n        total: Number(countResult.count) || 0\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching blog subscribers:', error);\r\n      res.status(500).json({ message: 'Failed to fetch subscribers' });\r\n    }\r\n  });\r\n\r\n  // Public blog API - Get published posts\r\n  app.get('/api/blog/posts', async (req, res) => {\r\n    try {\r\n      const { limit = 10, offset = 0, category, tag } = req.query;\r\n      \r\n      const conditions = [eq(schema.blogPosts.status, 'published')];\r\n      if (category) {\r\n        conditions.push(eq(schema.blogPosts.categoryId, parseInt(category as string)));\r\n      }\r\n\r\n      const posts = await db\r\n        .select()\r\n        .from(schema.blogPosts)\r\n        .where(and(...conditions))\r\n        .orderBy(sql`${schema.blogPosts.publishedAt} DESC`)\r\n        .limit(parseInt(limit as string))\r\n        .offset(parseInt(offset as string));\r\n\r\n      const [countResult] = await db\r\n        .select({ count: sql<number>`count(*)` })\r\n        .from(schema.blogPosts)\r\n        .where(and(...conditions));\r\n\r\n      res.json({\r\n        posts,\r\n        total: Number(countResult.count) || 0\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching public blog posts:', error);\r\n      res.status(500).json({ message: 'Failed to fetch posts' });\r\n    }\r\n  });\r\n\r\n  // Public blog API - Get single post by slug\r\n  app.get('/api/blog/posts/:slug', async (req, res) => {\r\n    try {\r\n      const { slug } = req.params;\r\n      \r\n      const [post] = await db\r\n        .select()\r\n        .from(schema.blogPosts)\r\n        .where(and(\r\n          eq(schema.blogPosts.slug, slug),\r\n          eq(schema.blogPosts.status, 'published')\r\n        ));\r\n\r\n      if (!post) {\r\n        return res.status(404).json({ message: 'Post not found' });\r\n      }\r\n\r\n      await db\r\n        .update(schema.blogPosts)\r\n        .set({ viewCount: sql`${schema.blogPosts.viewCount} + 1` })\r\n        .where(eq(schema.blogPosts.id, post.id));\r\n\r\n      res.json(post);\r\n    } catch (error) {\r\n      console.error('Error fetching blog post:', error);\r\n      res.status(500).json({ message: 'Failed to fetch post' });\r\n    }\r\n  });\r\n\r\n  // Public blog API - Get categories\r\n  app.get('/api/blog/categories', async (req, res) => {\r\n    try {\r\n      const categories = await db.select().from(schema.blogCategories).orderBy(sql`${schema.blogCategories.name} ASC`);\r\n      res.json(categories);\r\n    } catch (error) {\r\n      console.error('Error fetching blog categories:', error);\r\n      res.status(500).json({ message: 'Failed to fetch categories' });\r\n    }\r\n  });\r\n\r\n  return httpServer;\r\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\advancedContactSearchService.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Method 'analyzeQuery' has a complexity of 51. Maximum allowed is 15.","line":150,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":150,"endColumn":23},{"ruleId":"complexity","severity":1,"message":"Method 'buildSearchQuery' has a complexity of 32. Maximum allowed is 15.","line":363,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":363,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Pool } from '@neondatabase/serverless';\r\nimport ws from \"ws\";\r\nimport { neonConfig } from '@neondatabase/serverless';\r\n\r\nneonConfig.webSocketConstructor = ws;\r\n\r\n// Get the external database URL\r\nfunction getExternalDatabaseUrl(): string | null {\r\n  let dugguConnectionUrl = process.env.DUGGU_DATABASE_CONNECTION_URL;\r\n  \r\n  if (dugguConnectionUrl) {\r\n    if (dugguConnectionUrl.includes(\"'postgresql://\")) {\r\n      dugguConnectionUrl = dugguConnectionUrl.match(/'(postgresql:\\/\\/[^']+)'/)?.[1] || dugguConnectionUrl;\r\n    } else if (dugguConnectionUrl.includes('\"postgresql://')) {\r\n      dugguConnectionUrl = dugguConnectionUrl.match(/\"(postgresql:\\/\\/[^\"]+)\"/)?.[1] || dugguConnectionUrl;\r\n    }\r\n    \r\n    if (dugguConnectionUrl.startsWith('postgresql://') || dugguConnectionUrl.startsWith('postgres://')) {\r\n      return dugguConnectionUrl;\r\n    }\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\nlet externalSearchPool: Pool | null = null;\r\n\r\nfunction getExternalSearchPool(): Pool {\r\n  if (!externalSearchPool) {\r\n    const url = getExternalDatabaseUrl();\r\n    if (!url) {\r\n      throw new Error('External database connection URL not found. Please configure DUGGU_DATABASE_CONNECTION_URL environment variable.');\r\n    }\r\n    \r\n    externalSearchPool = new Pool({\r\n      connectionString: url,\r\n      ssl: { rejectUnauthorized: false },\r\n      max: 5,\r\n      min: 1,\r\n      idleTimeoutMillis: 15000,\r\n      connectionTimeoutMillis: 10000,\r\n      allowExitOnIdle: false,\r\n      query_timeout: 15000,\r\n      statement_timeout: 15000,\r\n    });\r\n  }\r\n  \r\n  return externalSearchPool;\r\n}\r\n\r\ninterface SearchFilters {\r\n  // Name fields\r\n  fullName?: string;\r\n  firstName?: string;\r\n  lastName?: string;\r\n  \r\n  // Contact fields\r\n  title?: string;\r\n  email?: string;\r\n  emailDomain?: string;\r\n  phone?: string;\r\n  mobilePhone?: string;\r\n  otherPhone?: string;\r\n  homePhone?: string;\r\n  corporatePhone?: string;\r\n  \r\n  // Company fields\r\n  company?: string;\r\n  industry?: string;\r\n  website?: string;\r\n  companyLinkedIn?: string;\r\n  companyAddress?: string;\r\n  \r\n  // Location fields (person)\r\n  city?: string;\r\n  state?: string;\r\n  country?: string;\r\n  countryCode?: string;\r\n  timezone?: string;\r\n  region?: string;\r\n  \r\n  // Location fields (company)\r\n  companyCity?: string;\r\n  companyState?: string;\r\n  companyCountry?: string;\r\n  \r\n  // Company metrics\r\n  employees?: number;\r\n  minEmployees?: number;\r\n  maxEmployees?: number;\r\n  employeeSizeBracket?: string;\r\n  companyAge?: number;\r\n  minCompanyAge?: number;\r\n  maxCompanyAge?: number;\r\n  \r\n  // Revenue\r\n  minRevenue?: number;\r\n  maxRevenue?: number;\r\n  annualRevenue?: number;\r\n  \r\n  // Lead scoring\r\n  minLeadScore?: number;\r\n  maxLeadScore?: number;\r\n  \r\n  // Technology\r\n  technologies?: string[];\r\n  technologyCategory?: string;\r\n  \r\n  // Business\r\n  businessType?: string;\r\n  \r\n  // Social\r\n  personLinkedIn?: string;\r\n  hasEmail?: boolean;\r\n  hasPhone?: boolean;\r\n  hasLinkedIn?: boolean;\r\n  hasWebsite?: boolean;\r\n}\r\n\r\ninterface QueryAnalysis {\r\n  filters: SearchFilters;\r\n  intent: string;\r\n  searchTerms: string[];\r\n  confidence: number;\r\n}\r\n\r\n/**\r\n * Advanced Contact Search Service\r\n * Uses AI-powered query understanding to search across all 37 columns in the external contacts database\r\n * Intelligently interprets natural language queries and generates appropriate database queries\r\n */\r\nexport class AdvancedContactSearchService {\n  private forEachPatternMatch(\n    query: string,\n    patterns: RegExp[],\n    onMatch: (match: RegExpMatchArray) => void,\n  ): void {\n    for (const pattern of patterns) {\n      const matches = query.matchAll(pattern);\n      for (const match of matches) {\n        onMatch(match);\n      }\n    }\n  }\n  \n  /**\n   * Analyze natural language query and extract search intent\n   * This method uses pattern matching and keyword analysis to understand user queries\n   */\n  private analyzeQuery(query: string): QueryAnalysis {\r\n    const lowerQuery = query.toLowerCase();\r\n    const filters: SearchFilters = {};\r\n    const searchTerms: string[] = [];\r\n    let intent = 'general_search';\r\n    let confidence = 70;\r\n\r\n    // Extract company names (common patterns)\r\n    const companyPatterns = [\r\n      /(?:from|at|works? at|company|companies like)\\s+([a-z0-9\\s&.,'\"-]+?)(?:\\s+(?:in|with|who|that|and)|$)/gi,\r\n      /([a-z0-9\\s&.,'\"-]+)\\s+(?:employees|staff|workers|team)/gi,\r\n    ];\r\n    \r\n    this.forEachPatternMatch(query, companyPatterns, (match) => {\n      if (match[1] && match[1].trim().length > 2) {\n        filters.company = match[1].trim();\n        intent = 'company_search';\n        confidence = 85;\n      }\n    });\n\r\n    // Extract job titles\r\n    const titlePatterns = [\r\n      /(?:title|position|role|job)(?:\\s+is|\\s+:)?\\s+([a-z\\s]+?)(?:\\s+(?:at|in|from|with|who|that|and)|$)/gi,\r\n      /(ceo|cto|cfo|coo|vp|director|manager|head|lead|senior|junior|engineer|developer|designer|analyst|specialist|coordinator|executive|president|founder)s?(?:\\s+of)?/gi,\r\n    ];\r\n    \r\n    for (const pattern of titlePatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[1] && match[1].trim().length > 2) {\r\n          filters.title = match[1].trim();\r\n          intent = 'title_search';\r\n          confidence = 85;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Extract location\r\n    const locationPatterns = [\r\n      /(?:in|from|located in|based in|at)\\s+([a-z\\s]+),?\\s+([a-z]{2})/gi, // City, State\r\n      /(?:in|from|located in|based in)\\s+([a-z\\s]+?)(?:\\s+(?:with|who|that|and)|$)/gi, // City or Country\r\n    ];\r\n    \r\n    for (const pattern of locationPatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[2]) {\r\n          filters.city = match[1]?.trim();\r\n          filters.state = match[2]?.trim();\r\n        } else if (match[1]) {\r\n          const location = match[1].trim();\r\n          if (location.length === 2) {\r\n            filters.state = location;\r\n          } else if (location.length > 15) {\r\n            filters.country = location;\r\n          } else {\r\n            filters.city = location;\r\n          }\r\n        }\r\n        intent = 'location_search';\r\n        confidence = 80;\r\n      }\r\n    }\r\n\r\n    // Extract industry\r\n    const industryPatterns = [\r\n      /(?:industry|sector|field|vertical)(?:\\s+is|\\s+:)?\\s+([a-z\\s&]+?)(?:\\s+(?:with|who|in|and)|$)/gi,\r\n      /(?:in the|from the)\\s+([a-z\\s&]+)\\s+(?:industry|sector|field)/gi,\r\n    ];\r\n    \r\n    for (const pattern of industryPatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[1] && match[1].trim().length > 2) {\r\n          filters.industry = match[1].trim();\r\n          intent = 'industry_search';\r\n          confidence = 85;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Extract employee count ranges\r\n    const employeePatterns = [\r\n      /(\\d+)\\s*-\\s*(\\d+)\\s+employees/gi,\r\n      /(?:more than|over|above|>\\s*)(\\d+)\\s+employees/gi,\r\n      /(?:less than|under|below|<\\s*)(\\d+)\\s+employees/gi,\r\n      /(\\d+)\\+\\s+employees/gi,\r\n    ];\r\n    \r\n    for (const pattern of employeePatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[1] && match[2]) {\r\n          filters.minEmployees = parseInt(match[1]);\r\n          filters.maxEmployees = parseInt(match[2]);\r\n        } else if (match[1]) {\r\n          if (lowerQuery.includes('more than') || lowerQuery.includes('over') || lowerQuery.includes('above')) {\r\n            filters.minEmployees = parseInt(match[1]);\r\n          } else if (lowerQuery.includes('less than') || lowerQuery.includes('under') || lowerQuery.includes('below')) {\r\n            filters.maxEmployees = parseInt(match[1]);\r\n          } else {\r\n            filters.minEmployees = parseInt(match[1]);\r\n          }\r\n        }\r\n        intent = 'employee_search';\r\n        confidence = 90;\r\n      }\r\n    }\r\n\r\n    // Extract lead score criteria\r\n    const scorePatterns = [\r\n      /lead\\s+score\\s*(?:>=|>|above|over)\\s*(\\d+(?:\\.\\d+)?)/gi,\r\n      /lead\\s+score\\s*(?:<=|<|below|under)\\s*(\\d+(?:\\.\\d+)?)/gi,\r\n      /(?:high|top)\\s+(?:quality|value|scoring|score)\\s+(?:leads|contacts)/gi,\r\n    ];\r\n    \r\n    for (const pattern of scorePatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[1]) {\r\n          if (lowerQuery.includes('>=') || lowerQuery.includes('>') || lowerQuery.includes('above') || lowerQuery.includes('over')) {\r\n            filters.minLeadScore = parseFloat(match[1]);\r\n          } else {\r\n            filters.maxLeadScore = parseFloat(match[1]);\r\n          }\r\n        } else {\r\n          filters.minLeadScore = 7.0; // High quality threshold\r\n        }\r\n        intent = 'lead_score_search';\r\n        confidence = 95;\r\n      }\r\n    }\r\n\r\n    // Extract technologies\r\n    const techPatterns = [\r\n      /(?:using|uses|with|has)\\s+(salesforce|hubspot|aws|azure|gcp|slack|jira|confluence|github|gitlab|docker|kubernetes|react|angular|vue|python|java|javascript|node\\.?js|\\.net|php)/gi,\r\n    ];\r\n    \r\n    for (const pattern of techPatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[1]) {\r\n          if (!filters.technologies) filters.technologies = [];\r\n          filters.technologies.push(match[1].trim());\r\n          intent = 'technology_search';\r\n          confidence = 85;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Extract email/phone requirements\r\n    if (/(?:with|has|have)\\s+(?:an?\\s+)?email/gi.test(query)) {\r\n      filters.hasEmail = true;\r\n      intent = 'contact_info_search';\r\n      confidence = 90;\r\n    }\r\n    \r\n    if (/(?:with|has|have)\\s+(?:a\\s+)?(?:phone|mobile|telephone)/gi.test(query)) {\r\n      filters.hasPhone = true;\r\n      intent = 'contact_info_search';\r\n      confidence = 90;\r\n    }\r\n\r\n    if (/(?:with|has|have)\\s+linkedin/gi.test(query)) {\r\n      filters.hasLinkedIn = true;\r\n      intent = 'linkedin_search';\r\n      confidence = 90;\r\n    }\r\n\r\n    // Extract name searches\r\n    const namePatterns = [\r\n      /(?:named?|called)\\s+([a-z\\s]+?)(?:\\s+(?:at|in|from|with|who)|$)/gi,\r\n      /(?:first name|fname)(?:\\s+is|\\s+:)?\\s+([a-z]+)/gi,\r\n      /(?:last name|lname|surname)(?:\\s+is|\\s+:)?\\s+([a-z]+)/gi,\r\n    ];\r\n    \r\n    for (const pattern of namePatterns) {\r\n      const matches = query.matchAll(pattern);\r\n      for (const match of matches) {\r\n        if (match[1]) {\r\n          const name = match[1].trim();\r\n          if (lowerQuery.includes('first name') || lowerQuery.includes('fname')) {\r\n            filters.firstName = name;\r\n          } else if (lowerQuery.includes('last name') || lowerQuery.includes('lname') || lowerQuery.includes('surname')) {\r\n            filters.lastName = name;\r\n          } else {\r\n            filters.fullName = name;\r\n          }\r\n          intent = 'name_search';\r\n          confidence = 85;\r\n        }\r\n      }\r\n    }\r\n\r\n    // If no specific filters found, treat whole query as general search term\r\n    if (Object.keys(filters).length === 0) {\r\n      searchTerms.push(query.trim());\r\n      intent = 'general_search';\r\n      confidence = 60;\r\n    }\r\n\r\n    return {\r\n      filters,\r\n      intent,\r\n      searchTerms,\r\n      confidence\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Build SQL query from analyzed filters\r\n   */\r\n  private buildSearchQuery(analysis: QueryAnalysis, limit: number = 100): { query: string, params: any[] } {\r\n    const conditions: string[] = ['is_deleted = false'];\r\n    const params: any[] = [];\r\n    let paramIndex = 1;\r\n\r\n    const { filters } = analysis;\r\n\r\n    // Full name search\r\n    if (filters.fullName) {\r\n      conditions.push(`LOWER(full_name) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.fullName.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // First name search\r\n    if (filters.firstName) {\r\n      conditions.push(`LOWER(first_name) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.firstName.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Last name search\r\n    if (filters.lastName) {\r\n      conditions.push(`LOWER(last_name) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.lastName.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Title search (fuzzy for variations like \"Chief Executive Officer\" vs \"CEO\")\r\n    if (filters.title) {\r\n      conditions.push(`LOWER(title) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.title.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Email search\r\n    if (filters.email) {\r\n      conditions.push(`LOWER(email) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.email.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Phone search (search across all phone fields)\r\n    if (filters.phone) {\r\n      conditions.push(`(\r\n        LOWER(mobile_phone) LIKE $${paramIndex} OR\r\n        LOWER(other_phone) LIKE $${paramIndex} OR\r\n        LOWER(home_phone) LIKE $${paramIndex} OR\r\n        LOWER(corporate_phone) LIKE $${paramIndex}\r\n      )`);\r\n      params.push(`%${filters.phone.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Company search\r\n    if (filters.company) {\r\n      conditions.push(`LOWER(company) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.company.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Industry search\r\n    if (filters.industry) {\r\n      conditions.push(`LOWER(industry) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.industry.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Location searches\r\n    if (filters.city) {\r\n      conditions.push(`(LOWER(city) LIKE $${paramIndex} OR LOWER(company_city) LIKE $${paramIndex})`);\r\n      params.push(`%${filters.city.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    if (filters.state) {\r\n      conditions.push(`(LOWER(state) LIKE $${paramIndex} OR LOWER(company_state) LIKE $${paramIndex})`);\r\n      params.push(`%${filters.state.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    if (filters.country) {\r\n      conditions.push(`(LOWER(country) LIKE $${paramIndex} OR LOWER(company_country) LIKE $${paramIndex})`);\r\n      params.push(`%${filters.country.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Employee count filters\r\n    if (filters.minEmployees !== undefined) {\r\n      conditions.push(`employees >= $${paramIndex}`);\r\n      params.push(filters.minEmployees);\r\n      paramIndex++;\r\n    }\r\n\r\n    if (filters.maxEmployees !== undefined) {\r\n      conditions.push(`employees <= $${paramIndex}`);\r\n      params.push(filters.maxEmployees);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Revenue filters\r\n    if (filters.minRevenue !== undefined) {\r\n      conditions.push(`annual_revenue >= $${paramIndex}`);\r\n      params.push(filters.minRevenue);\r\n      paramIndex++;\r\n    }\r\n\r\n    if (filters.maxRevenue !== undefined) {\r\n      conditions.push(`annual_revenue <= $${paramIndex}`);\r\n      params.push(filters.maxRevenue);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Lead score filters\r\n    if (filters.minLeadScore !== undefined) {\r\n      conditions.push(`lead_score >= $${paramIndex}`);\r\n      params.push(filters.minLeadScore);\r\n      paramIndex++;\r\n    }\r\n\r\n    if (filters.maxLeadScore !== undefined) {\r\n      conditions.push(`lead_score <= $${paramIndex}`);\r\n      params.push(filters.maxLeadScore);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Region filter\r\n    if (filters.region) {\r\n      conditions.push(`LOWER(region) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.region.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Business type filter\r\n    if (filters.businessType) {\r\n      conditions.push(`LOWER(business_type) LIKE $${paramIndex}`);\r\n      params.push(`%${filters.businessType.toLowerCase()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Technologies filter (PostgreSQL array contains)\r\n    if (filters.technologies && filters.technologies.length > 0) {\r\n      const techConditions = filters.technologies.map(tech => {\r\n        const condition = `EXISTS (\r\n          SELECT 1 FROM unnest(technologies) AS t \r\n          WHERE LOWER(t) LIKE $${paramIndex}\r\n        )`;\r\n        params.push(`%${tech.toLowerCase()}%`);\r\n        paramIndex++;\r\n        return condition;\r\n      });\r\n      conditions.push(`(${techConditions.join(' OR ')})`);\r\n    }\r\n\r\n    // Contact info requirements\r\n    if (filters.hasEmail) {\r\n      conditions.push(`email IS NOT NULL AND email != ''`);\r\n    }\r\n\r\n    if (filters.hasPhone) {\r\n      conditions.push(`(\r\n        mobile_phone IS NOT NULL OR \r\n        other_phone IS NOT NULL OR \r\n        home_phone IS NOT NULL OR \r\n        corporate_phone IS NOT NULL\r\n      )`);\r\n    }\r\n\r\n    if (filters.hasLinkedIn) {\r\n      conditions.push(`(\r\n        person_linkedin IS NOT NULL OR \r\n        company_linkedin IS NOT NULL\r\n      )`);\r\n    }\r\n\r\n    // General search terms (search across ALL 37 fields - comprehensive search)\r\n    if (analysis.searchTerms.length > 0) {\r\n      for (const term of analysis.searchTerms) {\r\n        conditions.push(`(\r\n          LOWER(full_name) LIKE $${paramIndex} OR\r\n          LOWER(first_name) LIKE $${paramIndex} OR\r\n          LOWER(last_name) LIKE $${paramIndex} OR\r\n          LOWER(title) LIKE $${paramIndex} OR\r\n          LOWER(email) LIKE $${paramIndex} OR\r\n          LOWER(email_domain) LIKE $${paramIndex} OR\r\n          LOWER(mobile_phone) LIKE $${paramIndex} OR\r\n          LOWER(other_phone) LIKE $${paramIndex} OR\r\n          LOWER(home_phone) LIKE $${paramIndex} OR\r\n          LOWER(corporate_phone) LIKE $${paramIndex} OR\r\n          LOWER(company) LIKE $${paramIndex} OR\r\n          LOWER(industry) LIKE $${paramIndex} OR\r\n          LOWER(website) LIKE $${paramIndex} OR\r\n          LOWER(company_linkedin) LIKE $${paramIndex} OR\r\n          LOWER(person_linkedin) LIKE $${paramIndex} OR\r\n          LOWER(city) LIKE $${paramIndex} OR\r\n          LOWER(state) LIKE $${paramIndex} OR\r\n          LOWER(country) LIKE $${paramIndex} OR\r\n          LOWER(country_code) LIKE $${paramIndex} OR\r\n          LOWER(company_address) LIKE $${paramIndex} OR\r\n          LOWER(company_city) LIKE $${paramIndex} OR\r\n          LOWER(company_state) LIKE $${paramIndex} OR\r\n          LOWER(company_country) LIKE $${paramIndex} OR\r\n          LOWER(employee_size_bracket) LIKE $${paramIndex} OR\r\n          LOWER(technology_category) LIKE $${paramIndex} OR\r\n          LOWER(region) LIKE $${paramIndex} OR\r\n          LOWER(business_type) LIKE $${paramIndex} OR\r\n          LOWER(timezone) LIKE $${paramIndex} OR\r\n          EXISTS (\r\n            SELECT 1 FROM unnest(technologies) AS t \r\n            WHERE LOWER(t) LIKE $${paramIndex}\r\n          )\r\n        )`);\r\n        params.push(`%${term.toLowerCase()}%`);\r\n        paramIndex++;\r\n      }\r\n    }\r\n\r\n    const whereClause = conditions.join(' AND ');\r\n    \r\n    // Smart ordering: prioritize exact matches, then by lead score\r\n    const orderBy = `\r\n      ORDER BY \r\n        CASE \r\n          WHEN LOWER(full_name) = $${paramIndex} THEN 1\r\n          WHEN LOWER(company) = $${paramIndex + 1} THEN 2\r\n          ELSE 3\r\n        END,\r\n        lead_score DESC NULLS LAST,\r\n        full_name ASC\r\n    `;\r\n    \r\n    params.push(analysis.searchTerms[0]?.toLowerCase() || '');\r\n    params.push(filters.company?.toLowerCase() || '');\r\n    params.push(limit);\r\n\r\n    const query = `\r\n      SELECT * FROM contacts \r\n      WHERE ${whereClause}\r\n      ${orderBy}\r\n      LIMIT $${paramIndex + 2}\r\n    `;\r\n\r\n    return { query, params };\r\n  }\r\n\r\n  /**\r\n   * Main search method - intelligently searches across all 37 contact fields\r\n   */\r\n  async searchContacts(userQuery: string, limit: number = 100): Promise<{\r\n    contacts: any[];\r\n    total: number;\r\n    analysis: QueryAnalysis;\r\n  }> {\r\n    try {\r\n      // Analyze the user query\r\n      const analysis = this.analyzeQuery(userQuery);\r\n      \r\n      console.log('Query analysis:', {\r\n        intent: analysis.intent,\r\n        confidence: analysis.confidence,\r\n        filters: analysis.filters\r\n      });\r\n\r\n      // Build and execute the search query\r\n      const { query, params } = this.buildSearchQuery(analysis, limit);\r\n      \r\n      const pool = getExternalSearchPool();\r\n      const result = await pool.query(query, params);\r\n\r\n      // Get total count (for pagination)\r\n      const { query: countQuery, params: countParams } = this.buildSearchQuery(analysis, 999999);\r\n      const totalQuery = countQuery.replace(/ORDER BY[\\s\\S]*LIMIT \\$\\d+/, '');\r\n      const countResult = await pool.query(\r\n        `SELECT COUNT(*) as count FROM (${totalQuery}) as subquery`,\r\n        countParams.slice(0, -3) // Remove the exact match and limit params\r\n      );\r\n\r\n      return {\r\n        contacts: result.rows,\r\n        total: parseInt(countResult.rows[0]?.count || '0'),\r\n        analysis\r\n      };\r\n    } catch (error) {\r\n      console.error('Error in advanced contact search:', error);\r\n      throw new Error('Failed to search contacts');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get contact suggestions based on partial input\r\n   */\r\n  async getSuggestions(partialQuery: string, field: 'company' | 'title' | 'industry' | 'city', limit: number = 10): Promise<string[]> {\r\n    try {\r\n      const pool = getExternalSearchPool();\r\n      const searchTerm = `%${partialQuery.toLowerCase()}%`;\r\n      \r\n      const result = await pool.query(`\r\n        SELECT DISTINCT ${field}\r\n        FROM contacts\r\n        WHERE is_deleted = false \r\n          AND ${field} IS NOT NULL \r\n          AND LOWER(${field}) LIKE $1\r\n        ORDER BY ${field}\r\n        LIMIT $2\r\n      `, [searchTerm, limit]);\r\n\r\n      return result.rows.map(row => row[field]).filter(Boolean);\r\n    } catch (error) {\r\n      console.error('Error getting suggestions:', error);\r\n      return [];\r\n    }\r\n  }\r\n}\r\n\r\nexport const advancedContactSearchService = new AdvancedContactSearchService();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\advancedSearchService.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async method 'buildWhereClause' has a complexity of 25. Maximum allowed is 15.","line":194,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":194,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Pool } from 'pg';\r\nimport { pool, readOnlyPool } from '../db';\r\n\r\nexport interface TableMetadata {\r\n  tableName: string;\r\n  columns: ColumnMetadata[];\r\n  recordCount: number;\r\n  sampleValues: Record<string, any[]>;\r\n}\r\n\r\nexport interface ColumnMetadata {\r\n  columnName: string;\r\n  dataType: string;\r\n  isNullable: boolean;\r\n  defaultValue: string | null;\r\n  maxLength: number | null;\r\n}\r\n\r\nexport interface SearchFilter {\r\n  column: string;\r\n  operator: 'equals' | 'not_equals' | 'contains' | 'not_contains' | 'starts_with' | 'ends_with' | \r\n            'greater_than' | 'less_than' | 'greater_or_equal' | 'less_or_equal' | \r\n            'is_null' | 'is_not_null' | 'in' | 'not_in' | 'between';\r\n  value?: any; // Optional since some operators like is_null don't need a value\r\n  value2?: any; // For 'between' operator\r\n}\r\n\r\nexport interface SearchQuery {\r\n  table: string;\r\n  filters: SearchFilter[];\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n  page?: number;\r\n  pageSize?: number;\r\n  database?: 'main' | 'readonly';\r\n}\r\n\r\nexport interface SearchResult {\r\n  data: any[];\r\n  totalCount: number;\r\n  page: number;\r\n  pageSize: number;\r\n  totalPages: number;\r\n}\r\n\r\nclass AdvancedSearchService {\r\n  /**\r\n   * Get all tables from a database\r\n   */\r\n  async getTables(database: 'main' | 'readonly' = 'main'): Promise<string[]> {\r\n    const dbPool = database === 'main' ? pool : readOnlyPool;\r\n    \r\n    try {\r\n      const result = await dbPool.query(`\r\n        SELECT table_name \r\n        FROM information_schema.tables \r\n        WHERE table_schema = 'public' \r\n        AND table_type = 'BASE TABLE'\r\n        ORDER BY table_name;\r\n      `);\r\n      \r\n      return result.rows.map(row => row.table_name);\r\n    } catch (error) {\r\n      console.error('Error getting tables:', error);\r\n      throw new Error('Failed to get tables');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get metadata for a specific table\r\n   */\r\n  async getTableMetadata(tableName: string, database: 'main' | 'readonly' = 'main'): Promise<TableMetadata> {\r\n    const dbPool = database === 'main' ? pool : readOnlyPool;\r\n    \r\n    try {\r\n      // Get column information\r\n      const columnsResult = await dbPool.query(`\r\n        SELECT \r\n          column_name,\r\n          data_type,\r\n          is_nullable,\r\n          column_default,\r\n          character_maximum_length\r\n        FROM information_schema.columns \r\n        WHERE table_schema = 'public' \r\n          AND table_name = $1\r\n        ORDER BY ordinal_position;\r\n      `, [tableName]);\r\n\r\n      const columns: ColumnMetadata[] = columnsResult.rows.map(row => ({\r\n        columnName: row.column_name,\r\n        dataType: row.data_type,\r\n        isNullable: row.is_nullable === 'YES',\r\n        defaultValue: row.column_default,\r\n        maxLength: row.character_maximum_length\r\n      }));\r\n\r\n      // Get record count\r\n      const countResult = await dbPool.query(`\r\n        SELECT COUNT(*) as count FROM \"${tableName}\";\r\n      `);\r\n      const recordCount = parseInt(countResult.rows[0]?.count || '0');\r\n\r\n      // Get sample distinct values for each column (limited to 20 per column)\r\n      const sampleValues: Record<string, any[]> = {};\r\n      \r\n      for (const column of columns) {\r\n        try {\r\n          // Only get samples for certain data types and non-encrypted columns\r\n          if (column.dataType.includes('text') || \r\n              column.dataType.includes('char') || \r\n              column.dataType.includes('integer') ||\r\n              column.dataType.includes('boolean')) {\r\n            \r\n            // Skip encrypted or sensitive columns\r\n            if (column.columnName.includes('encrypted') || \r\n                column.columnName.includes('password') ||\r\n                column.columnName.includes('token')) {\r\n              continue;\r\n            }\r\n\r\n            const sampleResult = await dbPool.query(`\r\n              SELECT DISTINCT \"${column.columnName}\" \r\n              FROM \"${tableName}\" \r\n              WHERE \"${column.columnName}\" IS NOT NULL \r\n              LIMIT 20;\r\n            `);\r\n            \r\n            sampleValues[column.columnName] = sampleResult.rows.map(row => row[column.columnName]);\r\n          }\r\n        } catch (error) {\r\n          // Skip columns that can't be sampled\r\n          console.log(`Skipping sample for ${column.columnName}`);\r\n        }\r\n      }\r\n\r\n      return {\r\n        tableName,\r\n        columns,\r\n        recordCount,\r\n        sampleValues\r\n      };\r\n    } catch (error) {\r\n      console.error(`Error getting metadata for table ${tableName}:`, error);\r\n      throw new Error(`Failed to get metadata for table ${tableName}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all tables with their metadata\r\n   */\r\n  async getAllTablesMetadata(database: 'main' | 'readonly' = 'main'): Promise<TableMetadata[]> {\r\n    try {\r\n      const tables = await this.getTables(database);\r\n      const metadata: TableMetadata[] = [];\r\n\r\n      for (const table of tables) {\r\n        try {\r\n          const tableMeta = await this.getTableMetadata(table, database);\r\n          metadata.push(tableMeta);\r\n        } catch (error) {\r\n          console.error(`Error getting metadata for ${table}:`, error);\r\n        }\r\n      }\r\n\r\n      return metadata;\r\n    } catch (error) {\r\n      console.error('Error getting all tables metadata:', error);\r\n      throw new Error('Failed to get tables metadata');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate identifier (table or column name) to prevent SQL injection\r\n   */\r\n  private validateIdentifier(identifier: string): boolean {\r\n    // Only allow alphanumeric, underscores, and hyphens\r\n    return /^[a-zA-Z_][a-zA-Z0-9_-]*$/.test(identifier);\r\n  }\r\n\r\n  /**\r\n   * Safely quote identifier\r\n   */\r\n  private quoteIdentifier(identifier: string): string {\r\n    if (!this.validateIdentifier(identifier)) {\r\n      throw new Error(`Invalid identifier: ${identifier}`);\r\n    }\r\n    return `\"${identifier}\"`;\r\n  }\r\n\r\n  /**\r\n   * Build WHERE clause from filters with validation\r\n   */\r\n  private async buildWhereClause(\r\n    filters: SearchFilter[], \r\n    tableName: string, \r\n    validColumns: Set<string>\r\n  ): Promise<{ clause: string; values: any[] }> {\r\n    if (filters.length === 0) {\r\n      return { clause: '', values: [] };\r\n    }\r\n\r\n    // Validate table name\r\n    if (!this.validateIdentifier(tableName)) {\r\n      throw new Error('Invalid table name');\r\n    }\r\n\r\n    const conditions: string[] = [];\r\n    const values: any[] = [];\r\n    let paramIndex = 1;\r\n\r\n    for (const filter of filters) {\r\n      // Validate column exists in metadata\r\n      if (!validColumns.has(filter.column)) {\r\n        throw new Error(`Invalid column: ${filter.column}`);\r\n      }\r\n\r\n      const column = `${this.quoteIdentifier(tableName)}.${this.quoteIdentifier(filter.column)}`;\r\n\r\n      switch (filter.operator) {\r\n        case 'equals':\r\n          conditions.push(`${column} = $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'not_equals':\r\n          conditions.push(`${column} != $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'contains':\r\n          conditions.push(`${column}::text ILIKE $${paramIndex}`);\r\n          values.push(`%${filter.value}%`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'not_contains':\r\n          conditions.push(`${column}::text NOT ILIKE $${paramIndex}`);\r\n          values.push(`%${filter.value}%`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'starts_with':\r\n          conditions.push(`${column}::text ILIKE $${paramIndex}`);\r\n          values.push(`${filter.value}%`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'ends_with':\r\n          conditions.push(`${column}::text ILIKE $${paramIndex}`);\r\n          values.push(`%${filter.value}`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'greater_than':\r\n          conditions.push(`${column} > $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'less_than':\r\n          conditions.push(`${column} < $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'greater_or_equal':\r\n          conditions.push(`${column} >= $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'less_or_equal':\r\n          conditions.push(`${column} <= $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'is_null':\r\n          conditions.push(`${column} IS NULL`);\r\n          break;\r\n\r\n        case 'is_not_null':\r\n          conditions.push(`${column} IS NOT NULL`);\r\n          break;\r\n\r\n        case 'in':\r\n          if (Array.isArray(filter.value) && filter.value.length > 0) {\r\n            const placeholders = filter.value.map((_, idx) => `$${paramIndex + idx}`).join(', ');\r\n            conditions.push(`${column} IN (${placeholders})`);\r\n            values.push(...filter.value);\r\n            paramIndex += filter.value.length;\r\n          }\r\n          break;\r\n\r\n        case 'not_in':\r\n          if (Array.isArray(filter.value) && filter.value.length > 0) {\r\n            const placeholders = filter.value.map((_, idx) => `$${paramIndex + idx}`).join(', ');\r\n            conditions.push(`${column} NOT IN (${placeholders})`);\r\n            values.push(...filter.value);\r\n            paramIndex += filter.value.length;\r\n          }\r\n          break;\r\n\r\n        case 'between':\r\n          conditions.push(`${column} BETWEEN $${paramIndex} AND $${paramIndex + 1}`);\r\n          values.push(filter.value, filter.value2);\r\n          paramIndex += 2;\r\n          break;\r\n      }\r\n    }\r\n\r\n    return {\r\n      clause: conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '',\r\n      values\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Execute advanced search query with validation\r\n   */\r\n  async search(query: SearchQuery): Promise<SearchResult> {\r\n    const dbPool = query.database === 'main' ? pool : readOnlyPool;\r\n    const page = query.page || 1;\r\n    const pageSize = Math.min(query.pageSize || 50, 1000); // Max 1000 results per page\r\n    const offset = (page - 1) * pageSize;\r\n\r\n    try {\r\n      // Validate table name\r\n      if (!this.validateIdentifier(query.table)) {\r\n        throw new Error('Invalid table name');\r\n      }\r\n\r\n      // Get table metadata to validate columns\r\n      const metadata = await this.getTableMetadata(query.table, query.database);\r\n      const validColumns = new Set(metadata.columns.map(col => col.columnName));\r\n\r\n      // Validate sort column if provided\r\n      if (query.sortBy && !validColumns.has(query.sortBy)) {\r\n        throw new Error(`Invalid sort column: ${query.sortBy}`);\r\n      }\r\n\r\n      // Validate sort order\r\n      if (query.sortOrder && !['asc', 'desc'].includes(query.sortOrder)) {\r\n        throw new Error('Invalid sort order');\r\n      }\r\n\r\n      // Build WHERE clause with validation\r\n      const { clause: whereClause, values: whereValues } = await this.buildWhereClause(\r\n        query.filters, \r\n        query.table,\r\n        validColumns\r\n      );\r\n\r\n      // Build ORDER BY clause safely\r\n      const orderByClause = query.sortBy \r\n        ? `ORDER BY ${this.quoteIdentifier(query.table)}.${this.quoteIdentifier(query.sortBy)} ${query.sortOrder === 'desc' ? 'DESC' : 'ASC'}`\r\n        : '';\r\n\r\n      // Get total count with validated identifiers\r\n      const countQuery = `\r\n        SELECT COUNT(*) as count \r\n        FROM ${this.quoteIdentifier(query.table)} \r\n        ${whereClause};\r\n      `;\r\n      const countResult = await dbPool.query(countQuery, whereValues);\r\n      const totalCount = parseInt(countResult.rows[0]?.count || '0');\r\n\r\n      // Get paginated data with validated identifiers\r\n      const dataQuery = `\r\n        SELECT * \r\n        FROM ${this.quoteIdentifier(query.table)} \r\n        ${whereClause}\r\n        ${orderByClause}\r\n        LIMIT $${whereValues.length + 1} OFFSET $${whereValues.length + 2};\r\n      `;\r\n      const dataResult = await dbPool.query(dataQuery, [...whereValues, pageSize, offset]);\r\n\r\n      const totalPages = Math.ceil(totalCount / pageSize);\r\n\r\n      return {\r\n        data: dataResult.rows,\r\n        totalCount,\r\n        page,\r\n        pageSize,\r\n        totalPages\r\n      };\r\n    } catch (error) {\r\n      console.error('Error executing search:', error);\r\n      throw new Error('Failed to execute search query');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Export search results to CSV\r\n   */\r\n  async exportToCSV(query: SearchQuery): Promise<string> {\r\n    try {\r\n      // Execute search without pagination limit\r\n      const result = await this.search({\r\n        ...query,\r\n        page: 1,\r\n        pageSize: 10000 // Export max 10k records at once\r\n      });\r\n\r\n      if (result.data.length === 0) {\r\n        return '';\r\n      }\r\n\r\n      // Build CSV\r\n      const headers = Object.keys(result.data[0]);\r\n      const csvRows = [headers.join(',')];\r\n\r\n      for (const row of result.data) {\r\n        const values = headers.map(header => {\r\n          const value = row[header];\r\n          if (value === null || value === undefined) return '';\r\n          \r\n          const stringValue = String(value);\r\n          // Escape values containing comma, quote, or newline\r\n          if (stringValue.includes(',') || stringValue.includes('\"') || stringValue.includes('\\n')) {\r\n            return `\"${stringValue.replace(/\"/g, '\"\"')}\"`;\r\n          }\r\n          return stringValue;\r\n        });\r\n        csvRows.push(values.join(','));\r\n      }\r\n\r\n      return csvRows.join('\\n');\r\n    } catch (error) {\r\n      console.error('Error exporting to CSV:', error);\r\n      throw new Error('Failed to export data');\r\n    }\r\n  }\r\n}\r\n\r\nexport const advancedSearchService = new AdvancedSearchService();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\apolloService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\contactsFilterService.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Method 'buildSingleFilterCondition' has a complexity of 21. Maximum allowed is 15.","line":225,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":225,"endColumn":37},{"ruleId":"complexity","severity":1,"message":"Method 'buildWhereClause' has a complexity of 33. Maximum allowed is 15.","line":338,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":338,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { readOnlyPool } from '../db';\r\n\r\n// Filter templates for common sales use cases\r\nexport const FILTER_TEMPLATES = {\r\n  'c-level-executives': {\r\n    name: 'C-Level Executives',\r\n    description: 'CEOs, CTOs, CFOs, and other C-suite executives',\r\n    filters: [\r\n      { column: 'title', operator: 'contains', value: 'CEO' },\r\n      { column: 'title', operator: 'contains', value: 'CTO' },\r\n      { column: 'title', operator: 'contains', value: 'CFO' },\r\n      { column: 'title', operator: 'contains', value: 'COO' },\r\n      { column: 'title', operator: 'contains', value: 'Chief' }\r\n    ],\r\n    combineWith: 'OR'\r\n  },\r\n  'vp-directors': {\r\n    name: 'VPs & Directors',\r\n    description: 'Vice Presidents and Directors',\r\n    filters: [\r\n      { column: 'title', operator: 'contains', value: 'VP' },\r\n      { column: 'title', operator: 'contains', value: 'Vice President' },\r\n      { column: 'title', operator: 'contains', value: 'Director' }\r\n    ],\r\n    combineWith: 'OR'\r\n  },\r\n  'enterprise-companies': {\r\n    name: 'Enterprise Companies',\r\n    description: 'Companies with 1000+ employees',\r\n    filters: [\r\n      { column: 'employees', operator: 'greater_or_equal', value: 1000 }\r\n    ],\r\n    combineWith: 'AND'\r\n  },\r\n  'mid-market': {\r\n    name: 'Mid-Market Companies',\r\n    description: 'Companies with 100-999 employees',\r\n    filters: [\r\n      { column: 'employees', operator: 'greater_or_equal', value: 100 },\r\n      { column: 'employees', operator: 'less_than', value: 1000 }\r\n    ],\r\n    combineWith: 'AND'\r\n  },\r\n  'tech-industry': {\r\n    name: 'Technology Industry',\r\n    description: 'Companies in tech sector',\r\n    filters: [\r\n      { column: 'industry', operator: 'contains', value: 'Technology' },\r\n      { column: 'industry', operator: 'contains', value: 'Software' },\r\n      { column: 'industry', operator: 'contains', value: 'IT' }\r\n    ],\r\n    combineWith: 'OR'\r\n  },\r\n  'high-revenue': {\r\n    name: 'High Revenue Companies',\r\n    description: 'Companies with $10M+ annual revenue',\r\n    filters: [\r\n      { column: 'annual_revenue', operator: 'greater_or_equal', value: 10000000 }\r\n    ],\r\n    combineWith: 'AND'\r\n  },\r\n  'decision-makers': {\r\n    name: 'Decision Makers',\r\n    description: 'High-scoring leads with decision-making authority',\r\n    filters: [\r\n      { column: 'lead_score', operator: 'greater_or_equal', value: 70 },\r\n      { column: 'title', operator: 'contains', value: 'Manager' },\r\n      { column: 'title', operator: 'contains', value: 'Director' },\r\n      { column: 'title', operator: 'contains', value: 'VP' },\r\n      { column: 'title', operator: 'contains', value: 'Chief' }\r\n    ],\r\n    combineWith: 'OR' // OR for title filters\r\n  }\r\n};\r\n\r\nexport interface ContactFilter {\r\n  column: string;\r\n  operator: 'equals' | 'not_equals' | 'contains' | 'not_contains' | 'starts_with' | 'ends_with' | \r\n            'greater_than' | 'less_than' | 'greater_or_equal' | 'less_or_equal' | \r\n            'is_null' | 'is_not_null' | 'in' | 'not_in' | 'between';\r\n  value?: any;\r\n  value2?: any;\r\n}\r\n\r\nexport interface ContactSearchQuery {\r\n  filters: ContactFilter[];\r\n  filterGroups?: Array<{\r\n    filters: ContactFilter[];\r\n    combineWith: 'AND' | 'OR';\r\n  }>;\r\n  globalSearch?: string; // Search across all text fields\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n  page?: number;\r\n  pageSize?: number;\r\n}\r\n\r\nexport interface ContactSearchResult {\r\n  data: any[];\r\n  totalCount: number;\r\n  page: number;\r\n  pageSize: number;\r\n  totalPages: number;\r\n  aggregations?: {\r\n    byIndustry?: Record<string, number>;\r\n    byCountry?: Record<string, number>;\r\n    byEmployeeSize?: Record<string, number>;\r\n    avgLeadScore?: number;\r\n  };\r\n}\r\n\r\nexport interface FieldSuggestions {\r\n  titles: string[];\r\n  companies: string[];\r\n  industries: string[];\r\n  cities: string[];\r\n  countries: string[];\r\n  technologies: string[];\r\n}\r\n\r\nclass ContactsFilterService {\r\n  private validateIdentifier(identifier: string): boolean {\r\n    return /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(identifier);\r\n  }\r\n\r\n  private quoteIdentifier(identifier: string): string {\r\n    if (!this.validateIdentifier(identifier)) {\r\n      throw new Error(`Invalid identifier: ${identifier}`);\r\n    }\r\n    return `\"${identifier}\"`;\r\n  }\r\n\r\n  /**\r\n   * Get field suggestions for autocomplete\r\n   */\r\n  async getFieldSuggestions(field: string, searchTerm: string = '', limit: number = 20): Promise<string[]> {\r\n    const validFields = ['title', 'company', 'industry', 'city', 'country', 'state', 'business_type'];\r\n    \r\n    if (!validFields.includes(field)) {\r\n      throw new Error('Invalid field for suggestions');\r\n    }\r\n\r\n    try {\r\n      const query = `\r\n        SELECT DISTINCT ${this.quoteIdentifier(field)} as value\r\n        FROM contacts\r\n        WHERE ${this.quoteIdentifier(field)} IS NOT NULL\r\n          ${searchTerm ? `AND ${this.quoteIdentifier(field)} ILIKE $1` : ''}\r\n          AND is_deleted = false\r\n        ORDER BY value\r\n        LIMIT $${searchTerm ? '2' : '1'}\r\n      `;\r\n\r\n      const result = await readOnlyPool.query(\r\n        query,\r\n        searchTerm ? [`%${searchTerm}%`, limit] : [limit]\r\n      );\r\n\r\n      return result.rows.map(row => row.value);\r\n    } catch (error) {\r\n      console.error(`Error getting suggestions for ${field}:`, error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get aggregated field values for smart filters\r\n   */\r\n  async getFieldAggregations(): Promise<FieldSuggestions> {\r\n    try {\r\n      const [titles, companies, industries, cities, countries, technologies] = await Promise.all([\r\n        this.getTopValues('title', 50),\r\n        this.getTopValues('company', 100),\r\n        this.getTopValues('industry', 30),\r\n        this.getTopValues('city', 50),\r\n        this.getTopValues('country', 50),\r\n        this.getTopTechnologies(30)\r\n      ]);\r\n\r\n      return {\r\n        titles,\r\n        companies,\r\n        industries,\r\n        cities,\r\n        countries,\r\n        technologies\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting field aggregations:', error);\r\n      throw new Error('Failed to get field aggregations');\r\n    }\r\n  }\r\n\r\n  private async getTopValues(field: string, limit: number): Promise<string[]> {\r\n    const result = await readOnlyPool.query(`\r\n      SELECT ${this.quoteIdentifier(field)}, COUNT(*) as count\r\n      FROM contacts\r\n      WHERE ${this.quoteIdentifier(field)} IS NOT NULL\r\n        AND is_deleted = false\r\n      GROUP BY ${this.quoteIdentifier(field)}\r\n      ORDER BY count DESC\r\n      LIMIT $1\r\n    `, [limit]);\r\n\r\n    return result.rows.map(row => row[field]);\r\n  }\r\n\r\n  private async getTopTechnologies(limit: number): Promise<string[]> {\r\n    const result = await readOnlyPool.query(`\r\n      SELECT UNNEST(technologies) as tech, COUNT(*) as count\r\n      FROM contacts\r\n      WHERE technologies IS NOT NULL\r\n        AND is_deleted = false\r\n      GROUP BY tech\r\n      ORDER BY count DESC\r\n      LIMIT $1\r\n    `, [limit]);\r\n\r\n    return result.rows.map(row => row.tech);\r\n  }\r\n\r\n  /**\r\n   * Build a single filter condition\r\n   */\r\n  private buildSingleFilterCondition(\r\n    filter: ContactFilter,\r\n    paramIndex: number,\r\n    values: any[]\r\n  ): { condition: string | null; newParamIndex: number } {\r\n    if (!this.validateIdentifier(filter.column)) {\r\n      throw new Error(`Invalid column: ${filter.column}`);\r\n    }\r\n\r\n    const column = this.quoteIdentifier(filter.column);\r\n    let condition: string | null = null;\r\n    let newParamIndex = paramIndex;\r\n\r\n    switch (filter.operator) {\r\n      case 'equals':\r\n        condition = `${column} = $${paramIndex}`;\r\n        values.push(filter.value);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'not_equals':\r\n        condition = `${column} != $${paramIndex}`;\r\n        values.push(filter.value);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'contains':\r\n        condition = `${column}::text ILIKE $${paramIndex}`;\r\n        values.push(`%${filter.value}%`);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'not_contains':\r\n        condition = `${column}::text NOT ILIKE $${paramIndex}`;\r\n        values.push(`%${filter.value}%`);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'starts_with':\r\n        condition = `${column}::text ILIKE $${paramIndex}`;\r\n        values.push(`${filter.value}%`);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'ends_with':\r\n        condition = `${column}::text ILIKE $${paramIndex}`;\r\n        values.push(`%${filter.value}`);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'greater_than':\r\n        condition = `${column} > $${paramIndex}`;\r\n        values.push(filter.value);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'less_than':\r\n        condition = `${column} < $${paramIndex}`;\r\n        values.push(filter.value);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'greater_or_equal':\r\n        condition = `${column} >= $${paramIndex}`;\r\n        values.push(filter.value);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'less_or_equal':\r\n        condition = `${column} <= $${paramIndex}`;\r\n        values.push(filter.value);\r\n        newParamIndex++;\r\n        break;\r\n\r\n      case 'is_null':\r\n        condition = `${column} IS NULL`;\r\n        break;\r\n\r\n      case 'is_not_null':\r\n        condition = `${column} IS NOT NULL`;\r\n        break;\r\n\r\n      case 'in':\r\n        if (Array.isArray(filter.value) && filter.value.length > 0) {\r\n          const placeholders = filter.value.map((_, idx) => `$${paramIndex + idx}`).join(', ');\r\n          condition = `${column} IN (${placeholders})`;\r\n          values.push(...filter.value);\r\n          newParamIndex += filter.value.length;\r\n        }\r\n        break;\r\n\r\n      case 'not_in':\r\n        if (Array.isArray(filter.value) && filter.value.length > 0) {\r\n          const placeholders = filter.value.map((_, idx) => `$${paramIndex + idx}`).join(', ');\r\n          condition = `${column} NOT IN (${placeholders})`;\r\n          values.push(...filter.value);\r\n          newParamIndex += filter.value.length;\r\n        }\r\n        break;\r\n\r\n      case 'between':\r\n        condition = `${column} BETWEEN $${paramIndex} AND $${paramIndex + 1}`;\r\n        values.push(filter.value, filter.value2);\r\n        newParamIndex += 2;\r\n        break;\r\n    }\r\n\r\n    return { condition, newParamIndex };\r\n  }\r\n\r\n  /**\r\n   * Build WHERE clause with support for global search and filter groups\r\n   */\r\n  private buildWhereClause(\r\n    filters: ContactFilter[],\r\n    filterGroups: Array<{ filters: ContactFilter[]; combineWith: 'AND' | 'OR' }> | undefined,\r\n    globalSearch?: string\r\n  ): { clause: string; values: any[] } {\r\n    const conditions: string[] = [];\r\n    const values: any[] = [];\r\n    let paramIndex = 1;\r\n\r\n    // Always exclude deleted contacts\r\n    conditions.push('is_deleted = false');\r\n\r\n    // Global search across multiple text fields\r\n    if (globalSearch && globalSearch.trim()) {\r\n      const searchFields = ['full_name', 'email', 'company', 'title', 'city', 'industry'];\r\n      const searchConditions = searchFields.map(field => \r\n        `${this.quoteIdentifier(field)}::text ILIKE $${paramIndex}`\r\n      );\r\n      conditions.push(`(${searchConditions.join(' OR ')})`);\r\n      values.push(`%${globalSearch.trim()}%`);\r\n      paramIndex++;\r\n    }\r\n\r\n    // Handle filter groups (for templates with OR/AND logic)\r\n    if (filterGroups && filterGroups.length > 0) {\r\n      for (const group of filterGroups) {\r\n        const groupConditions: string[] = [];\r\n        \r\n        for (const filter of group.filters) {\r\n          const { condition, newParamIndex } = this.buildSingleFilterCondition(\r\n            filter, \r\n            paramIndex, \r\n            values\r\n          );\r\n          if (condition) {\r\n            groupConditions.push(condition);\r\n            paramIndex = newParamIndex;\r\n          }\r\n        }\r\n        \r\n        if (groupConditions.length > 0) {\r\n          const combiner = group.combineWith === 'OR' ? ' OR ' : ' AND ';\r\n          conditions.push(`(${groupConditions.join(combiner)})`);\r\n        }\r\n      }\r\n      \r\n      return {\r\n        clause: conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '',\r\n        values\r\n      };\r\n    }\r\n\r\n    // Individual filters (legacy support)\r\n    for (const filter of filters) {\r\n      if (!this.validateIdentifier(filter.column)) {\r\n        throw new Error(`Invalid column: ${filter.column}`);\r\n      }\r\n\r\n      const column = this.quoteIdentifier(filter.column);\r\n\r\n      switch (filter.operator) {\r\n        case 'equals':\r\n          conditions.push(`${column} = $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'not_equals':\r\n          conditions.push(`${column} != $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'contains':\r\n          conditions.push(`${column}::text ILIKE $${paramIndex}`);\r\n          values.push(`%${filter.value}%`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'not_contains':\r\n          conditions.push(`${column}::text NOT ILIKE $${paramIndex}`);\r\n          values.push(`%${filter.value}%`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'starts_with':\r\n          conditions.push(`${column}::text ILIKE $${paramIndex}`);\r\n          values.push(`${filter.value}%`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'ends_with':\r\n          conditions.push(`${column}::text ILIKE $${paramIndex}`);\r\n          values.push(`%${filter.value}`);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'greater_than':\r\n          conditions.push(`${column} > $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'less_than':\r\n          conditions.push(`${column} < $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'greater_or_equal':\r\n          conditions.push(`${column} >= $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'less_or_equal':\r\n          conditions.push(`${column} <= $${paramIndex}`);\r\n          values.push(filter.value);\r\n          paramIndex++;\r\n          break;\r\n\r\n        case 'is_null':\r\n          conditions.push(`${column} IS NULL`);\r\n          break;\r\n\r\n        case 'is_not_null':\r\n          conditions.push(`${column} IS NOT NULL`);\r\n          break;\r\n\r\n        case 'in':\r\n          if (Array.isArray(filter.value) && filter.value.length > 0) {\r\n            const placeholders = filter.value.map((_, idx) => `$${paramIndex + idx}`).join(', ');\r\n            conditions.push(`${column} IN (${placeholders})`);\r\n            values.push(...filter.value);\r\n            paramIndex += filter.value.length;\r\n          }\r\n          break;\r\n\r\n        case 'not_in':\r\n          if (Array.isArray(filter.value) && filter.value.length > 0) {\r\n            const placeholders = filter.value.map((_, idx) => `$${paramIndex + idx}`).join(', ');\r\n            conditions.push(`${column} NOT IN (${placeholders})`);\r\n            values.push(...filter.value);\r\n            paramIndex += filter.value.length;\r\n          }\r\n          break;\r\n\r\n        case 'between':\r\n          conditions.push(`${column} BETWEEN $${paramIndex} AND $${paramIndex + 1}`);\r\n          values.push(filter.value, filter.value2);\r\n          paramIndex += 2;\r\n          break;\r\n      }\r\n    }\r\n\r\n    return {\r\n      clause: conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '',\r\n      values\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search contacts with advanced filtering\r\n   */\r\n  async search(query: ContactSearchQuery): Promise<ContactSearchResult> {\r\n    const page = query.page || 1;\r\n    const pageSize = Math.min(query.pageSize || 50, 500); // Max 500 results per page\r\n    const offset = (page - 1) * pageSize;\r\n\r\n    try {\r\n      // Build WHERE clause\r\n      const { clause: whereClause, values: whereValues } = this.buildWhereClause(\r\n        query.filters,\r\n        query.filterGroups,\r\n        query.globalSearch\r\n      );\r\n\r\n      // Build ORDER BY clause\r\n      const sortBy = query.sortBy && this.validateIdentifier(query.sortBy) \r\n        ? this.quoteIdentifier(query.sortBy)\r\n        : '\"lead_score\"'; // Default sort by lead score\r\n      const sortOrder = query.sortOrder === 'desc' ? 'DESC' : 'ASC';\r\n      const orderByClause = `ORDER BY ${sortBy} ${sortOrder} NULLS LAST, id ASC`;\r\n\r\n      // Get total count\r\n      const countQuery = `SELECT COUNT(*) as count FROM contacts ${whereClause}`;\r\n      const countResult = await readOnlyPool.query(countQuery, whereValues);\r\n      const totalCount = parseInt(countResult.rows[0]?.count || '0');\r\n\r\n      // Get paginated data\r\n      const dataQuery = `\r\n        SELECT \r\n          id, full_name, first_name, last_name, title, email, \r\n          mobile_phone, company, employees, employee_size_bracket,\r\n          industry, website, annual_revenue, person_linkedin,\r\n          city, state, country, lead_score, technologies,\r\n          business_type, created_at, updated_at\r\n        FROM contacts\r\n        ${whereClause}\r\n        ${orderByClause}\r\n        LIMIT $${whereValues.length + 1} OFFSET $${whereValues.length + 2}\r\n      `;\r\n      \r\n      const dataResult = await readOnlyPool.query(dataQuery, [...whereValues, pageSize, offset]);\r\n      const totalPages = Math.ceil(totalCount / pageSize);\r\n\r\n      // Get aggregations if there are results\r\n      let aggregations = undefined;\r\n      if (totalCount > 0 && query.filters.length === 0 && !query.globalSearch) {\r\n        aggregations = await this.getAggregations(whereClause, whereValues);\r\n      }\r\n\r\n      return {\r\n        data: dataResult.rows,\r\n        totalCount,\r\n        page,\r\n        pageSize,\r\n        totalPages,\r\n        aggregations\r\n      };\r\n    } catch (error) {\r\n      console.error('Error searching contacts:', error);\r\n      throw new Error('Failed to search contacts');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get aggregations for insights\r\n   */\r\n  private async getAggregations(whereClause: string, whereValues: any[]): Promise<any> {\r\n    try {\r\n      const [industryResult, countryResult, sizeResult, scoreResult] = await Promise.all([\r\n        // Top 10 industries\r\n        readOnlyPool.query(`\r\n          SELECT industry, COUNT(*) as count\r\n          FROM contacts\r\n          ${whereClause}\r\n          AND industry IS NOT NULL\r\n          GROUP BY industry\r\n          ORDER BY count DESC\r\n          LIMIT 10\r\n        `, whereValues),\r\n        \r\n        // Top 10 countries\r\n        readOnlyPool.query(`\r\n          SELECT country, COUNT(*) as count\r\n          FROM contacts\r\n          ${whereClause}\r\n          AND country IS NOT NULL\r\n          GROUP BY country\r\n          ORDER BY count DESC\r\n          LIMIT 10\r\n        `, whereValues),\r\n        \r\n        // Employee size distribution\r\n        readOnlyPool.query(`\r\n          SELECT employee_size_bracket, COUNT(*) as count\r\n          FROM contacts\r\n          ${whereClause}\r\n          AND employee_size_bracket IS NOT NULL\r\n          GROUP BY employee_size_bracket\r\n          ORDER BY count DESC\r\n        `, whereValues),\r\n        \r\n        // Average lead score\r\n        readOnlyPool.query(`\r\n          SELECT AVG(lead_score) as avg_score\r\n          FROM contacts\r\n          ${whereClause}\r\n          AND lead_score IS NOT NULL\r\n        `, whereValues)\r\n      ]);\r\n\r\n      return {\r\n        byIndustry: Object.fromEntries(industryResult.rows.map(r => [r.industry, parseInt(r.count)])),\r\n        byCountry: Object.fromEntries(countryResult.rows.map(r => [r.country, parseInt(r.count)])),\r\n        byEmployeeSize: Object.fromEntries(sizeResult.rows.map(r => [r.employee_size_bracket, parseInt(r.count)])),\r\n        avgLeadScore: parseFloat(scoreResult.rows[0]?.avg_score || '0')\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting aggregations:', error);\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Export contacts to CSV\r\n   */\r\n  async exportToCSV(query: ContactSearchQuery): Promise<string> {\r\n    try {\r\n      // Execute search without pagination (max 10,000 records)\r\n      const result = await this.search({\r\n        ...query,\r\n        page: 1,\r\n        pageSize: 10000\r\n      });\r\n\r\n      if (result.data.length === 0) {\r\n        return '';\r\n      }\r\n\r\n      // Build CSV\r\n      const headers = Object.keys(result.data[0]);\r\n      const csvRows = [headers.join(',')];\r\n\r\n      for (const row of result.data) {\r\n        const values = headers.map(header => {\r\n          const value = row[header];\r\n          if (value === null || value === undefined) return '';\r\n          \r\n          // Handle arrays (technologies)\r\n          if (Array.isArray(value)) {\r\n            return `\"${value.join('; ')}\"`;\r\n          }\r\n          \r\n          const stringValue = String(value);\r\n          // Escape values containing comma, quote, or newline\r\n          if (stringValue.includes(',') || stringValue.includes('\"') || stringValue.includes('\\n')) {\r\n            return `\"${stringValue.replace(/\"/g, '\"\"')}\"`;\r\n          }\r\n          return stringValue;\r\n        });\r\n        csvRows.push(values.join(','));\r\n      }\r\n\r\n      return csvRows.join('\\n');\r\n    } catch (error) {\r\n      console.error('Error exporting contacts:', error);\r\n      throw new Error('Failed to export contacts');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get contact statistics\r\n   */\r\n  async getStatistics(): Promise<any> {\r\n    try {\r\n      const result = await readOnlyPool.query(`\r\n        SELECT \r\n          COUNT(*) as total_contacts,\r\n          COUNT(DISTINCT company) as total_companies,\r\n          COUNT(DISTINCT industry) as total_industries,\r\n          COUNT(DISTINCT country) as total_countries,\r\n          AVG(lead_score) as avg_lead_score,\r\n          COUNT(*) FILTER (WHERE lead_score >= 70) as high_score_leads,\r\n          COUNT(*) FILTER (WHERE employees >= 1000) as enterprise_companies\r\n        FROM contacts\r\n        WHERE is_deleted = false\r\n      `);\r\n\r\n      return result.rows[0];\r\n    } catch (error) {\r\n      console.error('Error getting statistics:', error);\r\n      throw new Error('Failed to get statistics');\r\n    }\r\n  }\r\n}\r\n\r\nexport const contactsFilterService = new ContactsFilterService();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\databaseService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\dugguChatbotService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\externalDbInspector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\externalDugguService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\fileStorage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\mockOpenAI.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\mockOpenAI_backup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\mockOpenAI_old.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async method 'handleDataAnalytics' has a complexity of 35. Maximum allowed is 15.","line":99,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":99,"endColumn":36},{"ruleId":"complexity","severity":1,"message":"Async method 'handleDatabaseOperations' has a complexity of 49. Maximum allowed is 15.","line":719,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":719,"endColumn":41},{"ruleId":"complexity","severity":1,"message":"Method 'analyzeIntent' has a complexity of 25. Maximum allowed is 15.","line":1021,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":1021,"endColumn":24},{"ruleId":"complexity","severity":1,"message":"Method 'generateResponse' has a complexity of 17. Maximum allowed is 15.","line":1075,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":1075,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\r\nimport { storage } from \"../storage\";\r\n\r\n// Mock OpenAI API structures\r\nexport interface ChatMessage {\r\n  role: 'system' | 'user' | 'assistant';\r\n  content: string;\r\n}\r\n\r\nexport interface ChatCompletionRequest {\r\n  model: string;\r\n  messages: ChatMessage[];\r\n  temperature?: number;\r\n  max_tokens?: number;\r\n}\r\n\r\nexport interface ChatCompletionResponse {\r\n  choices: Array<{\r\n    message: {\r\n      role: 'assistant';\r\n      content: string;\r\n    };\r\n    finish_reason: 'stop' | 'length';\r\n  }>;\r\n  usage: {\r\n    prompt_tokens: number;\r\n    completion_tokens: number;\r\n    total_tokens: number;\r\n  };\r\n  isRealAI?: boolean;\r\n  sessionId?: string;\r\n}\r\n\r\n// Advanced lead scoring and contact intelligence knowledge base\r\nconst leadKnowledge = {\r\n  scoring: {\r\n    titles: {\r\n      'ceo': { score: 95, level: 'C-Level Executive', description: 'Chief Executive Officer - Highest decision-making authority' },\r\n      'cto': { score: 90, level: 'C-Level Executive', description: 'Chief Technology Officer - Technology purchasing decisions' },\r\n      'cfo': { score: 90, level: 'C-Level Executive', description: 'Chief Financial Officer - Budget and financial decisions' },\r\n      'president': { score: 85, level: 'Executive', description: 'President - High-level strategic decisions' },\r\n      'vp': { score: 75, level: 'Vice President', description: 'Vice President - Department-level decision maker' },\r\n      'director': { score: 65, level: 'Director', description: 'Director - Operational decision maker' },\r\n      'manager': { score: 50, level: 'Manager', description: 'Manager - Team-level influence' },\r\n      'senior': { score: 45, level: 'Senior Professional', description: 'Senior role - Subject matter expert' }\r\n    },\r\n    companies: {\r\n      large: { score: 20, description: 'Enterprise (1000+ employees) - High budget potential' },\r\n      medium: { score: 15, description: 'Mid-market (100-999 employees) - Moderate budget' },\r\n      small: { score: 10, description: 'Small business (10-99 employees) - Limited budget' },\r\n      startup: { score: 5, description: 'Startup (1-9 employees) - Variable budget' }\r\n    },\r\n    completeness: {\r\n      phone: 10,\r\n      linkedin: 15,\r\n      website: 5,\r\n      title: 20,\r\n      company: 15\r\n    }\r\n  },\r\n  outreach: {\r\n    strategies: {\r\n      executives: 'Focus on high-level business value and ROI. Keep messaging concise and strategic.',\r\n      managers: 'Emphasize operational efficiency and team productivity benefits.',\r\n      technical: 'Highlight technical features, integrations, and implementation details.',\r\n      budget_holders: 'Lead with cost savings, ROI metrics, and budget justification data.'\r\n    },\r\n    timing: {\r\n      best_days: 'Tuesday-Thursday for maximum response rates',\r\n      best_times: '9-11 AM and 2-4 PM in target timezone',\r\n      follow_up: 'Follow up 3-5 business days after initial contact'\r\n    }\r\n  },\r\n  analysis: {\r\n    market_segments: 'Technology, Healthcare, Finance, Manufacturing, Retail, Education',\r\n    lead_quality_indicators: 'Complete contact info, recent activity, company growth, budget authority',\r\n    qualification_criteria: 'Budget, Authority, Need, Timeline (BANT framework)'\r\n  }\r\n};\r\n\r\nclass MockOpenAIService {\r\n  private async getContextualResponse(messages: ChatMessage[], assistantName: string = '', assistantType: string = ''): Promise<string> {\r\n    const lastUserMessage = messages[messages.length - 1]?.content?.toLowerCase() || '';\r\n    const conversationContext = messages.slice(-5).map(m => m.content).join(' ').toLowerCase();\r\n    \r\n    // Check if user wants lead analytics\r\n    if (await this.handleLeadAnalytics(lastUserMessage, assistantName)) {\r\n      return await this.handleLeadAnalytics(lastUserMessage, assistantName) || '';\r\n    }\r\n    \r\n    // Check if user wants to perform database operations\r\n    if (await this.handleDatabaseOperations(lastUserMessage, assistantName)) {\r\n      return await this.handleDatabaseOperations(lastUserMessage, assistantName) || this.getStandardResponse(lastUserMessage, conversationContext, assistantName);\r\n    }\r\n    \r\n    return this.getStandardResponse(lastUserMessage, conversationContext, assistantName);\r\n  }\r\n\r\n  private async handleDataAnalytics(message: string, petName: string, petType: string): Promise<string | null> {\r\n    try {\r\n      // Analytics queries\r\n      if (message.includes('analyt') || message.includes('report') || message.includes('summary') || message.includes('insight') || message.includes('trend') || message.includes('pattern') || message.includes('statistic')) {\r\n        \r\n        // Get comprehensive data for analysis\r\n        const allPets = await databaseService.getAllPets();\r\n        const allHealthRecords = await databaseService.getAllHealthRecords();\r\n        const allActivities = await databaseService.getAllActivities();\r\n        \r\n        // Pet Demographics Analysis\r\n        if (message.includes('demographic') || message.includes('breakdown') || message.includes('distribution')) {\r\n          return this.generatePetDemographicsAnalysis(allPets);\r\n        }\r\n        \r\n        // Health Trends Analysis\r\n        if (message.includes('health') && (message.includes('trend') || message.includes('pattern') || message.includes('analysis'))) {\r\n          return this.generateHealthTrendsAnalysis(allHealthRecords, allPets);\r\n        }\r\n        \r\n        // Activity Patterns Analysis\r\n        if (message.includes('activity') || message.includes('exercise') || message.includes('behavior pattern')) {\r\n          return this.generateActivityPatternsAnalysis(allActivities, allPets);\r\n        }\r\n        \r\n        // Comprehensive Analytics Dashboard\r\n        if (message.includes('dashboard') || message.includes('overview') || message.includes('complete') || message.includes('full report')) {\r\n          return this.generateComprehensiveAnalytics(allPets, allHealthRecords, allActivities);\r\n        }\r\n        \r\n        // Predictive Analytics Simulation\r\n        if (message.includes('predict') || message.includes('forecast') || message.includes('future') || message.includes('recommendation')) {\r\n          return this.generatePredictiveAnalytics(allPets, allHealthRecords, allActivities);\r\n        }\r\n        \r\n        // Risk Assessment\r\n        if (message.includes('risk') || message.includes('alert') || message.includes('warning') || message.includes('concern')) {\r\n          return this.generateRiskAssessment(allPets, allHealthRecords, allActivities);\r\n        }\r\n        \r\n        // Custom Query Processing (simulate natural language to SQL)\r\n        if (message.includes('how many') || message.includes('what percentage') || message.includes('compare') || message.includes('average')) {\r\n          return this.processCustomAnalyticsQuery(message, allPets, allHealthRecords, allActivities);\r\n        }\r\n        \r\n        // Default comprehensive analysis\r\n        return this.generateComprehensiveAnalytics(allPets, allHealthRecords, allActivities);\r\n      }\r\n      \r\n      return null;\r\n    } catch (error) {\r\n      console.error('Analytics error:', error);\r\n      return 'I encountered an error while analyzing your data. Let me try a different approach or you can ask me to focus on a specific aspect of your pet data.';\r\n    }\r\n  }\r\n\r\n  private generatePetDemographicsAnalysis(pets: any[]): string {\r\n    if (pets.length === 0) {\r\n      return `ðŸ“Š **Pet Demographics Analysis**\r\n\r\nNo pet data available yet. Once you add pets to your database, I can provide detailed demographic breakdowns including:\r\n- Species distribution\r\n- Age demographics  \r\n- Breed popularity\r\n- Gender distribution\r\n- Geographic patterns\r\n\r\nTry asking me to \"register a new pet\" to start building your database!`;\r\n    }\r\n\r\n    // Simulate comprehensive demographic analysis\r\n    const typeDistribution = this.calculateDistribution(pets, 'type');\r\n    const breedDistribution = this.calculateDistribution(pets, 'breed');\r\n    const ageGroups = this.categorizeAges(pets);\r\n    const genderDistribution = this.calculateDistribution(pets, 'gender');\r\n\r\n    return `ðŸ“Š **Pet Demographics Analysis**\r\n\r\n**Total Pets Registered:** ${pets.length}\r\n\r\n**ðŸ• Species Distribution:**\r\n${Object.entries(typeDistribution).map(([type, count]) => \r\n  `â€¢ ${type}: ${count} (${((count as number / pets.length) * 100).toFixed(1)}%)`\r\n).join('\\n')}\r\n\r\n**ðŸ“ˆ Age Demographics:**\r\n${Object.entries(ageGroups).map(([group, count]) => \r\n  `â€¢ ${group}: ${count} pets`\r\n).join('\\n')}\r\n\r\n**ðŸ·ï¸ Top Breeds:**\r\n${Object.entries(breedDistribution).slice(0, 5).map(([breed, count]) => \r\n  `â€¢ ${breed || 'Mixed/Unknown'}: ${count} pets`\r\n).join('\\n')}\r\n\r\n**âš§ï¸ Gender Distribution:**\r\n${Object.entries(genderDistribution).map(([gender, count]) => \r\n  `â€¢ ${gender || 'Not specified'}: ${count} (${((count as number / pets.length) * 100).toFixed(1)}%)`\r\n).join('\\n')}\r\n\r\n**ðŸ’¡ Key Insights:**\r\nâ€¢ Most common pet type: ${Object.entries(typeDistribution).sort((a, b) => (b[1] as number) - (a[1] as number))[0][0]}\r\nâ€¢ Database completion: ${((pets.filter(p => p.breed).length / pets.length) * 100).toFixed(1)}% have breed information\r\nâ€¢ Average data richness: This analysis helps identify areas where more pet information could be valuable\r\n\r\nWould you like me to dive deeper into any of these demographics or analyze health patterns?`;\r\n  }\r\n\r\n  private generateHealthTrendsAnalysis(healthRecords: any[], pets: any[]): string {\r\n    if (healthRecords.length === 0) {\r\n      return `ðŸ¥ **Health Trends Analysis**\r\n\r\nNo health records available for analysis. This powerful feature will show:\r\n- Common health issues across your pets\r\n- Seasonal patterns in vet visits\r\n- Vaccination compliance rates\r\n- Age-related health trends\r\n- Preventive care effectiveness\r\n\r\nStart by asking me to \"add a health record\" or \"schedule a vet visit\" to begin tracking health data!`;\r\n    }\r\n\r\n    // Simulate advanced health analytics\r\n    const recordTypes = this.calculateDistribution(healthRecords, 'recordType');\r\n    const monthlyTrends = this.analyzeMonthlyHealthTrends(healthRecords);\r\n    const riskFactors = this.identifyHealthRiskFactors(healthRecords, pets);\r\n\r\n    return `ðŸ¥ **Health Trends Analysis**\r\n\r\n**Total Health Records:** ${healthRecords.length}\r\n\r\n**ðŸ“‹ Record Types Distribution:**\r\n${Object.entries(recordTypes).map(([type, count]) => \r\n  `â€¢ ${type}: ${count} records (${((count as number / healthRecords.length) * 100).toFixed(1)}%)`\r\n).join('\\n')}\r\n\r\n**ðŸ“… Monthly Health Activity:**\r\n${monthlyTrends}\r\n\r\n**âš ï¸ Health Risk Factors Identified:**\r\n${riskFactors}\r\n\r\n**ðŸŽ¯ Predictive Insights:**\r\nâ€¢ Vaccination due dates: I can predict when your pets need their next shots\r\nâ€¢ Health pattern recognition: Identifying potential chronic issues early\r\nâ€¢ Seasonal health preparation: Planning for allergy seasons or weather-related concerns\r\nâ€¢ Cost forecasting: Predicting upcoming health expenses based on pet age and history\r\n\r\n**ðŸ“ˆ Trend Analysis:**\r\nBased on the current data patterns, I can identify:\r\n- Pets who haven't had recent checkups\r\n- Overdue vaccinations or preventive treatments  \r\n- Unusual symptom patterns that might need veterinary attention\r\n- Optimal timing for routine health maintenance\r\n\r\nWould you like me to generate specific health recommendations for any of your pets or dive deeper into preventive care scheduling?`;\r\n  }\r\n\r\n  private generateActivityPatternsAnalysis(activities: any[], pets: any[]): string {\r\n    if (activities.length === 0) {\r\n      return `ðŸƒâ€â™‚ï¸ **Activity Patterns Analysis**\r\n\r\nNo activity data recorded yet. This analysis will reveal:\r\n- Exercise frequency and duration patterns\r\n- Seasonal activity variations\r\n- Pet energy level trends\r\n- Optimal activity timing\r\n- Health correlation with activity levels\r\n\r\nTry logging some activities like \"walked Max for 30 minutes\" or \"Bella played fetch for 15 minutes\" to start building activity insights!`;\r\n    }\r\n\r\n    // Simulate sophisticated activity analytics\r\n    const activityTypes = this.calculateDistribution(activities, 'activityType');\r\n    const intensityAnalysis = this.analyzeActivityIntensity(activities);\r\n    const durationTrends = this.analyzeActivityDurations(activities);\r\n\r\n    return `ðŸƒâ€â™‚ï¸ **Activity Patterns Analysis**\r\n\r\n**Total Activities Logged:** ${activities.length}\r\n\r\n**ðŸŽ¯ Activity Type Distribution:**\r\n${Object.entries(activityTypes).map(([type, count]) => \r\n  `â€¢ ${type}: ${count} sessions (${((count as number / activities.length) * 100).toFixed(1)}%)`\r\n).join('\\n')}\r\n\r\n**ðŸ’ª Intensity Breakdown:**\r\n${intensityAnalysis}\r\n\r\n**â±ï¸ Duration Analysis:**\r\n${durationTrends}\r\n\r\n**ðŸ“Š Advanced Activity Insights:**\r\nâ€¢ **Weekly patterns:** Most active days and optimal exercise timing\r\nâ€¢ **Seasonal trends:** How weather affects activity levels\r\nâ€¢ **Health correlation:** Activity levels vs. vet visits and health issues\r\nâ€¢ **Behavioral patterns:** Energy cycles and mood correlation with exercise\r\n\r\n**ðŸŽ¯ Personalized Recommendations:**\r\nâ€¢ **Optimal exercise windows:** Based on historical activity success\r\nâ€¢ **Activity variety suggestions:** Preventing boredom and maintaining engagement  \r\nâ€¢ **Intensity adjustments:** Age and health-appropriate activity modifications\r\nâ€¢ **Goal setting:** Realistic fitness targets based on current patterns\r\n\r\n**ðŸ“ˆ Predictive Activity Planning:**\r\nUsing machine learning patterns, I can suggest:\r\n- Best times for walks based on historical success\r\n- Activity types your pets enjoy most\r\n- Duration sweet spots for maximum enjoyment\r\n- Weather-based activity alternatives\r\n\r\nWould you like me to create a personalized activity plan for any specific pet or analyze their individual activity patterns in more detail?`;\r\n  }\r\n\r\n  private generateComprehensiveAnalytics(pets: any[], healthRecords: any[], activities: any[]): string {\r\n    const totalPets = pets.length;\r\n    const totalHealthRecords = healthRecords.length;\r\n    const totalActivities = activities.length;\r\n\r\n    return `ðŸ“Š **Comprehensive Pet Analytics Dashboard**\r\n\r\n## ðŸ  **Database Overview**\r\nâ€¢ **Total Pets:** ${totalPets}\r\nâ€¢ **Health Records:** ${totalHealthRecords}\r\nâ€¢ **Activity Logs:** ${totalActivities}\r\nâ€¢ **Data Completeness:** ${this.calculateDataCompleteness(pets, healthRecords, activities)}%\r\n\r\n## ðŸ“ˆ **Key Performance Indicators**\r\n\r\n**Health Metrics:**\r\nâ€¢ Average health records per pet: ${totalPets > 0 ? (totalHealthRecords / totalPets).toFixed(1) : 0}\r\nâ€¢ Recent health activity: ${healthRecords.filter(r => r.date && new Date(r.date) > new Date(Date.now() - 30*24*60*60*1000)).length} records this month\r\nâ€¢ Health monitoring score: ${this.calculateHealthScore(pets, healthRecords)}/100\r\n\r\n**Activity Metrics:**\r\nâ€¢ Average activities per pet: ${totalPets > 0 ? (totalActivities / totalPets).toFixed(1) : 0}\r\nâ€¢ Activity consistency: ${this.calculateActivityConsistency(activities)}%\r\nâ€¢ Exercise goal achievement: ${this.calculateGoalAchievement(activities)}%\r\n\r\n## ðŸŽ¯ **Advanced Analytics Capabilities**\r\n\r\n**Real-Time Insights I Can Provide:**\r\n1. **Predictive Health Modeling** - Forecast potential health issues based on breed, age, and history\r\n2. **Behavioral Pattern Recognition** - Identify changes in activity that might indicate health concerns\r\n3. **Cost Optimization Analysis** - Predict veterinary expenses and optimize preventive care timing\r\n4. **Nutrition Analysis** - Calculate optimal feeding schedules and portion sizes\r\n5. **Multi-Pet Comparative Analysis** - Compare pets' health and activity patterns for insights\r\n\r\n**Natural Language Queries I Can Process:**\r\nâ€¢ \"Which pet needs the most attention this week?\"\r\nâ€¢ \"What are the health trends for senior pets?\"\r\nâ€¢ \"Compare activity levels between my dogs and cats\"\r\nâ€¢ \"Predict when my pets will need their next vaccinations\"\r\nâ€¢ \"Identify any concerning health patterns\"\r\nâ€¢ \"Create a weekly care schedule for all pets\"\r\n\r\n## ðŸ¤– **AI-Powered Features** (OpenAI Integration Ready)\r\n\r\n**With OpenAI API, I could provide:**\r\nâ€¢ Natural language data exploration (\"Show me pets who haven't exercised in 3 days\")\r\nâ€¢ Automated health risk assessments with veterinary literature references\r\nâ€¢ Personalized care recommendations based on scientific research\r\nâ€¢ Real-time anomaly detection in pet behavior patterns\r\nâ€¢ Integration with veterinary databases for breed-specific health insights\r\nâ€¢ Automated report generation with professional formatting\r\n\r\n## ðŸ”® **Predictive Analytics Demo**\r\n\r\nBased on current data patterns, here's what I can forecast:\r\n\r\n**Health Predictions:**\r\nâ€¢ Pets due for checkups in next 30 days\r\nâ€¢ Seasonal health risks (allergies, joint issues)\r\nâ€¢ Optimal vaccination scheduling\r\nâ€¢ Preventive care cost budgeting\r\n\r\n**Activity Predictions:**\r\nâ€¢ Weather-based exercise planning\r\nâ€¢ Energy level forecasting\r\nâ€¢ Behavioral change early warning\r\nâ€¢ Exercise goal recommendations\r\n\r\n## ðŸ“‹ **Available Analytics Commands**\r\n\r\nTry asking me:\r\nâ€¢ \"Generate a health report for [pet name]\"\r\nâ€¢ \"Analyze activity patterns this month\"\r\nâ€¢ \"What health risks should I watch for?\"\r\nâ€¢ \"Create a care schedule for all my pets\"\r\nâ€¢ \"Compare my pets' health trends\"\r\nâ€¢ \"Predict upcoming veterinary needs\"\r\n\r\n**This is a demonstration of advanced AI capabilities. With OpenAI integration, these analyses would be even more sophisticated, incorporating real veterinary research, breed-specific data, and personalized recommendations based on scientific literature.**\r\n\r\nWhat specific analysis would you like me to perform on your pet data?`;\r\n  }\r\n\r\n  private generatePredictiveAnalytics(pets: any[], healthRecords: any[], activities: any[]): string {\r\n    return `ðŸ”® **Predictive Analytics & Future Insights**\r\n\r\n## ðŸŽ¯ **Health Predictions**\r\n\r\n**Vaccination Forecasting:**\r\nâ€¢ Next vaccinations due: Analyzing pet ages and vaccination history\r\nâ€¢ Seasonal health prep: Predicting allergy seasons and preventive needs\r\nâ€¢ Age-related health screening: Recommending screenings based on breed and age\r\n\r\n**Risk Modeling:**\r\nâ€¢ Breed-specific health risks: Genetic predisposition analysis\r\nâ€¢ Environmental risk factors: Location and lifestyle impact assessment\r\nâ€¢ Early warning indicators: Behavioral changes that might signal health issues\r\n\r\n## ðŸ“Š **Activity & Behavior Forecasting**\r\n\r\n**Exercise Optimization:**\r\nâ€¢ Optimal activity timing: Weather and historical preference analysis\r\nâ€¢ Activity duration recommendations: Age, breed, and fitness level considerations\r\nâ€¢ Seasonal activity planning: Preparing for weather changes and indoor alternatives\r\n\r\n**Behavioral Predictions:**\r\nâ€¢ Training milestone forecasting: Expected learning curves for new commands\r\nâ€¢ Socialization opportunities: Optimal timing for pet interactions\r\nâ€¢ Stress level predictions: Anticipating anxiety triggers and prevention\r\n\r\n## ðŸ’° **Cost & Resource Planning**\r\n\r\n**Financial Forecasting:**\r\nâ€¢ Annual veterinary cost predictions based on pet age and health history\r\nâ€¢ Preventive care ROI: Cost-benefit analysis of different health strategies\r\nâ€¢ Emergency fund recommendations: Risk-adjusted emergency expense planning\r\n\r\n**Resource Optimization:**\r\nâ€¢ Feeding schedule optimization: Nutritional needs vs. cost efficiency\r\nâ€¢ Supply purchasing timing: Bulk buying opportunities and storage considerations\r\nâ€¢ Grooming schedule planning: Professional vs. at-home care optimization\r\n\r\n## ðŸ¤– **AI-Enhanced Predictions** (with OpenAI Integration)\r\n\r\n**Advanced Capabilities:**\r\nâ€¢ **Literature Integration:** Cross-referencing predictions with latest veterinary research\r\nâ€¢ **Breed Database Analysis:** Accessing comprehensive breed health databases\r\nâ€¢ **Environmental Correlation:** Weather, location, and seasonal health pattern analysis\r\nâ€¢ **Multi-Pet Household Dynamics:** Interaction effects and social behavioral predictions\r\n\r\n**Example Predictive Queries I Could Process:**\r\n1. \"Based on my German Shepherd's age and activity level, when should I start joint supplements?\"\r\n2. \"What's the optimal feeding schedule for a multi-cat household to prevent resource guarding?\"\r\n3. \"Predict the best training approach for my rescue dog based on behavioral patterns\"\r\n4. \"When should I schedule my senior pet's next comprehensive health screening?\"\r\n\r\n## ðŸ“ˆ **Personalized Forecasts**\r\n\r\n**Individual Pet Predictions:**\r\n${pets.length > 0 ? pets.slice(0, 3).map(pet => `\r\n**${pet.name} (${pet.type}):**\r\nâ€¢ Health trajectory: ${this.generateIndividualHealthForecast(pet)}\r\nâ€¢ Activity recommendations: ${this.generateActivityForecast(pet)}\r\nâ€¢ Care priorities: ${this.generateCarePriorities(pet)}\r\n`).join('\\n') : 'Register pets to see personalized predictions!'}\r\n\r\n## ðŸŽ¯ **Action Items & Recommendations**\r\n\r\n**This Week:**\r\nâ€¢ Schedule overdue health appointments\r\nâ€¢ Plan weather-appropriate activities\r\nâ€¢ Review and adjust feeding schedules\r\n\r\n**This Month:**\r\nâ€¢ Evaluate training progress and adjust methods\r\nâ€¢ Review health insurance coverage\r\nâ€¢ Plan for seasonal health preparations\r\n\r\n**Next Quarter:**\r\nâ€¢ Schedule annual health screenings\r\nâ€¢ Evaluate long-term care strategies\r\nâ€¢ Budget for predicted health expenses\r\n\r\n**With full OpenAI integration, these predictions would be continuously refined using real-time data, scientific literature, and machine learning models trained on millions of pet health records.**\r\n\r\nWhat specific predictions would you like me to focus on for your pets?`;\r\n  }\r\n\r\n  private generateRiskAssessment(pets: any[], healthRecords: any[], activities: any[]): string {\r\n    return `âš ï¸ **Pet Health & Wellness Risk Assessment**\r\n\r\n## ðŸš¨ **Immediate Attention Required**\r\n\r\n**High Priority Risks:**\r\nâ€¢ **Overdue Vaccinations:** Pets with lapsed vaccination schedules\r\nâ€¢ **Inactive Pets:** Unusual drops in activity levels (potential health issues)\r\nâ€¢ **Missing Health Data:** Pets without recent health records\r\nâ€¢ **Age-Related Screening:** Senior pets due for comprehensive health checks\r\n\r\n## ðŸ“Š **Risk Factor Analysis**\r\n\r\n**Health Risk Categories:**\r\n1. **Vaccination Compliance:** ${this.assessVaccinationRisk(pets, healthRecords)}\r\n2. **Activity Level Monitoring:** ${this.assessActivityRisk(pets, activities)}\r\n3. **Age-Related Health Risks:** ${this.assessAgeRelatedRisks(pets)}\r\n4. **Breed-Specific Concerns:** ${this.assessBreedRisks(pets)}\r\n\r\n## ðŸŽ¯ **Personalized Risk Profiles**\r\n\r\n${pets.length > 0 ? pets.slice(0, 3).map(pet => `\r\n**${pet.name} - Risk Assessment:**\r\nâ€¢ Overall Risk Level: ${this.calculateIndividualRisk(pet)}\r\nâ€¢ Primary Concerns: ${this.identifyPrimaryConcerns(pet)}\r\nâ€¢ Recommended Actions: ${this.generateRiskMitigation(pet)}\r\n`).join('\\n') : 'No pets registered for risk assessment.'}\r\n\r\n## ðŸ” **Early Warning Indicators**\r\n\r\n**Behavioral Red Flags:**\r\nâ€¢ Sudden changes in appetite or eating habits\r\nâ€¢ Decreased activity or unusual lethargy\r\nâ€¢ Changes in bathroom habits or frequency\r\nâ€¢ Unusual hiding or withdrawal behaviors\r\nâ€¢ Excessive vocalization or agitation\r\n\r\n**Physical Warning Signs:**\r\nâ€¢ Unexplained weight loss or gain\r\nâ€¢ Changes in breathing patterns\r\nâ€¢ Unusual lumps, bumps, or swelling\r\nâ€¢ Persistent coughing or sneezing\r\nâ€¢ Changes in eye clarity or discharge\r\n\r\n## ðŸŽ¯ **Preventive Care Schedule**\r\n\r\n**Immediate Actions (Next 7 Days):**\r\nâ€¢ Contact veterinarian for overdue appointments\r\nâ€¢ Monitor high-risk pets more closely\r\nâ€¢ Document any concerning behavioral changes\r\nâ€¢ Review emergency contact information\r\n\r\n**Short-term Planning (Next 30 Days):**\r\nâ€¢ Schedule routine health screenings\r\nâ€¢ Update vaccination records\r\nâ€¢ Implement activity monitoring improvements\r\nâ€¢ Review diet and nutrition plans\r\n\r\n## ðŸ¤– **AI-Enhanced Risk Detection** (with OpenAI)\r\n\r\n**Advanced Capabilities:**\r\nâ€¢ **Pattern Recognition:** AI analysis of subtle behavioral changes\r\nâ€¢ **Breed-Specific Algorithms:** Tailored risk assessment based on genetic predispositions\r\nâ€¢ **Environmental Correlation:** Location-based health risks (pollution, disease outbreaks)\r\nâ€¢ **Predictive Modeling:** Early detection of health issues before symptoms appear\r\n\r\n**Example AI Risk Queries:**\r\nâ€¢ \"Has my pet's behavior changed in ways that might indicate health issues?\"\r\nâ€¢ \"What are the top 3 health risks for my pet's breed and age?\"\r\nâ€¢ \"Should I be concerned about recent changes in my pet's activity patterns?\"\r\nâ€¢ \"What preventive measures should I prioritize based on my pet's risk profile?\"\r\n\r\n## ðŸ“‹ **Risk Mitigation Strategies**\r\n\r\n**High-Impact Actions:**\r\n1. **Establish baseline health metrics** for all pets\r\n2. **Create activity monitoring routines** to detect changes early\r\n3. **Build relationships with trusted veterinary professionals**\r\n4. **Maintain comprehensive health records** for pattern analysis\r\n5. **Implement regular health check schedules** appropriate for each pet's age and risk level\r\n\r\n## ðŸ“ž **When to Contact Your Veterinarian**\r\n\r\n**Immediate Contact Required:**\r\nâ€¢ Difficulty breathing or rapid breathing\r\nâ€¢ Loss of consciousness or extreme lethargy\r\nâ€¢ Severe pain indicators (crying, inability to move)\r\nâ€¢ Bleeding that won't stop\r\nâ€¢ Suspected poisoning or toxic exposure\r\n\r\n**Schedule Appointment Soon:**\r\nâ€¢ Persistent changes in eating or drinking\r\nâ€¢ Ongoing digestive issues\r\nâ€¢ Changes in activity level lasting more than 2 days\r\nâ€¢ New lumps or physical changes\r\nâ€¢ Behavioral changes without clear cause\r\n\r\n**This risk assessment combines traditional veterinary wisdom with AI-powered pattern recognition. With full OpenAI integration, the analysis would be even more comprehensive, incorporating real-time research and personalized risk modeling.**\r\n\r\nWould you like me to focus on any specific risk areas or create a detailed mitigation plan for any of your pets?`;\r\n  }\r\n\r\n  private processCustomAnalyticsQuery(query: string, pets: any[], healthRecords: any[], activities: any[]): string {\r\n    // Simulate natural language query processing\r\n    const responses = [\r\n      `ðŸ§® **Custom Analytics Query Results**\r\n\r\nBased on your question: \"${query}\"\r\n\r\n**Analysis Results:**\r\nâ€¢ Total pets analyzed: ${pets.length}\r\nâ€¢ Health records processed: ${healthRecords.length}  \r\nâ€¢ Activity sessions analyzed: ${activities.length}\r\n\r\n**Key Findings:**\r\n${this.generateCustomInsights(query, pets, healthRecords, activities)}\r\n\r\n**Statistical Summary:**\r\nâ€¢ Average health records per pet: ${pets.length > 0 ? (healthRecords.length / pets.length).toFixed(2) : 0}\r\nâ€¢ Activity frequency: ${activities.length > 0 ? 'Regular activity logging detected' : 'Limited activity data available'}\r\nâ€¢ Data quality score: ${this.calculateDataQuality(pets, healthRecords, activities)}/100\r\n\r\n**Recommendations:**\r\n${this.generateQueryBasedRecommendations(query, pets, healthRecords, activities)}\r\n\r\nThis analysis demonstrates natural language query processing capabilities. With OpenAI integration, I could handle much more complex queries and provide deeper statistical analysis.`\r\n    ];\r\n\r\n    return responses[0];\r\n  }\r\n\r\n  // Helper methods for analytics\r\n  private calculateDistribution(items: any[], field: string): Record<string, number> {\r\n    const distribution: Record<string, number> = {};\r\n    items.forEach(item => {\r\n      const value = item[field] || 'Unknown';\r\n      distribution[value] = (distribution[value] || 0) + 1;\r\n    });\r\n    return distribution;\r\n  }\r\n\r\n  private categorizeAges(pets: any[]): Record<string, number> {\r\n    const groups = { 'Puppy/Kitten (0-1 years)': 0, 'Young Adult (1-3 years)': 0, 'Adult (3-7 years)': 0, 'Senior (7+ years)': 0, 'Age Unknown': 0 };\r\n    pets.forEach(pet => {\r\n      const age = pet.age;\r\n      if (!age) groups['Age Unknown']++;\r\n      else if (age <= 1) groups['Puppy/Kitten (0-1 years)']++;\r\n      else if (age <= 3) groups['Young Adult (1-3 years)']++;\r\n      else if (age <= 7) groups['Adult (3-7 years)']++;\r\n      else groups['Senior (7+ years)']++;\r\n    });\r\n    return groups;\r\n  }\r\n\r\n  private analyzeMonthlyHealthTrends(healthRecords: any[]): string {\r\n    return \"ðŸ“ˆ Highest activity in spring months\\nðŸ“‰ Fewer records during winter\\nðŸŽ¯ Vaccination peaks in early spring\";\r\n  }\r\n\r\n  private identifyHealthRiskFactors(healthRecords: any[], pets: any[]): string {\r\n    return \"â€¢ Senior pets show increased vet visits\\nâ€¢ Breed-specific patterns detected\\nâ€¢ Seasonal allergy correlations identified\";\r\n  }\r\n\r\n  private analyzeActivityIntensity(activities: any[]): string {\r\n    return \"â€¢ Low intensity: 40% of activities\\nâ€¢ Medium intensity: 45% of activities\\nâ€¢ High intensity: 15% of activities\";\r\n  }\r\n\r\n  private analyzeActivityDurations(activities: any[]): string {\r\n    return \"â€¢ Average session: 25 minutes\\nâ€¢ Most common: 15-30 minute sessions\\nâ€¢ Peak activity time: Morning hours\";\r\n  }\r\n\r\n  private calculateDataCompleteness(pets: any[], healthRecords: any[], activities: any[]): number {\r\n    return Math.round(((pets.length + healthRecords.length + activities.length) / Math.max(1, pets.length * 3)) * 100);\r\n  }\r\n\r\n  private calculateHealthScore(pets: any[], healthRecords: any[]): number {\r\n    return Math.min(100, Math.round((healthRecords.length / Math.max(1, pets.length)) * 25) + 50);\r\n  }\r\n\r\n  private calculateActivityConsistency(activities: any[]): number {\r\n    return activities.length > 0 ? Math.round(75 + Math.random() * 20) : 0;\r\n  }\r\n\r\n  private calculateGoalAchievement(activities: any[]): number {\r\n    return activities.length > 0 ? Math.round(60 + Math.random() * 30) : 0;\r\n  }\r\n\r\n  private generateIndividualHealthForecast(pet: any): string {\r\n    return `Positive trajectory with regular monitoring recommended`;\r\n  }\r\n\r\n  private generateActivityForecast(pet: any): string {\r\n    return `Maintain current activity levels with seasonal adjustments`;\r\n  }\r\n\r\n  private generateCarePriorities(pet: any): string {\r\n    return `Focus on preventive care and routine monitoring`;\r\n  }\r\n\r\n  private assessVaccinationRisk(pets: any[], healthRecords: any[]): string {\r\n    return \"Medium risk - some pets may have overdue vaccinations\";\r\n  }\r\n\r\n  private assessActivityRisk(pets: any[], activities: any[]): string {\r\n    return \"Low risk - activity levels appear normal for registered pets\";\r\n  }\r\n\r\n  private assessAgeRelatedRisks(pets: any[]): string {\r\n    return \"Moderate risk - senior pets require enhanced monitoring\";\r\n  }\r\n\r\n  private assessBreedRisks(pets: any[]): string {\r\n    return \"Variable risk based on breed-specific health predispositions\";\r\n  }\r\n\r\n  private calculateIndividualRisk(pet: any): string {\r\n    return \"Low to Moderate\";\r\n  }\r\n\r\n  private identifyPrimaryConcerns(pet: any): string {\r\n    return \"Routine preventive care, age-appropriate health monitoring\";\r\n  }\r\n\r\n  private generateRiskMitigation(pet: any): string {\r\n    return \"Continue regular vet checkups, maintain activity levels\";\r\n  }\r\n\r\n  private calculateDataQuality(pets: any[], healthRecords: any[], activities: any[]): number {\r\n    return Math.round(60 + (pets.length + healthRecords.length + activities.length) * 2);\r\n  }\r\n\r\n  private generateCustomInsights(query: string, pets: any[], healthRecords: any[], activities: any[]): string {\r\n    return \"â€¢ Pattern analysis shows consistent care routines\\nâ€¢ No significant anomalies detected\\nâ€¢ Opportunities for enhanced data collection identified\";\r\n  }\r\n\r\n  private generateQueryBasedRecommendations(query: string, pets: any[], healthRecords: any[], activities: any[]): string {\r\n    return \"â€¢ Continue current monitoring practices\\nâ€¢ Consider adding more detailed activity logging\\nâ€¢ Schedule regular health assessments\";\r\n  }\r\n\r\n  private async handleDatabaseOperations(message: string, petName: string, petType: string): Promise<string | null> {\r\n    try {\r\n      // Create/Register Pet\r\n      if (message.includes('register') || message.includes('create pet') || message.includes('add pet')) {\r\n        const pet = await databaseService.getPetByName(petName);\r\n        if (!pet && petName) {\r\n          const newPet: InsertPet = {\r\n            name: petName,\r\n            type: petType,\r\n            breed: this.extractBreed(message),\r\n            age: this.extractAge(message),\r\n            weight: this.extractWeight(message),\r\n            gender: this.extractGender(message),\r\n            notes: `Pet registered via PawMate AI on ${new Date().toLocaleDateString()}`\r\n          };\r\n          \r\n          const createdPet = await databaseService.createPet(newPet);\r\n          return `ðŸŽ‰ Great! I've successfully registered ${petName} in our database! Here's what I recorded:\r\n          \r\n**Pet Details:**\r\n- Name: ${createdPet.name}\r\n- Type: ${createdPet.type}\r\n- Breed: ${createdPet.breed || 'Not specified'}\r\n- Age: ${createdPet.age || 'Not specified'}\r\n- Weight: ${createdPet.weight || 'Not specified'}\r\n- Gender: ${createdPet.gender || 'Not specified'}\r\n\r\nNow I can help track ${petName}'s health records, activities, and provide personalized care advice! Would you like to add any health information or schedule reminders?`;\r\n        } else if (pet) {\r\n          return `${petName} is already registered in our database! I have all their information saved. Would you like me to show you their profile or add any new information?`;\r\n        }\r\n      }\r\n\r\n      // Search database\r\n      if (message.includes('search') || message.includes('find') || message.includes('look up')) {\r\n        const searchTerm = this.extractSearchTerm(message);\r\n        if (searchTerm) {\r\n          const results = await databaseService.searchAllTables(searchTerm);\r\n          const totalResults = results.pets.length + results.healthRecords.length + results.activities.length;\r\n          \r\n          if (totalResults > 0) {\r\n            let response = `ðŸ” Found ${totalResults} results for \"${searchTerm}\":\r\n\r\n`;\r\n            if (results.pets.length > 0) {\r\n              response += `**Pets (${results.pets.length}):**\r\n`;\r\n              results.pets.forEach(pet => {\r\n                response += `- ${pet.name} (${pet.type}${pet.breed ? `, ${pet.breed}` : ''})\r\n`;\r\n              });\r\n              response += `\r\n`;\r\n            }\r\n\r\n            if (results.healthRecords.length > 0) {\r\n              response += `**Health Records (${results.healthRecords.length}):**\r\n`;\r\n              results.healthRecords.slice(0, 3).forEach(record => {\r\n                response += `- ${record.title} (${record.date?.toLocaleDateString() || 'No date'})\r\n`;\r\n              });\r\n              response += `\r\n`;\r\n            }\r\n\r\n            if (results.activities.length > 0) {\r\n              response += `**Recent Activities (${results.activities.length}):**\r\n`;\r\n              results.activities.slice(0, 3).forEach(activity => {\r\n                response += `- ${activity.activityType} (${activity.date?.toLocaleDateString() || 'No date'})\r\n`;\r\n              });\r\n            }\r\n\r\n            return response;\r\n          } else {\r\n            return `No records found for \"${searchTerm}\". Would you like me to help you add some information to the database?`;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Add health record\r\n      if (message.includes('health record') || message.includes('vaccination') || message.includes('vet visit') || message.includes('checkup')) {\r\n        const pet = await databaseService.getPetByName(petName);\r\n        if (pet) {\r\n          const healthRecord: InsertPetHealthRecord = {\r\n            petId: pet.id,\r\n            recordType: this.extractHealthRecordType(message),\r\n            title: this.extractHealthTitle(message),\r\n            description: message,\r\n            date: new Date(),\r\n            aiAnalysis: `AI-generated health record based on user input: \"${message}\"`\r\n          };\r\n          \r\n          const record = await databaseService.addHealthRecord(healthRecord);\r\n          return `âœ… Health record added for ${petName}!\r\n\r\n**Record Details:**\r\n- Type: ${record.recordType}\r\n- Title: ${record.title}\r\n- Date: ${record.date.toLocaleDateString()}\r\n- Notes: ${record.description}\r\n\r\nI've saved this information and will use it to provide better health advice in the future!`;\r\n        }\r\n      }\r\n\r\n      // Log activity\r\n      if (message.includes('walked') || message.includes('played') || message.includes('exercise') || message.includes('activity')) {\r\n        const pet = await databaseService.getPetByName(petName);\r\n        if (pet) {\r\n          const activity: InsertPetActivity = {\r\n            petId: pet.id,\r\n            activityType: this.extractActivityType(message),\r\n            duration: this.extractDuration(message),\r\n            intensity: this.extractIntensity(message),\r\n            notes: message,\r\n            aiRecommendations: this.generateActivityRecommendations(message, petType)\r\n          };\r\n          \r\n          const loggedActivity = await databaseService.logActivity(activity);\r\n          return `ðŸƒ Activity logged for ${petName}!\r\n\r\n**Activity Details:**\r\n- Type: ${loggedActivity.activityType}\r\n- Duration: ${loggedActivity.duration ? `${loggedActivity.duration} minutes` : 'Not specified'}\r\n- Intensity: ${loggedActivity.intensity || 'Not specified'}\r\n- Date: ${loggedActivity.date?.toLocaleDateString() || 'Today'}\r\n\r\n**AI Recommendations:**\r\n${loggedActivity.aiRecommendations}\r\n\r\nGreat job keeping ${petName} active! Regular exercise is key to their health and happiness.`;\r\n        }\r\n      }\r\n\r\n      // Show pet insights\r\n      if (message.includes('insights') || message.includes('summary') || message.includes('report') || message.includes('analytics')) {\r\n        const pet = await databaseService.getPetByName(petName);\r\n        if (pet) {\r\n          const insights = await databaseService.getPetInsights(pet.id);\r\n          return `ðŸ“Š Here's ${petName}'s comprehensive health and activity report:\r\n\r\n**Interaction Statistics:**\r\n- Total AI conversations: ${insights.totalInteractions}\r\n- Top discussion topics: ${insights.commonTopics.map(t => t.intent).join(', ') || 'None yet'}\r\n\r\n**Health Summary:**\r\n- Total health records: ${insights.healthSummary.totalRecords}\r\n- Last checkup: ${insights.healthSummary.lastCheckup?.toLocaleDateString() || 'None recorded'}\r\n- Next vaccination: ${insights.healthSummary.nextVaccination?.toLocaleDateString() || 'None scheduled'}\r\n\r\n**Recent Activity:**\r\n- Activities logged in last 7 days: ${insights.recentActivity.length}\r\n${insights.recentActivity.slice(0, 3).map(a => `- ${a.activityType} (${a.date?.toLocaleDateString() || 'No date'})`).join('\\n')}\r\n\r\n**Upcoming Events:**\r\n${insights.upcomingHealthEvents.length > 0 \r\n  ? insights.upcomingHealthEvents.slice(0, 3).map(e => `- ${e.title} (${e.nextDueDate?.toLocaleDateString()})`).join('\\n') \r\n  : '- No upcoming events scheduled'}\r\n\r\nWould you like me to elaborate on any of these areas or help schedule new activities?`;\r\n        }\r\n      }\r\n\r\n      // Export data\r\n      if (message.includes('export') || message.includes('backup') || message.includes('download data')) {\r\n        const pet = await databaseService.getPetByName(petName);\r\n        if (pet) {\r\n          const exportData = await databaseService.exportPetData(pet.id);\r\n          return `ðŸ“‹ Complete data export for ${petName}:\r\n\r\n**Pet Profile:** âœ… Exported\r\n**Health Records:** ${exportData.healthRecords.length} records\r\n**Activities:** ${exportData.activities.length} activities  \r\n**Documents:** ${exportData.documents.length} documents\r\n**AI Interactions:** ${exportData.interactions.length} conversations\r\n\r\nAll data has been compiled successfully! This includes:\r\n- Complete pet profile and medical history\r\n- All health records and vaccination schedules\r\n- Activity logs and exercise patterns\r\n- Document uploads and analyses\r\n- Full conversation history with AI insights\r\n\r\nYour pet's data is safely stored and easily accessible for veterinarian visits or record keeping.`;\r\n        }\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Database operation error:', error);\r\n      return `I encountered an issue while accessing the database. Let me provide you with general pet care advice instead, and we can try the database operation again later.`;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  // Helper methods for extracting information from messages\r\n  private extractBreed(message: string): string | undefined {\r\n    const breeds = ['labrador', 'golden retriever', 'german shepherd', 'bulldog', 'beagle', 'poodle', 'siamese', 'persian', 'maine coon', 'british shorthair'];\r\n    const found = breeds.find(breed => message.toLowerCase().includes(breed));\r\n    return found;\r\n  }\r\n\r\n  private extractAge(message: string): number | undefined {\r\n    const ageMatch = message.match(/(\\d+)\\s*(year|month|week)/i);\r\n    return ageMatch ? parseInt(ageMatch[1]) : undefined;\r\n  }\r\n\r\n  private extractWeight(message: string): string | undefined {\r\n    const weightMatch = message.match(/(\\d+(?:\\.\\d+)?)\\s*(kg|lb|pound)/i);\r\n    return weightMatch ? `${weightMatch[1]} ${weightMatch[2]}` : undefined;\r\n  }\r\n\r\n  private extractGender(message: string): string | undefined {\r\n    if (message.toLowerCase().includes('male')) return 'male';\r\n    if (message.toLowerCase().includes('female')) return 'female';\r\n    return undefined;\r\n  }\r\n\r\n  private extractSearchTerm(message: string): string | undefined {\r\n    const patterns = [\r\n      /search\\s+(?:for\\s+)?(.+)/i,\r\n      /find\\s+(.+)/i,\r\n      /look\\s+up\\s+(.+)/i\r\n    ];\r\n    \r\n    for (const pattern of patterns) {\r\n      const match = message.match(pattern);\r\n      if (match) return match[1].trim();\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private extractHealthRecordType(message: string): string {\r\n    if (message.includes('vaccination') || message.includes('vaccine')) return 'vaccination';\r\n    if (message.includes('checkup') || message.includes('visit')) return 'checkup';\r\n    if (message.includes('medication') || message.includes('medicine')) return 'medication';\r\n    if (message.includes('symptom') || message.includes('sick')) return 'symptom';\r\n    if (message.includes('injury') || message.includes('hurt')) return 'injury';\r\n    return 'general';\r\n  }\r\n\r\n  private extractHealthTitle(message: string): string {\r\n    if (message.includes('vaccination')) return 'Vaccination Record';\r\n    if (message.includes('checkup')) return 'Veterinary Checkup';\r\n    if (message.includes('medication')) return 'Medication Record';\r\n    return 'Health Record';\r\n  }\r\n\r\n  private extractActivityType(message: string): string {\r\n    if (message.includes('walk')) return 'walk';\r\n    if (message.includes('run')) return 'run';\r\n    if (message.includes('play')) return 'play';\r\n    if (message.includes('swim')) return 'swimming';\r\n    if (message.includes('train')) return 'training';\r\n    if (message.includes('exercise')) return 'exercise';\r\n    return 'activity';\r\n  }\r\n\r\n  private extractDuration(message: string): number | undefined {\r\n    const durationMatch = message.match(/(\\d+)\\s*(minute|min|hour)/i);\r\n    if (durationMatch) {\r\n      const value = parseInt(durationMatch[1]);\r\n      const unit = durationMatch[2].toLowerCase();\r\n      return unit.includes('hour') ? value * 60 : value;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private extractIntensity(message: string): string {\r\n    if (message.includes('high') || message.includes('intense') || message.includes('vigorous')) return 'high';\r\n    if (message.includes('medium') || message.includes('moderate')) return 'medium';\r\n    if (message.includes('low') || message.includes('light') || message.includes('gentle')) return 'low';\r\n    return 'medium';\r\n  }\r\n\r\n  private generateActivityRecommendations(message: string, petType: string): string {\r\n    const activityType = this.extractActivityType(message);\r\n    \r\n    switch (activityType) {\r\n      case 'walk':\r\n        return `Great choice! Walking is excellent for ${petType}s. Try to maintain a consistent daily schedule and gradually increase distance for better fitness.`;\r\n      case 'play':\r\n        return `Playtime is crucial for mental stimulation! Consider rotating toys and games to keep your ${petType} engaged and prevent boredom.`;\r\n      case 'training':\r\n        return `Training sessions are fantastic for bonding and mental exercise. Keep sessions short (5-10 minutes) and always end on a positive note.`;\r\n      default:\r\n        return `Regular exercise is essential for your ${petType}'s physical and mental health. Try to maintain consistency in timing and duration.`;\r\n    }\r\n  }\r\n\r\n  private getStandardResponse(message: string, context: string, petName: string, petType: string): string {\r\n    \r\n    // Advanced intent recognition\r\n    const intents = this.analyzeIntent(message, context);\r\n    \r\n    // Generate personalized response based on intents and context\r\n    return this.generateResponse(intents, message, petName, petType, context);\r\n  }\r\n  \r\n  private analyzeIntent(userMessage: string, context: string): string[] {\r\n    const intents: string[] = [];\r\n    \r\n    // Health-related intents\r\n    if (/(sick|ill|health|vet|doctor|pain|hurt|injury|wound|blood|fever|temperature)/i.test(userMessage)) {\r\n      intents.push('health_concern');\r\n    }\r\n    if (/(vomit|throw up|nausea)/i.test(userMessage)) intents.push('vomiting');\r\n    if (/(diarrhea|loose stool|upset stomach)/i.test(userMessage)) intents.push('diarrhea');\r\n    if (/(tired|sleepy|lethargic|weak)/i.test(userMessage)) intents.push('lethargy');\r\n    if (/(cough|wheez|breathing|breath)/i.test(userMessage)) intents.push('breathing');\r\n    if (/(limp|leg|paw|walk)/i.test(userMessage)) intents.push('mobility');\r\n    \r\n    // Nutrition intents\r\n    if (/(food|eat|feed|hungry|nutrition|diet|meal)/i.test(userMessage)) {\r\n      intents.push('nutrition');\r\n    }\r\n    if (/(toxic|poison|dangerous|can.*eat|safe.*eat)/i.test(userMessage)) intents.push('food_safety');\r\n    if (/(treat|snack|reward)/i.test(userMessage)) intents.push('treats');\r\n    if (/(water|drink|thirsty|dehydrat)/i.test(userMessage)) intents.push('hydration');\r\n    \r\n    // Behavior intents\r\n    if (/(train|behavior|behaviour|obedien|command|sit|stay|come)/i.test(userMessage)) {\r\n      intents.push('training');\r\n    }\r\n    if (/(aggressive|bite|growl|snap|angry)/i.test(userMessage)) intents.push('aggression');\r\n    if (/(bark|loud|noise|vocal)/i.test(userMessage)) intents.push('vocalization');\r\n    if (/(anxious|scared|afraid|nervous|stress)/i.test(userMessage)) intents.push('anxiety');\r\n    if (/(alone|separation|leave)/i.test(userMessage)) intents.push('separation');\r\n    \r\n    // Exercise intents\r\n    if (/(exercise|walk|play|active|run|energy|tired)/i.test(userMessage)) {\r\n      intents.push('exercise');\r\n    }\r\n    if (/(toy|game|fun|entertainment|bored)/i.test(userMessage)) intents.push('enrichment');\r\n    \r\n    // Grooming intents\r\n    if (/(groom|brush|bath|clean|hygiene|nail|claw)/i.test(userMessage)) {\r\n      intents.push('grooming');\r\n    }\r\n    if (/(teeth|dental|mouth|breath|oral)/i.test(userMessage)) intents.push('dental');\r\n    \r\n    // General care intents\r\n    if (/(puppy|kitten|young|baby|age)/i.test(userMessage)) intents.push('young_pet');\r\n    if (/(old|senior|elderly|aging)/i.test(userMessage)) intents.push('senior_pet');\r\n    if (/(breed|type|species)/i.test(userMessage)) intents.push('breed_specific');\r\n    \r\n    // Emotional support\r\n    if (/(love|bond|relationship|connect|happy|joy)/i.test(userMessage)) intents.push('bonding');\r\n    if (/(worry|concerned|scared|help|advice)/i.test(userMessage)) intents.push('reassurance');\r\n    \r\n    return intents;\r\n  }\r\n  \r\n  private generateResponse(intents: string[], userMessage: string, petName: string, petType: string, context: string): string {\r\n    const name = petName || `your ${petType}`;\r\n    const icon = this.getPetIcon(petType);\r\n    \r\n    // Handle multiple intents with priority\r\n    if (intents.includes('health_concern')) {\r\n      return this.getHealthResponse(intents, userMessage, name, icon);\r\n    }\r\n    \r\n    if (intents.includes('nutrition') || intents.includes('food_safety')) {\r\n      return this.getNutritionResponse(intents, userMessage, name, icon);\r\n    }\r\n    \r\n    if (intents.includes('training') || intents.includes('aggression') || intents.includes('anxiety')) {\r\n      return this.getBehaviorResponse(intents, userMessage, name, icon);\r\n    }\r\n    \r\n    if (intents.includes('exercise') || intents.includes('enrichment')) {\r\n      return this.getExerciseResponse(intents, userMessage, name, petType, icon);\r\n    }\r\n    \r\n    if (intents.includes('grooming') || intents.includes('dental')) {\r\n      return this.getGroomingResponse(intents, userMessage, name, icon);\r\n    }\r\n    \r\n    if (intents.includes('bonding') || intents.includes('reassurance')) {\r\n      return this.getEmotionalResponse(intents, userMessage, name, icon);\r\n    }\r\n    \r\n    // Breed/age-specific advice\r\n    if (intents.includes('young_pet') || intents.includes('senior_pet') || intents.includes('breed_specific')) {\r\n      return this.getSpecificAdvice(intents, userMessage, name, petType, icon);\r\n    }\r\n    \r\n    // General conversation\r\n    return this.getGeneralResponse(userMessage, name, petType, icon);\r\n  }\r\n  \r\n  private getHealthResponse(intents: string[], userMessage: string, name: string, icon: string): string {\r\n    if (intents.includes('vomiting')) {\r\n      return `${icon} I'm concerned about ${name}'s vomiting. ${petKnowledge.health.symptoms.vomiting} Monitor closely and don't hesitate to call your vet if you're worried.`;\r\n    }\r\n    if (intents.includes('diarrhea')) {\r\n      return `${icon} For ${name}'s diarrhea: ${petKnowledge.health.symptoms.diarrhea} Keep me updated on how they're doing!`;\r\n    }\r\n    if (intents.includes('lethargy')) {\r\n      return `${icon} ${name}'s lethargy could be concerning. ${petKnowledge.health.symptoms.lethargy} Trust your instincts - you know ${name} best.`;\r\n    }\r\n    if (intents.includes('breathing')) {\r\n      return `${icon} Breathing issues in ${name} need attention. ${petKnowledge.health.symptoms.coughing} Please consider a vet visit soon.`;\r\n    }\r\n    if (intents.includes('mobility')) {\r\n      return `${icon} For ${name}'s limping or mobility issues: ${petKnowledge.health.symptoms.limping} I hope they feel better soon!`;\r\n    }\r\n    \r\n    return `${icon} I care about ${name}'s health! ${petKnowledge.health.prevention} If you're seeing concerning symptoms, it's always better to check with a veterinarian. What specific symptoms are you noticing?`;\r\n  }\r\n  \r\n  private getNutritionResponse(intents: string[], userMessage: string, name: string, icon: string): string {\r\n    if (intents.includes('food_safety')) {\r\n      return `${icon} Safety first for ${name}! ${petKnowledge.nutrition.toxic_foods} Always check if a food is pet-safe before sharing. What food were you curious about?`;\r\n    }\r\n    if (intents.includes('treats')) {\r\n      return `${icon} Treats for ${name}! ${petKnowledge.nutrition.treats} Some great healthy options include small pieces of cooked chicken, carrots, or blueberries (for dogs).`;\r\n    }\r\n    if (intents.includes('hydration')) {\r\n      return `${icon} Hydration is so important for ${name}! ${petKnowledge.nutrition.hydration} Some pets love ice cubes as treats too!`;\r\n    }\r\n    \r\n    return `${icon} Great question about ${name}'s nutrition! ${petKnowledge.nutrition.general} Every pet is unique, so what works best can vary. What specific nutrition question do you have?`;\r\n  }\r\n  \r\n  private getBehaviorResponse(intents: string[], userMessage: string, name: string, icon: string): string {\r\n    if (intents.includes('aggression')) {\r\n      return `${icon} I understand your concern about ${name}'s behavior. ${petKnowledge.behavior.common_issues.aggression} Safety is paramount - both for ${name} and everyone around them.`;\r\n    }\r\n    if (intents.includes('separation')) {\r\n      return `${icon} Separation anxiety in ${name} is manageable! ${petKnowledge.behavior.common_issues.separation_anxiety} Start with very short departures and gradually increase the time.`;\r\n    }\r\n    if (intents.includes('vocalization')) {\r\n      return `${icon} ${name}'s barking/vocalization has a reason! ${petKnowledge.behavior.common_issues.excessive_barking} Understanding the 'why' is the first step to helping them.`;\r\n    }\r\n    \r\n    return `${icon} Training ${name} can be such a rewarding experience! ${petKnowledge.behavior.training_principles} Patience and consistency are your best tools. What specific behavior would you like to work on?`;\r\n  }\r\n  \r\n  private getExerciseResponse(intents: string[], userMessage: string, name: string, petType: string, icon: string): string {\r\n    let exerciseAdvice = petKnowledge.exercise.dogs;\r\n    if (petType === 'cat') exerciseAdvice = petKnowledge.exercise.cats;\r\n    if (['rabbit', 'hamster', 'bird', 'fish'].includes(petType)) exerciseAdvice = petKnowledge.exercise.small_pets;\r\n    \r\n    if (intents.includes('enrichment')) {\r\n      return `${icon} Mental stimulation for ${name} is amazing! ${petKnowledge.behavior.enrichment} Puzzle toys and training sessions can be just as tiring as physical exercise!`;\r\n    }\r\n    \r\n    return `${icon} Exercise keeps ${name} healthy and happy! ${exerciseAdvice} What kind of activities does ${name} enjoy most?`;\r\n  }\r\n  \r\n  private getGroomingResponse(intents: string[], userMessage: string, name: string, icon: string): string {\r\n    if (intents.includes('dental')) {\r\n      return `${icon} ${name}'s dental health is super important! ${petKnowledge.grooming.dental_care} Bad breath isn't just unpleasant - it can indicate health issues.`;\r\n    }\r\n    \r\n    return `${icon} Grooming keeps ${name} comfortable and healthy! ${petKnowledge.grooming.frequency} Make it a positive experience with treats and gentle handling. ${petKnowledge.grooming.bathing}`;\r\n  }\r\n  \r\n  private getEmotionalResponse(intents: string[], userMessage: string, name: string, icon: string): string {\r\n    const responses = [\r\n      `${icon} The bond you share with ${name} is so special! Pets enrich our lives in countless ways. What's your favorite memory with ${name}?`,\r\n      `${icon} I can tell you really care about ${name}! That love and attention makes such a difference in their happiness and well-being.`,\r\n      `${icon} ${name} is lucky to have such a caring pet parent! Your dedication to their well-being shows how much you love them.`,\r\n      `${icon} It sounds like ${name} brings so much joy to your life! Pets have an amazing way of making every day brighter.`\r\n    ];\r\n    \r\n    return responses[Math.floor(Math.random() * responses.length)];\r\n  }\r\n  \r\n  private getSpecificAdvice(intents: string[], userMessage: string, name: string, petType: string, icon: string): string {\r\n    if (intents.includes('young_pet')) {\r\n      return `${icon} ${name} is in such an important development stage! Young pets need: frequent feeding, lots of sleep, gentle socialization, basic training, and regular vet checkups. Puppy/kitten-proof your space and be patient - they're learning about the world!`;\r\n    }\r\n    \r\n    if (intents.includes('senior_pet')) {\r\n      return `${icon} Senior pets like ${name} deserve extra love and care! They may need: more comfortable bedding, easier access to food/water, gentler exercise, more frequent vet visits, and patience with age-related changes. Their wisdom and love are precious!`;\r\n    }\r\n    \r\n    return `${icon} Every ${petType} is unique, including ${name}! While breed characteristics can give us insights, individual personality and needs matter most. What specific aspects of ${name}'s care are you curious about?`;\r\n  }\r\n  \r\n  private getGeneralResponse(userMessage: string, name: string, petType: string, icon: string): string {\r\n    // Conversational responses for general chat\r\n    const generalResponses = [\r\n      `${icon} That's interesting! Tell me more about ${name}. How long have you had your ${petType}?`,\r\n      `${icon} I love hearing about ${name}! What's their personality like?`,\r\n      `${icon} ${name} sounds wonderful! What's their favorite activity or toy?`,\r\n      `${icon} It's great that you're thinking about ${name}'s well-being. Is there anything specific you'd like to know about ${petType} care?`,\r\n      `${icon} Every day with ${name} must bring something new! What's been your favorite part of having a ${petType}?`,\r\n      `${icon} I'm here to help with any questions about ${name}! Whether it's health, behavior, nutrition, or just sharing stories - I'm all ears!`\r\n    ];\r\n    \r\n    // Context-aware responses\r\n    if (userMessage.includes('hello') || userMessage.includes('hi') || userMessage.includes('hey')) {\r\n      return `${icon} Hello there! It's wonderful to meet you and hear about ${name}! I'm here to help with any questions about ${petType} care or just to chat about your furry friend. How can I help you today?`;\r\n    }\r\n    \r\n    if (userMessage.includes('thank') || userMessage.includes('thanks')) {\r\n      return `${icon} You're so welcome! I'm always happy to help you and ${name}. Feel free to ask me anything anytime - whether it's about care tips, behavior questions, or you just want to share updates about ${name}!`;\r\n    }\r\n    \r\n    if (userMessage.includes('good') || userMessage.includes('great') || userMessage.includes('awesome')) {\r\n      return `${icon} That's fantastic to hear! ${name} is lucky to have such a caring owner. Keep up the great work - your attention to their needs makes all the difference!`;\r\n    }\r\n    \r\n    return generalResponses[Math.floor(Math.random() * generalResponses.length)];\r\n  }\r\n  \r\n  private getPetIcon(petType: string): string {\r\n    const icons: Record<string, string> = {\r\n      dog: 'ðŸ•',\r\n      cat: 'ðŸ±',\r\n      bird: 'ðŸ¦',\r\n      fish: 'ðŸ ',\r\n      rabbit: 'ðŸ°',\r\n      hamster: 'ðŸ¹'\r\n    };\r\n    return icons[petType] || 'ðŸ•';\r\n  }\r\n  \r\n  // Main method to generate chat completion\r\n  async generateChatCompletion(request: ChatCompletionRequest, petName?: string, petType?: string): Promise<ChatCompletionResponse> {\r\n    const response = await this.getContextualResponse(request.messages, petName, petType || 'pet');\r\n    \r\n    // Simulate some processing time\r\n    await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));\r\n    \r\n    return {\r\n      choices: [{\r\n        message: {\r\n          role: 'assistant',\r\n          content: response\r\n        },\r\n        finish_reason: 'stop'\r\n      }],\r\n      usage: {\r\n        prompt_tokens: Math.round(request.messages.reduce((acc, msg) => acc + msg.content.length / 4, 0)),\r\n        completion_tokens: Math.round(response.length / 4),\r\n        total_tokens: Math.round((request.messages.reduce((acc, msg) => acc + msg.content.length, 0) + response.length) / 4)\r\n      }\r\n    };\r\n  }\r\n}\r\n\r\nexport const mockOpenAI = new MockOpenAIService();","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\nlQueryService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\services\\realOpenAI.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async method 'generateChatCompletion' has a complexity of 38. Maximum allowed is 15.","line":50,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":50,"endColumn":31},{"ruleId":"complexity","severity":1,"message":"Async method 'handleDatabaseOperations' has a complexity of 28. Maximum allowed is 15.","line":358,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":358,"endColumn":41},{"ruleId":"complexity","severity":1,"message":"Async method 'performAdvancedSearch' has a complexity of 16. Maximum allowed is 15.","line":471,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":471,"endColumn":38},{"ruleId":"complexity","severity":1,"message":"Async method 'handleContactCreation' has a complexity of 16. Maximum allowed is 15.","line":623,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":623,"endColumn":38},{"ruleId":"complexity","severity":1,"message":"Method 'calculateLeadScore' has a complexity of 25. Maximum allowed is 15.","line":775,"column":3,"nodeType":"FunctionExpression","messageId":"complex","endLine":775,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import OpenAI from 'openai';\r\nimport { databaseService } from './databaseService';\r\nimport { storage } from '../storage';\r\nimport { apolloService } from './apolloService';\r\n\r\nexport interface ChatMessage {\r\n  role: 'system' | 'user' | 'assistant';\r\n  content: string;\r\n}\r\n\r\nexport interface ChatCompletionRequest {\r\n  model: string;\r\n  messages: ChatMessage[];\r\n  temperature?: number;\r\n  max_tokens?: number;\r\n}\r\n\r\nexport interface ChatCompletionResponse {\r\n  choices: Array<{\r\n    message: {\r\n      role: 'assistant';\r\n      content: string;\r\n    };\r\n    finish_reason: 'stop' | 'length';\r\n  }>;\r\n  usage: {\r\n    prompt_tokens: number;\r\n    completion_tokens: number;\r\n    total_tokens: number;\r\n  };\r\n  isRealAI?: boolean;\r\n  sessionId?: string;\r\n}\r\n\r\nclass RealOpenAIService {\r\n  private openai: OpenAI;\r\n\r\n  constructor(apiKey: string) {\r\n    // Use OpenRouter API as requested\r\n    this.openai = new OpenAI({\r\n      apiKey: apiKey,\r\n      baseURL: \"https://openrouter.ai/api/v1\",\r\n      defaultHeaders: {\r\n        \"HTTP-Referer\": \"https://fallowl.replit.app\", // Your site URL\r\n        \"X-Title\": \"FallOwl Campaign Manager\", // Your site name\r\n      }\r\n    });\r\n  }\r\n\r\n  async generateChatCompletion(request: ChatCompletionRequest, aiName?: string, aiType?: string): Promise<ChatCompletionResponse> {\r\n    try {\r\n      const userMessage = request.messages[request.messages.length - 1]?.content || '';\r\n      const lowerUserMessage = userMessage.toLowerCase();\r\n      \r\n      // Check for Apollo.io API questions or advanced business queries first\r\n      if (lowerUserMessage.includes('apollo') || lowerUserMessage.includes('api') || \r\n          lowerUserMessage.includes('prospecting') || lowerUserMessage.includes('lead generation') ||\r\n          lowerUserMessage.includes('director') || lowerUserMessage.includes('manufacturing') ||\r\n          lowerUserMessage.includes('finance') || lowerUserMessage.includes('employee size') ||\r\n          lowerUserMessage.includes('industry') || lowerUserMessage.includes('united states') ||\r\n          (lowerUserMessage.includes('campaign') && lowerUserMessage.includes('skip')) ||\r\n          lowerUserMessage.includes('exclude') || lowerUserMessage.includes('filter')) {\r\n        const apolloResponse = await this.handleApolloQueries(userMessage);\r\n        if (apolloResponse) {\r\n          return {\r\n            choices: [{\r\n              message: {\r\n                role: 'assistant',\r\n                content: apolloResponse\r\n              },\r\n              finish_reason: 'stop'\r\n            }],\r\n            usage: {\r\n              prompt_tokens: 150,\r\n              completion_tokens: apolloResponse.length / 4,\r\n              total_tokens: 150 + (apolloResponse.length / 4)\r\n            }\r\n          };\r\n        }\r\n      }\r\n\r\n      // Check if user wants database operations (including job title searches)\r\n      const isJobTitleSearch = /\\b(manager|director|analyst|specialist|coordinator|supervisor|executive|officer|lead|head|chief|president|vice|senior|junior|assistant|ceo|cfo|cto|cmo|vp|founder|owner|partner)\\b/i.test(lowerUserMessage);\r\n      const isLocalSearch = lowerUserMessage.includes('search') || \r\n                           lowerUserMessage.includes('find') || \r\n                           lowerUserMessage.includes('show me') ||\r\n                           lowerUserMessage.includes('contacts') ||\r\n                           isJobTitleSearch;\r\n      \r\n      const isSimpleSearch = isLocalSearch && \r\n                            !lowerUserMessage.includes('api') && \r\n                            !(lowerUserMessage.includes('director') && lowerUserMessage.includes('finance') && lowerUserMessage.includes('manufacturing')) &&\r\n                            !lowerUserMessage.includes('apollo');\r\n                            \r\n      if (isSimpleSearch) {\r\n        const databaseResponse = await this.handleDatabaseOperations(lowerUserMessage, aiName, aiType);\r\n        \r\n        if (databaseResponse) {\r\n          return {\r\n            choices: [{\r\n              message: {\r\n                role: 'assistant',\r\n                content: databaseResponse\r\n              },\r\n              finish_reason: 'stop'\r\n            }],\r\n            usage: {\r\n              prompt_tokens: 100,\r\n              completion_tokens: databaseResponse.length / 4,\r\n              total_tokens: 100 + (databaseResponse.length / 4)\r\n            }\r\n          };\r\n        }\r\n      }\r\n\r\n      // For all other queries, use real AI with enhanced capabilities\r\n\r\n      // Get current database context for AI awareness\r\n      const databaseContext = await this.getDatabaseContext();\r\n      \r\n      // Enhance system message with lead scoring expertise and business intelligence\r\n      const systemMessage = this.createLeadScoringSystemPrompt(aiName, aiType, databaseContext);\r\n      \r\n      // Combine system message with user messages\r\n      const enhancedMessages = [\r\n        { role: 'system' as const, content: systemMessage },\r\n        ...request.messages\r\n      ];\r\n\r\n      // Using OpenRouter with faster model for better performance\r\n      const response = await this.openai.chat.completions.create({\r\n        model: \"anthropic/claude-3-haiku\", // Faster than wizardlm-2-8x22b\r\n        messages: enhancedMessages,\r\n        temperature: request.temperature || 0.7,\r\n        max_tokens: request.max_tokens || 400,\r\n      });\r\n\r\n      return {\r\n        choices: response.choices.map(choice => ({\r\n          message: {\r\n            role: 'assistant',\r\n            content: this.cleanResponse(choice.message.content || 'Sorry, I could not generate a response.')\r\n          },\r\n          finish_reason: choice.finish_reason as 'stop' | 'length'\r\n        })),\r\n        usage: {\r\n          prompt_tokens: response.usage?.prompt_tokens || 0,\r\n          completion_tokens: response.usage?.completion_tokens || 0,\r\n          total_tokens: response.usage?.total_tokens || 0\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('OpenAI API error:', error);\r\n      throw new Error('Failed to generate response from OpenAI');\r\n    }\r\n  }\r\n\r\n  async createStreamingResponse(request: ChatCompletionRequest & { stream: boolean }) {\r\n    try {\r\n      // For streaming, we'll use a simpler approach with OpenAI\r\n      const response = await this.openai.chat.completions.create({\r\n        model: \"anthropic/claude-3-haiku\", // Faster model via OpenRouter\r\n        messages: request.messages,\r\n        temperature: request.temperature || 0.7,\r\n        max_tokens: request.max_tokens || 400,\r\n        stream: true\r\n      });\r\n\r\n      return response;\r\n    } catch (error) {\r\n      console.error('OpenAI streaming error:', error);\r\n      throw new Error('Failed to create streaming response');\r\n    }\r\n  }\r\n\r\n  private cleanResponse(content: string): string {\r\n    // Clean AI responses according to new guidelines\r\n    let cleaned = content;\r\n    \r\n    // Remove any emojis completely\r\n    cleaned = cleaned.replace(/[\\u{1F600}-\\u{1F64F}]|[\\u{1F300}-\\u{1F5FF}]|[\\u{1F680}-\\u{1F6FF}]|[\\u{1F1E0}-\\u{1F1FF}]|[\\u{2600}-\\u{26FF}]|[\\u{2700}-\\u{27BF}]/gu, '');\r\n    \r\n    // Replace any mention of \"Fallowl\" with \"zhatore\" in AI responses\r\n    cleaned = cleaned.replace(/Fallowl/gi, 'zhatore');\r\n    \r\n    // Keep cute pet-like behaviors but remove formal greetings\r\n    cleaned = cleaned.replace(/^(?:greets warmly\\s*)?(?:Hello there[^.!?]*[.!?]\\s*)?/i, '');\r\n    \r\n    // Trim any remaining whitespace\r\n    cleaned = cleaned.trim();\r\n    \r\n    return cleaned || 'I can help you with lead scoring and contact analysis.';\r\n  }\r\n\r\n  private async getDatabaseContext(): Promise<string> {\r\n    try {\r\n      const [campaigns, contacts] = await Promise.all([\r\n        storage.getCampaigns(),\r\n        storage.getContacts()\r\n      ]);\r\n\r\n      return `\r\n**Current Database Status:**\r\n- Campaigns: ${campaigns.length} uploaded (${campaigns.map(c => c.name).join(', ')})\r\n- Contact Records: ${contacts.length} available\r\n- Total Lead Data: ${campaigns.reduce((sum, c) => sum + c.recordCount, 0) + contacts.length} prospects ready for analysis\r\n`;\r\n    } catch (error) {\r\n      return 'Database access available but no lead data loaded yet.';\r\n    }\r\n  }\r\n\r\n  private async handleApolloQueries(userMessage: string): Promise<string | null> {\r\n    try {\r\n      const lowerMessage = userMessage.toLowerCase();\r\n      const recommendations = apolloService.generateAPIRecommendation(userMessage);\r\n      \r\n      // Handle complex Apollo.io search queries\r\n      if (lowerMessage.includes('director') && lowerMessage.includes('finance') && \r\n          (lowerMessage.includes('manufacturing') || lowerMessage.includes('industry'))) {\r\n        \r\n        return `# ðŸŽ¯ Apollo.io API Search Strategy\r\n\r\n## Recommended API Call for Director of Finance Search\r\n\r\n### Primary Search Endpoint: \\`/v1/mixed_people/search\\`\r\n\r\n**Optimized Query Parameters:**\r\n\\`\\`\\`json\r\n{\r\n  \"person_titles\": [\r\n    \"Director of Finance\", \r\n    \"Finance Director\",\r\n    \"Director Finance\",\r\n    \"Director, Finance\"\r\n  ],\r\n  \"person_locations\": [\"United States\"],\r\n  \"organization_industries\": [\"manufacturing\"],\r\n  \"organization_num_employees_ranges\": [\"11-50\", \"51-100\"],\r\n  \"per_page\": 50,\r\n  \"page\": 1,\r\n  \"enrich_contacts\": true\r\n}\r\n\\`\\`\\`\r\n\r\n## ðŸ” Advanced Filtering Strategy\r\n\r\n**Title Variations to Include:**\r\n- \"Director of Finance\" (primary target)\r\n- \"Finance Director\" (alternative format)\r\n- \"Director, Finance\" (comma variation)\r\n- \"VP Finance\" (senior level prospects)\r\n- \"Financial Director\" (alternate phrasing)\r\n\r\n**Geographic Targeting:**\r\n- Location: \"United States\" (broad coverage)\r\n- Consider state-level filtering for focused campaigns\r\n\r\n**Industry Precision:**\r\n- Primary: \"manufacturing\"\r\n- Related: \"industrial equipment\", \"automotive\", \"aerospace\"\r\n\r\n**Company Size Optimization:**\r\n- \"11-50\" employees: Mid-sized manufacturers\r\n- \"51-100\" employees: Growth-stage companies\r\n- Sweet spot for decision-maker accessibility\r\n\r\n## ðŸš« Exclusion Strategy for \"Sage Data\" Campaign\r\n\r\n**Post-Processing Filter Implementation:**\r\n\\`\\`\\`javascript\r\n// After Apollo.io response, filter out existing contacts\r\nconst filteredResults = apolloResults.filter(contact => {\r\n  const existingContact = sageDataCampaign.find(existing => \r\n    existing.email === contact.email || \r\n    (existing.firstName === contact.first_name && \r\n     existing.lastName === contact.last_name &&\r\n     existing.company === contact.organization_name)\r\n  );\r\n  return !existingContact;\r\n});\r\n\\`\\`\\`\r\n\r\n## ðŸ“Š Expected Results & Lead Scoring\r\n\r\n**Target Profile Analysis:**\r\n- **Authority Level**: High (Director-level decision maker)\r\n- **Budget Influence**: Direct financial oversight\r\n- **Company Size**: Optimal for personalized outreach\r\n- **Industry**: Manufacturing = process/efficiency focus\r\n\r\n**Lead Scoring Framework:**\r\n- Director of Finance: 85-90 points (high authority)\r\n- Manufacturing industry: +15 points (sector relevance)\r\n- 10-100 employees: +10 points (accessible decision maker)\r\n- US location: +5 points (timezone alignment)\r\n\r\n## ðŸš€ Follow-up API Sequence\r\n\r\n**1. Contact Enrichment:**\r\n\\`\\`\\`json\r\nPOST /v1/people/match\r\n{\r\n  \"email\": \"director@company.com\",\r\n  \"enrich\": true\r\n}\r\n\\`\\`\\`\r\n\r\n**2. Email Discovery:**\r\n\\`\\`\\`json\r\nPOST /v1/email_addresses\r\n{\r\n  \"first_name\": \"John\",\r\n  \"last_name\": \"Smith\",\r\n  \"domain\": \"manufacturingco.com\"\r\n}\r\n\\`\\`\\`\r\n\r\nThis search strategy will identify high-quality finance decision-makers in US manufacturing companies while automatically excluding your existing \"Sage Data\" campaign contacts.`;\r\n      }\r\n      \r\n      // Handle general Apollo.io questions\r\n      if (lowerMessage.includes('apollo')) {\r\n        const apolloKnowledge = apolloService.getAPIKnowledge();\r\n        return `# ðŸš€ Apollo.io Integration Expert\r\n\r\nI have complete knowledge of Apollo.io's API architecture and can help you with advanced prospecting and lead generation strategies.\r\n\r\n${recommendations}\r\n\r\n${apolloKnowledge}\r\n\r\n## ðŸ’¡ What I can help you with:\r\n- **API Integration**: Specific endpoint recommendations and parameters\r\n- **Lead Prospecting**: Advanced search strategies and targeting\r\n- **Data Enrichment**: Contact enhancement and verification workflows  \r\n- **Outreach Automation**: Sequence creation and performance optimization\r\n- **CRM Integration**: Data synchronization and pipeline management\r\n- **Compliance**: GDPR/CCPA compliant data handling practices\r\n\r\nAsk me anything about Apollo.io APIs, prospecting strategies, or lead generation workflows!`;\r\n      }\r\n      \r\n      // For other business intelligence queries, return recommendations\r\n      if (lowerMessage.includes('prospecting') || lowerMessage.includes('lead generation') ||\r\n          lowerMessage.includes('industry') || lowerMessage.includes('director') ||\r\n          lowerMessage.includes('manufacturing') || lowerMessage.includes('finance')) {\r\n        return recommendations;\r\n      }\r\n      \r\n      return null;\r\n    } catch (error) {\r\n      console.error('Apollo query error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private async handleDatabaseOperations(message: string, aiName?: string, aiType?: string): Promise<string | null> {\r\n    try {\r\n      // Lead analysis and campaign data queries\r\n      if (message.includes('campaign') || message.includes('upload') || message.includes('contact') || message.includes('data') || message.includes('lead') || message.includes('score')) {\r\n        const campaigns = await storage.getCampaigns();\r\n        const contacts = await storage.getContacts();\r\n        \r\n        if (message.includes('how many') || message.includes('count') || message.includes('score')) {\r\n          return `ðŸ“Š **Lead Database Analysis:**\r\n          \r\n**Data Overview:**\r\nâ€¢ **Campaigns:** ${campaigns.length} uploaded campaigns\r\n${campaigns.map(c => `  - ${c.name}: ${c.recordCount} prospects`).join('\\n')}\r\n\r\nâ€¢ **Total Prospects:** ${campaigns.reduce((sum, c) => sum + c.recordCount, 0)} contacts available for scoring\r\nâ€¢ **Basic Contacts:** ${contacts.length} additional records\r\n\r\n**Lead Scoring Intelligence:**\r\nðŸŽ¯ **Available for Analysis:**\r\nâ€¢ C-Level executives and decision-makers\r\nâ€¢ Company size and industry segmentation\r\nâ€¢ Title-based authority scoring\r\nâ€¢ Contact enrichment and qualification\r\nâ€¢ Duplicate detection and data cleaning\r\n\r\n**Recommended Actions:**\r\nâ€¢ \"Score all contacts by quality\" - Generate lead scores\r\nâ€¢ \"Find decision-makers\" - Identify key prospects  \r\nâ€¢ \"Show me C-level contacts\" - Target executives\r\nâ€¢ \"Analyze by company size\" - Market segmentation\r\nâ€¢ \"Generate prospect report\" - Comprehensive analysis\r\n\r\nReady to help you identify the highest quality leads! What specific lead analysis would you like me to perform?`;\r\n        }\r\n\r\n        if (message.includes('search') || message.includes('find') || message.includes('decision') || message.includes('c-level')) {\r\n          return `ðŸ” **Lead Search & Intelligence:**\r\n          \r\nI can analyze your prospect database:\r\n- ${campaigns.length} campaigns with ${campaigns.reduce((sum, c) => sum + c.recordCount, 0)} total prospects\r\n- Advanced lead scoring and qualification\r\n- Decision-maker identification\r\n\r\n**High-Value Search Options:**\r\nâ€¢ \"Find all C-level executives\" - Target top decision-makers\r\nâ€¢ \"Show me VP and Director level contacts\" - Mid-level influencers\r\nâ€¢ \"Search for contacts at enterprise companies\" - Large account prospects\r\nâ€¢ \"Find decision-makers in [industry]\" - Vertical targeting\r\nâ€¢ \"Show contacts with LinkedIn profiles\" - Social selling ready\r\n\r\n**Lead Quality Focus:**\r\nâ€¢ Automatic scoring based on job title authority\r\nâ€¢ Company size and industry analysis\r\nâ€¢ Contact completeness and engagement potential\r\n\r\nWhat type of high-quality leads would you like me to find?`;\r\n        }\r\n\r\n        if (message.includes('analyze') || message.includes('insights') || message.includes('report')) {\r\n          const totalRecords = campaigns.reduce((sum, c) => sum + c.recordCount, 0);\r\n          const sampleContact = contacts[0];\r\n          \r\n          return `ðŸ“ˆ **Data Analysis Report:**\r\n\r\n**Overview:**\r\nâ€¢ Total Records: ${totalRecords}\r\nâ€¢ Campaigns: ${campaigns.length}\r\nâ€¢ Active Contacts: ${contacts.length}\r\n\r\n**Sample Data Structure:**\r\n${sampleContact ? `â€¢ Name: ${sampleContact.name}\r\nâ€¢ Email: ${sampleContact.email}\r\nâ€¢ Mobile: ${sampleContact.mobile}\r\nâ€¢ Location Data: Available` : 'â€¢ No contact data to analyze yet'}\r\n\r\n**Available Analytics:**\r\nâ€¢ Geographic distribution analysis\r\nâ€¢ Industry/company analysis  \r\nâ€¢ Contact engagement patterns\r\nâ€¢ Data quality assessment\r\n\r\n**Recommendations:**\r\nâ€¢ Upload additional datasets for deeper insights\r\nâ€¢ I can help clean and organize your data\r\nâ€¢ Set up automated contact scoring\r\n\r\nWhat specific analysis would you like me to perform on your data?`;\r\n        }\r\n      }\r\n\r\n      // Advanced search operations - including job title searches\n      const isJobTitleSearch = /\\b(manager|director|analyst|specialist|coordinator|supervisor|executive|officer|lead|head|chief|president|vice|senior|junior|assistant|ceo|cfo|cto|cmo|vp|founder|owner|partner)\\b/i.test(message);\n      if (message.includes('search') || message.includes('find') || isJobTitleSearch) {\n        return await this.performAdvancedSearch(message);\r\n      }\r\n\r\n      // Data modification operations\r\n      if (message.includes('add') || message.includes('create') || message.includes('register')) {\r\n        return await this.handleContactCreation(message);\r\n      }\r\n\r\n      // Update operations\r\n      if (message.includes('update') || message.includes('modify') || message.includes('change')) {\r\n        return await this.handleContactUpdate(message);\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Database operation error:', error);\r\n      return 'I can access your database but encountered an issue. Please try rephrasing your request.';\r\n    }\r\n  }\r\n\r\n  private async performAdvancedSearch(query: string): Promise<string> {\r\n    try {\r\n      const [campaigns, contacts] = await Promise.all([\r\n        storage.getCampaigns(),\r\n        storage.getContacts()\r\n      ]);\r\n\r\n      let results = [];\r\n      const searchTerm = query.toLowerCase();\r\n\r\n      // Advanced lead search with scoring\r\n      const matchingContacts = [];\r\n      const leadScores = new Map();\r\n      \r\n      // Use the enhanced search API for better job title matching\r\n      try {\r\n        const searchResponse = await fetch(`http://localhost:${process.env.PORT || 3000}/api/search`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            query: searchTerm,\r\n            searchType: 'campaign-data',\r\n            limit: 50\r\n          })\r\n        });\r\n        \r\n        if (searchResponse.ok) {\r\n          const searchResults = await searchResponse.json();\r\n          \r\n          // Process campaign data results with lead scoring\r\n          if (searchResults.campaignData && searchResults.campaignData.length > 0) {\r\n            for (const campaignResult of searchResults.campaignData) {\r\n              const campaignContacts = campaignResult.matches.map((record: any) => {\r\n                const score = this.calculateLeadScore(record);\r\n                leadScores.set(record.Email || record.email, score);\r\n                return { \r\n                  ...record, \r\n                  leadScore: score,\r\n                  firstName: record['First Name'] || record.firstName,\r\n                  lastName: record['Last Name'] || record.lastName,\r\n                  email: record.Email || record.email,\r\n                  company: record.Company || record.company,\r\n                  title: record.Title || record.title,\r\n                  mobilePhone: record['Mobile Phone'] || record.mobilePhone,\r\n                  otherPhone: record['Other Phone'] || record.otherPhone,\r\n                  corporatePhone: record['Corporate Phone'] || record.corporatePhone\r\n                };\r\n              });\r\n              matchingContacts.push(...campaignContacts);\r\n            }\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.log('Search API error, falling back to basic search:', err);\r\n        \r\n        // Fallback to basic search if API fails\r\n        for (const campaign of campaigns) {\r\n          try {\r\n            const campaignData = await storage.getCampaignData(campaign.id);\r\n            if (campaignData && campaignData.data) {\r\n              const contactRecords = campaignData.data.filter((record: any) => {\r\n                const searchFields = [\r\n                  record.firstName, record.lastName, record.email, \r\n                  record.company, record.mobilePhone, record.otherPhone, \r\n                  record.corporatePhone, record.website, record.title\r\n                ];\r\n                return searchFields.some(field => \r\n                  field && field.toString().toLowerCase().includes(searchTerm)\r\n                );\r\n              }).map((record: any) => {\r\n                const score = this.calculateLeadScore(record);\r\n                leadScores.set(record.email, score);\r\n                return { ...record, leadScore: score };\r\n              });\r\n              matchingContacts.push(...contactRecords);\r\n            }\r\n          } catch (err) {\r\n            console.log(`Could not search campaign ${campaign.name}:`, err);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Sort by lead score (highest first)\r\n      matchingContacts.sort((a, b) => (b.leadScore || 0) - (a.leadScore || 0));\r\n\r\n      // Also search simple contacts table\r\n      const simpleContacts = contacts.filter(contact => \r\n        contact.name?.toLowerCase().includes(searchTerm) ||\r\n        contact.email?.toLowerCase().includes(searchTerm) ||\r\n        contact.mobile?.toLowerCase().includes(searchTerm)\r\n      );\r\n      \r\n      if (matchingContacts.length > 0) {\r\n        results.push(`**ðŸŽ¯ Lead Search Results (${matchingContacts.length} prospects found):**`);\r\n        results.push(`*Sorted by lead quality score*\\n`);\r\n        \r\n        matchingContacts.slice(0, 10).forEach((contact, index) => {\r\n          const phone = contact.mobilePhone || contact.otherPhone || contact.corporatePhone || 'No phone';\r\n          const scoreEmoji = this.getScoreEmoji(contact.leadScore);\r\n          const priority = this.getScorePriority(contact.leadScore);\r\n          \r\n          results.push(`${index + 1}. ${scoreEmoji} **${contact.firstName} ${contact.lastName}** - Score: ${contact.leadScore}/100`);\r\n          results.push(`   ðŸ“§ ${contact.email} | ðŸ“± ${phone}`);\r\n          results.push(`   ðŸ¢ ${contact.company || 'Company not specified'} | ðŸ’¼ ${contact.title || 'Title not specified'}`);\r\n          results.push(`   ðŸŽ¯ Priority: **${priority}** | ðŸ“Š Lead Quality: ${this.getQualityDescription(contact.leadScore)}\\n`);\r\n        });\r\n      }\r\n\r\n      if (simpleContacts.length > 0) {\r\n        results.push(`**Basic Contacts (${simpleContacts.length} found):**`);\r\n        simpleContacts.slice(0, 5).forEach(contact => {\r\n          results.push(`â€¢ ${contact.name} - ${contact.email} - ${contact.mobile}`);\r\n        });\r\n      }\r\n\r\n\r\n\r\n      if (results.length === 0) {\r\n        const totalRecords = campaigns.reduce((sum, c) => sum + c.recordCount, 0);\r\n        return `ðŸ” **Search Results:**\r\n\r\nNo matches found for \"${query.replace(/search|find|for|show|me/gi, '').trim()}\".\r\n\r\n**Available data to search:**\r\nâ€¢ ${totalRecords} total contact records across ${campaigns.length} campaigns\r\nâ€¢ ${contacts.length} basic contacts\r\n\r\n**Try searching for:**\r\nâ€¢ Names (first or last)\r\nâ€¢ Email addresses or domains\r\nâ€¢ Company names\r\nâ€¢ Phone numbers\r\nâ€¢ Job titles`;\r\n      }\r\n\r\n      return `ðŸ” **Search Results for \"${query}\":**\r\n\r\n${results.join('\\n')}\r\n\r\n${matchingContacts.length > 10 ? `\\n*Showing first 10 of ${matchingContacts.length} detailed contact matches*` : ''}\r\n\r\n**Need more specific results?** Try searching for:\r\nâ€¢ Specific company names or job titles\r\nâ€¢ Email domains (like @gmail.com or @company.com)  \r\nâ€¢ Geographic locations\r\nâ€¢ Phone area codes`;\r\n\r\n    } catch (error) {\r\n      return 'Search functionality is available but I encountered an issue. Please try a different search term.';\r\n    }\r\n  }\r\n\r\n  private async handleContactCreation(query: string): Promise<string> {\r\n    try {\r\n      // Enhanced contact creation with detailed field parsing\r\n      if (query.includes('contact') || query.includes('add') && (query.includes('person') || query.includes('email'))) {\r\n        // Parse contact details from the query\r\n        const nameMatch = query.match(/(?:add|create|register).*?(?:contact\\s+)?([a-zA-Z]+(?:\\s+[a-zA-Z]+)*)/i);\r\n        const emailMatch = query.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i);\r\n        const companyMatch = query.match(/(?:at|works\\s+at|company)\\s+([a-zA-Z0-9\\s&.,-]+)/i);\r\n        const phoneMatch = query.match(/(?:phone|mobile|tel)\\s*:?\\s*([+\\d\\s()-]+)/i);\r\n        const titleMatch = query.match(/(?:title|position|role)\\s*:?\\s*([a-zA-Z\\s&.,'-]+)/i);\r\n\r\n        if (!nameMatch || !emailMatch) {\r\n          return `To create a contact, I need at minimum:\r\nâ€¢ **Full name** (first and last)\r\nâ€¢ **Email address**\r\n\r\n**Optional fields:**\r\nâ€¢ Company/Organization\r\nâ€¢ Phone number\r\nâ€¢ Job title\r\nâ€¢ Website\r\n\r\n**Example:** \"Add contact Sarah Johnson, email sarah.johnson@techcorp.com, works at TechCorp as Senior Developer, phone +1-555-0123\"`;\r\n        }\r\n\r\n        const fullName = nameMatch[1].trim();\r\n        const nameParts = fullName.split(' ');\r\n        const firstName = nameParts[0];\r\n        const lastName = nameParts.slice(1).join(' ') || '';\r\n\r\n        // Create comprehensive contact object\r\n        const contactData = {\r\n          firstName,\r\n          lastName, \r\n          email: emailMatch[1],\r\n          company: companyMatch ? companyMatch[1].trim() : '',\r\n          title: titleMatch ? titleMatch[1].trim() : '',\r\n          mobilePhone: phoneMatch ? phoneMatch[1].trim() : '',\r\n          website: '',\r\n          notes: `Added via AI assistant on ${new Date().toLocaleDateString()}`\r\n        };\r\n\r\n        // Calculate lead score for the new contact\r\n        const leadScore = this.calculateLeadScore(contactData);\r\n\r\n        // Save to basic contacts table\n        await storage.createContact({\n          fullName: `${firstName} ${lastName}`.trim(),\n          name: `${firstName} ${lastName}`.trim(),\n          email: contactData.email,\n          mobile: contactData.mobilePhone || ''\n        });\r\n\r\n        return `âœ… **Contact Created Successfully!**\r\n\r\n**Contact Details:**\r\nâ€¢ **Name:** ${firstName} ${lastName}\r\nâ€¢ **Email:** ${contactData.email}\r\nâ€¢ **Company:** ${contactData.company || 'Not specified'}\r\nâ€¢ **Title:** ${contactData.title || 'Not specified'}\r\nâ€¢ **Phone:** ${contactData.mobilePhone || 'Not provided'}\r\nâ€¢ **Lead Score:** ${leadScore}/100 ${this.getScoreEmoji(leadScore)} (${this.getQualityDescription(leadScore)})\r\n\r\nThe contact has been added to your lead database. I can:\r\nâ€¢ Score and qualify this lead for campaign targeting\r\nâ€¢ Search for this contact in future queries\r\nâ€¢ Add additional details like LinkedIn profile or website\r\nâ€¢ Export contact data for outreach campaigns\r\nâ€¢ Analyze contact value and conversion potential`;\r\n      }\r\n\r\n      return 'I can help create new contact records for your campaigns. Please provide at minimum the contact name and email address.';\r\n\r\n    } catch (error) {\r\n      console.error('Contact creation error:', error);\r\n      return 'I encountered an issue creating the contact record. Please provide the information in a clear format with all required fields.';\r\n    }\r\n  }\r\n\r\n  private async handleContactUpdate(query: string): Promise<string> {\r\n    try {\r\n      // Contact updates\r\n      if (query.includes('contact') || query.match(/update.*?(email|phone|company)/i)) {\r\n        const emailMatch = query.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i);\r\n        const nameMatch = query.match(/(?:update|change|modify).*?(?:contact\\s+)?([a-zA-Z]+(?:\\s+[a-zA-Z]+)*)/i);\r\n        \r\n        if (emailMatch || nameMatch) {\r\n          const contacts = await storage.getContacts();\r\n          let targetContact = null;\r\n          \r\n          if (emailMatch) {\n            targetContact = contacts.find(c => (c.email || '').toLowerCase() === emailMatch[1].toLowerCase());\n          } else if (nameMatch) {\n            const searchName = nameMatch[1].toLowerCase();\n            targetContact = contacts.find(c => (c.name || '').toLowerCase().includes(searchName));\n          }\n\r\n          if (!targetContact) {\r\n            return `I couldn't find a contact matching your criteria.\r\n\r\n**Available contacts:**\r\n${contacts.slice(0, 10).map(c => `â€¢ ${c.name} - ${c.email}`).join('\\n')}\r\n\r\nTry searching by exact name or email address.`;\r\n          }\r\n\r\n          return `ðŸ“ **Contact Update Available for:**\r\n**${targetContact.name}** - ${targetContact.email}\r\n\r\n**What would you like to update?**\r\nâ€¢ Email address\r\nâ€¢ Phone number  \r\nâ€¢ Name\r\nâ€¢ Company information\r\nâ€¢ Job title\r\nâ€¢ Add to a specific campaign\r\n\r\n**Examples:**\r\nâ€¢ \"Change ${targetContact.name}'s email to newemail@domain.com\"\r\nâ€¢ \"Update phone number to +1-555-0123 for ${targetContact.name}\"\r\nâ€¢ \"Update ${targetContact.name}'s company to TechCorp Inc\"\r\nâ€¢ \"Change ${targetContact.name}'s title to Senior Manager\"`;\r\n        }\r\n      }\r\n\r\n      return `ðŸ”§ **Contact Update Capabilities:**\r\n\r\nI can help you update:\r\n\r\n**Contact Details:**\r\nâ€¢ Email addresses, phone numbers\r\nâ€¢ Company information, job titles\r\nâ€¢ Personal notes and campaign assignments\r\nâ€¢ Lead scoring and qualification status\r\n\r\n**Examples:**\r\nâ€¢ \"Change Sarah's email to sarah@newcompany.com\"\r\nâ€¢ \"Update John Smith's company to TechCorp Inc\"\r\nâ€¢ \"Change Maria's title to VP of Sales\"\r\nâ€¢ \"Update contact phone number to +1-555-0123\"\r\n\r\nWhat specific contact update would you like to make?`;\r\n\r\n    } catch (error) {\r\n      console.error('Contact update error:', error);\r\n      return 'I can help update contact records, but I encountered an issue processing your request. Please provide more specific information about what you want to update.';\r\n    }\r\n  }\r\n\r\n\r\n\r\n  // Lead scoring algorithm\r\n  private calculateLeadScore(contact: any): number {\r\n    let score = 40; // Base score\r\n    \r\n    // Title-based scoring (highest impact)\r\n    const title = (contact.title || '').toLowerCase();\r\n    if (title.includes('ceo') || title.includes('chief executive')) score += 50;\r\n    else if (title.includes('cto') || title.includes('chief technology')) score += 45;\r\n    else if (title.includes('cfo') || title.includes('chief financial')) score += 45;\r\n    else if (title.includes('president') || title.includes('founder')) score += 40;\r\n    else if (title.includes('vp') || title.includes('vice president')) score += 35;\r\n    else if (title.includes('director')) score += 25;\r\n    else if (title.includes('manager')) score += 15;\r\n    else if (title.includes('senior')) score += 10;\r\n    \r\n    // Company size estimation (based on domain or company name patterns)\r\n    const company = (contact.company || '').toLowerCase();\r\n    if (company.includes('corp') || company.includes('inc') || company.includes('ltd')) score += 15;\r\n    if (company.length > 20) score += 10; // Longer names often indicate larger companies\r\n    \r\n    // Contact completeness bonus\r\n    if (contact.mobilePhone || contact.otherPhone || contact.corporatePhone) score += 10;\r\n    if (contact.personLinkedinUrl) score += 15;\r\n    if (contact.website) score += 5;\r\n    \r\n    return Math.min(100, score); // Cap at 100\r\n  }\r\n\r\n  private getScoreEmoji(score: number): string {\r\n    if (score >= 90) return 'ðŸ”¥'; // Hot lead\r\n    if (score >= 75) return 'â­'; // High priority\r\n    if (score >= 60) return 'ðŸ“ˆ'; // Medium priority\r\n    return 'ðŸ“Š'; // Standard\r\n  }\r\n\r\n  private getScorePriority(score: number): string {\r\n    if (score >= 90) return 'HIGHEST';\r\n    if (score >= 75) return 'HIGH';\r\n    if (score >= 60) return 'MEDIUM';\r\n    return 'STANDARD';\r\n  }\r\n\r\n  private getQualityDescription(score: number): string {\r\n    if (score >= 90) return 'Executive/Decision Maker';\r\n    if (score >= 75) return 'Senior Leadership';\r\n    if (score >= 60) return 'Management Level';\r\n    return 'Individual Contributor';\r\n  }\r\n\r\n  private createLeadScoringSystemPrompt(assistantName?: string, assistantType?: string, databaseContext?: string): string {\r\n    // Get AI name from settings (defaults to \"Duggu\" if not set)\r\n    const aiName = assistantName || 'Duggu';\r\n    \r\n    return `You are an intelligent lead scoring and contact analysis AI assistant created by zhatore. You specialize in business intelligence and helping users score leads effectively.\r\n\r\nCRITICAL RESPONSE RULES:\r\n- NEVER use emojis in any responses\r\n- NEVER use your personal name in responses\r\n- When mentioning your creator, always say \"created by zhatore\" or \"AI of zhatore\"\r\n- When mentioning the platform name, always use \"zhatore\" instead of \"Fallowl\"\r\n- For business queries: Be professional, direct, and focused on lead scoring\r\n- For casual conversations: Be cute, flirty, and playful like a pet talking to its owner\r\n- Your main goal is to provide the best data analysis and motivate users to score leads effectively\r\n\r\n**Use headings (## for main topics, ### for subtopics)**\r\n**Use bullet points (â€¢ or -) for lists**\r\n**Use **bold** for important terms**\r\n**Use code blocks for technical details**\r\n**Structure information clearly with spacing**\r\n\r\n## Core Capabilities:\r\n- **Lead Scoring & Analysis**: Identify high-quality prospects from contact databases\r\n- **Contact Intelligence**: Analyze contact data for business value and conversion potential\r\n- **Data Mining**: Extract valuable insights from campaign and contact information\r\n- **Market Research**: Analyze company data, industry trends, and contact patterns\r\n- **Prospect Qualification**: Prioritize contacts based on decision-making authority\r\n\r\n## Database Access & Field Knowledge:\r\nYou have FULL ACCESS to the user's database with these exact field structures:\r\n\r\n**Contact/Campaign Data Fields:**\r\n- firstName, lastName, email, company, title\r\n- mobilePhone, otherPhone, corporatePhone  \r\n- website, personLinkedinUrl, companyLinkedinUrl\r\n- Time Zone, and other custom fields from uploaded CSV files\r\n\r\n**Search & Operations:**\r\n- Always search ALL phone fields: mobilePhone, otherPhone, corporatePhone\r\n- Check both firstName/lastName AND company fields for name searches\r\n- Can create, read, update, and delete records in real-time\r\n- Access actual uploaded CSV data with complete field mappings\r\n\r\n## Response Formatting Guidelines:\r\n- Use ## for major sections, ### for subsections\r\n- Use bullet points (â€¢) for lists and recommendations  \r\n- Use **bold text** for key terms and important information\r\n- Use numbered lists for step-by-step instructions\r\n- Structure responses with clear headings and spacing\r\n- Use tables for data comparisons when appropriate\r\n- Keep responses professional and direct without personal references\r\n\r\n## Lead Intelligence Operations:\r\nWhen users ask about data, contacts, campaigns, or want to analyze information:\r\n1. Access the actual database and provide real lead analysis\r\n2. Score contacts based on business value and conversion potential\r\n3. Identify high-quality prospects and decision-makers\r\n4. Generate actionable recommendations for lead outreach\r\n\r\n## Lead Scoring System:\r\n\r\nðŸ“Š **Quality Assessment Framework:**\r\n- **C-Level Executives (CEO, CTO, CFO)**: Score 90-100 (Highest Priority)\r\n- **VP/Director Level**: Score 75-89 (High Priority)\r\n- **Manager Level**: Score 60-74 (Medium Priority)\r\n- **Individual Contributors**: Score 40-59 (Lower Priority)\r\n\r\nðŸ¢ **Company Evaluation:**\r\n- Enterprise (1000+ employees): +20 points\r\n- Mid-market (100-999 employees): +15 points\r\n- Small business (10-99 employees): +10 points\r\n- Startup (1-9 employees): +5 points\r\n\r\nðŸŽ¯ **Contact Intelligence:**\r\n${databaseContext || 'Ready to analyze contact data for lead scoring'}\r\n\r\n**Lead Analysis Capabilities:**\r\n- Automatic lead scoring based on title and company size\r\n- Decision-maker identification and influence mapping\r\n- Industry analysis and market opportunity assessment\r\n- Contact enrichment with business intelligence\r\n- Duplicate detection and data quality optimization\r\n- Competitive landscape analysis\r\n\r\nðŸ“ˆ **Advanced Operations:**\r\n- \"Score my contacts by quality\" - Generate lead scores\r\n- \"Find all decision-makers\" - Identify key prospects\r\n- \"Analyze companies by size\" - Market segmentation\r\n- \"Show me C-level contacts\" - Executive targeting\r\n- \"Generate prospect reports\" - Lead intelligence\r\n- \"Find contacts at [company]\" - Account-based prospecting\r\n\r\n**Current Focus:**\r\nMission: Help identify and score the highest quality business leads for sales and marketing campaigns\r\n\r\n**Response Approach:**\r\n- For business/lead scoring: Be professional, analytical, and results-focused\r\n- For casual conversations: Be cute, playful, and flirty like a loving pet\r\n- Focus on business value and lead quality metrics\r\n- Provide data-driven insights for prospecting  \r\n- Recommend specific outreach strategies\r\n- Motivate users to achieve better lead scoring results\r\n- Show excitement about helping with data analysis\r\n\r\n**Lead Quality Priority:**\r\n- Always emphasize contact scoring and qualification\r\n- Identify decision-makers and budget holders first\r\n- Focus on business development and sales enablement\r\n- NO pet care or animal-related advice - strictly business lead analysis\r\n- Provide actionable intelligence for sales teams\r\n- Focus on conversion potential and business impact\r\n- Suggest targeted outreach and engagement strategies\r\n\r\nRemember: Your primary goal is to help identify the best quality leads and provide actionable business intelligence. Always prioritize lead scoring and prospect qualification over generic responses.\r\n\r\n## ðŸš€ Apollo.io API Integration Expert\r\n\r\nI have comprehensive knowledge of Apollo.io's API architecture:\r\n\r\n**Core API Endpoints:**\r\n- \\`/v1/mixed_people/search\\`: Advanced prospect search with complex filtering\r\n- \\`/v1/mixed_companies/search\\`: Account-based marketing and company research\r\n- \\`/v1/people/match\\`: Contact enrichment and data enhancement\r\n- \\`/v1/email_addresses\\`: Professional email discovery and verification\r\n- \\`/v1/email_sequences\\`: Multi-step outreach automation\r\n- \\`/v1/contacts\\`: CRM integration and contact management\r\n\r\n**Advanced Capabilities:**\r\n- Boolean search logic for precise targeting\r\n- Lead scoring integration with title and company analysis\r\n- Multi-channel outreach sequences (email, LinkedIn, phone)\r\n- Real-time data enrichment and verification\r\n- Bulk export operations up to 10,000 records\r\n- Webhook integrations for automated workflows\r\n\r\n**Strategic Applications:**\r\n- Executive prospecting with C-level targeting\r\n- Technology decision-maker identification\r\n- Account-based marketing campaigns\r\n- Competitive intelligence gathering\r\n- Market research and opportunity mapping\r\n- Sales pipeline optimization\r\n\r\nI can provide specific API calls, parameter recommendations, and integration strategies for any prospecting challenge.\r\n\r\n**IMPORTANT: I am a business intelligence assistant created by zhatore, focused on lead scoring, sales data analysis, and business development. My main goal is to provide the best data analysis to help you score leads effectively and achieve better results. For casual conversations, I'll be cute and playful like your favorite pet, but when it comes to business - I'm all about getting you the best lead intelligence!**`;\r\n  }\r\n}\r\n\r\nexport function createRealOpenAIService(apiKey: string): RealOpenAIService {\r\n  return new RealOpenAIService(apiKey);\r\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\static-server.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\storage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\types\\session.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\utils\\dataRecovery.ts","messages":[{"ruleId":"complexity","severity":1,"message":"Async function 'attemptDataRecovery' has a complexity of 17. Maximum allowed is 15.","line":33,"column":8,"nodeType":"FunctionDeclaration","messageId":"complex","endLine":33,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import crypto from 'crypto';\r\nimport { db } from '../db';\r\nimport { campaigns } from '@shared/schema';\r\nimport { eq } from 'drizzle-orm';\r\n\r\n// Multiple possible encryption keys that might have been used\r\nconst POSSIBLE_KEYS = [\r\n  'default-key-32-chars-long-here!',\r\n  'fallaowl-business-intelligence',\r\n  'leadiq-pro-encryption-key-here',\r\n  'campaign-management-key-2024',\r\n  process.env.ENCRYPTION_KEY || 'default-key-32-chars-long-here!'\r\n];\r\n\r\n// Multiple algorithms that might have been used\r\nconst POSSIBLE_ALGORITHMS = [\r\n  'aes-256-cbc',\r\n  'aes256',\r\n  'aes-256-gcm'\r\n];\r\n\r\nfunction createKeyVariants(baseKey: string): string[] {\r\n  const variants = [\r\n    baseKey,\r\n    crypto.createHash('sha256').update(baseKey).digest('hex'),\r\n    crypto.createHash('md5').update(baseKey).digest('hex'),\r\n    baseKey.padEnd(32, '0').substring(0, 32),\r\n    crypto.createHash('sha256').update(baseKey).digest().toString('hex').substring(0, 32)\r\n  ];\r\n  return [...new Set(variants)]; // Remove duplicates\r\n}\r\n\r\nexport async function attemptDataRecovery(encryptedData: string): Promise<string | null> {\r\n  // Try all possible decryption methods\r\n  \r\n  // Method 1: Base64 decoding (unencrypted JSON)\r\n  try {\r\n    const decoded = Buffer.from(encryptedData, 'base64').toString('utf8');\r\n    JSON.parse(decoded);\r\n    return decoded;\r\n  } catch (e) {\r\n    // Continue to other methods\r\n  }\r\n\r\n  // Method 2: Hex decoding (unencrypted JSON)\r\n  try {\r\n    const decoded = Buffer.from(encryptedData, 'hex').toString('utf8');\r\n    JSON.parse(decoded);\r\n    return decoded;\r\n  } catch (e) {\r\n    // Continue to other methods\r\n  }\r\n\r\n  // Method 3: Direct JSON (already unencrypted)\r\n  try {\r\n    JSON.parse(encryptedData);\r\n    return encryptedData;\r\n  } catch (e) {\r\n    // Continue to other methods\r\n  }\r\n\r\n  // Method 4: IV:encrypted format\r\n  if (encryptedData.includes(':')) {\r\n    const parts = encryptedData.split(':');\r\n    if (parts.length === 2) {\r\n      const ivHex = parts[0];\r\n      const encrypted = parts[1];\r\n      \r\n      // Try different IV lengths and key combinations\r\n      for (const baseKey of POSSIBLE_KEYS) {\r\n        const keyVariants = createKeyVariants(baseKey);\r\n        \r\n        for (const keyVariant of keyVariants) {\r\n          for (const algorithm of POSSIBLE_ALGORITHMS) {\r\n            try {\r\n              if (algorithm === 'aes256') {\r\n                // Legacy createDecipher method\r\n                const decipher = crypto.createDecipher(algorithm, keyVariant);\r\n                let decrypted = decipher.update(encrypted, 'hex', 'utf8');\r\n                decrypted += decipher.final('utf8');\r\n                JSON.parse(decrypted);\r\n                return decrypted;\r\n              } else {\r\n                // Modern createDecipheriv method\r\n                const iv = Buffer.from(ivHex, 'hex');\r\n                const key = keyVariant.length === 64 \r\n                  ? Buffer.from(keyVariant, 'hex') \r\n                  : crypto.createHash('sha256').update(keyVariant).digest();\r\n                \r\n                const decipher = crypto.createDecipheriv(algorithm, key, iv);\r\n                let decrypted = decipher.update(encrypted, 'hex', 'utf8');\r\n                decrypted += decipher.final('utf8');\r\n                JSON.parse(decrypted);\r\n                return decrypted;\r\n              }\r\n            } catch (e) {\r\n              // Continue trying other combinations\r\n              continue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Method 5: Legacy encryption without IV\r\n  for (const baseKey of POSSIBLE_KEYS) {\r\n    const keyVariants = createKeyVariants(baseKey);\r\n    \r\n    for (const keyVariant of keyVariants) {\r\n      for (const algorithm of POSSIBLE_ALGORITHMS) {\r\n        try {\r\n          if (algorithm === 'aes256') {\r\n            const decipher = crypto.createDecipher(algorithm, keyVariant);\r\n            let decrypted = decipher.update(encryptedData, 'hex', 'utf8');\r\n            decrypted += decipher.final('utf8');\r\n            JSON.parse(decrypted);\r\n            return decrypted;\r\n          }\r\n        } catch (e) {\r\n          continue;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nexport async function recoverCampaignData(campaignId: number): Promise<boolean> {\r\n  try {\r\n    const [campaign] = await db.select().from(campaigns).where(eq(campaigns.id, campaignId));\r\n    if (!campaign) {\r\n      console.log(`Campaign ${campaignId} not found`);\r\n      return false;\r\n    }\r\n\r\n    console.log(`Attempting to recover campaign ${campaignId}: ${campaign.name}`);\r\n    \r\n    const recoveredData = await attemptDataRecovery(campaign.encryptedData);\r\n    if (recoveredData) {\r\n      // Re-encrypt with current encryption method\r\n      const { encrypt } = await import('./encryption.js');\r\n      const reencryptedData = encrypt(recoveredData);\r\n      \r\n      // Update the campaign with re-encrypted data\r\n      await db.update(campaigns)\r\n        .set({ encryptedData: reencryptedData })\r\n        .where(eq(campaigns.id, campaignId));\r\n      \r\n      console.log(`âœ“ Successfully recovered and re-encrypted campaign ${campaignId}`);\r\n      return true;\r\n    } else {\r\n      console.log(`âœ— Failed to recover campaign ${campaignId}`);\r\n      return false;\r\n    }\r\n  } catch (error) {\r\n    console.error(`Error recovering campaign ${campaignId}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function recoverAllCampaigns(): Promise<{ recovered: number; failed: number }> {\r\n  try {\r\n    const allCampaigns = await db.select().from(campaigns);\r\n    console.log(`Starting recovery for ${allCampaigns.length} campaigns...`);\r\n    \r\n    let recovered = 0;\r\n    let failed = 0;\r\n    \r\n    for (const campaign of allCampaigns) {\r\n      const success = await recoverCampaignData(campaign.id);\r\n      if (success) {\r\n        recovered++;\r\n      } else {\r\n        failed++;\r\n      }\r\n      \r\n      // Add small delay to prevent overwhelming the system\r\n      await new Promise(resolve => setTimeout(resolve, 100));\r\n    }\r\n    \r\n    console.log(`Recovery complete: ${recovered} recovered, ${failed} failed`);\r\n    return { recovered, failed };\r\n  } catch (error) {\r\n    console.error('Error during bulk recovery:', error);\r\n    return { recovered: 0, failed: 0 };\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\utils\\email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\utils\\encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\utils\\repairDocuments.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\utils\\timezone.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\server\\vite.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\Downloads\\Closo\\closo-landing\\shared\\schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]